<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh" class="translated-ltr"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<title>第23章存储程序和视图</title>
<link rel="stylesheet" href="./images/mvl.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets + chunker.py v1.9.2">
<link rel="start" href="/mysql-5.7-google-zh/index.html" title="{书名}">
<link rel="up" href="/mysql-5.7-google-zh/stored-programs-views.html" title="">
<link rel="prev" href="/mysql-5.7-google-zh/partitioning.html" title="第22章分区">
<link rel="next" href="/mysql-5.7-google-zh/information-schema.html" title="第24章INFORMATION_SCHEMA表">
<link type="text/css" rel="stylesheet" charset="UTF-8" href="./images/translateelement.css"></head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tbody><tr>
<th colspan="3" align="center"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第23章存储程序和视图</font></font></th>
</tr>
<tr>
<td width="20%" align="left"><a accesskey="p" href="/mysql-5.7-google-zh/partitioning.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">上一页</font></font></a>&nbsp;</td>
<th width="60%" align="center"></th>
<td width="20%" align="right">&nbsp;<a accesskey="n" href="/mysql-5.7-google-zh/information-schema.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">下一个</font></font></a></td>
</tr>
</tbody></table>
<hr>
</div>
<div class="chapter">
<div class="titlepage">
<div>
<div>
<h1 class="title"><a name="stored-programs-views"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第23章存储程序和视图</font></font></h1>

</div>

</div>

</div>
<div class="toc">
<p><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">目录</font></font></b></p><dl class="toc"><dt><span class="section"><a href="/mysql-5.7-google-zh/stored-programs-views.html#stored-programs-defining"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.1定义存储程序</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/stored-programs-views.html#stored-routines"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.2使用存储例程（过程和函数）</font></font></a></span></dt><dd><dl><dt><span class="section"><a href="/mysql-5.7-google-zh/stored-programs-views.html#stored-routines-syntax"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.2.1存储的例程语法</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/stored-programs-views.html#stored-routines-privileges"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.2.2存储例程和MySQL权限</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/stored-programs-views.html#stored-routines-metadata"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.2.3存储的例程元数据</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/stored-programs-views.html#stored-routines-last-insert-id"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.2.4存储过程，函数，触发器和LAST_INSERT_ID（）</font></font></a></span></dt></dl></dd><dt><span class="section"><a href="/mysql-5.7-google-zh/stored-programs-views.html#triggers"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.3使用触发器</font></font></a></span></dt><dd><dl><dt><span class="section"><a href="/mysql-5.7-google-zh/stored-programs-views.html#trigger-syntax"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.3.1触发语法和示例</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/stored-programs-views.html#trigger-metadata"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.3.2触发器元数据</font></font></a></span></dt></dl></dd><dt><span class="section"><a href="/mysql-5.7-google-zh/stored-programs-views.html#event-scheduler"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.4使用事件调度程序</font></font></a></span></dt><dd><dl><dt><span class="section"><a href="/mysql-5.7-google-zh/stored-programs-views.html#events-overview"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.4.1事件调度程序概述</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/stored-programs-views.html#events-configuration"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.4.2事件调度程序配置</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/stored-programs-views.html#events-syntax"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.4.3事件语法</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/stored-programs-views.html#events-metadata"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.4.4事件元数据</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/stored-programs-views.html#events-status-info"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.4.5事件调度程序状态</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/stored-programs-views.html#events-privileges"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.4.6事件调度程序和MySQL特权</font></font></a></span></dt></dl></dd><dt><span class="section"><a href="/mysql-5.7-google-zh/stored-programs-views.html#views"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.5使用视图</font></font></a></span></dt><dd><dl><dt><span class="section"><a href="/mysql-5.7-google-zh/stored-programs-views.html#view-syntax"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.5.1查看语法</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/stored-programs-views.html#view-algorithms"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.5.2视图处理算法</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/stored-programs-views.html#view-updatability"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.5.3可更新和可插入的视图</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/stored-programs-views.html#view-check-option"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.5.4查看WITH CHECK OPTION子句</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/stored-programs-views.html#view-metadata"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.5.5查看元数据</font></font></a></span></dt></dl></dd><dt><span class="section"><a href="/mysql-5.7-google-zh/stored-programs-views.html#stored-programs-security"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.6存储程序和视图的访问控制</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/stored-programs-views.html#stored-programs-logging"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.7存储程序的二进制记录</font></font></a></span></dt></dl>
</div>
<a class="indexterm" name="idm140527981311200"></a><a class="indexterm" name="idm140527981310160"></a><a class="indexterm" name="idm140527981308672"></a><a class="indexterm" name="idm140527981307600"></a><a class="indexterm" name="idm140527981306528"></a><a class="indexterm" name="idm140527981305456"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    本章讨论存储的程序和视图，这些数据库对象是根据存储在服务器上供以后执行的SQL代码定义的数据库对象。
  </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    存储的程序包括这些对象：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        存储例程，即存储过程和函数。</font><font style="vertical-align: inherit;">使用该</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#call" title="13.2.1 CALL语法"><code class="literal">CALL</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句</font><font style="vertical-align: inherit;">调用存储过程
         </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">过程没有返回值，但可以修改其参数供调用者稍后检查。</font><font style="vertical-align: inherit;">它也可以生成返回给客户端程序的结果集。</font><font style="vertical-align: inherit;">存储的功能与内置功能非常相似。</font><font style="vertical-align: inherit;">您可以在表达式中调用它并在表达式评估期间返回一个值。
      </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        触发。</font><font style="vertical-align: inherit;">触发器是一个与表关联的已命名数据库对象，当表发生特定事件（如插入或更新）时，该对象将被激活。
      </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        活动。</font><font style="vertical-align: inherit;">事件是服务器按计划运行的任务。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    视图是被存储的查询，当被引用时产生结果集。</font><font style="vertical-align: inherit;">视图充当虚拟表格。
  </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    本章介绍如何使用存储的程序和视图。</font><font style="vertical-align: inherit;">以下各节提供了与这些对象相关的语句的SQL语法附加信息：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        为每个对象类型，还有</font></font><code class="literal">CREATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
         </font></font><code class="literal">ALTER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><code class="literal">DROP</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">控制哪些对象存在以及它们是如何定义语句。</font><font style="vertical-align: inherit;">请参见
         </font></font><a class="xref" href="/mysql-5.7-google-zh/sql-syntax.html#sql-syntax-data-definition" title="13.1数据定义语句"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第13.1节“数据定义语句”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
      </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        该</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#call" title="13.2.1 CALL语法"><code class="literal">CALL</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句用于调用存储过程。</font><font style="vertical-align: inherit;">请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/sql-syntax.html#call" title="13.2.1 CALL语法"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第13.2.1节“CALL语法”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
      </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        存储程序定义包括一个可以使用复合语句，循环，条件和声明变量的主体。</font><font style="vertical-align: inherit;">请参见
         </font></font><a class="xref" href="/mysql-5.7-google-zh/sql-syntax.html#sql-syntax-compound-statements" title="13.6复合语句语法"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第13.6节“复合语句语法”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    在MySQL中，检测存储程序引用的对象的元数据更改，并在下次执行程序时自动重新分析受影响的语句。</font><font style="vertical-align: inherit;">有关更多信息，请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/optimization.html#statement-caching" title="8.10.4缓存准备好的语句和存储的程序"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第8.10.4节“准备好的语句和存储的程序的缓存”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p>
<div class="section">

<div class="titlepage">
<div>
<div>
<h2 class="title" style="clear: both"><a name="stored-programs-defining"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.1定义存储程序</font></font></h2>
</div>
</div>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      每个存储的程序都包含一个由SQL语句组成的主体。</font><font style="vertical-align: inherit;">该语句可能是由多个由分号（</font></font><code class="literal">;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）字符</font><font style="vertical-align: inherit;">分隔的语句组成的复合语句</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">例如，以下存储过程的主体由一个</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#begin-end" title="13.6.1 BEGIN ... END复合语句句法"><code class="literal">BEGIN ...
      END</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">包含</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#set-variable" title="13.7.4.1变量赋值的SET语法"><code class="literal">SET</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      语句</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">块
       </font><font style="vertical-align: inherit;">和一个</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#repeat" title="13.6.5.6 REPEAT语法"><code class="literal">REPEAT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">本身包含另一个</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#set-variable" title="13.7.4.1变量赋值的SET语法"><code class="literal">SET</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      语句</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">循环组成
       </font><font style="vertical-align: inherit;">：
    </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CREATE PROCEDURE dorepeat（p1 INT）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
开始</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  SET @x = 0;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  REPEAT SET @x = @x + 1; </font><font style="vertical-align: inherit;">UNTIL @x&gt; p1 END REPEAT;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
结束;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      如果使用</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysql" title="4.5.1 mysql  -  MySQL命令行工具"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">客户端程序来定义包含分号字符的存储程序，</font><font style="vertical-align: inherit;">则会</font><font style="vertical-align: inherit;">出现问题。</font><font style="vertical-align: inherit;">默认情况下，</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysql" title="4.5.1 mysql  -  MySQL命令行工具"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">本身将分号识别为语句分隔符，因此您必须临时重新定义分隔符以使</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysql" title="4.5.1 mysql  -  MySQL命令行工具"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将整个存储的程序定义传递给服务器。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      要重新定义</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysql" title="4.5.1 mysql  -  MySQL命令行工具"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分隔符，请使用该
       </font></font><code class="literal">delimiter</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">命令。</font><font style="vertical-align: inherit;">以下示例显示了如何为</font></font><code class="literal">dorepeat()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">刚刚显示</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">过程</font><font style="vertical-align: inherit;">执行此操作</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">分隔符更改为</font></font><code class="literal">//</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使整个定义能够作为单个语句传递到服务器，然后</font></font><code class="literal">;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在调用过程之前将</font><font style="vertical-align: inherit;">其恢复到</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这使</font></font><code class="literal">;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      过程体中使用</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">分隔符能够传递到服务器，而不是被</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysql" title="4.5.1 mysql  -  MySQL命令行工具"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
      本身</font><font style="vertical-align: inherit;">解释</font><font style="vertical-align: inherit;">。
    </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL的&gt; </font></font><strong class="userinput"><code>delimiter //</code></strong><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql&gt; </font></font><strong class="userinput"><code>CREATE PROCEDURE dorepeat(p1 INT)</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    - &gt; </font></font><strong class="userinput"><code>BEGIN</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    - &gt;    </font></font><strong class="userinput"><code>SET @x = 0;</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    - &gt;    </font></font><strong class="userinput"><code>REPEAT SET @x = @x + 1; UNTIL @x &gt; p1 END REPEAT;</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    - &gt; </font></font><strong class="userinput"><code>END</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    - &gt;</font></font><strong class="userinput"><code>//</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
查询OK，0行受影响（0.00秒）</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MySQL的&gt; </font></font><strong class="userinput"><code>delimiter ;</code></strong><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MySQL的&gt; </font></font><strong class="userinput"><code>CALL dorepeat(1000);</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
查询OK，0行受影响（0.00秒）</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MySQL的&gt; </font></font><strong class="userinput"><code>SELECT @x;</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------ +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">@x |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------ +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">1001 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------ +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一排（0.00秒）</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      您可以将分隔符重新定义为除以外的字符串
       </font></font><code class="literal">//</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，并且分隔符可以由单个字符或多个字符组成。</font><font style="vertical-align: inherit;">您应该避免使用反斜杠（</font></font><code class="literal">\</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）字符，因为这是MySQL的转义字符。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      以下是一个函数的示例，该函数接受一个参数，使用SQL函数执行操作并返回结果。</font><font style="vertical-align: inherit;">在这种情况下，不需要使用，
       </font></font><code class="literal">delimiter</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">因为函数定义不包含内部</font></font><code class="literal">;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句分隔符：
    </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql&gt; </font></font><strong class="userinput"><code>CREATE FUNCTION hello (s CHAR(20))</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql&gt; </font></font><strong class="userinput"><code>RETURNS CHAR(50) DETERMINISTIC</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    - &gt;</font></font><strong class="userinput"><code>RETURN CONCAT('Hello, ',s,'!');</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
查询OK，0行受影响（0.00秒）</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MySQL的&gt; </font></font><strong class="userinput"><code>SELECT hello('world');</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ---------------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">hello（'world'）|</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ---------------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">你好，世界！</font><font style="vertical-align: inherit;">|</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ---------------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一排（0.00秒）</font></font><font></font>
</pre>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h2 class="title" style="clear: both"><a name="stored-routines"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.2使用存储例程（过程和函数）</font></font></h2>

</div>

</div>

</div>
<div class="toc">
<dl class="toc"><dt><span class="section"><a href="/mysql-5.7-google-zh/stored-programs-views.html#stored-routines-syntax"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.2.1存储的例程语法</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/stored-programs-views.html#stored-routines-privileges"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.2.2存储例程和MySQL权限</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/stored-programs-views.html#stored-routines-metadata"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.2.3存储的例程元数据</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/stored-programs-views.html#stored-routines-last-insert-id"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.2.4存储过程，函数，触发器和LAST_INSERT_ID（）</font></font></a></span></dt></dl>
</div>
<a class="indexterm" name="idm140527981250304"></a><a class="indexterm" name="idm140527981249264"></a><a class="indexterm" name="idm140527981247776"></a><a class="indexterm" name="idm140527981246704"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    MySQL支持存储的例程（过程和函数）。</font><font style="vertical-align: inherit;">存储的例程是一组可存储在服务器中的SQL语句。</font><font style="vertical-align: inherit;">完成此操作后，客户端不需要重新发布单个语句，而是可以引用存储的例程。
  </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    存储的例程需要</font><font style="vertical-align: inherit;">数据库中</font><font style="vertical-align: inherit;">的</font></font><code class="literal">proc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表
     </font></font><code class="literal">mysql</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">该表在MySQL安装过程中创建。</font><font style="vertical-align: inherit;">如果您要从早期版本升级到MySQL 5.7，请务必更新授权表以确保</font></font><code class="literal">proc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表存在。</font><font style="vertical-align: inherit;">请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/programs.html#mysql-upgrade" title="4.4.7 mysql_upgrade  - 检查并升级MySQL表"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第4.4.7节“ </font></font><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql_upgrade</font></font></strong></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - 检查并升级MySQL表”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
  </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    存储的例程在某些情况下特别有用：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        当多个客户端应用程序以不同语言编写或在不同平台上工作时，需要执行相同的数据库操作。
      </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        安全至关重要时。</font><font style="vertical-align: inherit;">例如，银行为所有常见操作使用存储过程和函数。</font><font style="vertical-align: inherit;">这提供了一致且安全的环境，并且例程可以确保每个操作都被正确记录。</font><font style="vertical-align: inherit;">在这样的设置中，应用程序和用户将不能直接访问数据库表，但只能执行特定的存储例程。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    存储的例程可以提供改进的性能，因为需要在服务器和客户端之间发送更少的信息。</font><font style="vertical-align: inherit;">折中的原因是这会增加数据库服务器上的负载，因为更多的工作是在服务器端完成的，而在客户端（应用程序）端则更少。</font><font style="vertical-align: inherit;">如果许多客户机（如Web服务器）仅由一个或几个数据库服务器提供服务，请考虑这一点。
  </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    存储的例程还使您能够在数据库服务器中拥有函数库。</font><font style="vertical-align: inherit;">这是现代应用程序语言所共有的一项功能，可在内部启用此类设计（例如，通过使用类）。</font><font style="vertical-align: inherit;">即使在数据库使用范围之外，使用这些客户端应用程序语言功能对程序员也是有益的。
  </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    MySQL遵循用于存储例程的SQL：2003语法，IBM DB2也使用该语法。</font><font style="vertical-align: inherit;">此处描述的所有语法均受支持，并在适当情况下记录了任何限制和扩展。
</font></font></p>
<h3><a name="idm140527981235824"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">其他资源</font></font></h3>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在使用存储过程和函数时，</font><font style="vertical-align: inherit;">
        您可能会发现使用</font></font><a class="ulink" href="http://forums.mysql.com/list.php?98" target="_top"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">存储过程用户论坛</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
      </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        有关MySQL中存储例程的一些常见问题的答案，请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/faqs.html#faqs-stored-procs" title="A.4 MySQL 5.7 FAQ：存储过程和函数"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第A.4节“MySQL 5.7 FAQ：存储过程和函数”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
      </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        使用存储的例程有一些限制。</font><font style="vertical-align: inherit;">参见
         </font></font><a class="xref" href="/mysql-5.7-google-zh/restrictions.html#stored-program-restrictions" title="C.1对存储程序的限制"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第C.1节“对存储程序的限制”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
      </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        存储例程的二进制日志记录按
         </font></font><a class="xref" href="/mysql-5.7-google-zh/stored-programs-views.html#stored-programs-logging" title="23.7存储程序的二进制记录"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第23.7节“存储程序的二进制日志记录”中所述进行</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p></li></ul>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="stored-routines-syntax"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.2.1存储的例程语法</font></font></h3>

</div>

</div>

</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      存储的例程是一个过程或一个函数。</font><font style="vertical-align: inherit;">使用</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#create-procedure" title="13.1.16 CREATE PROCEDURE和CREATE FUNCTION语法"><code class="literal">CREATE
      PROCEDURE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#create-function" title="13.1.13 CREATE FUNCTION语法"><code class="literal">CREATE
      FUNCTION</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句</font><font style="vertical-align: inherit;">创建存储例程</font><font style="vertical-align: inherit;">（请参见
       </font></font><a class="xref" href="/mysql-5.7-google-zh/sql-syntax.html#create-procedure" title="13.1.16 CREATE PROCEDURE和CREATE FUNCTION语法"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第13.1.16节“CREATE PROCEDURE和CREATE FUNCTION语法”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">使用</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#call" title="13.2.1 CALL语法"><code class="literal">CALL</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句</font><font style="vertical-align: inherit;">调用过程</font><font style="vertical-align: inherit;">（请参见
       </font></font><a class="xref" href="/mysql-5.7-google-zh/sql-syntax.html#call" title="13.2.1 CALL语法"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第13.2.1节“CALL语法”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">），并且只能使用输出变量传回值。</font><font style="vertical-align: inherit;">一个函数可以像声明中那样从其他函数中调用（也就是通过调用函数的名字），并且可以返回一个标量值。</font><font style="vertical-align: inherit;">存储例程的主体可以使用复合语句（请参见
       </font></font><a class="xref" href="/mysql-5.7-google-zh/sql-syntax.html#sql-syntax-compound-statements" title="13.6复合语句语法"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第13.6节“复合语句语法”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      存储的例程可以使用</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#drop-procedure" title="13.1.27 DROP程序和DROP FUNCTION语法"><code class="literal">DROP
      PROCEDURE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#drop-function" title="13.1.24 DROP FUNCTION语法"><code class="literal">DROP
      FUNCTION</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句（参见
       </font></font><a class="xref" href="/mysql-5.7-google-zh/sql-syntax.html#drop-procedure" title="13.1.27 DROP程序和DROP FUNCTION语法"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第13.1.27节“DROP PROCEDURE和DROP FUNCTION语法”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）进行</font><a class="xref" href="/mysql-5.7-google-zh/sql-syntax.html#drop-procedure" title="13.1.27 DROP程序和DROP FUNCTION语法"><font style="vertical-align: inherit;">删除</font></a><font style="vertical-align: inherit;">，并使用</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#alter-procedure" title="13.1.6 ALTER PROCEDURE语法"><code class="literal">ALTER PROCEDURE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
       </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#alter-function" title="13.1.3 ALTER FUNCTION语法"><code class="literal">ALTER FUNCTION</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句进行</font><font style="vertical-align: inherit;">更改
       </font><font style="vertical-align: inherit;">（请参见
       </font></font><a class="xref" href="/mysql-5.7-google-zh/sql-syntax.html#alter-procedure" title="13.1.6 ALTER PROCEDURE语法"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第13.1.6节“ALTER PROCEDURE语法”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      存储过程或函数与特定数据库相关联。</font><font style="vertical-align: inherit;">这有几个含义：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          当例程被调用时，隐式</font><font style="vertical-align: inherit;">被执行（并且在例程终止时被撤销）。
          </font><font style="vertical-align: inherit;">存储的例程中的语句不被允许。
        </font></font><code class="literal">USE
          <em class="replaceable"><code>db_name</code></em></code><font style="vertical-align: inherit;"></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#use" title="13.8.4 USE语法"><code class="literal">USE</code></a><font style="vertical-align: inherit;"></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          您可以使用数据库名称限定例程名称。</font><font style="vertical-align: inherit;">这可以用于引用不在当前数据库中的例程。</font><font style="vertical-align: inherit;">例如，要调用</font><font style="vertical-align: inherit;">与</font><font style="vertical-align: inherit;">数据库</font><font style="vertical-align: inherit;">关联</font><font style="vertical-align: inherit;">的存储过程
           </font></font><code class="literal">p</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或函数</font></font><code class="literal">f</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><code class="literal">test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可以说</font></font><code class="literal">CALL test.p()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
           </font></font><code class="literal">test.f()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          当数据库被删除时，所有与其关联的存储例程也会被删除。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      存储的函数不能递归。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      存储过程中的递归是允许的，但默认情况下是禁用的。</font><font style="vertical-align: inherit;">要启用递归，请将
       </font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_max_sp_recursion_depth"><code class="literal">max_sp_recursion_depth</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">服务器系统变量设置为大于零的值。</font><font style="vertical-align: inherit;">存储过程递归增加了对线程堆栈空间的需求。</font><font style="vertical-align: inherit;">如果增加值
       </font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_max_sp_recursion_depth"><code class="literal">max_sp_recursion_depth</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，可能需要通过增加</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_thread_stack"><code class="literal">thread_stack</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">服务器启动时</font><font style="vertical-align: inherit;">的值来增加线程堆栈大小
       </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">有关</font><font style="vertical-align: inherit;">更多信息</font></font><a class="xref" href="/mysql-5.7-google-zh/server-administration.html#server-system-variables" title="5.1.5服务器系统变量"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">请参见</font><a class="xref" href="/mysql-5.7-google-zh/server-administration.html#server-system-variables" title="5.1.5服务器系统变量"><font style="vertical-align: inherit;">第5.1.5节“服务器系统变量”</font></a><font style="vertical-align: inherit;">。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      MySQL支持一个非常有用的扩展，它允许在</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#select" title="13.2.9 SELECT语法"><code class="literal">SELECT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">存储过程中</font><font style="vertical-align: inherit;">使用常规</font><font style="vertical-align: inherit;">语句（即不使用游标或局部变量）。</font><font style="vertical-align: inherit;">这种查询的结果集只是直接发送给客户端。</font><font style="vertical-align: inherit;">多个</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#select" title="13.2.9 SELECT语法"><code class="literal">SELECT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      语句会生成多个结果集，因此客户端必须使用支持多个结果集的MySQL客户端库。</font><font style="vertical-align: inherit;">这意味着客户端必须至少使用4.1版本的MySQL版本的客户端库。</font><font style="vertical-align: inherit;">客户端也应该</font></font><code class="literal">CLIENT_MULTI_RESULTS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在连接时</font><font style="vertical-align: inherit;">指定
       </font><font style="vertical-align: inherit;">选项。</font><font style="vertical-align: inherit;">对于C程序，这可以使用
       </font></font><a class="link" href="/mysql-5.7-google-zh/connectors-apis.html#mysql-real-connect" title="27.8.7.54 mysql_real_connect（）"><code class="literal">mysql_real_connect()</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C API函数完成。</font><font style="vertical-align: inherit;">请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/connectors-apis.html#mysql-real-connect" title="27.8.7.54 mysql_real_connect（）"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第27.8.7.54节“mysql_real_connect（）”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
      </font></font><a class="xref" href="/mysql-5.7-google-zh/connectors-apis.html#c-api-multiple-queries" title="27.8.16 C API多语句执行支持"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第27.8.16节“C API多语句执行支持”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="stored-routines-privileges"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.2.2存储例程和MySQL权限</font></font></h3>

</div>

</div>

</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      MySQL授权系统将存储的例程考虑在内，如下所示：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          将</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_create-routine"><code class="literal">CREATE ROUTINE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">需要的权限来创建存储例程。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          在</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_alter-routine"><code class="literal">ALTER ROUTINE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">需要的权限更改或删除保存的程序。</font><font style="vertical-align: inherit;">如有必要，此特权将自动授予例程的创建者，并在例程被删除时从创建者处下载。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          该</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_execute"><code class="literal">EXECUTE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特权是执行存储例程所必需的。</font><font style="vertical-align: inherit;">但是，如果有必要，此特权会自动授予例程的创建者（并且在例程被删除时从创建者处删除）。</font><font style="vertical-align: inherit;">此外，</font></font><code class="literal">SQL SECURITY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          例程</font><font style="vertical-align: inherit;">的默认</font><font style="vertical-align: inherit;">特征是</font></font><code class="literal">DEFINER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，使有权访问与例程关联的数据库的用户可以执行例程。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          如果
           </font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_automatic_sp_privileges"><code class="literal">automatic_sp_privileges</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          系统变量为0，
           </font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_execute"><code class="literal">EXECUTE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并且
           </font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_alter-routine"><code class="literal">ALTER ROUTINE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">权限不会自动授予，并从日常的创造者下降。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          例程的创建者是用于为其执行</font></font><code class="literal">CREATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句</font><font style="vertical-align: inherit;">的帐户
           </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这可能与</font></font><code class="literal">DEFINER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在例程定义中</font><font style="vertical-align: inherit;">以名称命名的帐户
           </font><font style="vertical-align: inherit;">不同。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      服务器</font></font><code class="literal">mysql.proc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">根据创建，更改或删除存储例程的语句来</font><font style="vertical-align: inherit;">操纵</font><font style="vertical-align: inherit;">表。</font><font style="vertical-align: inherit;">服务器不会注意到手动操作该表。
</font></font></p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="stored-routines-metadata"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.2.3存储的例程元数据</font></font></h3>

</div>

</div>

</div>
<a class="indexterm" name="idm140527981172080"></a><a class="indexterm" name="idm140527981170592"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      关于存储例程的元数据可以通过以下方式获得：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          查询</font><font style="vertical-align: inherit;">数据库</font><font style="vertical-align: inherit;">的</font></font><a class="link" href="/mysql-5.7-google-zh/information-schema.html#routines-table" title="24.20 INFORMATION_SCHEMA ROUTINES表"><code class="literal">ROUTINES</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表
           </font></font><code class="literal">INFORMATION_SCHEMA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/information-schema.html#routines-table" title="24.20 INFORMATION_SCHEMA ROUTINES表"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第24.20节“INFORMATION_SCHEMA ROUTINES表”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          使用</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-create-procedure" title="13.7.5.9 SHOW CREATE PROCEDURE语法"><code class="literal">SHOW CREATE PROCEDURE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          和</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-create-function" title="13.7.5.8 SHOW CREATE FUNCTION语法"><code class="literal">SHOW CREATE FUNCTION</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          语句来查看例程定义。</font><font style="vertical-align: inherit;">请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/sql-syntax.html#show-create-procedure" title="13.7.5.9 SHOW CREATE PROCEDURE语法"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第13.7.5.9节“SHOW CREATE PROCEDURE Syntax”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          使用</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-procedure-status" title="13.7.5.28 SHOW PROCEDURE STATUS语法"><code class="literal">SHOW PROCEDURE STATUS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          和</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-function-status" title="13.7.5.20 SHOW FUNCTION STATUS语法"><code class="literal">SHOW FUNCTION STATUS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          语句查看常规特征。</font><font style="vertical-align: inherit;">请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/sql-syntax.html#show-procedure-status" title="13.7.5.28 SHOW PROCEDURE STATUS语法"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第13.7.5.28节“SHOW PROCEDURE STATUS语法”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p></li></ul>
</div>

</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="stored-routines-last-insert-id"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.2.4存储过程，函数，触发器和LAST_INSERT_ID（）</font></font></h3>

</div>

</div>

</div>
<a class="indexterm" name="idm140527981155472"></a><a class="indexterm" name="idm140527981153984"></a><a class="indexterm" name="idm140527981152496"></a><a class="indexterm" name="idm140527981151008"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      在存储例程（过程或函数）或触发器的主体内，其值与</font></font><a class="link" href="/mysql-5.7-google-zh/functions.html#function_last-insert-id"><code class="literal">LAST_INSERT_ID()</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在这些类型对象的主体之外执行的语句</font><font style="vertical-align: inherit;">的
       </font><font style="vertical-align: inherit;">改变方式相同（参见</font></font><a class="xref" href="/mysql-5.7-google-zh/functions.html#information-functions" title="12.14信息功能"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第12.14节“信息函数”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">存储的例程或触发器对其值的影响
       </font></font><a class="link" href="/mysql-5.7-google-zh/functions.html#function_last-insert-id"><code class="literal">LAST_INSERT_ID()</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可通过以下语句看出，具体取决于例程的类型：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          如果存储过程执行更改值的语句，那么更改后的值</font></font><a class="link" href="/mysql-5.7-google-zh/functions.html#function_last-insert-id"><code class="literal">LAST_INSERT_ID()</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将由过程调用后面的语句看到。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          对于更改值的存储函数和触发器，当函数或触发器结束时会恢复该值，因此以下语句看不到更改的值。
</font></font></p></li></ul>
</div>

</div>

</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h2 class="title" style="clear: both"><a name="triggers"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.3使用触发器</font></font></h2>

</div>

</div>

</div>
<div class="toc">
<dl class="toc"><dt><span class="section"><a href="/mysql-5.7-google-zh/stored-programs-views.html#trigger-syntax"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.3.1触发语法和示例</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/stored-programs-views.html#trigger-metadata"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.3.2触发器元数据</font></font></a></span></dt></dl>
</div>
<a class="indexterm" name="idm140527981140832"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    触发器是一个与表关联的命名数据库对象，当表发生特定事件时会激活该对象。</font><font style="vertical-align: inherit;">触发器的一些用途是执行要插入到表中的值的检查或对更新中涉及的值执行计算。
  </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    触发器定义为在语句插入，更新或删除关联表中的行时激活。</font><font style="vertical-align: inherit;">这些行操作是触发事件。</font><font style="vertical-align: inherit;">例如，可以通过
     </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#insert" title="13.2.5 INSERT语法"><code class="literal">INSERT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#load-data" title="13.2.6 LOAD DATA INFILE语法"><code class="literal">LOAD
    DATA</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句插入行，并为每个插入的行激活插入触发器。</font><font style="vertical-align: inherit;">触发器可以设置为在触发事件之前或之后激活。</font><font style="vertical-align: inherit;">例如，可以在插入表的每一行之前或每更新一行之后激活触发器。
</font></font></p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
重要
</font></font></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      MySQL触发器仅用于SQL语句对表进行的更改。</font><font style="vertical-align: inherit;">这包括对可更新视图基础的基表的更改。</font><font style="vertical-align: inherit;">触发器不会激活对由不向SQL Server发送SQL语句的API所做的表的更改。</font><font style="vertical-align: inherit;">这意味着触发器不会被使用</font></font><a class="link" href="/mysql-5.7-google-zh/mysql-cluster.html" title="第21章MySQL NDB集群7.5和NDB集群7.6"><code class="literal">NDB</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">API </font><font style="vertical-align: inherit;">进行的更新激活</font><font style="vertical-align: inherit;">。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      触发器不会被更改</font></font><code class="literal">INFORMATION_SCHEMA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
       </font></font><code class="literal">performance_schema</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表格</font><font style="vertical-align: inherit;">激活
       </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这些表实际上是视图，触发器不允许在视图上使用。
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    以下各节介绍创建和删除触发器的语法，显示如何使用它们的一些示例，并指出如何获取触发器元数据。
</font></font></p>
<h3><a name="idm140527981130816"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">其他资源</font></font></h3>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用</font></font><a class="ulink" href="http://forums.mysql.com/list.php?100" target="_top"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">触发器时，</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
        您可能会发现使用</font><a class="ulink" href="http://forums.mysql.com/list.php?100" target="_top"><font style="vertical-align: inherit;">触发器用户论坛</font></a><font style="vertical-align: inherit;">。
      </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        有关MySQL中触发器常见问题的答案，请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/faqs.html#faqs-triggers" title="A.5 MySQL 5.7 FAQ：触发器"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第A.5节“MySQL 5.7 FAQ：触发器”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
      </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        触发器的使用有一些限制; </font><font style="vertical-align: inherit;">参见
         </font></font><a class="xref" href="/mysql-5.7-google-zh/restrictions.html#stored-program-restrictions" title="C.1对存储程序的限制"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第C.1节“对存储程序的限制”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
      </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        按照</font></font><a class="xref" href="/mysql-5.7-google-zh/stored-programs-views.html#stored-programs-logging" title="23.7存储程序的二进制记录"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第23.7节“存储程序的二进制日志记录”中</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">所述进行触发器的
         </font><a class="xref" href="/mysql-5.7-google-zh/stored-programs-views.html#stored-programs-logging" title="23.7存储程序的二进制记录"><font style="vertical-align: inherit;">二进制日志记录</font></a><font style="vertical-align: inherit;">。
</font></font></p></li></ul>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="trigger-syntax"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.3.1触发语法和示例</font></font></h3>

</div>

</div>

</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      要创建触发器或删除触发器，请使用</font><a class="xref" href="/mysql-5.7-google-zh/sql-syntax.html#create-trigger" title="13.1.20 CREATE TRIGGER语法"><font style="vertical-align: inherit;">第13.1.20节“CREATE TRIGGER语法”</font></a><font style="vertical-align: inherit;">和
       </font><a class="xref" href="/mysql-5.7-google-zh/sql-syntax.html#drop-trigger" title="13.1.31 DROP TRIGGER语法"><font style="vertical-align: inherit;">第13.1.31节“DROP TRIGGER语法”中</font></a><font style="vertical-align: inherit;">所述</font><font style="vertical-align: inherit;">的
       </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#create-trigger" title="13.1.20 CREATE TRIGGER语法"><code class="literal">CREATE TRIGGER</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or
       </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#drop-trigger" title="13.1.31 DROP TRIGGER语法"><code class="literal">DROP TRIGGER</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句</font><font style="vertical-align: inherit;">。
    </font></font><a class="xref" href="/mysql-5.7-google-zh/sql-syntax.html#create-trigger" title="13.1.20 CREATE TRIGGER语法"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a class="xref" href="/mysql-5.7-google-zh/sql-syntax.html#drop-trigger" title="13.1.31 DROP TRIGGER语法"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      下面是一个简单的例子，它将一个触发器与一个表相关联，以激活</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#insert" title="13.2.5 INSERT语法"><code class="literal">INSERT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">操作。</font><font style="vertical-align: inherit;">触发器充当累加器，将插入到表格的其中一列中的值相加。
    </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL的&gt; </font></font><strong class="userinput"><code>CREATE TABLE account (acct_num INT, amount DECIMAL(10,2));</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
查询OK，0行受影响（0.03秒）</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MySQL的&gt; </font></font><strong class="userinput"><code>CREATE TRIGGER ins_sum BEFORE INSERT ON account</code></strong>
       <strong class="userinput"><code>FOR EACH ROW SET @sum = @sum + NEW.amount;</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
查询OK，0行受影响（0.01秒）</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      该</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#create-trigger" title="13.1.20 CREATE TRIGGER语法"><code class="literal">CREATE TRIGGER</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句创建一个名为</font></font><code class="literal">ins_sum</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">与</font></font><code class="literal">account</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表</font><font style="vertical-align: inherit;">关联</font><font style="vertical-align: inherit;">的触发器</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">它还包括用于指定触发器动作时间，触发事件以及触发器激活时要执行的操作的子句：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          关键字</font></font><code class="literal">BEFORE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指示触发器动作时间。</font><font style="vertical-align: inherit;">在这种情况下，触发器会在每行插入表之前激活。</font><font style="vertical-align: inherit;">这里另一个允许的关键字是</font></font><code class="literal">AFTER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          关键字</font></font><code class="literal">INSERT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表示触发事件; </font><font style="vertical-align: inherit;">即激活触发器的操作类型。</font><font style="vertical-align: inherit;">在该示例中，</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#insert" title="13.2.5 INSERT语法"><code class="literal">INSERT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          操作会导致触发器激活。</font><font style="vertical-align: inherit;">您也可以创建触发器</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#delete" title="13.2.2 DELETE语法"><code class="literal">DELETE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#update" title="13.2.11更新语法"><code class="literal">UPDATE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">操作。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          以下声明</font></font><code class="literal">FOR EACH ROW</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          定义了触发器主体; </font><font style="vertical-align: inherit;">即每次触发器激活时要执行的语句，对于受触发事件影响的每一行都会发生一次。</font><font style="vertical-align: inherit;">在该示例中，触发器主体很简单
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#set-variable" title="13.7.4.1变量赋值的SET语法"><code class="literal">SET</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          ，它将插入到</font></font><code class="literal">amount</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">列中</font><font style="vertical-align: inherit;">的值累加到用户变量中</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">该语句引用该列</font></font><code class="literal">NEW.amount</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">意味着
           </font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font><span class="quote"><font style="vertical-align: inherit;">要插入到新行</font></span></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">中的</font></font><code class="literal">amount</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">列</font><font style="vertical-align: inherit;">的值</font><font style="vertical-align: inherit;">。</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">”</font></font></span>
</p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      要使用触发器，请将累加器变量设置为零，执行</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#insert" title="13.2.5 INSERT语法"><code class="literal">INSERT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句，然后查看该变量后面的值：
    </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql&gt; </font></font><strong class="userinput"><code>SET @sum = 0;</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql&gt; </font></font><strong class="userinput"><code>INSERT INTO account VALUES(137,14.98),(141,1937.50),(97,-100.00);</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql&gt;</font></font><strong class="userinput"><code>SELECT @sum AS 'Total amount inserted';</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ----------------------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">总金额已插入|</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ----------------------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">1852.48 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ----------------------- +</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      在这种情况下，</font><font style="vertical-align: inherit;">语句执行</font></font><code class="literal">@sum</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">后
       </font><font style="vertical-align: inherit;">的值</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#insert" title="13.2.5 INSERT语法"><code class="literal">INSERT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是
       </font></font><code class="literal">14.98 + 1937.50 - 100</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
       </font></font><code class="literal">1852.48</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      要销毁触发器，请使用</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#drop-trigger" title="13.1.31 DROP TRIGGER语法"><code class="literal">DROP
      TRIGGER</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句。</font><font style="vertical-align: inherit;">如果触发器不在默认模式中，您必须指定模式名称：
    </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL的&gt; </font></font><strong class="userinput"><code>DROP TRIGGER test.ins_sum;</code></strong>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      如果删除表格，则表格的任何触发器也会被删除。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      触发器名称存在于模式名称空间中，这意味着所有触发器在模式中都必须具有唯一的名称。</font><font style="vertical-align: inherit;">不同模式中的触发器可以具有相同的名称。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      从MySQL 5.7.2开始，可以为具有相同触发事件和操作时间的给定表定义多个触发器。</font><font style="vertical-align: inherit;">例如，您可以</font></font><code class="literal">BEFORE UPDATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      为表格添加</font><font style="vertical-align: inherit;">两个</font><font style="vertical-align: inherit;">触发器。</font><font style="vertical-align: inherit;">默认情况下，具有相同触发事件和操作时间的触发器按其创建顺序激活。</font><font style="vertical-align: inherit;">要影响触发顺序，请在后面指定一个子句，
       </font></font><code class="literal">FOR EACH ROW</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以指示
       </font></font><code class="literal">FOLLOWS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或</font></font><code class="literal">PRECEDES</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">还有同样具有相同触发事件和操作时间的现有触发的名称。</font><font style="vertical-align: inherit;">随着</font></font><code class="literal">FOLLOWS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，新的触发器在现有的触发器之后激活。</font><font style="vertical-align: inherit;">使用时
       </font></font><code class="literal">PRECEDES</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，新触发器在现有触发器之前激活。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      例如，以下触发器定义</font></font><code class="literal">BEFORE INSERT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为该</font></font><code class="literal">account</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表</font><font style="vertical-align: inherit;">定义了另一个
       </font><font style="vertical-align: inherit;">触发器
       </font><font style="vertical-align: inherit;">：
    </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL的&gt; </font></font><strong class="userinput"><code>CREATE TRIGGER ins_transaction BEFORE INSERT ON account</code></strong>
       <strong class="userinput"><code>FOR EACH ROW PRECEDES ins_sum</code></strong>
       <strong class="userinput"><code>SET</code></strong>
       <strong class="userinput"><code>@deposits = @deposits + IF(NEW.amount&gt;0,NEW.amount,0),</code></strong>
       <strong class="userinput"><code>@withdrawals = @withdrawals + IF(NEW.amount&lt;0,-NEW.amount,0);</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
查询OK，0行受影响（0.01秒）</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      这个触发器</font></font><code class="literal">ins_transaction</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">类似于
       </font></font><code class="literal">ins_sum</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">但分别累积存款和取款。</font><font style="vertical-align: inherit;">它有一个</font></font><code class="literal">PRECEDES</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      条款导致它在之前激活
       </font></font><code class="literal">ins_sum</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">; </font><font style="vertical-align: inherit;">如果没有该子句，它会在之后</font></font><code class="literal">ins_sum</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">创建，因为它是在创建之后
       </font></font><code class="literal">ins_sum</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      在MySQL 5.7.2之前，对于具有相同触发事件和动作时间的给定表，不能有多个触发器。</font><font style="vertical-align: inherit;">例如，你不能有两个</font></font><code class="literal">BEFORE UPDATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      表的触发器。</font><font style="vertical-align: inherit;">要解决这个问题，你可以定义一个触发器，通过之后使用</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#begin-end" title="13.6.1 BEGIN ... END复合语句句法"><code class="literal">BEGIN ... END</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      复合语句构造</font><font style="vertical-align: inherit;">来执行多个语句
       </font></font><code class="literal">FOR EACH
      ROW</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">（本节稍后会出现一个示例。）
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      在触发器正文中，使用</font><font style="vertical-align: inherit;">关键字</font></font><code class="literal">OLD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
       </font></font><code class="literal">NEW</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">关键字可以访问受触发器影响的行中的列。</font></font><code class="literal">OLD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并且
       </font></font><code class="literal">NEW</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是触发器的MySQL扩展; </font><font style="vertical-align: inherit;">他们不区分大小写。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      在</font></font><code class="literal">INSERT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">触发器中，只能
       </font><font style="vertical-align: inherit;">使用; </font><font style="vertical-align: inherit;">没有旧的行。</font><font style="vertical-align: inherit;">在</font><font style="vertical-align: inherit;">触发器中，只能</font><font style="vertical-align: inherit;">
      使用; </font><font style="vertical-align: inherit;">没有新的行。</font><font style="vertical-align: inherit;">在</font><font style="vertical-align: inherit;">
      触发器中，可以使用
       </font><font style="vertical-align: inherit;">它在更新之前
       </font><font style="vertical-align: inherit;">引用行的列，并在更新后引用该行的列。
    </font></font><code class="literal">NEW.<em class="replaceable"><code>col_name</code></em></code><font style="vertical-align: inherit;"></font><code class="literal">DELETE</code><font style="vertical-align: inherit;"></font><code class="literal">OLD.<em class="replaceable"><code>col_name</code></em></code><font style="vertical-align: inherit;"></font><code class="literal">UPDATE</code><font style="vertical-align: inherit;"></font><code class="literal">OLD.<em class="replaceable"><code>col_name</code></em></code><font style="vertical-align: inherit;"></font><code class="literal">NEW.<em class="replaceable"><code>col_name</code></em></code><font style="vertical-align: inherit;"></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      名为with的列</font></font><code class="literal">OLD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是只读的。</font><font style="vertical-align: inherit;">你可以参考它（如果你有</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#select" title="13.2.9 SELECT语法"><code class="literal">SELECT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      特权），但不能修改它。</font></font><code class="literal">NEW</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果您有
       </font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_select"><code class="literal">SELECT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特权，</font><font style="vertical-align: inherit;">您可以参考名为的列</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">在
       </font></font><code class="literal">BEFORE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">触发器中，</font><font style="vertical-align: inherit;">如果您有
       </font><font style="vertical-align: inherit;">特权</font><font style="vertical-align: inherit;">，也可以更改其值</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这意味着您可以使用触发器修改要插入到新行或用于更新行的值。</font><font style="vertical-align: inherit;">（这种</font><font style="vertical-align: inherit;">
      说法对</font><font style="vertical-align: inherit;">触发器</font><font style="vertical-align: inherit;">没有影响，</font><font style="vertical-align: inherit;">因为行更改已经发生。）
    </font></font><code class="literal">SET NEW.<em class="replaceable"><code>col_name</code></em> =
      <em class="replaceable"><code>value</code></em></code><font style="vertical-align: inherit;"></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_update"><code class="literal">UPDATE</code></a><font style="vertical-align: inherit;"></font><code class="literal">SET</code><font style="vertical-align: inherit;"></font><code class="literal">AFTER</code><font style="vertical-align: inherit;"></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      在一个</font></font><code class="literal">BEFORE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">触发器中，</font></font><code class="literal">NEW</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      对于一个值</font></font><code class="literal">AUTO_INCREMENT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">列是0，实际上没有被插入新行时自动生成的序列号。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      通过使用</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#begin-end" title="13.6.1 BEGIN ... END复合语句句法"><code class="literal">BEGIN ...
      END</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">构造，您可以定义执行多个语句的触发器。</font><font style="vertical-align: inherit;">在</font></font><code class="literal">BEGIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">块内，还可以使用存储例程中允许的其他语法，如条件和循环。</font><font style="vertical-align: inherit;">但是，就像存储例程一样，如果使用</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysql" title="4.5.1 mysql  -  MySQL命令行工具"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">程序来定义执行多个语句的触发器，则必须重新定义</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysql" title="4.5.1 mysql  -  MySQL命令行工具"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句分隔符，以便可以</font></font><code class="literal">;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在触发器定义中</font><font style="vertical-align: inherit;">使用</font><font style="vertical-align: inherit;">语句分隔符。</font><font style="vertical-align: inherit;">以下示例说明了这些要点。</font><font style="vertical-align: inherit;">它定义了一个</font></font><code class="literal">UPDATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      触发器检查用于更新每行的新值，并将该值修改为0到100之间的范围。这必须是</font></font><code class="literal">BEFORE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">触发器，因为在用于更新行之前必须检查该值：
    </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql&gt; </font></font><strong class="userinput"><code>delimiter //</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql&gt; </font><font style="vertical-align: inherit;">
mysql&gt;</font></font><strong class="userinput"><code>CREATE TRIGGER upd_check BEFORE UPDATE ON account</code></strong>
       <strong class="userinput"><code>FOR EACH ROW</code></strong>
       <strong class="userinput"><code>BEGIN</code></strong>
           <strong class="userinput"><code>IF NEW.amount &lt; 0 THEN</code></strong>
               <strong class="userinput"><code>SET NEW.amount = 0;</code></strong>
           <strong class="userinput"><code>ELSEIF NEW.amount &gt; 100 THEN</code></strong>
               <strong class="userinput"><code>SET NEW.amount = 100;</code></strong>
           <strong class="userinput"><code>END IF;</code></strong>
       <strong class="userinput"><code>END;//</code></strong><font style="vertical-align: inherit;"></font><strong class="userinput"><code>delimiter ;</code></strong>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      分开定义一个存储过程并使用简单</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#call" title="13.2.1 CALL语法"><code class="literal">CALL</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句</font><font style="vertical-align: inherit;">从触发器中调用它可能更容易
       </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">如果你想从几个触发器中执行相同的代码，这也是有利的。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      激活时触发器执行的语句中可能出现的内容有限制：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          触发器不能使用该</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#call" title="13.2.1 CALL语法"><code class="literal">CALL</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          语句来调用将数据返回给客户端或使用动态SQL的存储过程。</font><font style="vertical-align: inherit;">（允许存储过程通过</font></font><code class="literal">OUT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或</font></font><code class="literal">INOUT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          参数</font><font style="vertical-align: inherit;">将数据返回到触发器
           </font><font style="vertical-align: inherit;">。）
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          触发不能使用语句或明或暗地开始或结束交易，如
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#commit" title="13.3.1 START TRANSACTION，COMMIT和ROLLBACK语法"><code class="literal">START
          TRANSACTION</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#commit" title="13.3.1 START TRANSACTION，COMMIT和ROLLBACK语法"><code class="literal">COMMIT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#commit" title="13.3.1 START TRANSACTION，COMMIT和ROLLBACK语法"><code class="literal">ROLLBACK</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">（</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#commit" title="13.3.1 START TRANSACTION，COMMIT和ROLLBACK语法"><code class="literal">ROLLBACK to
          SAVEPOINT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">由于不会结束交易，因此被允许）。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      另见</font></font><a class="xref" href="/mysql-5.7-google-zh/restrictions.html#stored-program-restrictions" title="C.1对存储程序的限制"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第C.1节“对存储程序的限制”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      MySQL在触发器执行期间处理错误如下：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          如果</font></font><code class="literal">BEFORE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">触发失败，则不执行相应行上的操作。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          甲</font></font><code class="literal">BEFORE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">触发由被激活的
           </font></font><span class="emphasis"><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">尝试</font></font></em></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">插入或修改的行，而不管的尝试是否成功随后。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          一个</font></font><code class="literal">AFTER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">只有当任何触发器执行
           </font></font><code class="literal">BEFORE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">触发器和行操作成功执行。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          在a </font></font><code class="literal">BEFORE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
           </font></font><code class="literal">AFTER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">触发器</font><font style="vertical-align: inherit;">期间发生的错误</font><font style="vertical-align: inherit;">会导致导致触发器调用的整个语句失败。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          对于事务性表，语句失败应导致回滚语句执行的所有更改。</font><font style="vertical-align: inherit;">触发失败会导致语句失败，因此触发失败也会导致回滚。</font><font style="vertical-align: inherit;">对于非事务性表，这种回滚无法完成，因此虽然语句失败，但在错误点之前执行的任何更改仍然有效。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      触发器可以包含按名称对表的直接引用，例如</font></font><code class="literal">testref</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">此示例中所示</font><font style="vertical-align: inherit;">的触发器</font><font style="vertical-align: inherit;">：
    </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CREATE TABLE test1（a1 INT）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CREATE TABLE test2（a2 INT）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CREATE TABLE test3（a3 INT NOT NULL AUTO_INCREMENT PRIMARY KEY）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CREATE TABLE test4（</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  a4 INT NOT NULL AUTO_INCREMENT PRIMARY KEY，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  b4 INT默认值0</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
）;</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
分隔符|</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CREATE TRIGGER testref BEFORE INSERT ON test1</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  对于每一行</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  开始</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    INSERT INTO test2 SET a2 = NEW.a1;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    DELETE FROM test3 WHERE a3 = NEW.a1;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    UPDATE test4 SET b4 = b4 + 1 WHERE a4 = NEW.a1;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  结束;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
|</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
定界符</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
INSERT INTO test3（a3）VALUES</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  （NULL），（NULL），（NULL），（NULL），（NULL），</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  （NULL），（NULL），（NULL），（NULL），（NULL）;</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
INSERT INTO test4（a4）VALUES</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  （0），（0），（0），（0），（0），（0），（0），（0），（0），（0）</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      假设您将以下值插入表中
       </font></font><code class="literal">test1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，如下所示：
    </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL的&gt; </font></font><strong class="userinput"><code>INSERT INTO test1 VALUES </code></strong>
       <strong class="userinput"><code>(1), (3), (1), (7), (1), (8), (4), (4);</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
查询OK，8行受影响（0.01秒）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
记录：8重复：0警告：0</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      因此，这四个表格包含以下数据：
    </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL的&gt; </font></font><strong class="userinput"><code>SELECT * FROM test1;</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------ +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">a1 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------ +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">1 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">3 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">1 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">7 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">1 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">8 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">4 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">4 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------ +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
集合中的8行（0.00秒）</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MySQL的&gt; </font></font><strong class="userinput"><code>SELECT * FROM test2;</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------ +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">a2 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------ +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">1 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">3 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">1 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">7 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">1 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">8 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">4 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">4 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------ +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
集合中的8行（0.00秒）</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MySQL的&gt; </font></font><strong class="userinput"><code>SELECT * FROM test3;</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ---- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">a3 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ---- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">2 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">5 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">6 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">9 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">10 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ---- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5行（0.00秒）</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MySQL的&gt; </font></font><strong class="userinput"><code>SELECT * FROM test4;</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ---- + ------ +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">a4 | </font><font style="vertical-align: inherit;">b4 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ---- + ------ +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">1 | </font><font style="vertical-align: inherit;">3 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">2 | </font><font style="vertical-align: inherit;">0 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">3 | </font><font style="vertical-align: inherit;">1 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">4 | </font><font style="vertical-align: inherit;">2 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">5 | </font><font style="vertical-align: inherit;">0 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">6 | </font><font style="vertical-align: inherit;">0 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">7 | </font><font style="vertical-align: inherit;">1 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">8 | </font><font style="vertical-align: inherit;">1 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">9 | </font><font style="vertical-align: inherit;">0 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">10 | </font><font style="vertical-align: inherit;">0 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ---- + ------ +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
整套10行（0.00秒）</font></font><font></font>
</pre>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="trigger-metadata"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.3.2触发器元数据</font></font></h3>

</div>

</div>

</div>
<a class="indexterm" name="idm140527980987152"></a><a class="indexterm" name="idm140527980985664"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      关于触发器的元数据可以通过以下方式获得：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          查询</font><font style="vertical-align: inherit;">数据库</font><font style="vertical-align: inherit;">的</font></font><a class="link" href="/mysql-5.7-google-zh/information-schema.html#triggers-table" title="24.28 INFORMATION_SCHEMA触发器表"><code class="literal">TRIGGERS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表
           </font></font><code class="literal">INFORMATION_SCHEMA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/information-schema.html#triggers-table" title="24.28 INFORMATION_SCHEMA触发器表"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第24.28节“INFORMATION_SCHEMA触发器表”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          使用</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-create-trigger" title="13.7.5.11 SHOW CREATE TRIGGER语法"><code class="literal">SHOW CREATE TRIGGER</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          声明。</font><font style="vertical-align: inherit;">请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/sql-syntax.html#show-create-trigger" title="13.7.5.11 SHOW CREATE TRIGGER语法"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第13.7.5.11节“SHOW CREATE TRIGGER Syntax”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          使用</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-triggers" title="13.7.5.38 SHOW TRIGGERS语法"><code class="literal">SHOW TRIGGERS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          声明。</font><font style="vertical-align: inherit;">请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/sql-syntax.html#show-triggers" title="13.7.5.38 SHOW TRIGGERS语法"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第13.7.5.38节“SHOW TRIGGERS语法”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p></li></ul>
</div>

</div>

</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h2 class="title" style="clear: both"><a name="event-scheduler"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.4使用事件调度程序</font></font></h2>

</div>

</div>

</div>
<div class="toc">
<dl class="toc"><dt><span class="section"><a href="/mysql-5.7-google-zh/stored-programs-views.html#events-overview"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.4.1事件调度程序概述</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/stored-programs-views.html#events-configuration"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.4.2事件调度程序配置</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/stored-programs-views.html#events-syntax"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.4.3事件语法</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/stored-programs-views.html#events-metadata"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.4.4事件元数据</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/stored-programs-views.html#events-status-info"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.4.5事件调度程序状态</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/stored-programs-views.html#events-privileges"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.4.6事件调度程序和MySQL特权</font></font></a></span></dt></dl>
</div>
<a class="indexterm" name="idm140527980973024"></a><a class="indexterm" name="idm140527980971984"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    在</font></font><span class="firstterm"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL的事件调度</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
    管理事件的调度和执行，也就是说，按照时间表运行的任务。</font><font style="vertical-align: inherit;">以下讨论涵盖了事件调度程序，并分为以下几部分：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
        <a class="xref" href="/mysql-5.7-google-zh/stored-programs-views.html#events-overview" title="23.4.1事件调度程序概述"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第23.4.1节“事件调度程序概述”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">提供了MySQL事件的介绍和概念性概述。
      </font></font></p></li><li class="listitem"><p>
        <a class="xref" href="/mysql-5.7-google-zh/stored-programs-views.html#events-syntax" title="23.4.3事件语法"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第23.4.3节“事件语法”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">讨论了用于创建，更改和删除MySQL事件的SQL语句。
      </font></font></p></li><li class="listitem"><p>
        <a class="xref" href="/mysql-5.7-google-zh/stored-programs-views.html#events-metadata" title="23.4.4事件元数据"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第23.4.4节“事件元数据”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">显示了如何获取有关事件的信息以及MySQL服务器如何存储这些信息。
      </font></font></p></li><li class="listitem"><p>
        <a class="xref" href="/mysql-5.7-google-zh/stored-programs-views.html#events-privileges" title="23.4.6事件调度程序和MySQL特权"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第23.4.6节“事件调度程序和MySQL权限”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">讨论了使用事件所需的权限以及事件在执行时对权限的影响。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    存储的例程需要</font><font style="vertical-align: inherit;">数据库中</font><font style="vertical-align: inherit;">的</font></font><code class="literal">event</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表
     </font></font><code class="literal">mysql</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">该表是在MySQL 5.7安装过程中创建的。</font><font style="vertical-align: inherit;">如果您要从早期版本升级到MySQL 5.7，请务必更新授权表以确保</font></font><code class="literal">event</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    表存在。</font><font style="vertical-align: inherit;">请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/programs.html#mysql-upgrade" title="4.4.7 mysql_upgrade  - 检查并升级MySQL表"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第4.4.7节“ </font></font><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql_upgrade</font></font></strong></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - 检查并升级MySQL表”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p>
<h3><a name="idm140527980958512"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">其他资源</font></font></h3>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在使用预定事件时，</font><font style="vertical-align: inherit;">
        您可能会发现</font></font><a class="ulink" href="http://forums.mysql.com/list.php?119" target="_top"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL Event Scheduler用户论坛</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的使用。
      </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        对事件的使用有一些限制; </font><font style="vertical-align: inherit;">参见
         </font></font><a class="xref" href="/mysql-5.7-google-zh/restrictions.html#stored-program-restrictions" title="C.1对存储程序的限制"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第C.1节“对存储程序的限制”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
      </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        事件的二进制日志记录按
         </font></font><a class="xref" href="/mysql-5.7-google-zh/stored-programs-views.html#stored-programs-logging" title="23.7存储程序的二进制记录"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第23.7节“存储程序的二进制日志记录”中所述进行</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p></li></ul>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="events-overview"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.4.1事件调度程序概述</font></font></h3>

</div>

</div>

</div>
<a class="indexterm" name="idm140527980951648"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      MySQL事件是按照计划运行的任务。</font><font style="vertical-align: inherit;">因此，我们有时将它们称为
       </font></font><span class="emphasis"><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">预定</font></font></em></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">事件。</font><font style="vertical-align: inherit;">创建事件时，您将创建一个指定的数据库对象，其中包含一个或多个SQL语句，以一个或多个定期间隔执行，以特定日期和时间开始和结束。</font><font style="vertical-align: inherit;">从概念上讲，这与Unix </font></font><code class="literal">crontab</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      （也称为</font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cron作业</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）或Windows任务计划程序</font><font style="vertical-align: inherit;">的想法类似</font><font style="vertical-align: inherit;">。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      此类计划任务有时也被称为
       </font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">时间触发器</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，这意味着这些是由时间推移触发的对象。</font><font style="vertical-align: inherit;">虽然这基本上是正确的，但我们倾向于使用术语
       </font></font><span class="emphasis"><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">事件</font></font></em></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以避免与</font></font><a class="xref" href="/mysql-5.7-google-zh/stored-programs-views.html#triggers" title="23.3使用触发器"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第23.3节“使用触发器”中</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">讨论的类型的触发器混淆</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">事件应该更具体地不要与</font><span class="quote"><font style="vertical-align: inherit;">“ </font></span><span class="quote"><span class="quote"><font style="vertical-align: inherit;">临时触发器</font></span></span><span class="quote"><font style="vertical-align: inherit;"> ”</font></span><font style="vertical-align: inherit;">混淆</font></font><span class="quote"><font style="vertical-align: inherit;"></font><span class="quote"><font style="vertical-align: inherit;"></font></span><font style="vertical-align: inherit;"></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">而触发器是一个数据库对象，它的语句是响应给定表上发生的特定类型的事件而执行的，（预定）事件是一个对象，它的语句响应指定时间间隔的执行而被执行。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      尽管SQL标准中没有规定事件调度，但是在其他数据库系统中有先例，您可能会注意到这些实现与MySQL服务器中的实现有些相似之处。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      MySQL事件具有以下主要特性和属性：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          在MySQL中，一个事件由它的名字和它所分配的模式来唯一标识。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          事件根据时间表执行特定的操作。</font><font style="vertical-align: inherit;">此操作由一条SQL语句组成，</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#begin-end" title="13.6.1 BEGIN ... END复合语句句法"><code class="literal">BEGIN ...
          END</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果需要</font><font style="vertical-align: inherit;">，它可以是</font><font style="vertical-align: inherit;">块中</font><font style="vertical-align: inherit;">的复合语句
           </font><font style="vertical-align: inherit;">（请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/sql-syntax.html#sql-syntax-compound-statements" title="13.6复合语句语法"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第13.6节“复合语句语法”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">事件的时间可以是
           </font></font><span class="firstterm"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一次性</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
           </font></font><span class="firstterm"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">反复发作</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">一次性事件只执行一次。</font><font style="vertical-align: inherit;">经常性事件以固定的时间间隔重复其行为，并且可以为循环事件的计划分配特定的开始日期和时间，结束日期和时间，两者或两者都不是。</font><font style="vertical-align: inherit;">（默认情况下，周期性事件的计划在创建后立即开始，并且无限期地继续，直到它被禁用或丢弃。）
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          如果重复事件不在其调度间隔内终止，则结果可能是同时执行的事件的多个实例。</font><font style="vertical-align: inherit;">如果这是不可取的，你应该建立一个机制来防止同时发生的事件。</font><font style="vertical-align: inherit;">例如，您可以使用该
           </font></font><a class="link" href="/mysql-5.7-google-zh/functions.html#function_get-lock"><code class="literal">GET_LOCK()</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数或行或表锁定。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          用户可以使用专门用于这些目的的SQL语句来创建，修改和删除预定事件。</font><font style="vertical-align: inherit;">语法无效的事件创建和修改语句会失败，并显示相应的错误消息。</font></font><span class="emphasis"><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用户可以在事件的操作中包含需要用户实际上没有的权限的语句</font></font></em></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">事件创建或修改语句成功，但事件的操作失败。</font><font style="vertical-align: inherit;">有关详细</font></font><a class="xref" href="/mysql-5.7-google-zh/stored-programs-views.html#events-privileges" title="23.4.6事件调度程序和MySQL特权"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">信息，</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">请参见</font><a class="xref" href="/mysql-5.7-google-zh/stored-programs-views.html#events-privileges" title="23.4.6事件调度程序和MySQL特权"><font style="vertical-align: inherit;">第23.4.6节“事件调度程序和MySQL权限”</font></a><font style="vertical-align: inherit;">。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          事件的许多属性可以使用SQL语句来设置或修改。</font><font style="vertical-align: inherit;">这些属性包括事件的名称，计时，持久性（即，是否在计划到期后保留），状态（启用还是禁用），要执行的操作以及分配的模式。</font><font style="vertical-align: inherit;">请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/sql-syntax.html#alter-event" title="13.1.2 ALTER EVENT语法"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第13.1.2节“ALTER EVENT语法”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          事件的默认定义者是创建事件的用户，除非事件已被更改，在这种情况下，定义者是发出</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#alter-event" title="13.1.2 ALTER EVENT语法"><code class="literal">ALTER EVENT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">影响该事件</font><font style="vertical-align: inherit;">的最后一条</font><font style="vertical-align: inherit;">语句</font><font style="vertical-align: inherit;">的用户
           </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">任何具有</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_event"><code class="literal">EVENT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">定义事件的数据库权限的</font><font style="vertical-align: inherit;">用户都可以修改
           </font><font style="vertical-align: inherit;">事件。</font><font style="vertical-align: inherit;">请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/stored-programs-views.html#events-privileges" title="23.4.6事件调度程序和MySQL特权"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第23.4.6节“事件调度程序和MySQL特权”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          事件的操作语句可能包含存储例程中允许的大多数SQL语句。</font><font style="vertical-align: inherit;">有关限制，请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/restrictions.html#stored-program-restrictions" title="C.1对存储程序的限制"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第C.1节“对存储程序的限制”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p></li></ul>
</div>

</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="events-configuration"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.4.2事件调度程序配置</font></font></h3>

</div>

</div>

</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      事件由特殊</font></font><span class="firstterm"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">事件调度程序线程执行</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ; </font><font style="vertical-align: inherit;">当我们引用事件调度器时，我们实际上是指这个线程。</font><font style="vertical-align: inherit;">在运行时，事件调度程序线程及其当前状态可以被具有</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_process"><code class="literal">PROCESS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">输出权限</font><font style="vertical-align: inherit;">的用户看到</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-processlist" title="13.7.5.29 SHOW PROCESSLIST语法"><code class="literal">SHOW PROCESSLIST</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，如下面的讨论所示。
    </font></font></p><a class="indexterm" name="idm140527980920720"></a><a class="indexterm" name="idm140527980919232"></a><p><a name="events-event-scheduler-option"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      全局</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_event_scheduler"><code class="literal">event_scheduler</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统变量确定事件计划程序是否已启用并在服务器上运行。</font><font style="vertical-align: inherit;">它具有以下3个值中的一个，这些值会影响事件调度，如下所述：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
          <code class="literal">OFF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：事件计划程序已停止。</font><font style="vertical-align: inherit;">事件调度程序线程不会运行，不会显示在输出中</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-processlist" title="13.7.5.29 SHOW PROCESSLIST语法"><code class="literal">SHOW PROCESSLIST</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，也不会执行预定事件。</font></font><code class="literal">OFF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是的默认值
           </font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_event_scheduler"><code class="literal">event_scheduler</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          当事件调度停止（</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_event_scheduler"><code class="literal">event_scheduler</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是
           </font></font><code class="literal">OFF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">），它可以通过设置的值开始</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_event_scheduler"><code class="literal">event_scheduler</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">到
           </font></font><code class="literal">ON</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">（见下一项。）
        </font></font></p></li><li class="listitem"><p>
          <code class="literal">ON</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：事件计划程序已启动; </font><font style="vertical-align: inherit;">事件调度程序线程运行并执行所有预定的事件。
        </font></font></p><a class="indexterm" name="idm140527980904704"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          当事件调度是</font></font><code class="literal">ON</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，事件调度器线程中的输出中列出
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-processlist" title="13.7.5.29 SHOW PROCESSLIST语法"><code class="literal">SHOW PROCESSLIST</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">作为守护进程，并且其状态被表示为如下所示：
        </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL的&gt; </font></font><strong class="userinput"><code>SHOW PROCESSLIST\G</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
*************************** 1. row ******************** *******</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
     Id：1</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   用户：root</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   主机：localhost</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
     db：NULL</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
命令：查询</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   时间：0</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  状态：NULL</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   信息：显示进程列表</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
*************************** 2. row ******************** *******</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
     Id：2</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   用户：event_scheduler</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   主机：localhost</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
     db：NULL</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
命令：守护进程</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   时间：3</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  状态：等待下一次激活</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   信息：NULL</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
设置2行（0.00秒）</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          事件调度可以通过设定的值来停止
           </font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_event_scheduler"><code class="literal">event_scheduler</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">对
           </font></font><code class="literal">OFF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p></li><li class="listitem"><p>
          <code class="literal">DISABLED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：该值使事件调度程序不可操作。</font><font style="vertical-align: inherit;">当事件调度器是
           </font></font><code class="literal">DISABLED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，事件调度程序线程不运行（所以不会出现在输出中
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-processlist" title="13.7.5.29 SHOW PROCESSLIST语法"><code class="literal">SHOW PROCESSLIST</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">另外，Event Scheduler状态不能在运行时更改。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      如果事件计划程序状态尚未设置为
       </font></font><code class="literal">DISABLED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
       </font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_event_scheduler"><code class="literal">event_scheduler</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可以在</font><font style="vertical-align: inherit;">（</font></font><code class="literal">ON</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><code class="literal">OFF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用
       </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#set-variable" title="13.7.4.1变量赋值的SET语法"><code class="literal">SET</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">之间切换</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">也可以使用</font></font><code class="literal">0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的
       </font></font><code class="literal">OFF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，而</font></font><code class="literal">1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">对于
       </font></font><code class="literal">ON</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">设置该变量时。</font><font style="vertical-align: inherit;">因此，可以在</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysql" title="4.5.1 mysql  -  MySQL命令行工具"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
      客户端中</font><font style="vertical-align: inherit;">使用以下4条语句中的任何</font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysql" title="4.5.1 mysql  -  MySQL命令行工具"><span class="command"><strong><font style="vertical-align: inherit;">一条</font></strong></span></a><font style="vertical-align: inherit;">来打开Event Scheduler：
    </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SET GLOBAL event_scheduler = ON;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SET @@ global.event_scheduler = ON;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SET GLOBAL event_scheduler = 1;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SET @@ global.event_scheduler = 1;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      同样，这4个语句中的任何一个都可以用来关闭事件调度器：
    </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SET GLOBAL event_scheduler = OFF;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SET @@ global.event_scheduler = OFF;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SET GLOBAL event_scheduler = 0;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SET @@ global.event_scheduler = 0;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      虽然</font></font><code class="literal">ON</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">与</font></font><code class="literal">OFF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">具有数字等同物，显示该值
       </font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_event_scheduler"><code class="literal">event_scheduler</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通过
       </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#select" title="13.2.9 SELECT语法"><code class="literal">SELECT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-variables" title="13.7.5.39 SHOW VARIABLES语法"><code class="literal">SHOW
      VARIABLES</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">总是之一</font></font><code class="literal">OFF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
       </font></font><code class="literal">ON</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或</font></font><code class="literal">DISABLED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
      </font></font><span class="emphasis"><em><code class="literal">DISABLED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">没有数字等值</font></font></em></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">出于这个原因，</font></font><code class="literal">ON</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并且
       </font></font><code class="literal">OFF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通常是优选的超过
       </font></font><code class="literal">1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><code class="literal">0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">设置此变量时。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      请注意，尝试设置
       </font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_event_scheduler"><code class="literal">event_scheduler</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">而不将其指定为全局变量会导致错误：
    </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql &lt; </font><span class="errortext"><font style="vertical-align: inherit;">错误1229（HY000）：变量'event_scheduler'是一个GLOBAL</font></span></font><strong class="userinput"><code>SET @@event_scheduler = OFF;</code></strong>
<span class="errortext"><font style="vertical-align: inherit;"></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
变量并且应该使用SET GLOBAL进行设置</font></font></span>
</pre>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
重要
</font></font></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        可以将事件计划程序</font></font><code class="literal">DISABLED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">仅</font><font style="vertical-align: inherit;">设置为
         </font><font style="vertical-align: inherit;">在服务器启动时。</font><font style="vertical-align: inherit;">如果
         </font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_event_scheduler"><code class="literal">event_scheduler</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是
         </font></font><code class="literal">ON</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或</font></font><code class="literal">OFF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，则不能</font></font><code class="literal">DISABLED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在运行时</font><font style="vertical-align: inherit;">将其设置为</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">另外，如果事件计划程序设置为</font></font><code class="literal">DISABLED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">启动时，则无法更改</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_event_scheduler"><code class="literal">event_scheduler</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">运行时</font><font style="vertical-align: inherit;">的值
         </font><font style="vertical-align: inherit;">。
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      要禁用事件调度程序，请使用以下两种方法之一：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          作为启动服务器时的命令行选项：
        </font></font></p><pre data-lang="terminal" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">--event调度= DISABLED
</font></font></pre></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          在服务器配置文件（</font></font><code class="filename">my.cnf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或</font></font><code class="filename">my.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows系统中）中，包含服务器将读取的行（例如，在一</font></font><code class="literal">[mysqld]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">节中）：
        </font></font></p><pre data-lang="ini" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">event_scheduler = DISABLED
</font></font></pre></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      要启用事件调度程序，请在不使用</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#option_mysqld_event-scheduler"><code class="option">--event-scheduler=DISABLED</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      命令行选项的</font><font style="vertical-align: inherit;">情况下重新启动服务器
       </font><font style="vertical-align: inherit;">，或者在删除或注释掉</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#option_mysqld_event-scheduler"><code class="option">event-scheduler=DISABLED</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      服务器配置文件中</font><font style="vertical-align: inherit;">包含的行之后</font><font style="vertical-align: inherit;">（如适用）。</font><font style="vertical-align: inherit;">或者，您可以</font><font style="vertical-align: inherit;">在启动服务器时</font><font style="vertical-align: inherit;">使用</font></font><code class="literal">ON</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（或</font></font><code class="literal">1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）或
       </font></font><code class="literal">OFF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（或</font></font><code class="literal">0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）代替
       </font></font><code class="literal">DISABLED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值。
</font></font></p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
注意
</font></font></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        您可以在</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_event_scheduler"><code class="literal">event_scheduler</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">设置
         </font><font style="vertical-align: inherit;">为时发出事件操作语句
         </font></font><code class="literal">DISABLED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">在这种情况下不会产生任何警告或错误（前提是这些声明本身有效）。</font><font style="vertical-align: inherit;">但是，直到此变量设置为</font></font><code class="literal">ON</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（或
         </font></font><code class="literal">1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">，才能执行预定事件</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">完成此操作后，事件调度程序线程将执行调度条件满足的所有事件。
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      使用该</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#option_mysqld_skip-grant-tables"><code class="option">--skip-grant-tables</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">选项</font><font style="vertical-align: inherit;">启动MySQL服务器
       </font><font style="vertical-align: inherit;">会导致
       </font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_event_scheduler"><code class="literal">event_scheduler</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">设置为
       </font></font><code class="literal">DISABLED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，覆盖命令行</font></font><code class="filename">my.cnf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
       </font></font><code class="filename">my.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文件</font><font style="vertical-align: inherit;">中的任何其他值</font><font style="vertical-align: inherit;">（错误＃26807）。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      对于用于创建，更改和删除事件的SQL语句，请参见
       </font></font><a class="xref" href="/mysql-5.7-google-zh/stored-programs-views.html#events-syntax" title="23.4.3事件语法"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第23.4.3节“事件语法”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      MySQL </font></font><a class="link" href="/mysql-5.7-google-zh/information-schema.html#events-table" title="24.7 INFORMATION_SCHEMA事件表"><code class="literal">EVENTS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在</font></font><code class="literal">INFORMATION_SCHEMA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数据库中</font><font style="vertical-align: inherit;">提供一个</font><font style="vertical-align: inherit;">表
       </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">可以查询此表以获取有关在服务器上定义的计划事件的信息。</font><font style="vertical-align: inherit;">有关更多</font></font><a class="xref" href="/mysql-5.7-google-zh/stored-programs-views.html#events-metadata" title="23.4.4事件元数据"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">信息，</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">请参见</font><a class="xref" href="/mysql-5.7-google-zh/stored-programs-views.html#events-metadata" title="23.4.4事件元数据"><font style="vertical-align: inherit;">第23.4.4节“事件元数据”</font></a><font style="vertical-align: inherit;">和</font></font><a class="xref" href="/mysql-5.7-google-zh/information-schema.html#events-table" title="24.7 INFORMATION_SCHEMA事件表"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第24.7节“INFORMATION_SCHEMA事件表”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      有关事件调度​​和MySQL特权系统的信息，请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/stored-programs-views.html#events-privileges" title="23.4.6事件调度程序和MySQL特权"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第23.4.6节“事件调度器和MySQL特权”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="events-syntax"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.4.3事件语法</font></font></h3>

</div>

</div>

</div>
<a class="indexterm" name="idm140527980828640"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      MySQL提供了几个用于处理预定事件的SQL语句：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          使用该</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#create-event" title="13.1.12创建事件语法"><code class="literal">CREATE
          EVENT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句</font><font style="vertical-align: inherit;">定义新事件</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/sql-syntax.html#create-event" title="13.1.12创建事件语法"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第13.1.12节“创建事件语法”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          现有事件的定义可以通过</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#alter-event" title="13.1.2 ALTER EVENT语法"><code class="literal">ALTER EVENT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">声明</font><font style="vertical-align: inherit;">来改变</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/sql-syntax.html#alter-event" title="13.1.2 ALTER EVENT语法"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第13.1.2节“ALTER EVENT语法”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          当预定的事件不再需要或不需要时，可以通过其定义者使用该</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#drop-event" title="13.1.23 DROP EVENT语法"><code class="literal">DROP EVENT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句</font><font style="vertical-align: inherit;">从服务器中删除它
           </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/sql-syntax.html#drop-event" title="13.1.23 DROP EVENT语法"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第13.1.23节“DROP EVENT语法”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">一个事件是否持续到它的时间表结束还取决于它的</font></font><code class="literal">ON
          COMPLETION</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">条款，如果它有一个。</font><font style="vertical-align: inherit;">请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/sql-syntax.html#create-event" title="13.1.12创建事件语法"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第13.1.12节“创建事件语法”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          任何具有</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_event"><code class="literal">EVENT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">事件定义数据库权限的</font><font style="vertical-align: inherit;">用户都可以删除
           </font><font style="vertical-align: inherit;">事件。</font><font style="vertical-align: inherit;">请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/stored-programs-views.html#events-privileges" title="23.4.6事件调度程序和MySQL特权"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第23.4.6节“事件调度程序和MySQL特权”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p></li></ul>
</div>

</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="events-metadata"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.4.4事件元数据</font></font></h3>

</div>

</div>

</div>
<a class="indexterm" name="idm140527980812752"></a><a class="indexterm" name="idm140527980811264"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      有关事件的元数据可以通过以下方式获得：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          查询</font><font style="vertical-align: inherit;">数据库</font><font style="vertical-align: inherit;">的</font></font><code class="literal">event</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表
           </font></font><code class="literal">mysql</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          查询</font><font style="vertical-align: inherit;">数据库</font><font style="vertical-align: inherit;">的</font></font><a class="link" href="/mysql-5.7-google-zh/information-schema.html#events-table" title="24.7 INFORMATION_SCHEMA事件表"><code class="literal">EVENTS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表
           </font></font><code class="literal">INFORMATION_SCHEMA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/information-schema.html#events-table" title="24.7 INFORMATION_SCHEMA事件表"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第24.7节“INFORMATION_SCHEMA事件表”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          使用</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-create-event" title="13.7.5.7 SHOW CREATE EVENT语法"><code class="literal">SHOW CREATE EVENT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          声明。</font><font style="vertical-align: inherit;">请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/sql-syntax.html#show-create-event" title="13.7.5.7 SHOW CREATE EVENT语法"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第13.7.5.7节“SHOW CREATE EVENT Syntax”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          使用</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-events" title="13.7.5.18 SHOW EVENTS语法"><code class="literal">SHOW EVENTS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">声明。</font><font style="vertical-align: inherit;">请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/sql-syntax.html#show-events" title="13.7.5.18 SHOW EVENTS语法"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第13.7.5.18节“SHOW EVENTS语法”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p></li></ul>
</div>
<p>
      <span class="bold"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">事件调度程序时间表示</font></font></strong></span>
    </p><a class="indexterm" name="idm140527980796672"></a><a class="indexterm" name="idm140527980795184"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      MySQL中的每个会话都有一个会话时区（STZ）。</font><font style="vertical-align: inherit;">这是</font><font style="vertical-align: inherit;">会话开始时</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_time_zone"><code class="literal">time_zone</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从服务器全局</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_time_zone"><code class="literal">time_zone</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值</font><font style="vertical-align: inherit;">初始化</font><font style="vertical-align: inherit;">的会话</font><font style="vertical-align: inherit;">值，
       </font><font style="vertical-align: inherit;">但可能在会话期间更改。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">执行语句</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#create-event" title="13.1.12创建事件语法"><code class="literal">CREATE EVENT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
       </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#alter-event" title="13.1.2 ALTER EVENT语法"><code class="literal">ALTER EVENT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">执行语句</font><font style="vertical-align: inherit;">
      时的当前会话时区
       </font><font style="vertical-align: inherit;">用于解释事件定义中指定的时间。</font><font style="vertical-align: inherit;">这成为事件时区（ETZ）; </font><font style="vertical-align: inherit;">即用于事件调度的时区，并在执行时在事件内生效。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      为了</font></font><code class="literal">mysql.event</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表格中</font><font style="vertical-align: inherit;">的事件信息的表示
       </font><font style="vertical-align: inherit;">，该
       </font></font><code class="literal">execute_at</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><code class="literal">starts</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
       </font></font><code class="literal">ends</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">时间被转换为UTC，并与事件时区一起存储。</font><font style="vertical-align: inherit;">这可以使事件执行按照定义继续进行，而不管后续对服务器时区或夏令时效果所做的任何更改。</font><font style="vertical-align: inherit;">该
       </font></font><code class="literal">last_executed</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">时间也存储在UTC。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      如果您选择信息</font></font><code class="literal">mysql.event</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，则刚刚提到的时间将被检索为UTC值。</font><font style="vertical-align: inherit;">这些时间也可以通过从</font></font><a class="link" href="/mysql-5.7-google-zh/information-schema.html#events-table" title="24.7 INFORMATION_SCHEMA事件表"><code class="literal">INFORMATION_SCHEMA.EVENTS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表格中</font><font style="vertical-align: inherit;">选择
       </font><font style="vertical-align: inherit;">或从中获得</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-events" title="13.7.5.18 SHOW EVENTS语法"><code class="literal">SHOW EVENTS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，但它们被报告为ETZ值。</font><font style="vertical-align: inherit;">从这些来源可获得的其他时间表明事件何时创建或最后更改; </font><font style="vertical-align: inherit;">这些显示为STZ值。</font><font style="vertical-align: inherit;">下表总结了事件时间的表示。
</font></font></p>
<div class="informaltable">
<table summary="Summary of event time representation (as UTC, EZT, or STZ values) from mysql.event, INFORMATION_SCHEMA.EVENTS, and SHOW EVENTS."><colgroup><col width="25%"><col width="25%"><col width="25%"><col width="25%"></colgroup><thead><tr>
          <th scope="col"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值</font></font></th>
          <th scope="col"><code class="literal">mysql.event</code></th>
          <th scope="col"><a class="link" href="/mysql-5.7-google-zh/information-schema.html#events-table" title="24.7 INFORMATION_SCHEMA事件表"><code class="literal">INFORMATION_SCHEMA.EVENTS</code></a></th>
          <th scope="col"><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-events" title="13.7.5.18 SHOW EVENTS语法"><code class="literal">SHOW EVENTS</code></a></th>
        </tr></thead><tbody><tr>
          <td scope="row"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">执行于</font></font></td>
          <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">世界标准时间</font></font></td>
          <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ETZ</font></font></td>
          <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ETZ</font></font></td>
        </tr><tr>
          <td scope="row"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">启动</font></font></td>
          <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">世界标准时间</font></font></td>
          <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ETZ</font></font></td>
          <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ETZ</font></font></td>
        </tr><tr>
          <td scope="row"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">完</font></font></td>
          <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">世界标准时间</font></font></td>
          <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ETZ</font></font></td>
          <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ETZ</font></font></td>
        </tr><tr>
          <td scope="row"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">上次执行</font></font></td>
          <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">世界标准时间</font></font></td>
          <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ETZ</font></font></td>
          <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N / A</font></font></td>
        </tr><tr>
          <td scope="row"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">创建</font></font></td>
          <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">STZ</font></font></td>
          <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">STZ</font></font></td>
          <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N / A</font></font></td>
        </tr><tr>
          <td scope="row"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最后修改</font></font></td>
          <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">STZ</font></font></td>
          <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">STZ</font></font></td>
          <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N / A</font></font></td>
</tr></tbody></table>
</div>

</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="events-status-info"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.4.5事件调度程序状态</font></font></h3>

</div>

</div>

</div>
<a class="indexterm" name="idm140527980741520"></a><a class="indexterm" name="idm140527980740016"></a><a class="indexterm" name="idm140527980738944"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      事件调度程序将关于事件执行的信息写入到MySQL服务器的错误日志中，该错误或警告终止。</font><font style="vertical-align: inherit;">有关</font></font><a class="xref" href="/mysql-5.7-google-zh/stored-programs-views.html#events-privileges" title="23.4.6事件调度程序和MySQL特权"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">示例，</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">请参见</font><a class="xref" href="/mysql-5.7-google-zh/stored-programs-views.html#events-privileges" title="23.4.6事件调度程序和MySQL特权"><font style="vertical-align: inherit;">第23.4.6节“事件调度程序和MySQL特权”</font></a><font style="vertical-align: inherit;">。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      要获得有关事件调度​​程序状态的信息以进行调试和故障排除，请运行</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqladmin" title="4.5.2 mysqladmin  - 用于管理MySQL服务器的客户端"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqladmin debug</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/programs.html#mysqladmin" title="4.5.2 mysqladmin  - 用于管理MySQL服务器的客户端"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第4.5.2节“ </font></font><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqladmin</font></font></strong></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - 管理MySQL服务器的客户端”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）; </font><font style="vertical-align: inherit;">运行此命令后，服务器的错误日志包含与事件调度程序相关的输出，类似于此处显示的内容：
    </font></font></p><pre data-lang="none" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">活动状态：</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
LLA =上次锁定在LUA =最后解锁时间</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WOC =等待条件DL =数据锁定</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
事件调度程序状态：</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
状态：初始化</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
线程ID：0</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
LLA：init_scheduler：313</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
LUA：init_scheduler：318</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WOC：NO</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
工人：0</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
执行：0</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
数据锁定：否</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
事件队列状态：</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
元素数量：1</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
数据锁定：否</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
尝试锁定：否</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
LLA：init_queue：148</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
LUA：init_queue：168</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WOC：NO</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
下一次激活：0000-00-00 00:00:00</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      在作为Event Scheduler执行的事件的一部分发生的语句中，诊断消息（不仅是错误，还包括警告）将写入错误日志，并在Windows上写入应用程序事件日志。</font><font style="vertical-align: inherit;">对于频繁执行的事件，可能会导致许多记录的消息。</font><font style="vertical-align: inherit;">例如，对于</font><font style="vertical-align: inherit;">语句，如果查询不返回任何行，则会发生错误代码为1329的警告（</font><font style="vertical-align: inherit;">），并且变量值保持不变。</font><font style="vertical-align: inherit;">如果查询返回多个行，则会发生错误1172（</font><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">对于任何一种情况，都可以通过声明条件处理程序来避免记录警告; </font><font style="vertical-align: inherit;">请参见
       </font><a class="xref" href="/mysql-5.7-google-zh/sql-syntax.html#declare-handler" title="13.6.7.2 DECLARE ... HANDLER语法"><font style="vertical-align: inherit;">第13.6.7.2节“DECLARE ... HANDLER语法”</font></a></font><code class="literal">SELECT ... INTO
      <em class="replaceable"><code>var_list</code></em></code><font style="vertical-align: inherit;"></font><code class="literal">No data</code><font style="vertical-align: inherit;"></font><code class="literal">Result consisted of more than one row</code><font style="vertical-align: inherit;"></font><a class="xref" href="/mysql-5.7-google-zh/sql-syntax.html#declare-handler" title="13.6.7.2 DECLARE ... HANDLER语法"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">对于可能检索多行的语句，另一种策略是使用</font></font><code class="literal">LIMIT
      1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将结果集限制为单行。
</font></font></p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="events-privileges"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.4.6事件调度程序和MySQL特权</font></font></h3>

</div>

</div>

</div>
<a class="indexterm" name="idm140527980725920"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      要启用或禁用预定事件的执行，需要设置全局
       </font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_event_scheduler"><code class="literal">event_scheduler</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统变量的值。</font><font style="vertical-align: inherit;">这需要</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_super"><code class="literal">SUPER</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特权。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      该</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_event"><code class="literal">EVENT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特权管理事件的创建，修改和删除。</font><font style="vertical-align: inherit;">这个特权可以使用</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#grant" title="13.7.1.4 GRANT语法"><code class="literal">GRANT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">例如，此</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#grant" title="13.7.1.4 GRANT语法"><code class="literal">GRANT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句赋予</font><font style="vertical-align: inherit;">用户上
       </font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_event"><code class="literal">EVENT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">命名的模式</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">特权</font><font style="vertical-align: inherit;">：
    </font></font><code class="literal">myschema</code><font style="vertical-align: inherit;"></font><code class="literal">jon@ghidora</code><font style="vertical-align: inherit;"></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GRANT EVENT ON myschema。* to jon @ ghidora;
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      （我们假设这个用户帐户已经存在，并且我们希望它保持不变，否则。）
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      要为同一用户授予</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_event"><code class="literal">EVENT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      所有模式</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">特权，请使用以下语句：
    </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GRANT EVENT ON *。* TO jon @ ghidora;
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      该</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_event"><code class="literal">EVENT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特权具有全局或模式级范围。</font><font style="vertical-align: inherit;">因此，尝试将其授予单个表导致如下所示的错误：
    </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql&gt; </font><span class="errortext"><font style="vertical-align: inherit;">错误1144（42000）：非法的GRANT / REVOKE命令; </font></span><span class="errortext"><font style="vertical-align: inherit;">请</font></span></font><strong class="userinput"><code>GRANT EVENT ON myschema.mytable TO jon@ghidora;</code></strong>
<span class="errortext"><font style="vertical-align: inherit;"></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
请参阅手册以查看可以使用哪些权限</font></font></span>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      理解事件是以其定义者的特权执行是很重要的，并且它不能执行其定义者没有必要特权的任何行为。</font><font style="vertical-align: inherit;">例如，假设</font></font><code class="literal">jon@ghidora</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">有
       </font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_event"><code class="literal">EVENT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特权
       </font></font><code class="literal">myschema</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">假设这个用户拥有</font><font style="vertical-align: inherit;">这个模式</font><font style="vertical-align: inherit;">的
       </font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_select"><code class="literal">SELECT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">权限
       </font></font><code class="literal">myschema</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，但没有其他特权。</font><font style="vertical-align: inherit;">有可能</font></font><code class="literal">jon@ghidora</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">创建一个新的事件，例如这个：
    </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">创建事件e_store_ts</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    按照时间表</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      每10秒</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    做</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      INSERT INTO myschema.mytable VALUES（UNIX_TIMESTAMP（））;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      用户等待一分钟左右，然后执行
       </font></font><code class="literal">SELECT * FROM mytable;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">查询，期望在表中看到几个新行。</font><font style="vertical-align: inherit;">相反，表格是空的。</font><font style="vertical-align: inherit;">由于用户没有</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_insert"><code class="literal">INSERT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      相关表格</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">权限，因此该事件不起作用。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      如果您检查MySQL错误日志（</font></font><code class="filename"><em class="replaceable"><code>hostname</code></em>.err</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">），您可以看到事件正在执行，但它正在尝试执行的操作失败：
    </font></font></p><pre data-lang="none" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2013-09-24T12：41：31.261992Z 25 [错误]事件调度程序：</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[jon @ ghidora] [cookbook.e_store_ts]对用户拒绝的INSERT命令</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
'jon'@'ghidora'表'mytable'</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2013-09-24T12：41：31.262022Z 25 [注] Event Scheduler：</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[jon @ ghidora]。[myschema.e_store_ts]事件执行失败。</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2013-09-24T12：41：41.271796Z 26 [错误]事件调度程序：</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[jon @ ghidora] [cookbook.e_store_ts]对用户拒绝的INSERT命令</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
'jon'@'ghidora'表'mytable'</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2013-09-24T12：41：41.272761Z 26 [注] Event Scheduler：</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[jon @ ghidora]。[myschema.e_store_ts]事件执行失败。</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      由于此用户很可能无法访问错误日志，因此可以通过直接执行来验证事件的操作语句是否有效：
    </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql&gt; </font><span class="errortext"><font style="vertical-align: inherit;">错误1142（42000）：INSERT命令被拒绝给用户</font></span></font><strong class="userinput"><code>INSERT INTO myschema.mytable VALUES (UNIX_TIMESTAMP());</code></strong>
<span class="errortext"><font style="vertical-align: inherit;"></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
'jon'@'ghidora'表'mytable'</font></font></span>
</pre><a class="indexterm" name="idm140527980690928"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      检查
       </font></font><a class="link" href="/mysql-5.7-google-zh/information-schema.html#events-table" title="24.7 INFORMATION_SCHEMA事件表"><code class="literal">INFORMATION_SCHEMA.EVENTS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表显示</font></font><code class="literal">e_store_ts</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">存在并已启用，但其
       </font></font><code class="literal">LAST_EXECUTED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">列是
       </font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：
    </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL的&gt; </font></font><strong class="userinput"><code>SELECT * FROM INFORMATION_SCHEMA.EVENTS</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
     &gt;      </font></font><strong class="userinput"><code>WHERE EVENT_NAME='e_store_ts'</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
     &gt;     </font></font><strong class="userinput"><code>AND EVENT_SCHEMA='myschema'\G</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
*************************** 1. row ******************** *******</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   EVENT_CATALOG：NULL</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    EVENT_SCHEMA：myschema</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      EVENT_NAME：e_store_ts</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
         定义：jon @ ghidora</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      EVENT_BODY：SQL</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
EVENT_DEFINITION：INSERT INTO myschema.mytable VALUES（UNIX_TIMESTAMP（））</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      EVENT_TYPE：RECURRING</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      EXECUTE_AT：NULL</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  INTERVAL_VALUE：5</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  INTERVAL_FIELD：第二</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        SQL_MODE：NULL</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          STARTS：0000-00-00 00:00:00</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            结束：0000-00-00 00:00:00</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          状态：已启用</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   ON_COMPLETION：不保存</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
         CREATED：2006-02-09 22:36:06</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    LAST_ALTERED：2006-02-09 22:36:06</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   LAST_EXECUTED：NULL</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   EVENT_COMMENT：</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一排（0.00秒）</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      要撤消</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_event"><code class="literal">EVENT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">权限，请使用该</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#revoke" title="13.7.1.6 REVOKE语法"><code class="literal">REVOKE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句。</font><font style="vertical-align: inherit;">在此示例中，</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_event"><code class="literal">EVENT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模式</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">特权</font></font><code class="literal">myschema</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从</font></font><code class="literal">jon@ghidora</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用户帐户中</font><font style="vertical-align: inherit;">删除
       </font><font style="vertical-align: inherit;">：
    </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">REVOKE EVENT ON myschema。* FROM jon @ ghidora;
</font></font></pre>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
重要
</font></font></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        撤销</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_event"><code class="literal">EVENT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用户</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">权限不会删除或禁用该用户可能创建的任何事件。
      </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        由于重命名或删除创建该事件的用户，事件不会被迁移或丢失。
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      假设用户</font></font><code class="literal">jon@ghidora</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已被授予</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_event"><code class="literal">EVENT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
       </font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_insert"><code class="literal">INSERT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特权上的
       </font></font><code class="literal">myschema</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">架构。</font><font style="vertical-align: inherit;">该用户然后创建以下事件：
    </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">创建事件e_insert</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    按照时间表</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      每7秒</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    做</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      INSERT INTO myschema.mytable;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      在创建此事件后，</font></font><code class="literal">root</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">撤销</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_event"><code class="literal">EVENT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特权
       </font></font><code class="literal">jon@ghidora</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">但是，
       </font></font><code class="literal">e_insert</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">继续执行，</font></font><code class="literal">mytable</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">每7秒</font><font style="vertical-align: inherit;">插入一个新行</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">如果</font></font><code class="literal">root</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">发布了以下任一陈述，情况也是如此：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
          <code class="literal">DROP USER jon@ghidora;</code>
        </p></li><li class="listitem"><p>
          <code class="literal">RENAME USER jon@ghidora TO
          someotherguy@ghidora;</code>
</p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      您可以通过</font><font style="vertical-align: inherit;">在发布</font><font style="vertical-align: inherit;">或
       </font><font style="vertical-align: inherit;">声明</font><font style="vertical-align: inherit;">之前和之后</font><font style="vertical-align: inherit;">检查</font></font><code class="literal">mysql.event</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表（本节稍后讨论）或
       </font></font><a class="link" href="/mysql-5.7-google-zh/information-schema.html#events-table" title="24.7 INFORMATION_SCHEMA事件表"><code class="literal">INFORMATION_SCHEMA.EVENTS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表（请参见
       </font></font><a class="xref" href="/mysql-5.7-google-zh/information-schema.html#events-table" title="24.7 INFORMATION_SCHEMA事件表"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第24.7节“INFORMATION_SCHEMA EVENTS表”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）
       </font><font style="vertical-align: inherit;">来验证这是否为真
       </font><font style="vertical-align: inherit;">。
    </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#drop-user" title="13.7.1.3 DROP USER语法"><code class="literal">DROP USER</code></a><font style="vertical-align: inherit;"></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#rename-user" title="13.7.1.5 RENAME USER语法"><code class="literal">RENAME USER</code></a><font style="vertical-align: inherit;"></font></p><a class="indexterm" name="idm140527980652752"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      事件定义存储在</font></font><code class="literal">mysql.event</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      表中。</font><font style="vertical-align: inherit;">要删除由另一个用户帐户创建的事件，MySQL
       </font></font><code class="literal">root</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用户（或具有必要权限的其他用户）可以从该表中删除行。</font><font style="vertical-align: inherit;">例如，要删除</font></font><code class="literal">e_insert</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">先前显示</font><font style="vertical-align: inherit;">的事件</font><font style="vertical-align: inherit;">，
       </font></font><code class="literal">root</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可以使用以下语句：
    </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从mysql.event删除</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    WHERE db ='myschema'</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      AND definer ='jon @ ghidora'</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      AND name ='e_insert';</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      从</font></font><code class="literal">mysql.event</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表中</font><font style="vertical-align: inherit;">删除行时，匹配事件名称，数据库模式名称和用户帐户非常重要
       </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这是因为同一个用户可以在不同的模式中创建同名的不同事件。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      用户的</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_event"><code class="literal">EVENT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">权限存储在</font><font style="vertical-align: inherit;">和</font><font style="vertical-align: inherit;">
      表</font><font style="vertical-align: inherit;">的</font></font><code class="literal">Event_priv</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">列中
       </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">在这两种情况下，该列都保存“ </font><font style="vertical-align: inherit;">'或' </font><font style="vertical-align: inherit;">'的</font><font style="vertical-align: inherit;">其中一个值</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">' </font><font style="vertical-align: inherit;">'是默认值。
      </font><font style="vertical-align: inherit;">只有当该用户具有全局</font><font style="vertical-align: inherit;">特权时（也就是说，如果授予了特权</font><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">，</font><font style="vertical-align: inherit;">才能为给定用户</font><font style="vertical-align: inherit;">设置为' </font><font style="vertical-align: inherit;">' </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">对于模式级
       </font><font style="vertical-align: inherit;">特权，
       </font><font style="vertical-align: inherit;">创建一行
       </font><font style="vertical-align: inherit;">并将该行的</font><font style="vertical-align: inherit;">列</font><font style="vertical-align: inherit;">设置
       </font><font style="vertical-align: inherit;">为模式的名称，将
       </font><font style="vertical-align: inherit;">列设置为用户的名称，将
       </font><font style="vertical-align: inherit;">列设置为'</font></font><code class="literal">mysql.user</code><font style="vertical-align: inherit;"></font><code class="literal">mysql.db</code><font style="vertical-align: inherit;"></font><code class="literal">Y</code><font style="vertical-align: inherit;"></font><code class="literal">N</code><font style="vertical-align: inherit;"></font><code class="literal">N</code><font style="vertical-align: inherit;"></font><code class="literal">mysql.user.Event_priv</code><font style="vertical-align: inherit;"></font><code class="literal">Y</code><font style="vertical-align: inherit;"></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_event"><code class="literal">EVENT</code></a><font style="vertical-align: inherit;"></font><code class="literal">GRANT EVENT ON
      *.*</code><font style="vertical-align: inherit;"></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_event"><code class="literal">EVENT</code></a><font style="vertical-align: inherit;"></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#grant" title="13.7.1.4 GRANT语法"><code class="literal">GRANT</code></a><font style="vertical-align: inherit;"></font><code class="literal">mysql.db</code><font style="vertical-align: inherit;"></font><code class="literal">Db</code><font style="vertical-align: inherit;"></font><code class="literal">User</code><font style="vertical-align: inherit;"></font><code class="literal">Event_priv</code><font style="vertical-align: inherit;"></font><code class="literal">Y</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">”。</font><font style="vertical-align: inherit;">应该永远不需要直接操作这些表，因为</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#grant" title="13.7.1.4 GRANT语法"><code class="literal">GRANT
      EVENT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><code class="literal">REVOKE EVENT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句对它们执行所需的操作。
    </font></font></p><a class="indexterm" name="idm140527980628128"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      五个状态变量提供事件相关操作的计数（但</font></font><span class="emphasis"><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不</font></font></em></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">包括事件执行的语句;请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/restrictions.html#stored-program-restrictions" title="C.1对存储程序的限制"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第C.1节“对存储的程序的限制”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">这些是：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
          <code class="literal">Com_create_event</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#create-event" title="13.1.12创建事件语法"><code class="literal">CREATE EVENT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自上次服务器重启后执行</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">语句</font><font style="vertical-align: inherit;">数
           </font><font style="vertical-align: inherit;">。
        </font></font></p></li><li class="listitem"><p>
          <code class="literal">Com_alter_event</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#alter-event" title="13.1.2 ALTER EVENT语法"><code class="literal">ALTER EVENT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自上次服务器重启后执行</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">语句</font><font style="vertical-align: inherit;">数
           </font><font style="vertical-align: inherit;">。
        </font></font></p></li><li class="listitem"><p>
          <code class="literal">Com_drop_event</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#drop-event" title="13.1.23 DROP EVENT语法"><code class="literal">DROP EVENT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自上次服务器重启后执行</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">语句</font><font style="vertical-align: inherit;">数
           </font><font style="vertical-align: inherit;">。
        </font></font></p></li><li class="listitem"><p>
          <code class="literal">Com_show_create_event</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-create-event" title="13.7.5.7 SHOW CREATE EVENT语法"><code class="literal">SHOW CREATE EVENT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自上次服务器重启后执行</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">语句</font><font style="vertical-align: inherit;">数
           </font><font style="vertical-align: inherit;">。
        </font></font></p></li><li class="listitem"><p>
          <code class="literal">Com_show_events</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-events" title="13.7.5.18 SHOW EVENTS语法"><code class="literal">SHOW EVENTS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自上次服务器重启后执行</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">语句</font><font style="vertical-align: inherit;">数
           </font><font style="vertical-align: inherit;">。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      您可以通过运行语句一次查看所有这些值的当前值</font></font><code class="literal">SHOW STATUS LIKE
      '%event%';</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p>
</div>

</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h2 class="title" style="clear: both"><a name="views"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.5使用视图</font></font></h2>

</div>

</div>

</div>
<div class="toc">
<dl class="toc"><dt><span class="section"><a href="/mysql-5.7-google-zh/stored-programs-views.html#view-syntax"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.5.1查看语法</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/stored-programs-views.html#view-algorithms"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.5.2视图处理算法</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/stored-programs-views.html#view-updatability"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.5.3可更新和可插入的视图</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/stored-programs-views.html#view-check-option"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.5.4查看WITH CHECK OPTION子句</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/stored-programs-views.html#view-metadata"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.5.5查看元数据</font></font></a></span></dt></dl>
</div>
<a class="indexterm" name="idm140527980608064"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    MySQL支持视图，包括可更新视图。</font><font style="vertical-align: inherit;">视图是存储的查询，当调用时产生结果集。</font><font style="vertical-align: inherit;">视图充当虚拟表格。
  </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    以下讨论描述了创建和删除视图的语法，并展示了如何使用它们的一些示例。
</font></font></p>
<h3><a name="idm140527980605904"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">其他资源</font></font></h3>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        处理</font></font><a class="ulink" href="http://forums.mysql.com/list.php?100" target="_top"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">视图时，</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">您可以找到使用的</font><a class="ulink" href="http://forums.mysql.com/list.php?100" target="_top"><font style="vertical-align: inherit;">视图用户论坛</font></a><font style="vertical-align: inherit;">。
      </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        有关MySQL中视图的一些常见问题的答案，请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/faqs.html#faqs-views" title="A.6 MySQL 5.7 FAQ：视图"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第A.6节“MySQL 5.7 FAQ：视图”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
      </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        对视图的使用有一些限制; </font><font style="vertical-align: inherit;">参见
         </font></font><a class="xref" href="/mysql-5.7-google-zh/restrictions.html#view-restrictions" title="C.5对视图的限制"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第C.5节“视图限制”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p></li></ul>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="view-syntax"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.5.1查看语法</font></font></h3>

</div>

</div>

</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      该</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#create-view" title="13.1.21 CREATE VIEW语法"><code class="literal">CREATE VIEW</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句创建一个新视图（请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/sql-syntax.html#create-view" title="13.1.21 CREATE VIEW语法"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第13.1.21节“CREATE VIEW语法”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">要改变视图的定义或删除视图，请使用
       </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#alter-view" title="13.1.10 ALTER VIEW语法"><code class="literal">ALTER VIEW</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（请参见
       </font></font><a class="xref" href="/mysql-5.7-google-zh/sql-syntax.html#alter-view" title="13.1.10 ALTER VIEW语法"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第13.1.10节“ALTER VIEW语法”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）或</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#drop-view" title="13.1.32 DROP VIEW语法"><code class="literal">DROP
      VIEW</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/sql-syntax.html#drop-view" title="13.1.32 DROP VIEW语法"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第13.1.32节“DROP VIEW语法”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      视图可以从多种</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#select" title="13.2.9 SELECT语法"><code class="literal">SELECT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句中</font><font style="vertical-align: inherit;">创建
       </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">它可以引用基表或其他视图。</font><font style="vertical-align: inherit;">它可以使用连接
       </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#union" title="13.2.9.3 UNION语法"><code class="literal">UNION</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，和子查询。</font><font style="vertical-align: inherit;">该
       </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#select" title="13.2.9 SELECT语法"><code class="literal">SELECT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">甚至不需要引用任何表。</font><font style="vertical-align: inherit;">以下示例定义了一个从另一个表中选择两列的视图，以及从这些列计算出的表达式：
    </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql&gt; </font></font><strong class="userinput"><code>CREATE TABLE t (qty INT, price INT);</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql&gt; </font></font><strong class="userinput"><code>INSERT INTO t VALUES(3, 50), (5, 60);</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql&gt; </font></font><strong class="userinput"><code>CREATE VIEW v AS SELECT qty, price, qty*price AS value FROM t;</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql&gt;</font></font><strong class="userinput"><code>SELECT * FROM v;</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------ + ------- ------- + +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">qty | </font><font style="vertical-align: inherit;">价格| </font><font style="vertical-align: inherit;">值|</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------ + ------- ------- + +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">3 | </font><font style="vertical-align: inherit;">50 | </font><font style="vertical-align: inherit;">150 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">5 | </font><font style="vertical-align: inherit;">60 | </font><font style="vertical-align: inherit;">300 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------ + ------- ------- + +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MySQL的&gt; </font></font><strong class="userinput"><code>SELECT * FROM v WHERE qty = 5;</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------ + ------- ------- + +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">qty | </font><font style="vertical-align: inherit;">价格| </font><font style="vertical-align: inherit;">值|</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------ + ------- ------- + +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">5 | </font><font style="vertical-align: inherit;">60 | </font><font style="vertical-align: inherit;">300 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------ + ------- ------- + +</font></font><font></font>
</pre>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="view-algorithms"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.5.2视图处理算法</font></font></h3>

</div>

</div>

</div>
<a class="indexterm" name="idm140527980581984"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or
       </font><font style="vertical-align: inherit;">
      的可选</font></font><code class="literal">ALGORITHM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">子句
       </font><font style="vertical-align: inherit;">是对标准SQL的MySQL扩展。</font><font style="vertical-align: inherit;">它影响MySQL处理视图的方式。
      </font><font style="vertical-align: inherit;">三个值：
       </font><font style="vertical-align: inherit;">，</font><font style="vertical-align: inherit;">或
       </font><font style="vertical-align: inherit;">。
</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#create-view" title="13.1.21 CREATE VIEW语法"><code class="literal">CREATE VIEW</code></a><font style="vertical-align: inherit;"></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#alter-view" title="13.1.10 ALTER VIEW语法"><code class="literal">ALTER VIEW</code></a><font style="vertical-align: inherit;"></font><code class="literal">ALGORITHM</code><font style="vertical-align: inherit;"></font><code class="literal">MERGE</code><font style="vertical-align: inherit;"></font><code class="literal">TEMPTABLE</code><font style="vertical-align: inherit;"></font><code class="literal">UNDEFINED</code><font style="vertical-align: inherit;"></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          因为</font></font><code class="literal">MERGE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，引用视图和视图定义的语句的文本被合并，使得视图定义的各部分替换语句的相应部分。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          因为</font></font><code class="literal">TEMPTABLE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，视图的结果被检索到一个临时表，然后用它来执行语句。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          因为</font></font><code class="literal">UNDEFINED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，MySQL选择使用哪种算法。</font><font style="vertical-align: inherit;">它喜欢</font></font><code class="literal">MERGE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在
           </font></font><code class="literal">TEMPTABLE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果可能的话，因为
           </font></font><code class="literal">MERGE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通常是更高效的并且因为如果使用临时表的视图不能更新。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          如果不存在</font></font><code class="literal">ALGORITHM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">子句，
           </font></font><code class="literal">UNDEFINED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">则是MySQL 5.7.6之前的默认算法。</font><font style="vertical-align: inherit;">从5.7.6开始，默认算法由</font><font style="vertical-align: inherit;">系统变量</font><font style="vertical-align: inherit;">的</font></font><code class="literal">derived_merge</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">标志</font><font style="vertical-align: inherit;">值决定</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_optimizer_switch"><code class="literal">optimizer_switch</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">有关其他讨论，请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/optimization.html#derived-table-optimization" title="8.2.2.3优化派生表和视图引用"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第8.2.2.3节“优化派生表和视图引用”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"></font><code class="literal">TEMPTABLE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">明确</font><font style="vertical-align: inherit;">
      指定的原因</font><font style="vertical-align: inherit;">是可以在创建临时表之后以及在用于完成处理语句之前，在基础表上释放锁。</font><font style="vertical-align: inherit;">这可能会导致比</font></font><code class="literal">MERGE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">算法</font><font style="vertical-align: inherit;">更快的锁定释放，</font><font style="vertical-align: inherit;">以便其他使用该视图的客户端不会长时间阻塞。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      视图算法可能有</font></font><code class="literal">UNDEFINED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">三个原因：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">声明中</font><font style="vertical-align: inherit;">
          没有任何</font></font><code class="literal">ALGORITHM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">条款
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#create-view" title="13.1.21 CREATE VIEW语法"><code class="literal">CREATE VIEW</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          该</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#create-view" title="13.1.21 CREATE VIEW语法"><code class="literal">CREATE VIEW</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">声明有明确的</font></font><code class="literal">ALGORITHM = UNDEFINED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">条款。
        </font></font></p></li><li class="listitem"><p>
          <code class="literal">ALGORITHM = MERGE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是为只能用临时表进行处理的视图指定的。</font><font style="vertical-align: inherit;">在这种情况下，MySQL会生成警告并将算法设置为
           </font></font><code class="literal">UNDEFINED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      如前所述，</font></font><code class="literal">MERGE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通过将视图定义的相应部分合并到引用视图的语句中进行处理。</font><font style="vertical-align: inherit;">以下示例简要说明</font></font><code class="literal">MERGE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">算法的工作原理。</font><font style="vertical-align: inherit;">这些例子假定有一个观点</font></font><code class="literal">v_merge</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      具有这个定义：
    </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CREATE ALGORITHM = MERGE VIEW v_merge（vc1，vc2）AS</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SELECT c1，c2 FROM t WHERE c3&gt; 100;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      例1：假设我们发布这个语句：
    </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SELECT * FROM v_merge;
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      MySQL如下处理语句：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
          <code class="literal">v_merge</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 变 </font></font><code class="literal">t</code>
        </p></li><li class="listitem"><p>
          <code class="literal">*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">变成</font></font><code class="literal">vc1, vc2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，对应于</font></font><code class="literal">c1, c2</code>
        </p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          视图</font></font><code class="literal">WHERE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">子句被添加
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      由此产生的语句将被执行：
    </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SELECT c1，c2 FROM t WHERE c3&gt; 100;
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      例2：假设我们发出这样的声明：
    </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SELECT * FROM v_merge WHERE vc1 &lt;100;
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      这种说法也同样处理前一个，只是</font></font><code class="literal">vc1 &lt; 100</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">变得</font></font><code class="literal">c1 &lt;
      100</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和视图</font></font><code class="literal">WHERE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">子句添加到语句</font></font><code class="literal">WHERE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用条款
       </font></font><a class="link" href="/mysql-5.7-google-zh/functions.html#operator_and"><code class="literal">AND</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结缔组织（并添加括号以确保条款的部分用正确的优先顺序执行）。</font><font style="vertical-align: inherit;">由此产生的语句将被执行：
    </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SELECT c1，c2 FROM t WHERE（c3&gt; 100）AND（c1 &lt;100）;
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      实际上，要执行的声明有一个</font></font><code class="literal">WHERE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这种形式</font><font style="vertical-align: inherit;">的
       </font><font style="vertical-align: inherit;">条款：
    </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WHERE（选择WHERE）AND（查看WHERE）
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      如果</font></font><code class="literal">MERGE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">算法不能使用，则必须使用临时表。</font><font style="vertical-align: inherit;">阻止合并的构造与防止派生表中合并的构造相同。</font><font style="vertical-align: inherit;">示例是</font></font><code class="literal">SELECT DISTINCT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
       </font></font><code class="literal">LIMIT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在子查询中。</font><font style="vertical-align: inherit;">有关详细信息，请参见
       </font></font><a class="xref" href="/mysql-5.7-google-zh/optimization.html#derived-table-optimization" title="8.2.2.3优化派生表和视图引用"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第8.2.2.3节“优化派生表和视图引用”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="view-updatability"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.5.3可更新和可插入的视图</font></font></h3>

</div>

</div>

</div>
<a class="indexterm" name="idm140527980521504"></a><a class="indexterm" name="idm140527980520464"></a><a class="indexterm" name="idm140527980518976"></a><a class="indexterm" name="idm140527980517488"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      一些视图是可更新的，并且可以使用对它们的引用来指定要在数据更改语句中更新的表。</font><font style="vertical-align: inherit;">也就是说，你可以在语句，如使用它们
       </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#update" title="13.2.11更新语法"><code class="literal">UPDATE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
       </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#delete" title="13.2.2 DELETE语法"><code class="literal">DELETE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
       </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#insert" title="13.2.5 INSERT语法"><code class="literal">INSERT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">更新基础表的内容。</font><font style="vertical-align: inherit;">派生表也可以在多表</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#update" title="13.2.11更新语法"><code class="literal">UPDATE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
       </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#delete" title="13.2.2 DELETE语法"><code class="literal">DELETE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句中</font><font style="vertical-align: inherit;">指定</font><font style="vertical-align: inherit;">，但只能用于读取数据以指定要更新或删除的行。</font><font style="vertical-align: inherit;">一般来说，视图引用必须是可更新的，这意味着它们可以合并而不实现。</font><font style="vertical-align: inherit;">复合视图具有更复杂的规则。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      要使视图可更新，视图中的行与基础表中的行之间必须存在一对一的关系。</font><font style="vertical-align: inherit;">还有一些其他构造使视图不可更新。</font><font style="vertical-align: inherit;">更具体地说，如果一个视图包含下列任何一个视图，则该视图不可更新：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          聚合函数（</font></font><a class="link" href="/mysql-5.7-google-zh/functions.html#function_sum"><code class="literal">SUM()</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
           </font></font><a class="link" href="/mysql-5.7-google-zh/functions.html#function_min"><code class="literal">MIN()</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
           </font></font><a class="link" href="/mysql-5.7-google-zh/functions.html#function_max"><code class="literal">MAX()</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
           </font></font><a class="link" href="/mysql-5.7-google-zh/functions.html#function_count"><code class="literal">COUNT()</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，等等）
        </font></font></p></li><li class="listitem"><p>
          <code class="literal">DISTINCT</code>
        </p></li><li class="listitem"><p>
          <code class="literal">GROUP BY</code>
        </p></li><li class="listitem"><p>
          <code class="literal">HAVING</code>
        </p></li><li class="listitem"><p>
          <a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#union" title="13.2.9.3 UNION语法"><code class="literal">UNION</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 要么
          </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#union" title="13.2.9.3 UNION语法"><code class="literal">UNION ALL</code></a>
        </p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          子查询在选择列表中
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          在MySQL 5.7.11之前，选择列表中的子查询失败
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#insert" title="13.2.5 INSERT语法"><code class="literal">INSERT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，但可以使用
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#update" title="13.2.11更新语法"><code class="literal">UPDATE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#delete" title="13.2.2 DELETE语法"><code class="literal">DELETE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">从MySQL 5.7.11开始，非依赖子查询仍然如此。</font><font style="vertical-align: inherit;">对于选择列表中的从属子查询，不允许使用数据更改语句。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          某些连接（请参阅本节后面的其他连接讨论）
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          在</font></font><code class="literal">FROM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          子句中
         </font><font style="vertical-align: inherit;">引用nonupdatable视图</font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          子查询的</font></font><code class="literal">WHERE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">子句是指表在</font></font><code class="literal">FROM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">条款
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          仅指字面值（在这种情况下，不存在更新的基础表）
        </font></font></p></li><li class="listitem"><p>
          <code class="literal">ALGORITHM = TEMPTABLE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> （使用临时表总是使视图不可更新）
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          对基表的任何列的多次引用（失败
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#insert" title="13.2.5 INSERT语法"><code class="literal">INSERT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，可以
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#update" title="13.2.11更新语法"><code class="literal">UPDATE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#delete" title="13.2.2 DELETE语法"><code class="literal">DELETE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）
</font></font></p></li></ul>
</div>
<a class="indexterm" name="idm140527980477520"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      视图中生成的列被认为是可更新的，因为可以将其分配给它。</font><font style="vertical-align: inherit;">但是，如果这样的列被明确更新，则唯一允许的值是
       </font></font><code class="literal">DEFAULT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">有关生成列的信息，请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/sql-syntax.html#create-table-generated-columns" title="13.1.18.8创建表和生成的列"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第13.1.18.8节“CREATE TABLE和Generated Columns”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      假设可以使用</font></font><code class="literal">MERGE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">算法</font><font style="vertical-align: inherit;">处理多表视图，则有时可以更新多表视图
       </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">为此，视图必须使用内部联接（不是外部联接或a
       </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#union" title="13.2.9.3 UNION语法"><code class="literal">UNION</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">此外，只能更新视图定义中的单个表，因此
       </font></font><code class="literal">SET</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">子句必须仅命名视图中其中一个表的列。</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#union" title="13.2.9.3 UNION语法"><code class="literal">UNION ALL</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">即使它们可能在理论上可更新</font><font style="vertical-align: inherit;">，</font><font style="vertical-align: inherit;">也不允许</font><font style="vertical-align: inherit;">使用</font><font style="vertical-align: inherit;">这些</font><font style="vertical-align: inherit;">视图
       </font><font style="vertical-align: inherit;">。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      关于可插入性（可用</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#insert" title="13.2.5 INSERT语法"><code class="literal">INSERT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句</font><font style="vertical-align: inherit;">更新
       </font><font style="vertical-align: inherit;">），如果可更新视图也满足视图列的这些附加要求，则可插入：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          不得有重复的视图列名称。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          该视图必须包含基表中没有默认值的所有列。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          视图列必须是简单的列引用。</font><font style="vertical-align: inherit;">它们不能是表达式，例如：
        </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.14159</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
col1 + 3</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
UPPER（COL2）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
col3 / col4</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
（</font></font><em class="replaceable"><code>subquery</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）
</font></font></pre></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      MySQL在</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#create-view" title="13.1.21 CREATE VIEW语法"><code class="literal">CREATE VIEW</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">时间</font><font style="vertical-align: inherit;">设置一个标志，称为视图可更新性标志
       </font><font style="vertical-align: inherit;">。</font></font><code class="literal">YES</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#update" title="13.2.11更新语法"><code class="literal">UPDATE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
       </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#delete" title="13.2.2 DELETE语法"><code class="literal">DELETE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（和类似的操作）对视图合法，</font><font style="vertical-align: inherit;">标志被设置为</font><font style="vertical-align: inherit;">（true）
       </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">否则，标志被设置为
       </font></font><code class="literal">NO</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（false）。</font><font style="vertical-align: inherit;">表中</font><font style="vertical-align: inherit;">的</font></font><code class="literal">IS_UPDATABLE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      列
       </font></font><a class="link" href="/mysql-5.7-google-zh/information-schema.html#views-table" title="24.30 INFORMATION_SCHEMA视图表"><code class="literal">INFORMATION_SCHEMA.VIEWS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">显示该标志的状态。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      如果视图是不可更新的，这样的语句
       </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#update" title="13.2.11更新语法"><code class="literal">UPDATE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
       </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#delete" title="13.2.2 DELETE语法"><code class="literal">DELETE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以及
       </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#insert" title="13.2.5 INSERT语法"><code class="literal">INSERT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是非法的，将被拒绝。</font><font style="vertical-align: inherit;">（请注意，即使视图是可更新的，也可能无法插入，如本节其他部分所述。）
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      所述</font></font><code class="literal">IS_UPDATABLE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果视图依赖于一个或多个其他的观点，以及这些基本视图中的一个被更新的标志可以是不可靠的。</font><font style="vertical-align: inherit;">无论该</font></font><code class="literal">IS_UPDATABLE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值</font><font style="vertical-align: inherit;">如何
       </font><font style="vertical-align: inherit;">，服务器都会跟踪视图的可更新性，并正确拒绝将数据更改操作拒绝到不可更新的视图。</font><font style="vertical-align: inherit;">如果</font></font><code class="literal">IS_UPDATABLE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">视图</font><font style="vertical-align: inherit;">的
       </font><font style="vertical-align: inherit;">值由于对基础视图的更改而变得不准确，则可以通过删除并重新创建视图来更新该值。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      视图的可更新性可能受</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_updatable_views_with_limit"><code class="literal">updatable_views_with_limit</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统变量</font><font style="vertical-align: inherit;">值的影响
       </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/server-administration.html#server-system-variables" title="5.1.5服务器系统变量"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第5.1.5节“服务器系统变量”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      对于下面的讨论，假设这些表和视图存在：
    </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CREATE TABLE t1（x INTEGER）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CREATE TABLE t2（c INTEGER）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CREATE VIEW vmat AS SELECT SUM（x）AS s FROM t1;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CREATE VIEW vup AS SELECT * FROM t2;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CREATE VIEW vjoin AS SELECT * FROM vmat JOIN vup ON vmat.s = vup.c;</font></font><font></font>
</pre><p>
      <a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#insert" title="13.2.5 INSERT语法"><code class="literal">INSERT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
       </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#update" title="13.2.11更新语法"><code class="literal">UPDATE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并且
       </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#delete" title="13.2.2 DELETE语法"><code class="literal">DELETE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">允许声明如下：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
          <a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#insert" title="13.2.5 INSERT语法"><code class="literal">INSERT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#insert" title="13.2.5 INSERT语法"><code class="literal">INSERT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句</font><font style="vertical-align: inherit;">的插入表
           </font><font style="vertical-align: inherit;">可能是合并的视图引用。</font><font style="vertical-align: inherit;">如果视图是连接视图，则视图的所有组件都必须是可更新的（未实现）。</font><font style="vertical-align: inherit;">对于多表可更新视图，</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#insert" title="13.2.5 INSERT语法"><code class="literal">INSERT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果它插入到单个表中</font><font style="vertical-align: inherit;">，则
           </font><font style="vertical-align: inherit;">可以工作。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          此语句无效，因为连接视图的一个组件是不可更新的：
        </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">INSERT INTO vjoin（c）VALUES（1）;
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          此声明有效; </font><font style="vertical-align: inherit;">该视图不包含物化组件：
        </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">INSERT INTO vup（c）VALUES（1）;
</font></font></pre></li><li class="listitem"><p>
          <a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#update" title="13.2.11更新语法"><code class="literal">UPDATE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：要在</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#update" title="13.2.11更新语法"><code class="literal">UPDATE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          语句中</font><font style="vertical-align: inherit;">更新的</font><font style="vertical-align: inherit;">表或许是合并的视图引用。</font><font style="vertical-align: inherit;">如果一个视图是一个连接视图，则该视图的至少一个组件必须是可更新的（这与之不同
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#insert" title="13.2.5 INSERT语法"><code class="literal">INSERT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          在多表</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#update" title="13.2.11更新语法"><code class="literal">UPDATE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          语句中，语句的更新表引用必须是基表或可更新视图引用。</font><font style="vertical-align: inherit;">非过时表引用可能是实体化视图或派生表。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          此声明有效; </font><font style="vertical-align: inherit;">列</font></font><code class="literal">c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">来自连接视图的可更新部分：
        </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UPDATE vjoin SET c = c + 1;
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          此声明无效; </font><font style="vertical-align: inherit;">列</font></font><code class="literal">x</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">来自不可更新的部分：
        </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UPDATE vjoin SET x = x + 1;
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          此声明有效; </font><font style="vertical-align: inherit;">更新的多表的表引用</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#update" title="13.2.11更新语法"><code class="literal">UPDATE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是可更新的视图（</font></font><code class="literal">vup</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）：
        </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UPDATE vup JOIN（SELECT SUM（x）AS s FROM t1）AS dt ON ...</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SET c = c + 1;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          此声明无效; </font><font style="vertical-align: inherit;">它会尝试更新一个物化派生表：
        </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UPDATE vup JOIN（SELECT SUM（x）AS s FROM t1）AS dt ON ...</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SET s = s + 1;</font></font><font></font>
</pre></li><li class="listitem"><p>
          <a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#delete" title="13.2.2 DELETE语法"><code class="literal">DELETE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：要从</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#delete" title="13.2.2 DELETE语法"><code class="literal">DELETE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          语句中</font><font style="vertical-align: inherit;">删除的表格</font><font style="vertical-align: inherit;">必须是合并视图。</font><font style="vertical-align: inherit;">不允许加入视图（这不同于</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#insert" title="13.2.5 INSERT语法"><code class="literal">INSERT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#update" title="13.2.11更新语法"><code class="literal">UPDATE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          此声明无效，因为视图是联接视图：
        </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DELETE vjoin WHERE ...;
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          此语句有效，因为该视图是合并（可更新）视图：
        </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DELETE vup WHERE ...;
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          此语句有效，因为它从合并（可更新）视图中删除：
        </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DELETE vup FROM vup JOIN（SELECT SUM（x）AS s FROM t1）AS dt ON ...;
</font></font></pre></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      其他的讨论和例子如下。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      本节前面的讨论指出，如果不是所有列都是简单的列引用（例如，如果它包含表达式或复合表达式的列），则视图不可插入。</font><font style="vertical-align: inherit;">虽然这样的视图不可插入，但如果仅更新不是表达式的列，则它可以是可更新的。</font><font style="vertical-align: inherit;">考虑这个观点：
    </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CREATE VIEW v AS SELECT col1，1 AS col2 FROM t;
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      这个视图是不可插入的，因为它</font></font><code class="literal">col2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是一个表达式。</font><font style="vertical-align: inherit;">但是如果更新没有尝试更新，它是可更新的</font></font><code class="literal">col2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">此更新是允许的：
    </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UPDATE v SET col1 = 0;
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      此更新不允许，因为它尝试更新表达式列：
    </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UPDATE v SET col2 = 0;
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      如果一个表包含一个</font></font><code class="literal">AUTO_INCREMENT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">列，那么插入到不包含该</font></font><code class="literal">AUTO_INCREMENT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">列</font><font style="vertical-align: inherit;">的表上的可插入视图</font><font style="vertical-align: inherit;">中不会更改该值
       </font></font><a class="link" href="/mysql-5.7-google-zh/functions.html#function_last-insert-id"><code class="literal">LAST_INSERT_ID()</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，因为将默认值插入不属于视图一部分的列的副作用不应该是可见的。
</font></font></p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="view-check-option"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.5.4查看WITH CHECK OPTION子句</font></font></h3>

</div>

</div>

</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      的</font></font><code class="literal">WITH CHECK OPTION</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">条款可以给出一个可更新视图来防止插入到行的量，
       </font></font><code class="literal">WHERE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在该条款
       </font></font><em class="replaceable"><code>select_statement</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是不正确的。</font><font style="vertical-align: inherit;">它还可以防止对</font></font><code class="literal">WHERE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      子句为true的</font><font style="vertical-align: inherit;">行进行更新，</font><font style="vertical-align: inherit;">但更新会导致它不为真（换句话说，它会阻止将可见行更新为不可见行）。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      在</font></font><code class="literal">WITH CHECK OPTION</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可更新视图</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">子句中</font></font><code class="literal">LOCAL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><code class="literal">CASCADED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      关键字</font><font style="vertical-align: inherit;">和</font><font style="vertical-align: inherit;">视图按照另一个视图来定义视图的检查范围。</font><font style="vertical-align: inherit;">如果没有给出关键字，则默认为</font></font><code class="literal">CASCADED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      在MySQL 5.7.6之前，</font></font><code class="literal">WITH CHECK OPTION</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">测试的工作是这样的：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          与</font></font><code class="literal">LOCAL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><code class="literal">WHERE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">检查</font><font style="vertical-align: inherit;">视图
           </font><font style="vertical-align: inherit;">子句，但没有检查基础视图。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          使用时</font></font><code class="literal">CASCADED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，将</font></font><code class="literal">WHERE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">检查</font><font style="vertical-align: inherit;">视图
           </font><font style="vertical-align: inherit;">子句，然后检查对基础视图的递归，添加</font></font><code class="literal">WITH CASCADED
          CHECK OPTION</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">到它们（为了检查的目的;它们的定义保持不变），并应用相同的规则。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          如果没有检查选项，view </font></font><code class="literal">WHERE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">子句不会被选中，也不会检查底层视图。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      从MySQL 5.7.6开始，</font></font><code class="literal">WITH CHECK OPTION</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">测试符合标准（从以前的</font></font><code class="literal">LOCAL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和不包含检查子句的</font><font style="vertical-align: inherit;">语义改变
       </font><font style="vertical-align: inherit;">）：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          随着</font></font><code class="literal">LOCAL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，视图
           </font></font><code class="literal">WHERE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">子句被检查，然后检查对基础视图的递归并应用相同的规则。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          使用时</font></font><code class="literal">CASCADED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，将</font></font><code class="literal">WHERE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">检查</font><font style="vertical-align: inherit;">视图
           </font><font style="vertical-align: inherit;">子句，然后检查对基础视图的递归，添加</font></font><code class="literal">WITH CASCADED
          CHECK OPTION</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">到它们（为了检查的目的;它们的定义保持不变），并应用相同的规则。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          如果没有检查选项，则不检查视图</font></font><code class="literal">WHERE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">子句，然后检查对基础视图的递归，并应用相同的规则。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      考虑下表和一组视图的定义：
    </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CREATE TABLE t1（a INT）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CREATE VIEW v1 AS SELECT * FROM t1 WHERE a &lt;2</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
带检查选项;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CREATE VIEW v2 AS SELECT * FROM v1 WHERE a&gt; 0</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
带本地检查选项;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CREATE VIEW v3 AS SELECT * FROM v1 WHERE a&gt; 0</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
带级联检查选项;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      在这里，</font></font><code class="literal">v2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><code class="literal">v3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">意见在另一视图中的术语的定义，</font></font><code class="literal">v1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">在MySQL 5.7.6之前，因为</font></font><code class="literal">v2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">有一个
       </font></font><code class="literal">LOCAL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">检查选项，插入仅针对</font></font><code class="literal">v2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">检查</font><font style="vertical-align: inherit;">进行测试</font><font style="vertical-align: inherit;">。</font></font><code class="literal">v3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">有一个</font></font><code class="literal">CASCADED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">检查选项，所以插入不仅针对</font></font><code class="literal">v3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">检查，而且针对基础视图</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">检查。</font><font style="vertical-align: inherit;">以下声明说明了这些差异：
    </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL的&gt; </font></font><strong class="userinput"><code>INSERT INTO v2 VALUES (2);</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
查询OK，1行受影响（0.00秒）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MySQL的&gt; </font></font><strong class="userinput"><code>INSERT INTO v3 VALUES (2);</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
错误1369（HY000）：检查选项失败'test.v3'</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      从MySQL 5.7.6开始，</font></font><code class="literal">LOCAL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      与以前不同</font><font style="vertical-align: inherit;">的语义</font><font style="vertical-align: inherit;">：</font></font><code class="literal">v2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">检查</font><font style="vertical-align: inherit;">插入for </font></font><code class="literal">LOCAL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">检查选项，然后（不像5.7.6之前）检查递归</font></font><code class="literal">v1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      并且规则再次应用。</font></font><code class="literal">v1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">导致检查失败</font><font style="vertical-align: inherit;">的规则
       </font><font style="vertical-align: inherit;">。</font></font><code class="literal">v3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">与以前一样，</font><font style="vertical-align: inherit;">检查
       </font><font style="vertical-align: inherit;">失败：
    </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL的&gt; </font></font><strong class="userinput"><code>INSERT INTO v2 VALUES (2);</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
错误1369（HY000）：检查选项失败'test.v2'</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MySQL的&gt; </font></font><strong class="userinput"><code>INSERT INTO v3 VALUES (2);</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
错误1369（HY000）：检查选项失败'test.v3'</font></font><font></font>
</pre>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="view-metadata"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.5.5查看元数据</font></font></h3>

</div>

</div>

</div>
<a class="indexterm" name="idm140527980350160"></a><a class="indexterm" name="idm140527980348672"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      关于视图的元数据可以通过以下方式获得：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          查询</font><font style="vertical-align: inherit;">数据库</font><font style="vertical-align: inherit;">的</font></font><a class="link" href="/mysql-5.7-google-zh/information-schema.html#views-table" title="24.30 INFORMATION_SCHEMA视图表"><code class="literal">VIEWS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表
           </font></font><code class="literal">INFORMATION_SCHEMA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/information-schema.html#views-table" title="24.30 INFORMATION_SCHEMA视图表"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第24.30节“INFORMATION_SCHEMA视图表”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          使用</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-create-view" title="13.7.5.13 SHOW CREATE VIEW语法"><code class="literal">SHOW CREATE VIEW</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          声明。</font><font style="vertical-align: inherit;">请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/sql-syntax.html#show-create-view" title="13.7.5.13 SHOW CREATE VIEW语法"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第13.7.5.13节“SHOW CREATE VIEW语法”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p></li></ul>
</div>

</div>

</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h2 class="title" style="clear: both"><a name="stored-programs-security"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.6存储程序和视图的访问控制</font></font></h2>

</div>

</div>

</div>
<a class="indexterm" name="idm140527980338752"></a><a class="indexterm" name="idm140527980337264"></a><a class="indexterm" name="idm140527980335776"></a><a class="indexterm" name="idm140527980334288"></a><a class="indexterm" name="idm140527980333216"></a><a class="indexterm" name="idm140527980331728"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      存储的程序和视图在使用之前定义，并且在被引用时在确定其特权的安全上下文中执行。</font><font style="vertical-align: inherit;">这些特权由它们的</font></font><code class="literal">DEFINER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">属性</font><font style="vertical-align: inherit;">来控制
       </font><font style="vertical-align: inherit;">，并且如果有的话，它们的
       </font></font><code class="literal">SQL SECURITY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特征。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      所有存储的程序（过程，函数，触发器和事件）和视图都可以具有一个</font></font><code class="literal">DEFINER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">名称为MySQL帐户</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">属性。</font><font style="vertical-align: inherit;">如果</font></font><code class="literal">DEFINER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从存储的程序或视图定义中省略</font><font style="vertical-align: inherit;">该</font><font style="vertical-align: inherit;">属性，则默认帐户是创建该对象的用户。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      另外，存储的例程（过程和函数）和视图可以具有</font></font><code class="literal">SQL SECURITY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">带有值的特征</font></font><code class="literal">DEFINER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或者</font></font><code class="literal">INVOKER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      指定对象是在定义者还是调用者上下文中执行。</font><font style="vertical-align: inherit;">如果</font></font><code class="literal">SQL SECURITY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">省略</font><font style="vertical-align: inherit;">了</font><font style="vertical-align: inherit;">特征，则默认为定义上下文。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      触发器和事件没有</font></font><code class="literal">SQL SECURITY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      特征，并始终在定义的上下文中执行。</font><font style="vertical-align: inherit;">服务器根据需要自动调用这些对象，因此不存在调用用户。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      定义者和调用者安全上下文的区别如下：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          在定义者安全上下文中执行的存储程序或视图以其</font></font><code class="literal">DEFINER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">属性</font><font style="vertical-align: inherit;">命名的帐户的特权执行</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这些特权可能与调用用户的特权完全不同。</font><font style="vertical-align: inherit;">调用者必须具有引用对象的适当特权（例如，</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_execute"><code class="literal">EXECUTE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">调用存储过程或
           </font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_select"><code class="literal">SELECT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从视图中选择），但是当对象执行时，调用者的特权将被忽略，并且只有</font></font><code class="literal">DEFINER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">帐户特权很重要。</font><font style="vertical-align: inherit;">如果此帐户拥有很少的权限，则该对象在其可执行的操作中相应地受到限制。</font><font style="vertical-align: inherit;">如果该</font></font><code class="literal">DEFINER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">帐户具有高度特权（例如</font></font><code class="literal">root</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">账户），对象可以执行强大的操作，</font></font><span class="emphasis"><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">无论谁调用它。</font></font></em></span>
        </p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          在调用程序安全上下文中执行的存储例程或视图只能执行调用程序具有权限的操作。</font></font><code class="literal">DEFINER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可以指定</font><font style="vertical-align: inherit;">该</font><font style="vertical-align: inherit;">属性，但对在调用程序上下文中执行的对象没有影响。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      考虑下面的存储过程：
    </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CREATE DEFINER ='admin'@'localhost'PROCEDURE p1（）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SQL安全定义器</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
开始</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  UPDATE t1 SET counter = counter + 1;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
结束;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      任何具有</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_execute"><code class="literal">EXECUTE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      特权的</font><font style="vertical-align: inherit;">用户都</font></font><code class="literal">p1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可以用</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#call" title="13.2.1 CALL语法"><code class="literal">CALL</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句</font><font style="vertical-align: inherit;">调用它
       </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">但是，在
       </font></font><code class="literal">p1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">执行时，它在定义者安全上下文中执行此操作，并因此</font></font><code class="literal">'admin'@'localhost'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以</font></font><code class="literal">DEFINER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">属性中</font><font style="vertical-align: inherit;">指定的帐户
       </font><font style="vertical-align: inherit;">的特权执行
       </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">此帐户必须具有
       </font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_execute"><code class="literal">EXECUTE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的权限
       </font></font><code class="literal">p1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，以及在
       </font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_update"><code class="literal">UPDATE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">该表的权限
       </font></font><code class="literal">t1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">否则，该过程失败。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      现在考虑这个存储过程，
       </font></font><code class="literal">p1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">除了它的</font></font><code class="literal">SQL
      SECURITY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特征是</font></font><code class="literal">INVOKER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：
    </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CREATE DEFINER ='admin'@'localhost'PROCEDURE p2（）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SQL安全调用</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
开始</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  UPDATE t1 SET counter = counter + 1;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
结束;</font></font><font></font>
</pre><p>
      <code class="literal">p2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不像</font></font><code class="literal">p1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，在调用者安全上下文中执行。</font><font style="vertical-align: inherit;">该</font></font><code class="literal">DEFINER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">属性是不相关的，并</font></font><code class="literal">p2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以调用用户的特权执行。</font></font><code class="literal">p2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果调用者缺乏</font><font style="vertical-align: inherit;">表格</font><font style="vertical-align: inherit;">的</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_execute"><code class="literal">EXECUTE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      特权</font></font><code class="literal">p2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
       </font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_update"><code class="literal">UPDATE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特权，则
       </font><font style="vertical-align: inherit;">失败</font></font><code class="literal">t1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      MySQL使用以下规则来控制用户可以在对象</font></font><code class="literal">DEFINER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">属性中</font><font style="vertical-align: inherit;">指定的帐户</font><font style="vertical-align: inherit;">：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"></font><code class="literal">DEFINER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">只有拥有该</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_super"><code class="literal">SUPER</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">权限，</font><font style="vertical-align: inherit;">
          才能指定一个</font><font style="vertical-align: inherit;">非自己帐户</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">值
           </font><font style="vertical-align: inherit;">。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          如果您没有</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_super"><code class="literal">SUPER</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          权限，唯一合法的用户价值是您自己的帐户，无论是字面上的还是使用
           </font></font><a class="link" href="/mysql-5.7-google-zh/functions.html#function_current-user"><code class="literal">CURRENT_USER</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">您无法将定义者设置为某个其他帐户。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      为了尽量减少存储程序和视图创建和使用的潜在风险，请遵循以下准则：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          对于存储的例程或视图，</font></font><code class="literal">SQL SECURITY
          INVOKER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">尽可能在对象定义中</font><font style="vertical-align: inherit;">使用</font><font style="vertical-align: inherit;">，以便只能由具有适合对象执行的操作的权限的用户使用。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          如果您在使用具有该</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_super"><code class="literal">SUPER</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">权限</font><font style="vertical-align: inherit;">的帐户时创建定义者上下文存储的程序或视图
           </font><font style="vertical-align: inherit;">，请指定一个显式</font></font><code class="literal">DEFINER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">属性，用于命名只拥有该对象执行的操作所需权限的帐户。</font></font><code class="literal">DEFINER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">仅在绝对必要时</font><font style="vertical-align: inherit;">指定高度特权</font><font style="vertical-align: inherit;">帐户。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          管理员可以</font></font><code class="literal">DEFINER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通过不授予他们</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_super"><code class="literal">SUPER</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特权</font><font style="vertical-align: inherit;">来阻止用户指定高权限</font><font style="vertical-align: inherit;">帐户</font><font style="vertical-align: inherit;">。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          应该编写定义器上下文对象，记住它们可以访问调用用户没有权限的数据。</font><font style="vertical-align: inherit;">在某些情况下，您可以通过不授予未经授权的用户特定权限来防止引用这些对象：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              存储过程或函数不能被没有</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_execute"><code class="literal">EXECUTE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">权限</font><font style="vertical-align: inherit;">的用户引用
               </font><font style="vertical-align: inherit;">。
            </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              视图不能被没有适当权限的用户引用（</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_select"><code class="literal">SELECT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">要从中选择，
               </font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_insert"><code class="literal">INSERT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">插入</font><font style="vertical-align: inherit;">视图</font><font style="vertical-align: inherit;">等等）。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          但是，触发器不存在此类控制，因为用户不直接引用它们。</font><font style="vertical-align: inherit;">触发器总是在定义的上下文中执行，并且通过访问与其关联的表来激活，即使是没有特殊权限的用户的普通表访问。</font><font style="vertical-align: inherit;">如果</font></font><code class="literal">DEFINER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          帐户拥有高度特权，则触发器可以执行敏感或危险的操作。</font><font style="vertical-align: inherit;">如果这仍是如此
           </font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_super"><code class="literal">SUPER</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，并
           </font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_trigger"><code class="literal">TRIGGER</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">创建触发所需的权限从该帐户谁创造了它的用户撤销。</font><font style="vertical-align: inherit;">管理员应该特别注意授予用户这些权限的组合。
</font></font></p></li></ul>
</div>

</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h2 class="title" style="clear: both"><a name="stored-programs-logging"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23.7存储程序的二进制记录</font></font></h2>

</div>

</div>

</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      二进制日志包含有关修改数据库内容的SQL语句的信息。</font><font style="vertical-align: inherit;">该信息以</font><font style="vertical-align: inherit;">描述修改</font><font style="vertical-align: inherit;">的</font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">事件</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的形式存储</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">二进制日志有两个重要目的：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          对于复制，二进制日志在主复制服务器上用作要发送到从属服务器的语句的记录。</font><font style="vertical-align: inherit;">主服务器将其二进制日志中包含的事件发送给其从服务器，从服务器执行这些事件以对主服务器进行相同的数据更改。</font><font style="vertical-align: inherit;">请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/replication.html#replication-implementation" title="16.2复制实现"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第16.2节“复制实现”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          某些数据恢复操作需要使用二进制日志。</font><font style="vertical-align: inherit;">备份文件恢复后，重新执行备份后记录的二进制日志中的事件。</font><font style="vertical-align: inherit;">这些事件从备份的角度使数据库保持最新状态。</font><font style="vertical-align: inherit;">请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/backup-and-recovery.html#recovery-from-backups" title="7.3.2使用备份进行恢复"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第7.3.2节“使用备份进行恢复”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      但是，如果在语句级别进行日志记录，则存储程序（存储过程和函数，触发器和事件）存在某些二进制日志记录问题：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          在某些情况下，语句可能会影响主站和从站上的不同行集。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          从属执行的复制语句由具有完全权限的从属SQL线程处理。</font><font style="vertical-align: inherit;">程序可以在主服务器和从服务器上遵循不同的执行路径，因此用户可以编写包含危险语句的例程，该语句只会在具有完全权限的线程处理的从站上执行。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          如果修改数据的存储程序不确定，则不可重复。</font><font style="vertical-align: inherit;">这可能会导致主站和从站上的数据不同，或导致恢复的数据与原始数据不同。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      本节介绍MySQL如何处理存储程序的二进制日志记录。</font><font style="vertical-align: inherit;">它指出了实施对使用存储程序的当前条件，以及您可以采取哪些措施来避免记录问题。</font><font style="vertical-align: inherit;">它还提供了有关这些情况的原因的其他信息。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      通常，在SQL语句级别（基于语句的二进制日志记录）发生二进制日志记录时，会导致这里描述的问题。</font><font style="vertical-align: inherit;">如果您使用基于行的二进制日志记录，则日志包含由于执行SQL语句而对各行进行的更改。</font><font style="vertical-align: inherit;">当例程或触发器执行时，将记录行更改，而不是进行更改的语句。</font><font style="vertical-align: inherit;">对于存储过程，这意味着该
       </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#call" title="13.2.1 CALL语法"><code class="literal">CALL</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句未被记录。</font><font style="vertical-align: inherit;">对于存储的函数，在函数内进行的行更改被记录，而不是函数调用。</font><font style="vertical-align: inherit;">对于触发器，记录由触发器进行的行更改。</font><font style="vertical-align: inherit;">在从属方面，只看到行更改，而不是存储的程序调用。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      混合格式二进制日志记录（</font></font><a class="link" href="/mysql-5.7-google-zh/replication.html#sysvar_binlog_format"><code class="literal">binlog_format=MIXED</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）使用基于语句的二进制日志记录，除非只有基于行的二进制日志记录才能保证结果正确。</font><font style="vertical-align: inherit;">对于混合格式，当存储函数，存储过程，触发器，事件或预准备语句包含对基于语句的二进制日志记录不安全的任何内容时，整个语句将标记为不安全并以行格式记录。</font><font style="vertical-align: inherit;">用于创建和删除过程，函数，触发器和事件的语句总是安全的，并以语句格式记录。</font><font style="vertical-align: inherit;">有关基于行，混合和基于语句的日志记录以及确定安全和不安全语句的详细信息，请参见
       </font></font><a class="xref" href="/mysql-5.7-google-zh/replication.html#replication-formats" title="16.2.1复制格式"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第16.2.1节“复制格式”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      除非另有说明，否则此处的说明假定在服务器上启用了二进制日志记录（请参见
       </font></font><a class="xref" href="/mysql-5.7-google-zh/server-administration.html#binary-log" title="5.4.4二进制日志"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第5.4.4节“二进制日志”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。）如果未启用二进制日志，则不能进行复制，二进制日志也不可用于数据恢复。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      在MySQL中使用存储函数的条件可以总结如下。</font><font style="vertical-align: inherit;">这些条件不适用于存储过程或事件调度程序事件，除非启用二进制日志记录，否则它们不适用。
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          要创建或更改存储功能，你必须有
           </font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_super"><code class="literal">SUPER</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特权，除了</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_create-routine"><code class="literal">CREATE ROUTINE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或者
           </font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_alter-routine"><code class="literal">ALTER ROUTINE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通常是必需的特权。</font><font style="vertical-align: inherit;">（根据</font></font><code class="literal">DEFINER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数定义中</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">值，</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_super"><code class="literal">SUPER</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不管是否启用二进制日志记录</font><font style="vertical-align: inherit;">，都</font><font style="vertical-align: inherit;">可能需要</font><font style="vertical-align: inherit;">这些
           </font><font style="vertical-align: inherit;">值，
           </font><font style="vertical-align: inherit;">请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/sql-syntax.html#create-procedure" title="13.1.16 CREATE PROCEDURE和CREATE FUNCTION语法"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第13.1.16节“CREATE PROCEDURE和CREATE FUNCTION语法”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。）
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          当你创建一个存储函数时，你必须声明它是确定性的或者它不修改数据。</font><font style="vertical-align: inherit;">否则，它可能不安全的数据恢复或复制。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          默认情况下，一个</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#create-function" title="13.1.13 CREATE FUNCTION语法"><code class="literal">CREATE
          FUNCTION</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句被接受，至少一个
           </font></font><code class="literal">DETERMINISTIC</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><code class="literal">NO SQL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或</font></font><code class="literal">READS SQL DATA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">必须明确指定。</font><font style="vertical-align: inherit;">否则会发生错误：
        </font></font></p><pre data-lang="none" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">错误1418（HY000）：该函数没有DETERMINISTIC，NO SQL，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
或READS SQL DATA在其声明和二进制日志记录中启用</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
（你*可能*想要使用不太安全的log_bin_trust_function_creators</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
变量）</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          这个函数是确定性的（并且不修改数据），所以它是安全的：
        </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CREATE FUNCTION f1（INT）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
返回INT</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
确定性</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
READS SQL DATA</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
开始</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  返回我;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
结束;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          这个函数使用</font></font><a class="link" href="/mysql-5.7-google-zh/functions.html#function_uuid"><code class="literal">UUID()</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，这是不确定的，所以这个函数也是不确定的，是不安全的：
        </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CREATE FUNCTION f2（）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
返回CHAR（36）字符集utf8</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
开始</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  RETURN UUID（）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
结束;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          此功能修改数据，因此可能不安全：
        </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CREATE FUNCTION f3（p_id INT）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
返回INT</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
开始</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  UPDATE t SET modtime = NOW（）WHERE id = p_id;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  RETURN ROW_COUNT（）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
结束;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          评估一个功能的性质是基于</font><font style="vertical-align: inherit;">创建者</font><font style="vertical-align: inherit;">的
           </font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">诚实</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">MySQL不会检查声明的函数</font></font><code class="literal">DETERMINISTIC</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是否存在产生不确定结果的语句。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          当您尝试执行存储的函数时，如果
           </font></font><a class="link" href="/mysql-5.7-google-zh/replication.html#sysvar_binlog_format"><code class="literal">binlog_format=STATEMENT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">设置了，则</font></font><code class="literal">DETERMINISTIC</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">必须在函数定义中指定关键字。</font><font style="vertical-align: inherit;">如果情况并非如此，则会生成错误并且该函数不会运行，除非
           </font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_log_bin_trust_function_creators"><code class="literal">log_bin_trust_function_creators=1</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          指定覆盖此检查（请参阅下文）。</font><font style="vertical-align: inherit;">对于递归函数调用，</font></font><code class="literal">DETERMINISTIC</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">仅在最外层调用时需要关键字。</font><font style="vertical-align: inherit;">如果正在使用基于行或混合二进制日志记录，即使该函数没有定义</font></font><code class="literal">DETERMINISTIC</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">关键字</font><font style="vertical-align: inherit;">，也会接受并复制该语句
           </font><font style="vertical-align: inherit;">。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          由于MySQL在创建时不检查函数是否确实是确定性的，因此使用</font></font><code class="literal">DETERMINISTIC</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">关键字</font><font style="vertical-align: inherit;">调用存储函数</font><font style="vertical-align: inherit;">可能会执行对基于语句的日志不安全的操作，或者调用包含不安全语句的函数或过程。</font><font style="vertical-align: inherit;">如果在</font></font><a class="link" href="/mysql-5.7-google-zh/replication.html#sysvar_binlog_format"><code class="literal">binlog_format=STATEMENT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          设置</font><font style="vertical-align: inherit;">时发生这种情况
           </font><font style="vertical-align: inherit;">，则会发出警告消息。</font><font style="vertical-align: inherit;">如果正在使用基于行的或混合二进制日志记录，则不会发出警告，并且会以基于行的格式复制语句。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          为了放松函数创建的上述条件（您必须具有</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_super"><code class="literal">SUPER</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          权限并且函数必须声明为确定性或不修改数据），请将全局</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_log_bin_trust_function_creators"><code class="literal">log_bin_trust_function_creators</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          系统变量</font><font style="vertical-align: inherit;">设置
           </font><font style="vertical-align: inherit;">为1.默认情况下，此变量的值为0，但你可以像这样改变它：
        </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL的&gt; </font></font><strong class="userinput"><code>SET GLOBAL log_bin_trust_function_creators = 1;</code></strong>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          您也</font></font><a class="link" href="/mysql-5.7-google-zh/replication.html#option_mysqld_log-bin-trust-function-creators"><code class="option">--log-bin-trust-function-creators=1</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          可以在启动服务器时</font><font style="vertical-align: inherit;">使用该</font><font style="vertical-align: inherit;">选项</font><font style="vertical-align: inherit;">来设置此变量
           </font><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          如果二进制日志记录未启用，
           </font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_log_bin_trust_function_creators"><code class="literal">log_bin_trust_function_creators</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          则不适用。</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_super"><code class="literal">SUPER</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">对于函数创建不是必需的，除非如前所述，</font></font><code class="literal">DEFINER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数定义中</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">值需要它。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          有关可能对复制不安全的内置函数（因此也会导致使用它们的存储函数也不安全）的信息，请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/replication.html#replication-features" title="16.4.1复制功能和问题"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第16.4.1节“复制功能和问题”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      触发器与存储函数类似，所以前面关于函数的注释也适用于触发器，但有以下例外：</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#create-trigger" title="13.1.20 CREATE TRIGGER语法"><code class="literal">CREATE TRIGGER</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不具有可选</font></font><code class="literal">DETERMINISTIC</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特性，因此触发器始终是确定性的。</font><font style="vertical-align: inherit;">但是，这种假设在某些情况下可能是无效的。</font><font style="vertical-align: inherit;">例如，该
       </font></font><a class="link" href="/mysql-5.7-google-zh/functions.html#function_uuid"><code class="literal">UUID()</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数是非确定性的（并且不复制）。</font><font style="vertical-align: inherit;">在触发器中使用这些函数时要小心。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      触发器可以更新表，因此</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#create-trigger" title="13.1.20 CREATE TRIGGER语法"><code class="literal">CREATE
      TRIGGER</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果您没有所需的权限，</font><font style="vertical-align: inherit;">则会出现类似于存储函数的错误消息</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">在从属方面，从属使用触发
       </font></font><code class="literal">DEFINER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">属性来确定哪个用户被认为是触发器的创建者。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      本节的其余部分提供了关于日志实施及其影响的更多细节。</font><font style="vertical-align: inherit;">除非您对存储日常使用中当前日志记录相关条件的基本背景感兴趣，否则不需要阅读它。</font><font style="vertical-align: inherit;">本讨论仅适用于基于语句的日志记录，而不适用于基于行的日志记录，但第一项除外：
       </font></font><code class="literal">CREATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并且</font></font><code class="literal">DROP</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句会记录为语句，而不考虑日志记录模式。
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          服务器写入</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#create-event" title="13.1.12创建事件语法"><code class="literal">CREATE EVENT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#create-procedure" title="13.1.16 CREATE PROCEDURE和CREATE FUNCTION语法"><code class="literal">CREATE PROCEDURE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#create-function" title="13.1.13 CREATE FUNCTION语法"><code class="literal">CREATE FUNCTION</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#alter-event" title="13.1.2 ALTER EVENT语法"><code class="literal">ALTER EVENT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#alter-procedure" title="13.1.6 ALTER PROCEDURE语法"><code class="literal">ALTER PROCEDURE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#alter-function" title="13.1.3 ALTER FUNCTION语法"><code class="literal">ALTER FUNCTION</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#drop-event" title="13.1.23 DROP EVENT语法"><code class="literal">DROP EVENT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#drop-procedure" title="13.1.27 DROP程序和DROP FUNCTION语法"><code class="literal">DROP PROCEDURE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，和
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#drop-function" title="13.1.24 DROP FUNCTION语法"><code class="literal">DROP FUNCTION</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句二进制日志。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#select" title="13.2.9 SELECT语法"><code class="literal">SELECT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果函数更改了数据并且出现在不会记录的语句中，则会将</font><font style="vertical-align: inherit;">
          存储的函数调用记录为
           </font><font style="vertical-align: inherit;">语句。</font><font style="vertical-align: inherit;">这可以防止在非记录语句中使用存储函数导致的数据更改的不可复制性。</font><font style="vertical-align: inherit;">例如，</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#select" title="13.2.9 SELECT语法"><code class="literal">SELECT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          语句不写入二进制日志，但
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#select" title="13.2.9 SELECT语法"><code class="literal">SELECT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可能会调用一个存储的函数进行更改。</font><font style="vertical-align: inherit;">为了处理这个问题，</font><font style="vertical-align: inherit;">当给定的函数进行更改时，会将语句写入二进制日志。</font><font style="vertical-align: inherit;">假设在主机上执行以下语句：
        </font></font><code class="literal">SELECT
          <em class="replaceable"><code>func_name</code></em>()</code><font style="vertical-align: inherit;"></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CREATE FUNCTION f1（INT）RETURNS INT</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
开始</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  IF（a &lt;3）THEN</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    插入t2值（a）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  万一;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  返回0;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
结束;</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CREATE TABLE t1（a INT）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
INSERT INTO t1 VALUES（1），（2），（3）;</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SELECT f1（a）FROM t1;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          当</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#select" title="13.2.9 SELECT语法"><code class="literal">SELECT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句执行时，该函数</font></font><code class="literal">f1()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">被调用三次。</font><font style="vertical-align: inherit;">其中两个调用插入一行，MySQL </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#select" title="13.2.9 SELECT语法"><code class="literal">SELECT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为它们中的每一个</font><font style="vertical-align: inherit;">记录一条</font><font style="vertical-align: inherit;">语句。</font><font style="vertical-align: inherit;">也就是说，MySQL将以下语句写入二进制日志：
        </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SELECT f1（1）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SELECT f1（2）;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#select" title="13.2.9 SELECT语法"><code class="literal">SELECT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          当函数调用导致错误的存储过程时，</font><font style="vertical-align: inherit;">
          服务器还会记录</font><font style="vertical-align: inherit;">存储函数调用</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">语句。</font><font style="vertical-align: inherit;">在这种情况下，服务器将该</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#select" title="13.2.9 SELECT语法"><code class="literal">SELECT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          语句与预期的错误代码一起</font><font style="vertical-align: inherit;">写入</font><font style="vertical-align: inherit;">日志。</font><font style="vertical-align: inherit;">在从站上，如果发生相同的错误，那是预期的结果，并且复制将继续。</font><font style="vertical-align: inherit;">否则，复制停止。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          记录存储的函数调用而不是函数执行的语句对复制具有安全隐含意义，这是由两个因素引起的：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              函数可以在主服务器和从服务器上遵循不同的执行路径。
            </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              在从机上执行的语句由具有完全权限的从属SQL线程处理。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          其含义是尽管用户必须有权
           </font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_create-routine"><code class="literal">CREATE ROUTINE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">创建一个函数，但用户可以编写一个包含危险语句的函数，该语句只会在具有完全权限的线程处理的从站上执行。</font><font style="vertical-align: inherit;">例如，如果主服务器和从属服务器的服务器ID值分别为1和2，则主服务器上的用户可以创建和调用不安全的函数
           </font></font><code class="literal">unsafe_func()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，如下所示：
        </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql&gt; </font></font><strong class="userinput"><code>delimiter //</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql&gt; </font></font><strong class="userinput"><code>CREATE FUNCTION unsafe_func () RETURNS INT</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    - &gt; </font></font><strong class="userinput"><code>BEGIN</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    - &gt;    </font><font style="vertical-align: inherit;">
    - &gt;    </font><font style="vertical-align: inherit;">
    - &gt; </font><font style="vertical-align: inherit;">
    - &gt; </font><font style="vertical-align: inherit;">
mysql&gt; </font><font style="vertical-align: inherit;">
mysql&gt;</font></font><strong class="userinput"><code>IF @@server_id=2 THEN <em class="replaceable"><code>dangerous_statement</code></em>; END IF;</code></strong><font style="vertical-align: inherit;"></font><strong class="userinput"><code>RETURN 1;</code></strong><font style="vertical-align: inherit;"></font><strong class="userinput"><code>END;</code></strong><font style="vertical-align: inherit;"></font><strong class="userinput"><code>//</code></strong><font style="vertical-align: inherit;"></font><strong class="userinput"><code>delimiter ;</code></strong><font style="vertical-align: inherit;"></font><strong class="userinput"><code>INSERT INTO t VALUES(unsafe_func());</code></strong>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          该</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#create-function" title="13.1.13 CREATE FUNCTION语法"><code class="literal">CREATE FUNCTION</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#insert" title="13.2.5 INSERT语法"><code class="literal">INSERT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句被写入二进制日志，以便从机将执行它们。</font><font style="vertical-align: inherit;">由于从属SQL线程具有完全权限，因此它将执行危险语句。</font><font style="vertical-align: inherit;">因此，函数调用对主从机有不同的影响，并且不是复制安全的。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          为了防止启用二进制日志记录的服务器出现这种危险，存储函数创建者</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_super"><code class="literal">SUPER</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">除了需要通常的</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_create-routine"><code class="literal">CREATE ROUTINE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          特权</font><font style="vertical-align: inherit;">之外，还</font><font style="vertical-align: inherit;">必须具有
           </font><font style="vertical-align: inherit;">特权</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">同样，要使用
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#alter-function" title="13.1.3 ALTER FUNCTION语法"><code class="literal">ALTER FUNCTION</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，您必须拥有该</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_super"><code class="literal">SUPER</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特权以外的</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_alter-routine"><code class="literal">ALTER ROUTINE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特权。</font><font style="vertical-align: inherit;">没有这个</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_super"><code class="literal">SUPER</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特权，会发生错误：
        </font></font></p><pre data-lang="none" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">错误1419（HY000）：您没有SUPER权限和</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
启用二进制日志记录（您*可能*希望使用不太安全的日志</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
log_bin_trust_function_creators变量）</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          如果您不想要功能创建者拥有该
           </font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_super"><code class="literal">SUPER</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">权限（例如，如果</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_create-routine"><code class="literal">CREATE
          ROUTINE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">您的系统上</font><font style="vertical-align: inherit;">具有该</font><font style="vertical-align: inherit;">权限的</font><font style="vertical-align: inherit;">所有用户</font><font style="vertical-align: inherit;">都是有经验的应用程序开发人员），请将全局</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_log_bin_trust_function_creators"><code class="literal">log_bin_trust_function_creators</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          系统变量</font><font style="vertical-align: inherit;">设置
           </font><font style="vertical-align: inherit;">为1.您还可以使用该</font></font><a class="link" href="/mysql-5.7-google-zh/replication.html#option_mysqld_log-bin-trust-function-creators"><code class="option">--log-bin-trust-function-creators=1</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          选项</font><font style="vertical-align: inherit;">设置此变量
           </font><font style="vertical-align: inherit;">当启动服务器时。</font><font style="vertical-align: inherit;">如果二进制日志记录未启用，
           </font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_log_bin_trust_function_creators"><code class="literal">log_bin_trust_function_creators</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          则不适用。</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_super"><code class="literal">SUPER</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">对于函数创建不是必需的，除非如前所述，</font></font><code class="literal">DEFINER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数定义中</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">值需要它。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          如果执行更新的函数不确定，则不可重复。</font><font style="vertical-align: inherit;">这可能会产生两个不良影响：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              它会使奴隶与主人不同。
            </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              恢复的数据将与原始数据不同。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          为了解决这些问题，MySQL强制执行以下要求：在主服务器上，除非将函数声明为确定性或不修改数据，否则将拒绝创建和更改函数。</font><font style="vertical-align: inherit;">这里适用两套函数特性：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              的</font></font><code class="literal">DETERMINISTIC</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><code class="literal">NOT
              DETERMINISTIC</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特性指示的功能是否总是产生对于给定的输入相同的结果。</font><font style="vertical-align: inherit;">默认情况下，</font></font><code class="literal">NOT DETERMINISTIC</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果没有给出任何特征。</font><font style="vertical-align: inherit;">要声明一个函数是确定性的，你必须</font></font><code class="literal">DETERMINISTIC</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">明确</font><font style="vertical-align: inherit;">指定
               </font><font style="vertical-align: inherit;">。
            </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              的</font></font><code class="literal">CONTAINS SQL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><code class="literal">NO
              SQL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><code class="literal">READS SQL DATA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，和
               </font></font><code class="literal">MODIFIES SQL DATA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特征提供有关该功能是否读取或写入数据信息。</font><font style="vertical-align: inherit;">无论是</font></font><code class="literal">NO SQL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
               </font></font><code class="literal">READS SQL DATA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指示功能不会改变的数据，但由于默认情况下是必须指定的这些明确的一个</font></font><code class="literal">CONTAINS
              SQL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，如果没有特性给予。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          默认情况下，一个</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#create-function" title="13.1.13 CREATE FUNCTION语法"><code class="literal">CREATE
          FUNCTION</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句被接受，至少一个
           </font></font><code class="literal">DETERMINISTIC</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><code class="literal">NO SQL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或</font></font><code class="literal">READS SQL DATA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">必须明确指定。</font><font style="vertical-align: inherit;">否则会发生错误：
        </font></font></p><pre data-lang="none" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">错误1418（HY000）：该函数没有DETERMINISTIC，NO SQL，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
或READS SQL DATA在其声明和二进制日志记录中启用</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
（你*可能*想要使用不太安全的log_bin_trust_function_creators</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
变量）</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          如果设置
           </font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_log_bin_trust_function_creators"><code class="literal">log_bin_trust_function_creators</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          为1，则功能是确定性的或不修改数据的要求将被丢弃。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          存储过程调用在语句级而不是在</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#call" title="13.2.1 CALL语法"><code class="literal">CALL</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">级别上进行记录。</font><font style="vertical-align: inherit;">也就是说，服务器不会记录该
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#call" title="13.2.1 CALL语法"><code class="literal">CALL</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句，它会在实际执行的过程中记录这些语句。</font><font style="vertical-align: inherit;">因此，在从服务器上会观察到主服务器上发生的相同更改。</font><font style="vertical-align: inherit;">这可以防止在不同计算机上执行不同路径的过程可能导致的问题。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          通常，在存储过程中执行的语句将使用与将应用的语句相同的规则写入二进制日志中，以独立方式执行语句。</font><font style="vertical-align: inherit;">记录过程语句时需要特别注意，因为过程内的语句执行与非过程上下文中的语句执行不完全相同：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
              <a class="indexterm" name="idm140527980100704"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">

              要记录的语句可能包含对本地过程变量的引用。</font><font style="vertical-align: inherit;">这些变量不存在于存储过程上下文之外，因此引用此变量的语句不能逐字记录。</font><font style="vertical-align: inherit;">相反，为了记录目的，每个对局部变量的引用都被这个构造替换：
            </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NAME_CONST（</font></font><em class="replaceable"><code>var_name</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><em class="replaceable"><code>var_value</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）
</font></font></pre><p>
              <em class="replaceable"><code>var_name</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是局部变量名称，并且</font></font><em class="replaceable"><code>var_value</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是一个常量，指示变量在语句记录时的值。
              </font></font><a class="link" href="/mysql-5.7-google-zh/functions.html#function_name-const"><code class="literal">NAME_CONST()</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">具有的价值
               </font></font><em class="replaceable"><code>var_value</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，以及
               </font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">名</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的
               </font></font><em class="replaceable"><code>var_name</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">因此，如果你直接调用这个函数，你会得到如下结果：
            </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL的&gt; </font></font><strong class="userinput"><code>SELECT NAME_CONST('myname', 14);</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ -------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">myname |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ -------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">14 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ -------- +</font></font><font></font>
</pre><p>
              <a class="link" href="/mysql-5.7-google-zh/functions.html#function_name-const"><code class="literal">NAME_CONST()</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 使一个记录的独立语句在一个从机上执行，与存储过程中在主机上执行的原始语句具有相同的效果。
            </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">当源列表达式引用局部变量时，</font><font style="vertical-align: inherit;">
              使用</font></font><a class="link" href="/mysql-5.7-google-zh/functions.html#function_name-const"><code class="literal">NAME_CONST()</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可能会导致</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#create-table" title="13.1.18 CREATE TABLE语法"><code class="literal">CREATE TABLE
              ... SELECT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句出现</font><font style="vertical-align: inherit;">问题
               </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">将这些引用转换为</font></font><a class="link" href="/mysql-5.7-google-zh/functions.html#function_name-const"><code class="literal">NAME_CONST()</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              表达式会导致主服务器和从属服务器上的列名称不同，或者名称太长而无法成为合法的列标识符。</font><font style="vertical-align: inherit;">解决方法是为引用局部变量的列提供别名。</font><font style="vertical-align: inherit;">当</font></font><code class="literal">myvar</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值为1 </font><font style="vertical-align: inherit;">时，请考虑以下语句</font><font style="vertical-align: inherit;">：
            </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CREATE TABLE t1 SELECT myvar;
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              这将被重写如下：
            </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CREATE TABLE t1 SELECT NAME_CONST（myvar，1）;
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              要确保主表和主表具有相同的列名，请像这样编写语句：
            </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CREATE TABLE t1 SELECT myvar AS myvar;
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              重写的声明变成：
            </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CREATE TABLE t1 SELECT NAME_CONST（myvar，1）AS myvar;
</font></font></pre></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              要记录的语句可能包含对用户定义变量的引用。</font><font style="vertical-align: inherit;">为了处理这个问题，MySQL </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#set-variable" title="13.7.4.1变量赋值的SET语法"><code class="literal">SET</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              向二进制日志中</font><font style="vertical-align: inherit;">写入一条
               </font><font style="vertical-align: inherit;">语句，以确保该变量存在于与主服务器上的值相同的从服务器上。</font><font style="vertical-align: inherit;">例如，如果语句引用了一个变量
               </font></font><code class="literal">@my_var</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，那么该语句将在二进制日志中以下列语句开头：其中</font></font><em class="replaceable"><code>value</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是</font></font><code class="literal">@my_var</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">主节点上的</font><font style="vertical-align: inherit;">值
               </font><font style="vertical-align: inherit;">：
            </font></font></p><pre data-lang="sql" class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SET @my_var = </font></font><em class="replaceable"><code>value</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;
</font></font></pre></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              过程调用可发生在已提交或回滚的事务中。</font><font style="vertical-align: inherit;">考虑事务性上下文，以便正确复制过程执行的事务性方面。</font><font style="vertical-align: inherit;">也就是说，服务器日志中发现实际执行和修改数据的过程中这些语句，还记录
               </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#commit" title="13.3.1 START TRANSACTION，COMMIT和ROLLBACK语法"><code class="literal">BEGIN</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
               </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#commit" title="13.3.1 START TRANSACTION，COMMIT和ROLLBACK语法"><code class="literal">COMMIT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
               </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#commit" title="13.3.1 START TRANSACTION，COMMIT和ROLLBACK语法"><code class="literal">ROLLBACK</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              语句是必要的。</font><font style="vertical-align: inherit;">例如，如果过程只更新事务表并在回退的事务中执行，则不记录这些更新。</font><font style="vertical-align: inherit;">如果程序发生在已提交的事务中，
               </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#commit" title="13.3.1 START TRANSACTION，COMMIT和ROLLBACK语法"><code class="literal">BEGIN</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              并且</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#commit" title="13.3.1 START TRANSACTION，COMMIT和ROLLBACK语法"><code class="literal">COMMIT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句记录在更新中。</font><font style="vertical-align: inherit;">对于在回滚事务中执行的过程，其语句使用与以独立方式执行的语句相同的规则进行记录：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: square; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                  不记录事务表的更新。
                </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                  记录对非事务表的更新，因为回滚不会取消它们。
                </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                  对事务性和非事务性表的混合更新记录在周围，
                   </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#commit" title="13.3.1 START TRANSACTION，COMMIT和ROLLBACK语法"><code class="literal">BEGIN</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                  并且
                   </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#commit" title="13.3.1 START TRANSACTION，COMMIT和ROLLBACK语法"><code class="literal">ROLLBACK</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                  从属机器将进行与主机上相同的更改和回滚。
</font></font></p></li></ul>
</div>
</li></ul>
</div>
</li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果从存储函数内调用过程，则</font><font style="vertical-align: inherit;">
          存储过程调用</font></font><span class="emphasis"><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不会</font></font></em></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">写入语句级别的二进制日志。</font><font style="vertical-align: inherit;">在这种情况下，唯一记录的是调用该函数（如果它发生在记录的语句内）或
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#do" title="13.2.3 DO语法"><code class="literal">DO</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句（如果它发生在未记录的语句内）的语句。</font><font style="vertical-align: inherit;">出于这个原因，应该谨慎使用调用过程的存储函数，即使过程本身是安全的。
</font></font></p></li></ul>
</div>

</div>

</div>
<div class="copyright-footer">

</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tbody><tr>
<td width="40%" align="left"><a accesskey="p" href="/mysql-5.7-google-zh/partitioning.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">上一页</font></font></a></td>
<td width="20%" align="center"><a accesskey="u" href="/mysql-5.7-google-zh/stored-programs-views.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">向上</font></font></a></td>
<td width="40%" align="right">&nbsp;<a accesskey="n" href="/mysql-5.7-google-zh/information-schema.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">下一个</font></font></a></td>
</tr>
<tr>
<td width="40%" align="left" valign="top"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第22章分区</font></font></td>
<td width="20%" align="center"><a accesskey="h" href="/mysql-5.7-google-zh/index.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">家</font></font></a></td>
<td width="40%" align="right" valign="top"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第24章INFORMATION_SCHEMA表</font></font></td>
</tr>
</tbody></table>
</div><div id="goog-gt-tt" class="skiptranslate" dir="ltr"><div style="padding: 8px;"><div><div class="logo"><img src="./images/translate_24dp.png" width="20" height="20" alt="Google 翻译"></div></div></div><div class="top" style="padding: 8px; float: left; width: 100%;"><h1 class="title gray">原文</h1></div><div class="middle" style="padding: 8px;"><div class="original-text"></div></div><div class="bottom" style="padding: 8px;"><div class="activity-links"><span class="activity-link">提供更好的翻译建议</span><span class="activity-link"></span></div><div class="started-activity-container"><hr style="color: #CCC; background-color: #CCC; height: 1px; border: none;"><div class="activity-root"></div></div></div><div class="status-message" style="display: none;"></div></div>


<div class="goog-te-spinner-pos"><div class="goog-te-spinner-animation"><svg xmlns="http://www.w3.org/2000/svg" class="goog-te-spinner" width="96px" height="96px" viewBox="0 0 66 66"><circle class="goog-te-spinner-path" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"></circle></svg></div></div></body></html>