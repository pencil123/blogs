<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh" class="translated-ltr"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<title>第28章扩展MySQL</title>
<link rel="stylesheet" href="./images/mvl.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets + chunker.py v1.9.2">
<link rel="start" href="/mysql-5.7-google-zh/index.html" title="{书名}">
<link rel="up" href="/mysql-5.7-google-zh/extending-mysql.html" title="">
<link rel="prev" href="/mysql-5.7-google-zh/connectors-apis.html" title="第27章连接器和API">
<link rel="next" href="/mysql-5.7-google-zh/mysql-enterprise.html" title="Chapter 29 MySQL Enterprise Edition">
<link type="text/css" rel="stylesheet" charset="UTF-8" href="./images/translateelement.css"></head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tbody><tr>
<th colspan="3" align="center"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28章扩展MySQL</font></font></th>
</tr>
<tr>
<td width="20%" align="left"><a accesskey="p" href="/mysql-5.7-google-zh/connectors-apis.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">上一页</font></font></a>&nbsp;</td>
<th width="60%" align="center"></th>
<td width="20%" align="right">&nbsp;<a accesskey="n" href="/mysql-5.7-google-zh/mysql-enterprise.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">下一个</font></font></a></td>
</tr>
</tbody></table>
<hr>
</div>
<div class="chapter">
<div class="titlepage">
<div>
<div>
<h1 class="title"><a name="extending-mysql"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28章扩展MySQL</font></font></h1>

</div>

</div>

</div>
<div class="toc">
<p><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">目录</font></font></b></p><dl class="toc"><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#mysql-internals"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.1 MySQL内部</font></font></a></span></dt><dd><dl><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#mysql-threads"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.1.1 MySQL线程</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#mysql-test-suite"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.1.2 MySQL测试套件</font></font></a></span></dt></dl></dd><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#plugin-api"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2 MySQL插件API</font></font></a></span></dt><dd><dl><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#plugin-types"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.1插件的类型</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#plugin-api-characteristics"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.2插件API特性</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#plugin-api-components"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.3插件API组件</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#writing-plugins"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.4编写插件</font></font></a></span></dt></dl></dd><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#plugin-services"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.3用于插件的MySQL服务</font></font></a></span></dt><dd><dl><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#locking-service"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.3.1锁定服务</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#keyring-service"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.3.2钥匙圈服务</font></font></a></span></dt></dl></dd><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#adding-functions"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.4为MySQL添加新功能</font></font></a></span></dt><dd><dl><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#udf-features"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.4.1用户定义的功能接口的功能</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#adding-udf"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.4.2添加新的用户定义函数</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#adding-native-function"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.4.3添加一个新的本地函数</font></font></a></span></dt></dl></dd><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#porting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.5调试和移植MySQL</font></font></a></span></dt><dd><dl><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#debugging-server"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.5.1调试MySQL服务器</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#debugging-client"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.5.2调试MySQL客户端</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#dbug-package"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.5.3 DBUG包</font></font></a></span></dt></dl></dd></dl>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h2 class="title" style="clear: both"><a name="mysql-internals"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.1 MySQL内部</font></font></h2>

</div>

</div>

</div>
<div class="toc">
<dl class="toc"><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#mysql-threads"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.1.1 MySQL线程</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#mysql-test-suite"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.1.2 MySQL测试套件</font></font></a></span></dt></dl>
</div>
<a class="indexterm" name="idm140527956652480"></a><a class="indexterm" name="idm140527956651408"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      本章介绍了在处理MySQL代码时需要了解的许多事情。</font><font style="vertical-align: inherit;">要跟踪或促成MySQL开发，请按照
       </font></font><a class="xref" href="/mysql-5.7-google-zh/installing.html#installing-development-tree" title="2.9.3使用开发源树安装MySQL"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第2.9.3节“使用开发源代码树安装MySQL”中的说明进行操作</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">如果你对MySQL内部感兴趣，你也应该订阅我们的
       </font></font><code class="literal">internals</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">邮件列表。</font><font style="vertical-align: inherit;">该列表的流量相对较低。</font><font style="vertical-align: inherit;">有关如何订阅的详细信息，请参阅</font></font><a class="xref" href="/mysql-5.7-google-zh/introduction.html#mailing-lists" title="1.6.2 MySQL邮件列表"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第1.6.2节“MySQL邮件列表”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">甲骨文公司的许多MySQL开发人员都在</font></font><code class="literal">internals</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">列表，我们帮助其他正在开发MySQL代码的人员。</font><font style="vertical-align: inherit;">请随意使用此列表来提出有关代码的问题，并发送您想要贡献给MySQL项目的补丁！
</font></font></p>
<div class="section">

<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="mysql-threads"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.1.1 MySQL线程</font></font></h3>
</div>
</div>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        MySQL服务器创建以下线程：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            连接管理器线程处理服务器侦听的网络接口上的客户端连接请求。</font><font style="vertical-align: inherit;">在所有平台上，一个管理器线程处理TCP / IP连接请求。</font><font style="vertical-align: inherit;">在Unix上，这个管理器线程还处理Unix套接字文件连接请求。</font><font style="vertical-align: inherit;">在Windows上，管理器线程处理共享内存连接请求，另一个处理命名管道连接请求。</font><font style="vertical-align: inherit;">服务器不会创建线程来处理它不会听的接口。</font><font style="vertical-align: inherit;">例如，不支持命名管道连接的Windows服务器不会创建线程来处理它们。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            连接管理器线程将每个客户端连接与专用于它的线程关联，以处理该连接的身份验证和请求处理。</font><font style="vertical-align: inherit;">管理器线程在必要时创建一个新线程，但尝试通过首先查询线程缓存来查看它是否包含可用于连接的线程来避免这样做。</font><font style="vertical-align: inherit;">当连接结束时，如果缓存未满，则其线程返回到线程缓存。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            有关调整控制线程资源的参数的信息，请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/optimization.html#connection-threads" title="8.12.5.1 MySQL如何使用线程进行客户端连接"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第8.12.5.1节“MySQL如何使用线程进行客户端连接”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            在主复制服务器上，来自从属服务器的连接与客户端连接一样处理：每个连接的从属设备有一个线程。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            在从属复制服务器上，启动I / O线程以连接到主服务器并从中读取更新。</font><font style="vertical-align: inherit;">SQL线程开始应用从主服务器读取的更新。</font><font style="vertical-align: inherit;">这两个线程独立运行，可以独立启动和停止。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            信号线程处理所有信号。</font><font style="vertical-align: inherit;">此线程通常还会处理警报和呼叫，
             </font></font><code class="literal">process_alarm()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以强制超时连接的超时。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            如果</font></font><code class="literal">InnoDB</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用，默认情况下会有额外的读写线程。</font><font style="vertical-align: inherit;">这些数量由</font><font style="vertical-align: inherit;">
            参数</font></font><a class="link" href="/mysql-5.7-google-zh/innodb-storage-engine.html#sysvar_innodb_read_io_threads"><code class="literal">innodb_read_io_threads</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
             </font></font><a class="link" href="/mysql-5.7-google-zh/innodb-storage-engine.html#sysvar_innodb_write_io_threads"><code class="literal">innodb_write_io_threads</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参数</font><font style="vertical-align: inherit;">控制
             </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/innodb-storage-engine.html#innodb-parameters" title="14.14 InnoDB启动选项和系统变量"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第14.14节“InnoDB启动选项和系统变量”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            如果服务器使用该</font><font style="vertical-align: inherit;">
            选项</font><font style="vertical-align: inherit;">启动，
             </font><font style="vertical-align: inherit;">则会创建专用线程以每秒刷新所有表</font><font style="vertical-align: inherit;">。
          </font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_flush_time"><code class="option">--flush_time=<em class="replaceable"><code>val</code></em></code></a><font style="vertical-align: inherit;"></font><em class="replaceable"><code>val</code></em><font style="vertical-align: inherit;"></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            如果事件调度程序处于活动状态，则调度程序有一个线程，当前正在运行的每个事件都有一个线程。</font><font style="vertical-align: inherit;">请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/stored-programs-views.html#events-overview" title="23.4.1事件调度程序概述"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第23.4.1节“事件调度程序概述”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p></li></ul>
</div>
<p>
        <a class="link" href="/mysql-5.7-google-zh/programs.html#mysqladmin" title="4.5.2 mysqladmin  - 用于管理MySQL服务器的客户端"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqladmin processlist</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">只显示连接，复制和事件线程。
</font></font></p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="mysql-test-suite"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.1.2 MySQL测试套件</font></font></h3>

</div>

</div>

</div>
<a class="indexterm" name="idm140527956624816"></a><a class="indexterm" name="idm140527956623328"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        Unix源代码和二进制发行版中包含的测试系统使用户和开发人员可以对MySQL代码执行回归测试。</font><font style="vertical-align: inherit;">这些测试可以在Unix上运行。
      </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        你也可以编写你自己的测试用例。</font><font style="vertical-align: inherit;">有关MySQL测试框架的信息，包括系统要求，请参阅</font></font><a class="ulink" href="http://dev.mysql.com/doc/mysqltest/2.0/en/" target="_top"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http://dev.mysql.com/doc/mysqltest/2.0/en/上</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">提供的手册</font><font style="vertical-align: inherit;">。
      </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        当前的一组测试用例并不测试MySQL中的所有内容，但它应该捕获SQL处理代码，操作系统或库问题中最明显的错误，并且在测试复制时非常全面。</font><font style="vertical-align: inherit;">我们的目标是让测试覆盖100％的代码。</font><font style="vertical-align: inherit;">我们欢迎对我们测试套件的贡献。</font><font style="vertical-align: inherit;">您可能特别希望提供测试来检查对系统至关重要的功能，因为这可以确保所有未来的MySQL版本都能够与您的应用程序一起正常工作。
      </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        测试系统由测试语言解释器（</font></font><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqltest</font></font></strong></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">），运行所有测试的Perl脚本（</font></font><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql-test-run.pl</font></font></strong></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">），用特殊测试语言编写的实际测试用例及其预期结果组成。</font><font style="vertical-align: inherit;">要在构建之后在系统上运行测试套件，请</font><font style="vertical-align: inherit;">从源根目录</font><font style="vertical-align: inherit;">键入
         </font></font><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">make test</font></font></strong></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，或将位置更改为该</font></font><code class="filename">mysql-test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">目录并键入</font></font><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">./mysql-test-run.pl</font></font></strong></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">如果您安装了二进制分发版，请将位置更改
         </font></font><code class="filename">mysql-test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为安装根目录下的目录（例如，
         </font></font><code class="filename">/usr/local/mysql/mysql-test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">），然后运行
         </font></font><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">./mysql-test-run.pl</font></font></strong></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">所有测试都应该成功。</font><font style="vertical-align: inherit;">如果有的话，请随时尝试找出原因并报告问题，如果它指出MySQL中的错误。</font><font style="vertical-align: inherit;">请参见
         </font></font><a class="xref" href="/mysql-5.7-google-zh/introduction.html#bug-reports" title="1.7如何报告错误或问题"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第1.7节“如何报告错误或问题”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
      </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        如果一个测试失败，您应该运行
         </font></font><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql-test-run.pl</font></font></strong></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，并
         </font></font><code class="option">--force</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">选择是否有其他测试失败。
      </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        如果您</font><font style="vertical-align: inherit;">希望运行测试套件的计算机上运行</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的副本，</font><font style="vertical-align: inherit;">则只要不使用端口</font></font><code class="literal">9306</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或</font><font style="vertical-align: inherit;">端口，就不必停止它
         </font></font><code class="literal">9307</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">如果其中任何一个端口被占用，则应该将
         </font></font><code class="literal">MTR_BUILD_THREAD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">环境变量设置为适当的值，并且测试套件将使用不同的主端口，从端口和NDB端口组）。</font><font style="vertical-align: inherit;">例如：
      </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shell&gt; export MTR_BUILD_THREAD = 31</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
shell&gt; ./mysql-test-run.pl [ </font></font><em class="replaceable"><code>options</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">] [ </font></font><em class="replaceable"><code>test_name</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">]
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        在</font></font><code class="filename">mysql-test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">目录中，您可以使用</font></font><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">./mysql-test-run.pl
        </font></font><em class="replaceable"><code>test_name</code></em></strong></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">运行单个测试用例</font><font style="vertical-align: inherit;">。
      </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        如果您对测试套件有疑问，或者有测试案例参与，请发送电子邮件至MySQL
         </font></font><code class="literal">internals</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">邮件列表。</font><font style="vertical-align: inherit;">请参见
         </font></font><a class="xref" href="/mysql-5.7-google-zh/introduction.html#mailing-lists" title="1.6.2 MySQL邮件列表"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第1.6.2节“MySQL邮件列表”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p>
</div>

</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h2 class="title" style="clear: both"><a name="plugin-api"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2 MySQL插件API</font></font></h2>

</div>

</div>

</div>
<div class="toc">
<dl class="toc"><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#plugin-types"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.1插件的类型</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#plugin-api-characteristics"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.2插件API特性</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#plugin-api-components"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.3插件API组件</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#writing-plugins"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.4编写插件</font></font></a></span></dt></dl>
</div>
<a class="indexterm" name="idm140527956598672"></a><a class="indexterm" name="idm140527956597600"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      MySQL支持一个可以创建服务器组件的插件API。</font><font style="vertical-align: inherit;">可以在服务器启动时加载插件，或者在运行时加载和卸载插件，而无需重新启动服务器。</font><font style="vertical-align: inherit;">该API是通用的，并不指定插件可以做什么。</font><font style="vertical-align: inherit;">此接口支持的组件包括但不限于存储引擎，全文分析器插件和服务器扩展。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      例如，可以使用全文分析器插件来替换或扩充内置的全文分析器。</font><font style="vertical-align: inherit;">插件可以使用与内置解析器使用的规则不同的规则将文本解析为单词。</font><font style="vertical-align: inherit;">如果需要解析具有与内置解析器所期望的不同特征的文本，这可能很有用。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      插件接口比旧的用户​​定义函数（UDF）接口更普遍。

    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      插件接口使用</font><font style="vertical-align: inherit;">数据库中</font><font style="vertical-align: inherit;">的</font></font><code class="literal">plugin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表</font></font><code class="literal">mysql</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">来记录关于通过</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#install-plugin" title="13.7.3.3安装PLUGIN语法"><code class="literal">INSTALL PLUGIN</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句</font><font style="vertical-align: inherit;">永久安装的插件的信息
       </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">该表是作为MySQL安装过程的一部分创建的。</font><font style="vertical-align: inherit;">使用该</font></font><code class="option">--plugin-load</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">选项</font><font style="vertical-align: inherit;">也可以为单个服务器调用安装插件</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">以这种方式安装的插件不会记录在</font></font><code class="literal">plugin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表格中。</font><font style="vertical-align: inherit;">请参见
       </font></font><a class="xref" href="/mysql-5.7-google-zh/server-administration.html#server-plugin-loading" title="5.5.1安装和卸载插件"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第5.5.1节“安装和卸载插件”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      除了服务器插件以外，MySQL还支持用于客户端插件的API。</font><font style="vertical-align: inherit;">例如，这可以通过身份验证插件使用，其中服务器端插件和客户端插件配合使客户端通过各种身份验证方法连接到服务器。
</font></font></p>
<h3><a name="idm140527956587264"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">其他资源</font></font></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">由Sergei Golubchik和Andrew Hutchings </font><font style="vertical-align: inherit;">
      撰写的</font></font><em class="citetitle"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL 5.1插件开发</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">书</font><font style="vertical-align: inherit;">提供了关于插件API的大量细节。</font><font style="vertical-align: inherit;">尽管本书的标题引用了MySQL Server 5.1，但其中的大部分信息也适用于更高版本。
</font></font></p>
<div class="section">

<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="plugin-types"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.1插件的类型</font></font></h3>
</div>
</div>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        插件API可以创建实现多种功能的插件：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            <a class="link" href="/mysql-5.7-google-zh/extending-mysql.html#storage-engine-plugin-type" title="存储引擎插件"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">存储引擎</font></font></a>
          </p></li><li class="listitem"><p>
            <a class="link" href="/mysql-5.7-google-zh/extending-mysql.html#full-text-plugin-type" title="全文解析器插件"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">全文分析器</font></font></a>
          </p></li><li class="listitem"><p>
            <a class="link" href="/mysql-5.7-google-zh/extending-mysql.html#daemon-plugin-type" title="守护进程插件"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">守护进程</font></font></a>
          </p></li><li class="listitem"><p>
            <a class="link" href="/mysql-5.7-google-zh/extending-mysql.html#information-schema-plugin-type" title="INFORMATION_SCHEMA插件"><code class="literal">INFORMATION_SCHEMA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            表</font></font></a>
          </p></li><li class="listitem"><p>
            <a class="link" href="/mysql-5.7-google-zh/extending-mysql.html#semisynchronous-replication-plugin-type" title="半同步复制插件"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">半同步复制</font></font></a>
          </p></li><li class="listitem"><p>
            <a class="link" href="/mysql-5.7-google-zh/extending-mysql.html#audit-plugin-type" title="审计插件"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">审计</font></font></a>
          </p></li><li class="listitem"><p>
            <a class="link" href="/mysql-5.7-google-zh/extending-mysql.html#authentication-plugin-type" title="身份验证插件"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">认证</font></font></a>
          </p></li><li class="listitem"><p>
            <a class="link" href="/mysql-5.7-google-zh/extending-mysql.html#password-validation-plugin-type" title="密码验证插件"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">密码验证和强度检查</font></font></a>
          </p></li><li class="listitem"><p>
            <a class="link" href="/mysql-5.7-google-zh/extending-mysql.html#protocol-trace-plugin-type" title="协议跟踪插件"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">协议追踪</font></font></a>
          </p></li><li class="listitem"><p>
            <a class="link" href="/mysql-5.7-google-zh/extending-mysql.html#query-rewrite-plugin-type" title="查询重写插件"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">查询重写</font></font></a>
          </p></li><li class="listitem"><p>
            <a class="link" href="/mysql-5.7-google-zh/extending-mysql.html#keyring-plugin-type" title="Keyring插件"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">安全密钥环存储和检索</font></font></a>
</p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        以下各节提供了这些插件类型的概述。
</font></font></p>
<div class="simplesect">

<div class="titlepage">
<div>

<div class="simple">
<h4 class="title"><a name="storage-engine-plugin-type"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">存储引擎插件</font></font></h4>
</div>
</div>
</div>
<a class="indexterm" name="idm140527956562416"></a><a class="indexterm" name="idm140527956561344"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          MySQL服务器使用的可插拔存储引擎架构使得存储引擎可以被编写为插件，并可以从正在运行的服务器中加载和卸载。</font><font style="vertical-align: inherit;">有关此体系结构的描述，请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/storage-engines.html#pluggable-storage-overview" title="15.11 MySQL存储引擎架构概述"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第15.11节“MySQL存储引擎体系结构概述”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          有关如何使用插件API写入存储引擎的信息，请参阅
           </font></font><a class="ulink" href="http://dev.mysql.com/doc/internals/en/custom-engine.html" target="_top"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL内部：编写自定义存储引擎</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p>
</div>
<div class="simplesect">
<div class="titlepage">
<div>
<div class="simple">
<h4 class="title"><a name="full-text-plugin-type"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">全文解析器插件</font></font></h4>

</div>

</div>

</div>
<a class="indexterm" name="idm140527956556000"></a><a class="indexterm" name="idm140527956554944"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          MySQL有一个内置的解析器，默认情况下它用于全文操作（解析要编入索引的文本，或解析查询字符串以确定用于搜索的术语）。</font><font style="vertical-align: inherit;">内置的全文分析器支持
           </font></font><code class="literal">InnoDB</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><code class="literal">MyISAM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          表。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          MySQL还有一个支持中文，日文和韩文（CJK）的基于字符的ngram全文分析器，以及一个支持日文的基于字的MeCab分析器插件，用于
           </font></font><code class="literal">InnoDB</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><code class="literal">MyISAM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          表格。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          对于全文处理，</font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">解析</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">意味着</font><font style="vertical-align: inherit;">从文本或基于定义哪些字符序列组成单词的规则的查询字符串中</font><font style="vertical-align: inherit;">提取单词（或者</font><font style="vertical-align: inherit;">在基于n-gram字符的解析器的情况下为</font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">令牌</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”）</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，以及词边界在哪里。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          解析索引时，解析器会将每个单词传递给服务器，并将其添加到全文索引中。</font><font style="vertical-align: inherit;">解析查询字符串时，解析器会将每个单词传递给服务器，这会累积用于搜索的单词。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          内置全文分析器的解析属性在</font></font><a class="xref" href="/mysql-5.7-google-zh/functions.html#fulltext-search" title="12.9全文搜索功能"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第12.9节“全文搜索功能”中进行了描述</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这些属性包括确定如何从文本中提取单词的规则。</font><font style="vertical-align: inherit;">解析器受到某些系统变量的影响，这些系统变量会导致排除更短或更长的单词，并通过标识常用单词的停用词列表被忽略。</font><font style="vertical-align: inherit;">有关更多信息，请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/functions.html#fulltext-stopwords" title="12.9.4全文停用词"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第12.9.4节“全文停用词”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
           </font></font><a class="xref" href="/mysql-5.7-google-zh/functions.html#fulltext-fine-tuning" title="12.9.6微调MySQL全文搜索"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第12.9.6节“微调MySQL全文搜索”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          插件API使您能够使用默认的内置全文分析器以外的全文分析器。</font><font style="vertical-align: inherit;">例如，如果您使用的是日语，则可以选择使用MeCab全文分析器。</font><font style="vertical-align: inherit;">插件API还使您能够提供自己的全文解析器，以便控制解析器的基本职责。</font><font style="vertical-align: inherit;">解析器插件可以以两种角色中的任意一种来操作：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              该插件可以替换内置的解析器。</font><font style="vertical-align: inherit;">在这个角色中，插件读取要解析的输入，将其拆分为单词，并将单词传递给服务器（用于索引或令牌累积）。</font><font style="vertical-align: inherit;">ngram和MeCab解析器用作内置全文解析器的替代品。
            </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              如果您需要使用与内置解析器不同的规则来确定如何将输入拆分为单词，则可以选择提供自己的全文解析器。</font><font style="vertical-align: inherit;">例如，内置解析器认为文本
               </font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">区分大小写</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">由两个单词
               </font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">case</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sensitive</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”组成，</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">而应用程序可能需要将文本视为单个单词。
            </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              该插件可以作为它的前端与内置解析器一起使用。</font><font style="vertical-align: inherit;">在这个角色中，插件从输入中提取文本并将文本传递给解析器，解析器使用正常的解析规则将文本拆分为单词。</font><font style="vertical-align: inherit;">此分析是受影响
               </font><font style="vertical-align: inherit;">
              或</font><font style="vertical-align: inherit;">
              系统变量和停止字。
            </font></font><code class="literal">innodb_ft_<em class="replaceable"><code>xxx</code></em></code><font style="vertical-align: inherit;"></font><code class="literal">ft_<em class="replaceable"><code>xxx</code></em></code><font style="vertical-align: inherit;"></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              以这种方式使用解析器的一个原因是，您需要对诸如PDF文档，XML文档或</font></font><code class="filename">.doc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文件</font><font style="vertical-align: inherit;">等内容进行索引
               </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">内置解析器不适用于这些类型的输入，但插件可以从这些输入源中提取文本并将其传递给内置解析器。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          解析器插件也可以在两种角色中操作。</font><font style="vertical-align: inherit;">也就是说，它可以从noncleartext输入中提取文本（前端角色），并将文本解析为单词（从而替换内置解析器）。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          全文插件与每个索引的全文索引相关联。</font><font style="vertical-align: inherit;">也就是说，当您最初安装解析器插件时，并不会导致它用于任何全文操作。</font><font style="vertical-align: inherit;">它只是变得可用。</font><font style="vertical-align: inherit;">例如，全文解析器插件</font></font><code class="literal">WITH PARSER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在创建单个</font></font><code class="literal">FULLTEXT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">索引</font><font style="vertical-align: inherit;">时</font><font style="vertical-align: inherit;">变得可以在</font><font style="vertical-align: inherit;">子句中
           </font><font style="vertical-align: inherit;">命名
           </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">要在创建表时创建这样的索引，请执行以下操作：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CREATE TABLE t</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
（</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  doc CHAR（255），</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  FULLTEXT INDEX（doc）WITH PARSER parser_name</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
）ENGINE = InnoDB;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          或者可以在创建表后添加索引：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ALTER TABLE t ADD FULLTEXT INDEX（doc）WITH PARSER parser_name;
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          将分析器与索引关联的唯一SQL更改是</font></font><code class="literal">WITH PARSER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">子句。</font><font style="vertical-align: inherit;">搜索与以前一样被指定，不需要对查询进行任何更改。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          当您将解析器插件与</font></font><code class="literal">FULLTEXT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">索引</font><font style="vertical-align: inherit;">关联时
           </font><font style="vertical-align: inherit;">，插件对于使用索引是必需的。</font><font style="vertical-align: inherit;">如果解析器插件被删除，则与其关联的任何索引都将无法使用。</font><font style="vertical-align: inherit;">任何尝试使用插件不可用的表都会导致错误，尽管</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#drop-table" title="13.1.29 DROP TABLE语法"><code class="literal">DROP TABLE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">仍然有可能。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          有关全文插件的更多信息，请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#writing-full-text-plugins" title="28.2.4.4编写全文解析器插件"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.2.4.4节“编写全文解析器插件”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">MySQL 5.7支持带有</font></font><a class="link" href="/mysql-5.7-google-zh/storage-engines.html#myisam-storage-engine" title="15.2 MyISAM存储引擎"><code class="literal">MyISAM</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
           </font><font style="vertical-align: inherit;">的全文插件
           </font></font><a class="link" href="/mysql-5.7-google-zh/innodb-storage-engine.html" title="第14章InnoDB存储引擎"><code class="literal">InnoDB</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p>
</div>
<div class="simplesect">
<div class="titlepage">
<div>
<div class="simple">
<h4 class="title"><a name="daemon-plugin-type"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">守护进程插件</font></font></h4>

</div>

</div>

</div>
<a class="indexterm" name="idm140527956521152"></a><a class="indexterm" name="idm140527956520080"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          守护进程插件是一种简单类型的插件，用于应该由服务器运行但不与其通信的代码。</font><font style="vertical-align: inherit;">MySQL发行版包括一个示例守护进程插件，用于将定期心跳消息写入文件。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          有关守护进程插件的更多信息，请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#writing-daemon-plugins" title="28.2.4.5编写守护进程插件"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.2.4.5节“编写守护进程插件”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p>
</div>
<div class="simplesect">
<div class="titlepage">
<div>
<div class="simple">
<h4 class="title"><a name="information-schema-plugin-type"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">INFORMATION_SCHEMA插件</font></font></h4>

</div>

</div>

</div>
<a class="indexterm" name="idm140527956515440"></a><a class="indexterm" name="idm140527956514352"></a><p>
          <code class="literal">INFORMATION_SCHEMA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">插件可以创建包含通过</font></font><code class="literal">INFORMATION_SCHEMA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          数据库</font><font style="vertical-align: inherit;">向用户公开的服务器元数据的表</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">例如，</font></font><code class="literal">InnoDB</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用
           </font></font><code class="literal">INFORMATION_SCHEMA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">插件来提供包含当前事务和锁定信息的表。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          有关</font></font><code class="literal">INFORMATION_SCHEMA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">插件的</font><font style="vertical-align: inherit;">更多信息
           </font><font style="vertical-align: inherit;">，请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#writing-information-schema-plugins" title="28.2.4.6编写INFORMATION_SCHEMA插件"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.2.4.6节“编写INFORMATION_SCHEMA插件”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p>
</div>
<div class="simplesect">
<div class="titlepage">
<div>
<div class="simple">
<h4 class="title"><a name="semisynchronous-replication-plugin-type"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">半同步复制插件</font></font></h4>

</div>

</div>

</div>
<a class="indexterm" name="idm140527956506160"></a><a class="indexterm" name="idm140527956505072"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          默认情况下，MySQL复制是异步的。</font><font style="vertical-align: inherit;">使用半同步复制，在主端执行的提交会在返回执行事务的会话之前阻止，直到至少一个从服务器确认它已接收并记录事务的事件。</font><font style="vertical-align: inherit;">半同步复制通过互补的主插件和客户端插件实现。</font><font style="vertical-align: inherit;">请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/replication.html#replication-semisync" title="16.3.9半同步复制"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第16.3.9节“半同步复制”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          有关半同步复制插件的更多信息，请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#writing-semisynchronous-replication-plugins" title="28.2.4.7编写半同步复制插件"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.2.4.7节“编写</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">半同步复制插件
           </font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#writing-semisynchronous-replication-plugins" title="28.2.4.7编写半同步复制插件"><font style="vertical-align: inherit;">”</font></a><font style="vertical-align: inherit;">。
</font></font></p>
</div>
<div class="simplesect">
<div class="titlepage">
<div>
<div class="simple">
<h4 class="title"><a name="audit-plugin-type"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">审计插件</font></font></h4>

</div>

</div>

</div>
<a class="indexterm" name="idm140527956499520"></a><a class="indexterm" name="idm140527956498448"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          MySQL服务器提供了一个可插入的审计界面，可以将有关服务器操作的信息报告给相关方。</font><font style="vertical-align: inherit;">对这些操作发生审计通知（尽管接口是通用的，并且可以修改服务器以报告其他人）：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              将消息写入常规查询日志（如果日志已启用）
            </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              将消息写入错误日志
            </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              将查询结果发送给客户端
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          审计插件可以向审计界面注册以接收关于服务器操作的通知。</font><font style="vertical-align: inherit;">当服务器中发生可审计的事件时，服务器将确定是否需要通知。</font><font style="vertical-align: inherit;">对于每个注册的审计插件，服务器都会根据插件感兴趣的事件类检查事件，并在事件匹配时将事件传递给插件。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          该接口使审计插件只接收有关他们认为重要的事件类中的操作的通知，并忽略其他人。</font><font style="vertical-align: inherit;">该接口提供了将操作分类为事件类并进一步划分为每个类内的事件子类。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          当审计插件收到可审计事件的通知时，它会收到一个指向当前THD结构的指针和一个指向包含有关该事件信息的结构的指针。</font><font style="vertical-align: inherit;">插件可以检查事件并执行适合的审核操作。</font><font style="vertical-align: inherit;">例如，插件可以查看生成结果集或记录的语句，结果中的行数，当前用户针对操作的人员或失败操作的错误代码。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          有关审计插件的更多信息，请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#writing-audit-plugins" title="28.2.4.8编写审计插件"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.2.4.8节“编写审计插件”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p>
</div>
<div class="simplesect">
<div class="titlepage">
<div>
<div class="simple">
<h4 class="title"><a name="authentication-plugin-type"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">身份验证插件</font></font></h4>

</div>

</div>

</div>
<a class="indexterm" name="idm140527956488224"></a><a class="indexterm" name="idm140527956487152"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          MySQL支持可插入的身份验证。</font><font style="vertical-align: inherit;">身份验证插件存在于服务器和客户端。</font><font style="vertical-align: inherit;">服务器端的插件实现了客户端连接到服务器时使用的身份验证方法。</font><font style="vertical-align: inherit;">客户端上的插件与服务器端插件进行通信，以提供它所需的身份验证信息。</font><font style="vertical-align: inherit;">客户端插件可以与用户交互，执行任务，例如请求密码或其他认证凭证发送到服务器。</font><font style="vertical-align: inherit;">参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/security.html#pluggable-authentication" title="6.3.9可插入认证"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第6.3.9节“可插入认证”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          可插入认证还启用代理用户功能，其中一个用户获取另一个用户的身份。</font><font style="vertical-align: inherit;">服务器端认证插件可以向服务器返回连接用户应具有的用户的名称。</font><font style="vertical-align: inherit;">参见</font></font><a class="xref" href="/mysql-5.7-google-zh/security.html#proxy-users" title="6.3.10代理用户"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第6.3.10节“代理用户”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          有关认证插件的更多信息，请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#writing-authentication-plugins" title="28.2.4.9编写认证插件"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.2.4.9节“编写认证插件”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p>
</div>
<div class="simplesect">
<div class="titlepage">
<div>
<div class="simple">
<h4 class="title"><a name="password-validation-plugin-type"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">密码验证插件</font></font></h4>

</div>

</div>

</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          MySQL服务器为编写测试密码的插件提供了一个接口。</font><font style="vertical-align: inherit;">这样的插件实现了两个功能：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              在分配密码（例如</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#create-user" title="13.7.1.2 CREATE USER语法"><code class="literal">CREATE
              USER</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#alter-user" title="13.7.1.1 ALTER USER语法"><code class="literal">ALTER
              USER</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句）的</font><font style="vertical-align: inherit;">语句中拒绝太弱的密码</font><font style="vertical-align: inherit;">，以及作为参数给出的密码</font></font><a class="link" href="/mysql-5.7-google-zh/functions.html#function_password"><code class="literal">PASSWORD()</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              和</font></font><a class="link" href="/mysql-5.7-google-zh/functions.html#function_old-password"><code class="literal">OLD_PASSWORD()</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              函数。
            </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              评估</font></font><a class="link" href="/mysql-5.7-google-zh/functions.html#function_validate-password-strength"><code class="literal">VALIDATE_PASSWORD_STRENGTH()</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              SQL函数</font><font style="vertical-align: inherit;">潜在密码的强度
               </font><font style="vertical-align: inherit;">。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          有关编写此类插件的信息，请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#writing-password-validation-plugins" title="28.2.4.10编写密码验证插件"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.2.4.10节“编写密码验证插件”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p>
</div>
<div class="simplesect">
<div class="titlepage">
<div>
<div class="simple">
<h4 class="title"><a name="protocol-trace-plugin-type"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">协议跟踪插件</font></font></h4>

</div>

</div>

</div>
<a class="indexterm" name="idm140527956468640"></a><a class="indexterm" name="idm140527956467568"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          MySQL支持使用协议跟踪插件：使用客户端/服务器协议实现客户端与服务器之间通信跟踪的客户端插件。</font><font style="vertical-align: inherit;">此功能可以在MySQL 5.7.2及更高版本中使用。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          有关协议跟踪插件的更多信息，请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#writing-protocol-trace-plugins" title="28.2.4.11编写协议跟踪插件"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.2.4.11节“编写协议跟踪插件”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p>
</div>
<div class="simplesect">
<div class="titlepage">
<div>
<div class="simple">
<h4 class="title"><a name="query-rewrite-plugin-type"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">查询重写插件</font></font></h4>

</div>

</div>

</div>
<a class="indexterm" name="idm140527956462944"></a><a class="indexterm" name="idm140527956461872"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          从MySQL 5.7.6开始，MySQL服务器支持查询重写插件，可以在服务器执行它们之前检查并可能修改服务器接收的语句。</font><font style="vertical-align: inherit;">查询重写插件在服务器解析它们之前或之后需要声明。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          一个准备查询重写插件有这些特点：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              该插件允许在服务器处理之前重写到达服务器的SQL语句。
            </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              该插件接收一个语句字符串并可能返回一个不同的字符串。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          后分析查询重写插件具有以下特征：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              该插件支持基于分析树的语句重写。
            </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              服务器解析每个语句并将其分析树传递给可能遍历树的插件。</font><font style="vertical-align: inherit;">该插件可以将原始树返回给服务器以供进一步处理，或者构建不同的树并返回。
            </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              插件可以使用</font></font><code class="literal">mysql_parser</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              插件服务用于这些目的：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                  激活语句摘要计算并获取与性能模式是否产生摘要无关的语句的标准化版本。
                </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                  遍历分析树。
                </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                  解析语句。</font><font style="vertical-align: inherit;">如果插件从分析树构造一个新的语句字符串，这很有用。</font><font style="vertical-align: inherit;">该插件可以让服务器解析字符串以生成一个新树，然后返回该树作为重写语句的表示。
</font></font></p></li></ul>
</div>
</li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          有关插件服务的更多信息，请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#plugin-services" title="28.3用于插件的MySQL服务"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.3节“插件的MySQL服务”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          Preparse和postparse查询重写插件共享这些特征：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              如果安装了查询重写插件，则该
               </font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#option_mysqld_log-raw"><code class="option">--log-raw</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">选项会影响语句记录，如下所示：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                  如果没有</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#option_mysqld_log-raw"><code class="option">--log-raw</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，服务器将记录查询重写插件返回的语句。</font><font style="vertical-align: inherit;">这可能与收到的声明有所不同。
                </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                  使用时</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#option_mysqld_log-raw"><code class="option">--log-raw</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，服务器将收到的原始语句记录下来。
</font></font></p></li></ul>
</div>
</li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              如果插件重写语句，服务器将根据重写的语句（而不是原始语句）决定是否将其写入二进制日志（从而写入任何复制从服务器）。</font><font style="vertical-align: inherit;">如果插件仅</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#select" title="13.2.9 SELECT语法"><code class="literal">SELECT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#select" title="13.2.9 SELECT语法"><code class="literal">SELECT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句</font><font style="vertical-align: inherit;">重写
               </font><font style="vertical-align: inherit;">为
               </font><font style="vertical-align: inherit;">语句，则不会影响二进制日志记录，因为服务器不会将</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#select" title="13.2.9 SELECT语法"><code class="literal">SELECT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句</font><font style="vertical-align: inherit;">写入</font><font style="vertical-align: inherit;">二进制日志。
            </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              如果插件重写语句，则服务器会生成一条</font></font><code class="literal">Note</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">消息，客户端可以使用</font><font style="vertical-align: inherit;">该
               </font><font style="vertical-align: inherit;">消息进行查看</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-warnings" title="13.7.5.40 SHOW WARNINGS语法"><code class="literal">SHOW WARNINGS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">消息具有这种格式，</font></font><em class="replaceable"><code>stmt_in</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">原始语句和</font></font><em class="replaceable"><code>stmt_out</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重写语句</font><font style="vertical-align: inherit;">在哪里
               </font><font style="vertical-align: inherit;">：
            </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">查询' </font><font style="vertical-align: inherit;">通过查询重写插件</font></font><em class="replaceable"><code>stmt_in</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重写为' </font></font><em class="replaceable"><code>stmt_out</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'
</font></font></pre></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          MySQL发行版包含一个名为postparse query rewrite的插件</font></font><code class="literal">Rewriter</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这个插件是基于规则的。</font><font style="vertical-align: inherit;">您可以将行添加到其规则表以导致
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#select" title="13.2.9 SELECT语法"><code class="literal">SELECT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句重写。</font><font style="vertical-align: inherit;">有关更多信息，请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/server-administration.html#rewriter-query-rewrite-plugin" title="5.5.4重写器查询重写插件"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">部分5.5.4，“重写器查询重写插件”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          查询重写插件使用与审计插件相同的API。</font><font style="vertical-align: inherit;">有关审计插件的更多信息，请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#writing-audit-plugins" title="28.2.4.8编写审计插件"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.2.4.8节“编写审计插件”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p>
</div>
<div class="simplesect">
<div class="titlepage">
<div>
<div class="simple">
<h4 class="title"><a name="keyring-plugin-type"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keyring插件</font></font></h4>

</div>

</div>

</div>
<a class="indexterm" name="idm140527956424976"></a><a class="indexterm" name="idm140527956423904"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          从MySQL 5.7.11开始，MySQL服务器支持密钥环插件，可以使内部服务器组件和插件安全地存储敏感信息以供日后检索。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          所有的MySQL发行版都包含一个名为keyring的插件
           </font></font><code class="literal">keyring_file</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">MySQL企业版发行版包含一个密钥环插件</font></font><code class="literal">keyring_okv</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
           </font></font><code class="literal">keyring_aws</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/security.html#keyring" title="6.5.4 MySQL Keyring"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第6.5.4节“MySQL Keyring”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          有关密钥环插件的更多信息，请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#writing-keyring-plugins" title="28.2.4.12编写密钥环插件"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.2.4.12节“编写密钥环插件”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p>
</div>

</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="plugin-api-characteristics"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.2插件API特性</font></font></h3>

</div>

</div>

</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        服务器插件API具有以下特征：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            所有插件都有几个共同点。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            每个插件都有一个可以在SQL语句中引用的名称，以及提供其他信息的其他元数据（如作者和描述）。</font><font style="vertical-align: inherit;">这些信息可以在
             </font></font><a class="link" href="/mysql-5.7-google-zh/information-schema.html#plugins-table" title="24.16 INFORMATION_SCHEMA插件表"><code class="literal">INFORMATION_SCHEMA.PLUGINS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            表格中查看或使用</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-plugins" title="13.7.5.25 SHOW PLUGINS语法"><code class="literal">SHOW
            PLUGINS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">声明。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            插件框架可以扩展以适应不同种类的插件。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            尽管插件API的某些方面对所有类型的插件都是通用的，但API也允许类型特定的接口元素，以便可以创建不同类型的插件。</font><font style="vertical-align: inherit;">一个具有一个目的的插件可以有一个最适合自己需求的接口，而不是其他插件类型的需求。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            存在多种类型插件的接口，例如存储引擎，全文分析器和
             </font></font><code class="literal">INFORMATION_SCHEMA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表格。</font><font style="vertical-align: inherit;">其他可以添加。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            插件可以向用户公开信息。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            插件可以实现通过</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-variables" title="13.7.5.39 SHOW VARIABLES语法"><code class="literal">SHOW
            VARIABLES</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-status" title="13.7.5.35 SHOW STATUS语法"><code class="literal">SHOW
            STATUS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句</font><font style="vertical-align: inherit;">可用的系统和状态变量</font><font style="vertical-align: inherit;">。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            插件API包含版本信息。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            包含在插件API中的版本信息使得插件库和它包含的每个插件都能够自我识别用于构建库的API版本。</font><font style="vertical-align: inherit;">如果API随时间变化，版本号将会改变，但服务器可以检查给定的插件库的版本信息，以确定它是否支持库中的插件。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            有两种类型的版本号。</font><font style="vertical-align: inherit;">第一个是通用插件框架本身的版本。</font><font style="vertical-align: inherit;">每个插件库都包含这种版本号。</font><font style="vertical-align: inherit;">第二种类型的版本适用于单个插件。</font><font style="vertical-align: inherit;">每种特定类型的插件都有一个用于其接口的版本，因此库中的每个插件都有一个类型特定的版本号。</font><font style="vertical-align: inherit;">例如，包含全文分析器插件的库具有通用插件API版本号，并且插件具有特定于全文插件接口的版本号。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            插件API实现安全限制。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            插件库必须安装在特定的专用目录中，该目录由服务器控制，并且不能在运行时更改。</font><font style="vertical-align: inherit;">此外，该库必须包含将其标识为插件库的特定符号。</font><font style="vertical-align: inherit;">如果服务器不是作为插件构建的，则服务器不会将其作为插件加载。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            插件可以访问服务器服务。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            服务接口公开了插件可以使用普通函数调用访问的服务器功能。</font><font style="vertical-align: inherit;">有关详细信息，请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#plugin-services" title="28.3用于插件的MySQL服务"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.3节“用于插件的MySQL服务”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        在某些方面，服务器插件API与它取代的旧的用户定义函数（UDF）API相似，但插件API与旧界面相比具有几个优点。</font><font style="vertical-align: inherit;">例如，UDF没有版本信息。</font><font style="vertical-align: inherit;">另外，较新的插件接口消除了旧的UDF接口的安全问题。</font><font style="vertical-align: inherit;">用于编写非插件UDF的旧接口允许从系统的动态链接器搜索的任何目录加载库，并且标识UDF库的符号相对非特定。
      </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        客户端插件API具有类似的架构特征，但客户端插件无法像服务器插件那样直接访问服务器。
</font></font></p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="plugin-api-components"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.3插件API组件</font></font></h3>

</div>

</div>

</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        服务器插件实现包含几个组件。
      </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        SQL语句：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            <a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#install-plugin" title="13.7.3.3安装PLUGIN语法"><code class="literal">INSTALL PLUGIN</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在</font></font><code class="literal">mysql.plugin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表中</font><font style="vertical-align: inherit;">注册一个插件</font><font style="vertical-align: inherit;">并加载插件代码。
          </font></font></p></li><li class="listitem"><p>
            <a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#uninstall-plugin" title="13.7.3.4卸载PLUGIN语法"><code class="literal">UNINSTALL PLUGIN</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">取消</font></font><code class="literal">mysql.plugin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注册表中的插件并卸载插件代码。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            该</font></font><code class="literal">WITH PARSER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">全文索引创建子句关联与给定的全文解析器插件</font></font><code class="literal">FULLTEXT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">索引。
          </font></font></p></li><li class="listitem"><p>
            <a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-plugins" title="13.7.5.25 SHOW PLUGINS语法"><code class="literal">SHOW PLUGINS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 显示关于服务器插件的信息。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        命令行选项和系统变量：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            该</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#option_mysqld_plugin-load"><code class="option">--plugin-load</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">选项使插件可以在服务器启动时加载。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            该</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_plugin_dir"><code class="literal">plugin_dir</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统变量指示必须在其中安装的所有插件的目录位置。</font><font style="vertical-align: inherit;">这个变量的值可以在服务器启动时用一个</font><font style="vertical-align: inherit;">
            选项</font><font style="vertical-align: inherit;">指定
             </font><font style="vertical-align: inherit;">。</font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysql-config" title="4.7.1 mysql_config  - 显示编译客户端的选项"><span class="command"><strong><font style="vertical-align: inherit;">mysql_config --plugindir</font></strong></span></a><font style="vertical-align: inherit;">显示默认的插件目录路径名。
</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_plugin_dir"><code class="option">--plugin_dir=<em class="replaceable"><code>dir_name</code></em></code></a><font style="vertical-align: inherit;"></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysql-config" title="4.7.1 mysql_config  - 显示编译客户端的选项"><span class="command"><strong><font style="vertical-align: inherit;"></font></strong></span></a><font style="vertical-align: inherit;"></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        有关插件加载的更多信息，请参见
         </font></font><a class="xref" href="/mysql-5.7-google-zh/server-administration.html#server-plugin-loading" title="5.5.1安装和卸载插件"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第5.5.1节“安装和卸载插件”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
      </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        与插件相关的表格：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            该</font></font><a class="link" href="/mysql-5.7-google-zh/information-schema.html#plugins-table" title="24.16 INFORMATION_SCHEMA插件表"><code class="literal">INFORMATION_SCHEMA.PLUGINS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            表包含插件信息。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            该</font></font><code class="literal">mysql.plugin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表列出</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#install-plugin" title="13.7.3.3安装PLUGIN语法"><code class="literal">INSTALL
            PLUGIN</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">了插件使用</font><font style="vertical-align: inherit;">时安装的每个插件</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">对于新的MySQL安装，此表在安装过程中创建。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        客户端插件的实现更简单：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            对于</font></font><a class="link" href="/mysql-5.7-google-zh/connectors-apis.html#mysql-options" title="27.8.7.50 mysql_options（）"><code class="literal">mysql_options()</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C API函数，</font></font><code class="literal">MYSQL_DEFAULT_AUTH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
             </font></font><code class="literal">MYSQL_PLUGIN_DIR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">选项使客户端程序能够加载认证插件。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            有C API函数可以管理客户端插件。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        要检查MySQL如何实现插件，请参阅MySQL源代码发布中的以下源文件：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            在</font></font><code class="filename">include/mysql</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">目录中，
             </font></font><code class="filename">plugin.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">公开插件API。</font><font style="vertical-align: inherit;">任何想编写插件库的人都应该检查这个文件。
            </font><font style="vertical-align: inherit;">
            文件提供了与特定类型的插件有关的其他信息。
            </font><font style="vertical-align: inherit;">包含特定于客户端插件的信息。
          </font></font><code class="filename">plugin_<em class="replaceable"><code>xxx</code></em>.h</code><font style="vertical-align: inherit;"></font><code class="filename">client_plugin.h</code><font style="vertical-align: inherit;"></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            在</font></font><code class="filename">sql</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">目录中，
             </font></font><code class="filename">sql_plugin.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并
             </font></font><code class="filename">sql_plugin.cc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">包含内部插件实现。</font></font><code class="filename">sql_acl.cc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是服务器使用认证插件的地方。</font><font style="vertical-align: inherit;">这些文件不需要插件开发者咨询。</font><font style="vertical-align: inherit;">对于那些想知道更多关于服务器如何处理插件的人来说，他们可能会感兴趣。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            在</font></font><code class="filename">sql-common</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">目录中，
             </font></font><code class="filename">client_plugin.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">实现了C API客户端插件功能，并</font></font><code class="literal">client.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            实现了客户端认证支持。</font><font style="vertical-align: inherit;">这些文件不需要插件开发者咨询。</font><font style="vertical-align: inherit;">对于那些想知道更多关于服务器如何处理插件的人来说，他们可能会感兴趣。
</font></font></p></li></ul>
</div>

</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="writing-plugins"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.4编写插件</font></font></h3>

</div>

</div>

</div>
<div class="toc">
<dl class="toc"><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#writing-plugins-overview"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.4.1插件写作概述</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#plugin-data-structures"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.4.2插件数据结构</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#compiling-plugin-libraries"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.4.3编译和安装插件库</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#writing-full-text-plugins"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.4.4编写全文解析器插件</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#writing-daemon-plugins"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.4.5编写守护进程插件</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#writing-information-schema-plugins"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.4.6编写INFORMATION_SCHEMA插件</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#writing-semisynchronous-replication-plugins"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.4.7编写半同步复制插件</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#writing-audit-plugins"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.4.8编写审计插件</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#writing-authentication-plugins"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.4.9编写认证插件</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#writing-password-validation-plugins"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.4.10编写密码验证插件</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#writing-protocol-trace-plugins"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.4.11编写协议跟踪插件</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#writing-keyring-plugins"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.4.12编写密钥环插件</font></font></a></span></dt></dl>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        要创建插件库，您必须提供所需的描述符信息，该信息指示库文件包含哪些插件，并为每个插件编写接口函数。
      </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        每个服务器插件必须有一个向插件API提供信息的通用描述符，以及一个类型特定的描述符，该描述符为给定类型的插件提供有关插件接口的信息。</font><font style="vertical-align: inherit;">一般描述符的结构对于所有插件类型都是相同的。</font><font style="vertical-align: inherit;">类型特定描述符的结构因插件类型而异，由插件需要做什么决定。</font><font style="vertical-align: inherit;">服务器插件接口还允许插件显示状态和系统变量。</font><font style="vertical-align: inherit;">这些变量通过</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-status" title="13.7.5.35 SHOW STATUS语法"><code class="literal">SHOW STATUS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
         </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-variables" title="13.7.5.39 SHOW VARIABLES语法"><code class="literal">SHOW VARIABLES</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句以及相应的</font></font><code class="literal">INFORMATION_SCHEMA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表格</font><font style="vertical-align: inherit;">变得可见
         </font><font style="vertical-align: inherit;">。
      </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        对于客户端插件，体系结构有点不同。</font><font style="vertical-align: inherit;">每个插件都必须有一个描述符，但是没有划分为单独的通用描述符和特定类型的描述符。</font><font style="vertical-align: inherit;">相反，描述符以所有客户端插件类型通用的一组固定成员开始，公共成员之后是实现特定插件类型所需的任何其他成员。
      </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        您可以使用C或C ++编写插件（或可以使用C调用约定的其他语言）。</font><font style="vertical-align: inherit;">插件是动态加载和卸载的，因此您的操作系统必须支持动态加载，并且您必须动态（非静态地）编译调用应用程序。</font><font style="vertical-align: inherit;">对于服务器插件，这意味着</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">必须动态链接。
      </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        服务器插件包含的代码成为运行服务器的一部分，因此，当您编写插件时，您受到任何和所有适用于编写服务器代码的约束的约束。</font><font style="vertical-align: inherit;">例如，如果尝试使用</font></font><code class="literal">libstdc++</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">库中的</font><font style="vertical-align: inherit;">函数，可能会遇到问题</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这些约束可能在服务器的未来版本中发生变化，因此服务器升级可能需要修改最初为旧服务器编写的插件。</font><font style="vertical-align: inherit;">有关这些约束的信息，请参见
         </font></font><a class="xref" href="/mysql-5.7-google-zh/installing.html#source-configuration-options" title="2.9.4 MySQL源配置选项"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第2.9.4节“MySQL源配置选项”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
         </font></font><a class="xref" href="/mysql-5.7-google-zh/installing.html#compilation-problems" title="2.9.5处理编译MySQL的问题"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第2.9.5节“处理编译MySQL的问题”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
      </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        客户端插件编写者应避免依赖于调用应用程序的符号，因为您无法确定哪些应用程序将使用该插件。
</font></font></p>
<div class="section">

<div class="titlepage">
<div>
<div>
<h4 class="title"><a name="writing-plugins-overview"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.4.1插件写作概述</font></font></h4>
</div>
</div>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          以下过程概述了创建插件库所需的步骤。</font><font style="vertical-align: inherit;">接下来的部分提供了关于设置插件数据结构和编写特定类型插件的更多细节。
</font></font></p>
<div class="orderedlist">
<ol class="orderedlist" type="1"><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              在插件源文件中，包含插件库需要的头文件。</font><font style="vertical-align: inherit;">该
               </font></font><code class="filename">plugin.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文件是必需的，并且该库也可能需要其他文件。</font><font style="vertical-align: inherit;">例如：
            </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#include &lt;stdlib.h&gt;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
#include &lt;ctype.h&gt;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
#include &lt;mysql / plugin.h&gt;</font></font><font></font>
</pre></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              设置插件库文件的描述符信息。</font><font style="vertical-align: inherit;">对于服务器插件，编写库描述符，该描述符必须包含文件中每个服务器插件的常规插件描述符。</font><font style="vertical-align: inherit;">有关更多信息，请参见
               </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#server-plugin-descriptors" title="28.2.4.2.1服务器插件库和插件描述符"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.2.4.2.1节“服务器插件库和插件描述符”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">另外，为库中的每个服务器插件设置类型特定的描述符。</font><font style="vertical-align: inherit;">每个插件的一般描述符指向它的类型特定的描述符。
            </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              对于客户端插件，编写客户端描述符。</font><font style="vertical-align: inherit;">有关更多信息，请参见
               </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#client-plugin-descriptors" title="28.2.4.2.3客户端插件描述符"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.2.4.2.3节“客户端插件描述符”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
            </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              为每个插件编写插件接口函数。</font><font style="vertical-align: inherit;">例如，每个插件的通用插件描述符都指向服务器在加载和卸载插件时应调用的初始化和取消初始化函数。</font><font style="vertical-align: inherit;">插件的类型特定描述也可能指向接口函数。
            </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              对于服务器插件，请设置状态和系统变量（如果有）。
            </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              将插件库编译为共享库并将其安装在插件目录中。</font><font style="vertical-align: inherit;">有关更多信息，请参见
               </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#compiling-plugin-libraries" title="28.2.4.3编译和安装插件库"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.2.4.3节“编译和安装插件库”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
            </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              对于服务器插件，将插件注册到服务器。</font><font style="vertical-align: inherit;">有关更多信息，请参见
               </font></font><a class="xref" href="/mysql-5.7-google-zh/server-administration.html#server-plugin-loading" title="5.5.1安装和卸载插件"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第5.5.1节“安装和卸载插件”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
            </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              测试插件以验证它是否正常工作。
</font></font></p></li></ol>
</div>

</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h4 class="title"><a name="plugin-data-structures"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.4.2插件数据结构</font></font></h4>

</div>

</div>

</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          插件库文件包含描述符信息以指示其包含的插件。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          如果插件库包含任何服务器插件，则它必须包含以下描述符信息：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              库描述符指示库使用的通用服务器插件API版本号，并包含库中每个服务器插件的常规插件描述符。</font><font style="vertical-align: inherit;">要为此描述符提供框架，请从头</font></font><code class="filename">plugin.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              文件中</font><font style="vertical-align: inherit;">调用两个宏</font><font style="vertical-align: inherit;">：
            </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql_declare_plugin（</font></font><em class="replaceable"><code>name</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）
 </font></font><em class="replaceable"><code>... one or more server plugin descriptors here ...</code></em><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql_declare_plugin_end;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              宏扩展为自动提供API版本的声明。</font><font style="vertical-align: inherit;">您必须提供插件描述符。
            </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              在库描述符中，每个通用服务器插件都由一个</font></font><code class="literal">st_mysql_plugin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              结构</font><font style="vertical-align: inherit;">描述</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">该插件描述符结构包含每种服务器插件通用的信息：一个表示插件类型的值; </font><font style="vertical-align: inherit;">插件名称，作者，说明和许可证类型; </font><font style="vertical-align: inherit;">指向服务器在加载和卸载插件时调用的初始化和取消初始化函数的指针，以及指向插件实现的任何状态或系统变量的指针。
            </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              库描述符中的每个通用服务器插件描述符还包含指向特定于类型的插件描述符的指针。</font><font style="vertical-align: inherit;">特定于类型的描述符的结构因插件类型而异，因为每种类型的插件都可以拥有自己的API。</font><font style="vertical-align: inherit;">特定于类型的插件描述符包含特定于类型的API版本号和指向实现该插件类型所需的函数的指针。</font><font style="vertical-align: inherit;">例如，全文解析器插件具有初始化和取消初始化函数，以及主解析函数。</font><font style="vertical-align: inherit;">服务器在使用插件解析文本时调用这些函数。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          插件库还包含由库中每个插件的常规和特定于类型的描述符引用的接口函数。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          如果插件库包含客户端插件，则它必须包含插件的描述符。</font><font style="vertical-align: inherit;">描述符以所有客户端插件通用的一组固定成员开始，后面跟随特定于插件类型的任何成员。</font><font style="vertical-align: inherit;">要提供描述符框架，请从头</font></font><code class="filename">client_plugin.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文件中</font><font style="vertical-align: inherit;">调用两个宏
           </font><font style="vertical-align: inherit;">：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql_declare_client_plugin（</font></font><em class="replaceable"><code>plugin_type</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   ... </font></font><em class="replaceable"><code>members common to all client plugins</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">...</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   ... </font></font><em class="replaceable"><code>type-specific extra members</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">...</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql_end_client_plugin;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          插件库还包含客户端描述符引用的任何接口函数。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          在</font></font><code class="literal">mysql_declare_plugin()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
           </font></font><code class="literal">mysql_declare_client_plugin()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">宏在它们如何被调用，这对插件库的内容含义有所不同。</font><font style="vertical-align: inherit;">以下指南总结了这些规则：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              <code class="literal">mysql_declare_plugin()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并且
               </font></font><code class="literal">mysql_declare_client_plugin()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可以在同一个源文件中使用，这意味着插件库可以同时包含服务器和客户端插件。</font><font style="vertical-align: inherit;">但是，每个</font></font><code class="literal">mysql_declare_plugin()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              和</font></font><code class="literal">mysql_declare_client_plugin()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最多可以使用一次。
            </font></font></p></li><li class="listitem"><p>
              <code class="literal">mysql_declare_plugin()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 允许多个服务器插件声明，所以一个插件库可以包含多个服务器插件。
            </font></font></p></li><li class="listitem"><p>
              <code class="literal">mysql_declare_client_plugin()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">只允许一个客户端插件声明。</font><font style="vertical-align: inherit;">要创建多个客户端插件，必须使用单独的插件库。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          当客户端程序查找插件库中没有内置的客户端插件时
           </font></font><code class="literal">libmysqlclient</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，它会查找基本名称与插件名称相同的文件。</font><font style="vertical-align: inherit;">例如，如果某个程序需要使用</font></font><code class="literal">auth_xxx</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在</font></font><code class="filename">.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用作库后缀</font><font style="vertical-align: inherit;">的系统上
           </font><font style="vertical-align: inherit;">命名的客户端身份验证插件
           </font><font style="vertical-align: inherit;">，它会查找名为的文件</font></font><code class="filename">auth_xxx.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">（在OS X上，程序首先查找</font></font><code class="filename">auth_xxx.dylib</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，然后查找</font></font><code class="filename">auth_xxx.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。因此，如果插件库包含客户端插件，则该库必须具有与该插件相同的基本名称。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          包含服务器插件的库也是如此。</font><font style="vertical-align: inherit;">该</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#option_mysqld_plugin-load"><code class="option">--plugin-load</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          选项和</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#install-plugin" title="13.7.3.3安装PLUGIN语法"><code class="literal">INSTALL PLUGIN</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          语句显式提供库文件名，所以库名和它包含的任何服务器插件的名称之间不需要明确的关系。
</font></font></p>
<div class="section">

<div class="titlepage">
<div>
<div>
<h5 class="title"><a name="server-plugin-descriptors"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.4.2.1服务器插件库和插件描述符</font></font></h5>
</div>
</div>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            每个包含服务器插件的插件库都必须包含一个库描述符，其中包含文件中每个服务器插件的常规插件描述符。</font><font style="vertical-align: inherit;">本节讨论如何编写服务器插件的库和一般描述符。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            库描述符必须定义两个符号：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
                <code class="literal">_mysql_plugin_interface_version_</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                指定通用插件框架的版本号。</font><font style="vertical-align: inherit;">这由</font><font style="vertical-align: inherit;">文件中</font></font><code class="literal">MYSQL_PLUGIN_INTERFACE_VERSION</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                定义</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">符号
                 </font><font style="vertical-align: inherit;">给出
                 </font></font><code class="filename">plugin.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">_mysql_plugin_declarations_</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">定义一个插件声明数组，终止于所有成员设置为0的声明。每个声明都是该</font></font><code class="literal">st_mysql_plugin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                结构</font><font style="vertical-align: inherit;">的实例</font><font style="vertical-align: inherit;">（也在其中定义
                 </font></font><code class="filename">plugin.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">库中的每个服务器插件必须具有其中的一个。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            如果服务器在库中找不到这两个符号，则它不会将其作为合法插件库接受并拒绝该错误。</font><font style="vertical-align: inherit;">这可以防止为插件目的使用库，除非它专门构建为插件库。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            定义两个必需符号的传统方法是使用</font><font style="vertical-align: inherit;">文件中</font><font style="vertical-align: inherit;">的</font></font><code class="literal">mysql_declare_plugin()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
             </font></font><code class="literal">mysql_declare_plugin_end</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">宏
             </font></font><code class="filename">plugin.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql_declare_plugin（</font></font><em class="replaceable"><code>name</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）
 </font></font><em class="replaceable"><code>... one or more server plugin descriptors here ...</code></em><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql_declare_plugin_end;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            每个服务器插件必须有一个通用描述符，用于向服务器插件API提供信息。</font><font style="vertical-align: inherit;">一般描述符对于所有插件类型具有相同的结构。</font><font style="vertical-align: inherit;">文件中</font><font style="vertical-align: inherit;">的
             </font></font><code class="literal">st_mysql_plugin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结构
             </font></font><code class="filename">plugin.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">定义了这个描述符：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">struct st_mysql_plugin</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  int类型; </font><font style="vertical-align: inherit;">/ *插件类型（MYSQL_XXX_PLUGIN值）* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  void * info; </font><font style="vertical-align: inherit;">/ *指向类型特定插件描述符的指针* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  const char * name; </font><font style="vertical-align: inherit;">/ *插件名称* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  const char *作者; </font><font style="vertical-align: inherit;">/ *插件作者（用于I_S.PLUGINS）* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  const char * descr; </font><font style="vertical-align: inherit;">/ *一般描述性文本（用于I_S.PLUGINS）* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  int许可证 </font><font style="vertical-align: inherit;">/ *插件许可证（PLUGIN_LICENSE_XXX）* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  int（* init）（void *）; </font><font style="vertical-align: inherit;">/ *加载插件时调用的函数* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  int（* deinit）（void *）; / *插件卸载时调用的函数* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  unsigned int版本; </font><font style="vertical-align: inherit;">/ *插件版本（用于I_S.PLUGINS）* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  struct st_mysql_show_var * status_vars;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  struct st_mysql_sys_var ** system_vars;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  void * __reserved1; </font><font style="vertical-align: inherit;">/ *保留用于依赖性检查* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  无符号长标志; </font><font style="vertical-align: inherit;">/ *插件标志* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
};</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            该</font></font><code class="literal">st_mysql_plugin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">描述符结构构件被使用如下。</font></font><code class="literal">char *</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            成员应该被指定为以空字符结尾的字符串。
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
                <code class="literal">type</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：插件类型。</font><font style="vertical-align: inherit;">这必须是来自以下内容的插件类型值之一
                 </font></font><code class="filename">plugin.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：
              </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ *</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  允许的插件类型</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
#define MYSQL_UDF_PLUGIN 0 / *用户定义的函数* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
#define MYSQL_STORAGE_ENGINE_PLUGIN 1 / *存储引擎* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
#define MYSQL_FTPARSER_PLUGIN 2 / *全文分析器插件* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
#define MYSQL_DAEMON_PLUGIN 3 / *守护进程/原始插件类型* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
#define MYSQL_INFORMATION_SCHEMA_PLUGIN 4 / * I_S插件类型* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
#define MYSQL_AUDIT_PLUGIN 5 / * Audit插件类型* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
#define MYSQL_REPLICATION_PLUGIN 6 / *复制插件类型* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
#define MYSQL_AUTHENTICATION_PLUGIN 7 / *认证插件类型* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                例如，对于全文分析器插件，
                 </font></font><code class="literal">type</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值为
                 </font></font><code class="literal">MYSQL_FTPARSER_PLUGIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">info</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：指向插件类型特定描述符的指针。</font><font style="vertical-align: inherit;">这个描述符的结构取决于特定类型的插件，而不像通用插件描述符结构。</font><font style="vertical-align: inherit;">出于版本控制的目的，每种插件类型的特定于类型的描述符的第一个成员应该是该类型的接口版本。</font><font style="vertical-align: inherit;">这使服务器可以检查每个插件的类型特定版本，而不管其类型。</font><font style="vertical-align: inherit;">在版本号之后，描述符包括所需的任何其他成员，例如服务器正确调用插件所需的回调函数和其他信息。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">name</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：一个给出插件名称的字符串。</font><font style="vertical-align: inherit;">这是将在</font></font><code class="literal">mysql.plugin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表中</font><font style="vertical-align: inherit;">列出的名称，
                 </font><font style="vertical-align: inherit;">以及您在SQL语句（例如</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#install-plugin" title="13.7.3.3安装PLUGIN语法"><code class="literal">INSTALL PLUGIN</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
                 </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#uninstall-plugin" title="13.7.3.4卸载PLUGIN语法"><code class="literal">UNINSTALL PLUGIN</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）中使用该</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#option_mysqld_plugin-load"><code class="option">--plugin-load</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">选项</font><font style="vertical-align: inherit;">引用插件
                 </font><font style="vertical-align: inherit;">的名称</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">该名称也可以在</font></font><a class="link" href="/mysql-5.7-google-zh/information-schema.html#plugins-table" title="24.16 INFORMATION_SCHEMA插件表"><code class="literal">INFORMATION_SCHEMA.PLUGINS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                表格或输出中</font><font style="vertical-align: inherit;">看到
                 </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-plugins" title="13.7.5.25 SHOW PLUGINS语法"><code class="literal">SHOW
                PLUGINS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
              </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                插件名称不应以任何服务器选项的名称开头。</font><font style="vertical-align: inherit;">如果是这样，服务器将无法初始化它。</font><font style="vertical-align: inherit;">例如，服务器有一个
                 </font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#option_mysqld_socket"><code class="option">--socket</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">选项，所以你不应该使用插件名称，例如
                 </font></font><code class="literal">socket</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
                 </font></font><code class="literal">socket_plugin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">等等。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">author</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：一个命名插件作者的字符串。</font><font style="vertical-align: inherit;">这可以是任何你喜欢的。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">desc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：提供插件的一般描述的字符串。</font><font style="vertical-align: inherit;">这可以是任何你喜欢的。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">license</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：插件许可证类型。</font><font style="vertical-align: inherit;">该值可以是一个
                 </font></font><code class="literal">PLUGIN_LICENSE_PROPRIETARY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
                 </font></font><code class="literal">PLUGIN_LICENSE_GPL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
                 </font></font><code class="literal">PLUGIN_LICENSE_BSD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">init</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：一次只有初始化函数，或者</font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果没有这样的函数。</font><font style="vertical-align: inherit;">
                在服务器启动时，服务器</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#install-plugin" title="13.7.3.3安装PLUGIN语法"><code class="literal">INSTALL PLUGIN</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在</font><font style="vertical-align: inherit;">加载插件时执行此功能，该功能发生</font><font style="vertical-align: inherit;">在</font></font><code class="literal">mysql.plugin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表中</font><font style="vertical-align: inherit;">列出</font><font style="vertical-align: inherit;">的插件上，
                 </font><font style="vertical-align: inherit;">或者对于该插件</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">该函数有一个参数指向用于标识插件的内部结构。</font><font style="vertical-align: inherit;">它成功返回零，失败返回非零。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">deinit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：一次只有去初始化功能，或者</font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果没有这样的功能。</font><font style="vertical-align: inherit;">
                在服务器关闭时，服务器</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#uninstall-plugin" title="13.7.3.4卸载PLUGIN语法"><code class="literal">UNINSTALL PLUGIN</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在</font><font style="vertical-align: inherit;">卸载插件时执行该函数，该插件发生</font><font style="vertical-align: inherit;">在</font></font><code class="literal">mysql.plugin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表中</font><font style="vertical-align: inherit;">列出</font><font style="vertical-align: inherit;">的插件上，
                 </font><font style="vertical-align: inherit;">或者针对该插件</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">该函数采用一个参数指向用于标识插件的内部结构。它返回成功为零，失败返回非零。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">version</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：插件版本号。</font><font style="vertical-align: inherit;">当安装插件时，可以从</font></font><a class="link" href="/mysql-5.7-google-zh/information-schema.html#plugins-table" title="24.16 INFORMATION_SCHEMA插件表"><code class="literal">INFORMATION_SCHEMA.PLUGINS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                表格中</font><font style="vertical-align: inherit;">检索该值
                 </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">该值包括主要和次要数字。</font><font style="vertical-align: inherit;">如果你写的值作为一个十六进制常量，格式为
                 </font><font style="vertical-align: inherit;">，其中</font><font style="vertical-align: inherit;">和
                 </font><font style="vertical-align: inherit;">是主要和次要数字，分别。</font><font style="vertical-align: inherit;">例如，</font><font style="vertical-align: inherit;">
                表示版本3.2。
              </font></font><code class="literal">0x<em class="replaceable"><code>MMNN</code></em></code><font style="vertical-align: inherit;"></font><em class="replaceable"><code>MM</code></em><font style="vertical-align: inherit;"></font><code class="literal">NN</code><font style="vertical-align: inherit;"></font><code class="literal">0x0302</code><font style="vertical-align: inherit;"></font></p></li><li class="listitem"><p>
                <code class="literal">status_vars</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：指向与插件关联的状态变量结构的指针，或者
                 </font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果没有这样的变量。</font><font style="vertical-align: inherit;">当安装插件时，这些变量显示在</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-status" title="13.7.5.35 SHOW STATUS语法"><code class="literal">SHOW
                STATUS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句</font><font style="vertical-align: inherit;">的输出中</font><font style="vertical-align: inherit;">。
              </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                该</font></font><code class="literal">status_vars</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">成员如果不是
                 </font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，则指向</font></font><code class="literal">st_mysql_show_var</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">描述状态变量</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">结构</font><font style="vertical-align: inherit;">数组
                 </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">请参见
                 </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#plugin-status-system-variables" title="28.2.4.2.2服务器插件状态和系统变量"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.2.4.2.2节“服务器插件状态和系统变量”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">system_vars</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：指向与插件关联的系统变量结构的指针，或者
                 </font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果没有这样的变量。</font><font style="vertical-align: inherit;">这些选项和系统变量可用于帮助初始化插件中的变量。</font><font style="vertical-align: inherit;">当安装插件时，这些变量显示在</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-variables" title="13.7.5.39 SHOW VARIABLES语法"><code class="literal">SHOW
                VARIABLES</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句</font><font style="vertical-align: inherit;">的输出中</font><font style="vertical-align: inherit;">。
              </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                该</font></font><code class="literal">system_vars</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">成员如果不是
                 </font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，则指向</font></font><code class="literal">st_mysql_sys_var</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">描述系统变量的</font><font style="vertical-align: inherit;">一组
                 </font><font style="vertical-align: inherit;">结构。</font><font style="vertical-align: inherit;">请参见
                 </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#plugin-status-system-variables" title="28.2.4.2.2服务器插件状态和系统变量"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.2.4.2.2节“服务器插件状态和系统变量”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">__reserved1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：未来的占位符。</font><font style="vertical-align: inherit;">它应该设置为</font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">flags</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：插件标志。</font><font style="vertical-align: inherit;">各个位对应不同的标志。</font><font style="vertical-align: inherit;">该值应该设置为适用标志的OR。</font><font style="vertical-align: inherit;">这些标志可用：
              </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#define PLUGIN_OPT_NO_INSTALL 1UL / *不可动态加载* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
#define PLUGIN_OPT_NO_UNINSTALL 2UL / *不能动态卸载* /</font></font><font></font>
</pre><p>
                <code class="literal">PLUGIN_OPT_NO_INSTALL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表示该插件无法在运行时与该</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#install-plugin" title="13.7.3.3安装PLUGIN语法"><code class="literal">INSTALL PLUGIN</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句</font><font style="vertical-align: inherit;">一起加载
                 </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这适用于必须在服务器启动时使用该</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#option_mysqld_plugin-load"><code class="option">--plugin-load</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">选项</font><font style="vertical-align: inherit;">加载的插件
                 </font><font style="vertical-align: inherit;">。
                </font></font><code class="literal">PLUGIN_OPT_NO_UNINSTALL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表示该插件无法在运行时通过该</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#uninstall-plugin" title="13.7.3.4卸载PLUGIN语法"><code class="literal">UNINSTALL PLUGIN</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                语句</font><font style="vertical-align: inherit;">进行卸载
                 </font><font style="vertical-align: inherit;">。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">只有在加载和卸载插件时</font><font style="vertical-align: inherit;">
            ，服务器才调用</font><font style="vertical-align: inherit;">通用插件描述符中的函数</font></font><code class="literal">init</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
             </font></font><code class="literal">deinit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数。</font><font style="vertical-align: inherit;">它们与使用插件无关，例如在SQL语句导致插件被调用时发生。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            例如，包含一个名为单个全文分析器插件的库的描述符信息
             </font></font><code class="literal">simple_parser</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如下所示：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql_declare_plugin（ftexample）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_FTPARSER_PLUGIN，/ * type * /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  ＆simple_parser_descriptor，/ *描述符* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “simple_parser”，/ *名称* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “Oracle Corporation”，/ *作者* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “简单的全文解析器”，/ *描述* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  PLUGIN_LICENSE_GPL，/ *插件许可* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  simple_parser_plugin_init，/ * init函数（加载时）* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  simple_parser_plugin_deinit，/ * deinit函数（卸载时）* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  0x0001，/ *版本* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  simple_status，/ *状态变量* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  simple_system_variables，/ *系统变量* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  空值，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  0</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql_declare_plugin_end;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            对于全文分析器插件，类型必须是
             </font></font><code class="literal">MYSQL_FTPARSER_PLUGIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这是将插件标识为在</font></font><code class="literal">WITH PARSER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">创建</font></font><code class="literal">FULLTEXT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">索引</font><font style="vertical-align: inherit;">时</font><font style="vertical-align: inherit;">适用于
             </font><font style="vertical-align: inherit;">子句的
             </font><font style="vertical-align: inherit;">值。</font><font style="vertical-align: inherit;">（没有其他插件类型对此子句是合法的。）
          </font></font></p><p>
            <code class="filename">plugin.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">像这样</font><font style="vertical-align: inherit;">定义
             </font></font><code class="literal">mysql_declare_plugin()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
             </font></font><code class="literal">mysql_declare_plugin_end</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">宏：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#ifndef MYSQL_DYNAMIC_PLUGIN</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
#define __MYSQL_DECLARE_PLUGIN（NAME，VERSION，PSIZE，DECLS）\</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MYSQL_PLUGIN_EXPORT int VERSION = MYSQL_PLUGIN_INTERFACE_VERSION; </font><font style="vertical-align: inherit;">\</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MYSQL_PLUGIN_EXPORT int PSIZE = sizeof（struct st_mysql_plugin）; </font><font style="vertical-align: inherit;">\</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MYSQL_PLUGIN_EXPORT struct st_mysql_plugin DECLS [] = {</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
＃其他</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
#define __MYSQL_DECLARE_PLUGIN（NAME，VERSION，PSIZE，DECLS）\</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MYSQL_PLUGIN_EXPORT int _mysql_plugin_interface_version_ = MYSQL_PLUGIN_INTERFACE_VERSION; </font><font style="vertical-align: inherit;">\</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MYSQL_PLUGIN_EXPORT int _mysql_sizeof_struct_st_plugin_ = sizeof（struct st_mysql_plugin）; </font><font style="vertical-align: inherit;">\</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MYSQL_PLUGIN_EXPORT struct st_mysql_plugin _mysql_plugin_declarations _ [] = {</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
＃万一</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
#define mysql_declare_plugin（NAME）\</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
__MYSQL_DECLARE_PLUGIN（NAME，\</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                 builtin_ ## NAME ## _plugin_interface_version，\</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                 builtin_ ## NAME ## _sizeof_struct_st_plugin，\</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                 builtin_ ## NAME ## _plugin）</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
#define mysql_declare_plugin_end，{0,0,0,0,0,0,0,0,0,0,0,0,0}}</font></font><font></font>
</pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
注意
</font></font></div>
<p><font style="vertical-align: inherit;"></font><code class="literal">_mysql_plugin_interface_version_</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">只有</font></font><code class="literal">MYSQL_DYNAMIC_PLUGIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">符号被定义时，</font><font style="vertical-align: inherit;">
              这些声明才定义
               </font><font style="vertical-align: inherit;">符号</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这意味着
               </font></font><code class="literal">-DMYSQL_DYNAMIC_PLUGIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">必须作为编译命令的一部分提供，以将该插件构建为共享库。
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            如刚才所示使用宏时，它们展开为以下代码，它定义了所需的两个符号（</font></font><code class="literal">_mysql_plugin_interface_version_</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
             </font></font><code class="literal">_mysql_plugin_declarations_</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">int _mysql_plugin_interface_version_ = MYSQL_PLUGIN_INTERFACE_VERSION;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
int _mysql_sizeof_struct_st_plugin_ = sizeof（struct st_mysql_plugin）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
struct st_mysql_plugin _mysql_plugin_declarations _ [] = {</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_FTPARSER_PLUGIN，/ * type * /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  ＆simple_parser_descriptor，/ *描述符* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “simple_parser”，/ *名称* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “Oracle Corporation”，/ *作者* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “简单的全文解析器”，/ *描述* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  PLUGIN_LICENSE_GPL，/ *插件许可* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  simple_parser_plugin_init，/ * init函数（加载时）* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  simple_parser_plugin_deinit，/ * deinit函数（卸载时）* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  0x0001，/ *版本* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  simple_status，/ *状态变量* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  simple_system_variables，/ *系统变量* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  空值，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  0</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  {0,0,0,0,0,0,0,0,0,0,0,0}}</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
};</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            前面的示例在一般描述符中声明了单个插件，但可以声明多个插件。</font><font style="vertical-align: inherit;">用逗号分隔</font></font><code class="literal">mysql_declare_plugin()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
             </font><font style="vertical-align: inherit;">之间列出声明
             </font></font><code class="literal">mysql_declare_plugin_end</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            MySQL服务器插件可以用C或C ++编写（或另一种可以使用C调用约定的语言）。</font><font style="vertical-align: inherit;">如果你编写一个C ++插件，你不应该使用的一个C ++特性是非常量变量来初始化全局结构。</font><font style="vertical-align: inherit;">诸如结构等</font></font><code class="literal">st_mysql_plugin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结构的</font><font style="vertical-align: inherit;">成员
             </font><font style="vertical-align: inherit;">只能使用常量变量进行初始化。</font></font><code class="literal">simple_parser</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">之前显示</font><font style="vertical-align: inherit;">的
             </font><font style="vertical-align: inherit;">描述符在C ++插件中是允许的，因为它满足了这个要求：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql_declare_plugin（ftexample）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_FTPARSER_PLUGIN，/ * type * /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  ＆simple_parser_descriptor，/ *描述符* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “simple_parser”，/ *名称* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “Oracle Corporation”，/ *作者* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “简单的全文解析器”，/ *描述* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  PLUGIN_LICENSE_GPL，/ *插件许可* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  simple_parser_plugin_init，/ * init函数（加载时）* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  simple_parser_plugin_deinit，/ * deinit函数（卸载时）* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  0x0001，/ *版本* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  simple_status，/ *状态变量* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  simple_system_variables，/ *系统变量* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  空值，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  0</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql_declare_plugin_end;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            这是编写一般描述符的另一种有效方法。</font><font style="vertical-align: inherit;">它使用常量变量来指示插件名称，作者和描述：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">const char * simple_parser_name =“simple_parser”;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
const char * simple_parser_author =“Oracle Corporation”;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
const char * simple_parser_description =“简单的全文解析器”;</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql_declare_plugin（ftexample）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_FTPARSER_PLUGIN，/ * type * /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  ＆simple_parser_descriptor，/ *描述符* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  simple_parser_name，/ *名称* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  simple_parser_author，/ *作者* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  simple_parser_description，/ *描述* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  PLUGIN_LICENSE_GPL，/ *插件许可* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  simple_parser_plugin_init，/ * init函数（加载时）* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  simple_parser_plugin_deinit，/ * deinit函数（卸载时）* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  0x0001，/ *版本* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  simple_status，/ *状态变量* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  simple_system_variables，/ *系统变量* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  空值，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  0</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql_declare_plugin_end;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            但是，下面的一般描述符是无效的。</font><font style="vertical-align: inherit;">它使用结构成员来指示插件名称，作者和描述，但结构在C ++中不被认为是常量初始化器：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">typedef结构</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  const char * name;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  const char *作者;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  const char *描述;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
} plugin_info;</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
plugin_info parser_info = {</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “simple_parser”</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “甲骨文公司”，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “简单的全文解析器”</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
};</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql_declare_plugin（ftexample）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_FTPARSER_PLUGIN，/ * type * /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  ＆simple_parser_descriptor，/ *描述符* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  parser_info.name，/ *名称* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  parser_info.author，/ * author * /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  parser_info.description，/ *描述* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  PLUGIN_LICENSE_GPL，/ *插件许可* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  simple_parser_plugin_init，/ * init函数（加载时）* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  simple_parser_plugin_deinit，/ * deinit函数（卸载时）* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  0x0001，/ *版本* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  simple_status，/ *状态变量* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  simple_system_variables，/ *系统变量* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  空值，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  0</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql_declare_plugin_end;</font></font><font></font>
</pre>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h5 class="title"><a name="plugin-status-system-variables"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.4.2.2服务器插件状态和系统变量</font></font></h5>

</div>

</div>

</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            服务器插件接口允许插件使用</font><font style="vertical-align: inherit;">通用插件描述符的成员</font></font><code class="literal">status_vars</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
             </font></font><code class="literal">system_vars</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">成员</font><font style="vertical-align: inherit;">公开状态和系统变量
             </font><font style="vertical-align: inherit;">。
          </font></font></p><p><font style="vertical-align: inherit;"></font><code class="literal">status_vars</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通用插件描述符</font><font style="vertical-align: inherit;">
            的</font><font style="vertical-align: inherit;">成员（如果不是0）指向一个</font></font><code class="literal">st_mysql_show_var</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结构</font><font style="vertical-align: inherit;">数组，
             </font><font style="vertical-align: inherit;">其中每个结构都描述一个状态变量，后跟一个所有成员都设置为0的</font></font><code class="literal">st_mysql_show_var</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结构。</font><font style="vertical-align: inherit;">该
             </font><font style="vertical-align: inherit;">结构具有以下定义：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">struct st_mysql_show_var {</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  const char * name;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  char *值;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  枚举enum_mysql_show_type类型;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
};</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            下表显示了允许的状态变量
             </font></font><code class="literal">type</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值以及相应的变量应该是什么。
</font></font></p>
<div class="table">
<a name="idm140527956158528"></a><p class="title"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表28.1服务器插件状态变量类型</font></font></b></p>
<div class="table-contents">
<table><colgroup><col width="30%"><col width="70%"></colgroup><thead><tr>
                <th scope="col"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">变量类型</font></font></th>
                <th scope="col"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">含义</font></font></th>
              </tr></thead><tbody><tr>
                <td scope="row"><code class="literal">SHOW_BOOL</code></td>
                <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指向布尔变量的指针</font></font></td>
              </tr><tr>
                <td scope="row"><code class="literal">SHOW_INT</code></td>
                <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指向整型变量的指针</font></font></td>
              </tr><tr>
                <td scope="row"><code class="literal">SHOW_LONG</code></td>
                <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指向长整型变量的指针</font></font></td>
              </tr><tr>
                <td scope="row"><code class="literal">SHOW_LONGLONG</code></td>
                <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指向longlong整型变量的指针</font></font></td>
              </tr><tr>
                <td scope="row"><code class="literal">SHOW_CHAR</code></td>
                <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一个字符串</font></font></td>
              </tr><tr>
                <td scope="row"><code class="literal">SHOW_CHAR_PTR</code></td>
                <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指向字符串的指针</font></font></td>
              </tr><tr>
                <td scope="row"><code class="literal">SHOW_ARRAY</code></td>
                <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指向另一个</font></font><code class="literal">st_mysql_show_var</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数组的</font><font style="vertical-align: inherit;">指针</font></font></td>
              </tr><tr>
                <td scope="row"><code class="literal">SHOW_FUNC</code></td>
                <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指向函数的指针</font></font></td>
              </tr><tr>
                <td scope="row"><code class="literal">SHOW_DOUBLE</code></td>
                <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指向双</font></font></td>
</tr></tbody></table>
</div>

</div>
<br class="table-break"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            对于该</font></font><code class="literal">SHOW_FUNC</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">类型，调用该函数并填充其</font></font><code class="literal">out</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参数，然后提供有关要显示的变量的信息。</font><font style="vertical-align: inherit;">该功能有这个签名：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#define SHOW_VAR_FUNC_BUFF_SIZE 1024</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
typedef int（* mysql_show_var_func）（void * thd，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                                    struct st_mysql_show_var * out，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                                    char * buf）;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            的</font></font><code class="literal">system_vars</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">构件，如果不为0，指向的阵列</font></font><code class="literal">st_mysql_sys_var</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            结构，其中的每一个描述了一个系统变量（其也可以从命令行或配置文件中设置），随后的结构与所有成员设置为0。</font></font><code class="literal">st_mysql_sys_var</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            结构定义如下：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">struct st_mysql_sys_var {</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 int标志;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 const char * name，* comment;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 int（* check）（THD *，struct st_mysql_sys_var *，void *，st_mysql_value *）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 void（* update）（THD *，struct st_mysql_sys_var *，void *，const void *）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
};</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            根据标志，其他字段会根据需要进行追加。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            为了方便起见，定义了许多宏，使得在插件中创建新的系统变量变得更加简单。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            在整个宏中，以下字段可用：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
                <code class="literal">name</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：系统变量的未加引号标识符。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">varname</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：静态变量的标识符。</font><font style="vertical-align: inherit;">在没有可用的地方，它与</font></font><code class="literal">name</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">现场</font><font style="vertical-align: inherit;">相同</font><font style="vertical-align: inherit;">。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">opt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：系统变量的附加使用标志。</font><font style="vertical-align: inherit;">下表显示了允许的标志。
</font></font></p>
<div class="table">
<a name="idm140527956112960"></a><p class="title"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表28.2服务器插件系统变量标志</font></font></b></p>
<div class="table-contents">
<table><colgroup><col width="25%"><col width="75%"></colgroup><thead><tr>
                    <th scope="col"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">标志值</font></font></th>
                    <th scope="col"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">描述</font></font></th>
                  </tr></thead><tbody><tr>
                    <td scope="row"><code class="literal">PLUGIN_VAR_READONLY</code></td>
                    <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统变量是只读的</font></font></td>
                  </tr><tr>
                    <td scope="row"><code class="literal">PLUGIN_VAR_NOSYSVAR</code></td>
                    <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统变量在运行时不是用户可见的</font></font></td>
                  </tr><tr>
                    <td scope="row"><code class="literal">PLUGIN_VAR_NOCMDOPT</code></td>
                    <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统变量不能从命令行配置</font></font></td>
                  </tr><tr>
                    <td scope="row"><code class="literal">PLUGIN_VAR_NOCMDARG</code></td>
                    <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在命令行中不需要参数（通常用于布尔变量）</font></font></td>
                  </tr><tr>
                    <td scope="row"><code class="literal">PLUGIN_VAR_RQCMDARG</code></td>
                    <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在命令行中需要一个参数（这是默认设置）</font></font></td>
                  </tr><tr>
                    <td scope="row"><code class="literal"> PLUGIN_VAR_OPCMDARG</code></td>
                    <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在命令行中参数是可选的</font></font></td>
                  </tr><tr>
                    <td scope="row"><code class="literal">PLUGIN_VAR_MEMALLOC</code></td>
                    <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用于字符串变量; </font><font style="vertical-align: inherit;">表示内存将被分配用于存储字符串</font></font></td>
</tr></tbody></table>
</div>

</div>
<br class="table-break"></li><li class="listitem"><p>
                <code class="literal">comment</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：在服务器帮助消息中显示的描述性注释。
                </font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果这个变量是隐藏的。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">check</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：检查功能，
                 </font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">默认。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">update</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：更新功能，
                 </font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">默认。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">default</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：变量的默认值。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">minimum</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：可变的最小值。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">maximum</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：可变的最大值。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">blocksize</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：可变块大小。</font><font style="vertical-align: inherit;">当该值被设置时，它被四舍五入到最接近的倍数</font></font><code class="literal">blocksize</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            系统变量可以通过直接使用静态变量或使用
             </font></font><code class="literal">SYSVAR()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">访问宏访问。</font><font style="vertical-align: inherit;">该
             </font></font><code class="literal">SYSVAR()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">宏提供了完整。</font><font style="vertical-align: inherit;">通常只有当代码不能直接访问底层变量时才能使用它。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            例如：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">static int my_foo;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
静态MYSQL_SYSVAR_INT（foo_var，my_foo，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                        PLUGIN_VAR_RQCMDARG，“foo评论”，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                        NULL，NULL，0，0，INT_MAX，0）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 ...</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   SYSVAR（foo_var）= value;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   value = SYSVAR（foo_var）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   my_foo = value;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   value = my_foo;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            会话变量只能通过</font></font><code class="literal">THDVAR()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">访问宏</font><font style="vertical-align: inherit;">访问
             </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">例如：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">静态MYSQL_THDVAR_BOOL（some_flag，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                         PLUGIN_VAR_NOCMDARG，“国旗评论”，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                         NULL，NULL，FALSE）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 ...</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   如果（THDVAR（thd，some_flag））</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   {</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
     做一点事（）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
     THDVAR（thd，some_flag）= FALSE;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   }</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            所有全局和会话系统变量必须</font><font style="vertical-align: inherit;">在使用前</font><font style="vertical-align: inherit;">发布到
             </font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这是通过构建一个</font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">变量的终端数组并在插件公共接口中链接到变量来完成的。</font><font style="vertical-align: inherit;">例如：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">static struct st_mysql_sys_var * my_plugin_vars [] = {</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_SYSVAR（foo_var）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_SYSVAR（some_flag）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  空值</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
};</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql_declare_plugin（fooplug）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL _..._插件，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  ＆plugin_data，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “fooplug”</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “foo作者”，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “这真是太棒了！”，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  PLUGIN_LICENSE_GPL，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  foo_init，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  foo_fini，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  0×0001，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  空值，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  my_plugin_vars，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  空值，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  0</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql_declare_plugin_end;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            以下便利的宏使您可以声明不同类型的系统变量：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                布尔类型的系统变量
                 </font></font><code class="literal">my_bool</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，它是一个1字节的布尔值。</font><font style="vertical-align: inherit;">（0 = FALSE，1 = TRUE）
              </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MYSQL_THDVAR_BOOL（名称，选择，评论，检查，更新，默认）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MYSQL_SYSVAR_BOOL（name，varname，opt，comment，check，update，default）</font></font><font></font>
</pre></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                类型的字符串系统变量
                 </font></font><code class="literal">char*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，它是一个指向以空字符结尾的字符串的指针。
              </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MYSQL_THDVAR_STR（名称，选择，评论，检查，更新，默认）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MYSQL_SYSVAR_STR（名称，varname，opt，comment，check，update，default）</font></font><font></font>
</pre></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                整数系统变量，其中有几个变种。
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                    一个</font></font><code class="literal">int</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统变量，通常是一个4字节的有符号字。
                  </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MYSQL_THDVAR_INT（name，opt，comment，check，update，default，min，max，blk）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MYSQL_SYSVAR_INT（name，varname，opt，comment，check，update，default，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
               最小，最大，块大小）</font></font><font></font>
</pre></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                    一个</font></font><code class="literal">unsigned int</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统变量，通常是一个4字节的无符号字。
                  </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MYSQL_THDVAR_UINT（name，opt，comment，check，update，default，min，max，blk）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MYSQL_SYSVAR_UINT（name，varname，opt，comment，check，update，default，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                最小，最大，块大小）</font></font><font></font>
</pre></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                    一个</font></font><code class="literal">long</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统变量，通常是一个4字节或8字节的有符号字。
                  </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MYSQL_THDVAR_LONG（name，opt，comment，check，update，default，min，max，blk）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MYSQL_SYSVAR_LONG（名称，varname，opt，comment，check，update，default，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                最小，最大，块大小）</font></font><font></font>
</pre></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                    一个</font></font><code class="literal">unsigned long</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统变量，这典型地是4或8个字节的无符号字。
                  </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MYSQL_THDVAR_ULONG（name，opt，comment，check，update，default，min，max，blk）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MYSQL_SYSVAR_ULONG（name，varname，opt，comment，check，update，default，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                 最小，最大，块大小）</font></font><font></font>
</pre></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                    甲</font></font><code class="literal">long long</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统变量，其通常为8字节符号字。
                  </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MYSQL_THDVAR_LONGLONG（名称，选择，评论，检查，更新，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                    默认，最小，最大，块大小）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MYSQL_SYSVAR_LONGLONG（名称，varname，opt，comment，check，update，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                    默认，最小，最大，块大小）</font></font><font></font>
</pre></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                    一个</font></font><code class="literal">unsigned long long</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统变量，其通常为8字节无符号字。
                  </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MYSQL_THDVAR_ULONGLONG（名称，选择，评论，检查，更新，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                     默认，最小，最大，块大小）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MYSQL_SYSVAR_ULONGLONG（名称，varname，opt，comment，check，update，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                     默认，最小，最大，块大小）</font></font><font></font>
</pre></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                    甲</font></font><code class="literal">double</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统变量，其通常为8字节符号字。</font><font style="vertical-align: inherit;">这些访问器宏是在MySQL 5.7.2中添加的。
                  </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MYSQL_THDVAR_DOUBLE（名称，选择，评论，检查，更新，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                     默认，最小，最大，块大小）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MYSQL_SYSVAR_DOUBLE（名称，varname，opt，comment，check，update，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                     默认，最小，最大，块大小）</font></font><font></font>
</pre></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                    一个</font></font><code class="literal">unsigned long</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统变量，这典型地是4或8个字节的无符号字。</font><font style="vertical-align: inherit;">可能值的范围是</font></font><code class="literal">typelib</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从0开始</font><font style="vertical-align: inherit;">的元素数量的序数
                     </font><font style="vertical-align: inherit;">。
                  </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MYSQL_THDVAR_ENUM（name，opt，comment，check，update，default，typelib）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MYSQL_SYSVAR_ENUM（name，varname，opt，comment，check，update，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                默认，typelib）</font></font><font></font>
</pre></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                    一个</font></font><code class="literal">unsigned long long</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统变量，其通常为8字节无符号字。</font><font style="vertical-align: inherit;">每一位代表中的一个元素
                     </font></font><code class="literal">typelib</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
                  </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MYSQL_THDVAR_SET（name，opt，comment，check，update，default，typelib）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MYSQL_SYSVAR_SET（name，varname，opt，comment，check，update，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
               默认，typelib）</font></font><font></font>
</pre></li></ul>
</div>
</li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            在内部，所有可变和插件系统变量都存储在一个</font></font><code class="literal">HASH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结构中。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            服务器命令行帮助文本的显示通过编译</font></font><code class="literal">DYNAMIC_ARRAY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">与命令行选项相关的所有变量中的</font><font style="vertical-align: inherit;">一个来</font><font style="vertical-align: inherit;">进行</font><font style="vertical-align: inherit;">处理</font><font style="vertical-align: inherit;">，对它们进行排序，然后遍历它们以显示每个选项。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            当一个命令行选项已被处理，则接着从除去</font></font><code class="literal">argv</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">由
             </font></font><code class="literal">handle_option()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数（</font></font><code class="filename">my_getopt.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）; </font><font style="vertical-align: inherit;">实际上，它被消耗。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            服务器在插件安装过程中处理命令行选项，在插件成功加载之后，但在插件初始化函数被调用之前
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            运行时加载的插件不会受益于任何配置选项，并且必须具有可用的默认值。</font><font style="vertical-align: inherit;">安装完成后，它们将在</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">初始化时</font><font style="vertical-align: inherit;">加载，
             </font><font style="vertical-align: inherit;">配置选项可以在命令行或内部进行设置</font></font><code class="filename">my.cnf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            插件应该将</font></font><code class="literal">thd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参数视为只读。
</font></font></p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h5 class="title"><a name="client-plugin-descriptors"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.4.2.3客户端插件描述符</font></font></h5>

</div>

</div>

</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            每个客户端插件必须有一个描述符，向客户端插件API提供信息。</font><font style="vertical-align: inherit;">描述符结构从所有客户端插件通用的一组固定成员开始，随后是特定于插件类型的任何成员。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文件中</font><font style="vertical-align: inherit;">
            的</font></font><code class="literal">st_mysql_client_plugin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结构</font></font><code class="filename">client_plugin.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">定义了一个</font><font style="vertical-align: inherit;">包含普通成员</font><font style="vertical-align: inherit;">的
             </font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通用</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">描述符：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">struct st_mysql_client_plugin</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  int类型;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  unsigned int interface_version;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  const char * name;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  const char *作者;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  const char * desc;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  unsigned int version [3];</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  const char *许可证;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  void * mysql_api;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  int（* init）（char *，size_t，int，va_list）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  int（* deinit）（）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  int（* options）（const char *选项，const void *）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
};</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            公共</font></font><code class="literal">st_mysql_client_plugin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            描述符结构成员的使用如下。
            </font></font><code class="literal">char *</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">成员应该被指定为以空字符结尾的字符串。
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
                <code class="literal">type</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：插件类型。</font><font style="vertical-align: inherit;">这必须是其中的插件类型值之一
                 </font></font><code class="filename">client_plugin.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，例如
                 </font></font><code class="literal">MYSQL_CLIENT_AUTHENTICATION_PLUGIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">interface_version</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：插件接口版本。</font><font style="vertical-align: inherit;">例如，这是
                 </font></font><code class="literal">MYSQL_CLIENT_AUTHENTICATION_PLUGIN_INTERFACE_VERSION</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                一个认证插件。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">name</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：一个给出插件名称的字符串。</font><font style="vertical-align: inherit;">这是您在</font></font><a class="link" href="/mysql-5.7-google-zh/connectors-apis.html#mysql-options" title="27.8.7.50 mysql_options（）"><code class="literal">mysql_options()</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用该
                 </font></font><code class="literal">MYSQL_DEFAULT_AUTH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">选项进行</font><font style="vertical-align: inherit;">调用时指向插件的名称，
                 </font><font style="vertical-align: inherit;">或者指定</font></font><code class="option">--default-auth</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL客户端程序</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">选项。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">author</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：一个命名插件作者的字符串。</font><font style="vertical-align: inherit;">这可以是任何你喜欢的。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">desc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：提供插件的一般描述的字符串。</font><font style="vertical-align: inherit;">这可以是任何你喜欢的。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">version</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：插件版本，由三个整数组成，表示主版本，次版本和小版本。</font><font style="vertical-align: inherit;">例如，</font></font><code class="literal">{1,2,3}</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                指示版本1.2.3。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">license</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：指定许可证类型的字符串。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">mysql_api</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：供内部使用。</font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在插件描述符中</font><font style="vertical-align: inherit;">指定它</font><font style="vertical-align: inherit;">。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">init</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：一次只有初始化函数，或者</font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果没有这样的函数。</font><font style="vertical-align: inherit;">客户端库在加载插件时执行此功能。</font><font style="vertical-align: inherit;">该函数成功返回零，失败返回非零。
              </font></font></p><p><font style="vertical-align: inherit;"></font><code class="literal">init</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果发生错误，</font><font style="vertical-align: inherit;">
                该</font><font style="vertical-align: inherit;">函数使用其前两个参数来返回错误消息。</font><font style="vertical-align: inherit;">第一个参数是指向</font></font><code class="literal">char</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">缓冲区</font><font style="vertical-align: inherit;">的指针
                 </font><font style="vertical-align: inherit;">，第二个参数指示缓冲区的长度。</font><font style="vertical-align: inherit;">该</font></font><code class="literal">init</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数</font><font style="vertical-align: inherit;">返回的任何消息都
                 </font><font style="vertical-align: inherit;">必须以null结尾，所以最大消息长度是缓冲区长度减1。</font><font style="vertical-align: inherit;">接下来的参数传递给</font></font><a class="link" href="/mysql-5.7-google-zh/connectors-apis.html#mysql-load-plugin" title="27.8.14.3 mysql_load_plugin（）"><code class="literal">mysql_load_plugin()</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">第一个表示还有多少个参数（如果没有，则为0），后面跟随任何剩余的参数。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">deinit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：一次只有去初始化功能，或者</font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果没有这样的功能。</font><font style="vertical-align: inherit;">客户端库在卸载插件时执行此功能。</font><font style="vertical-align: inherit;">该函数不带任何参数。</font><font style="vertical-align: inherit;">它成功返回零，失败返回非零。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">options</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：处理传递给插件的选项的函数，或者</font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                如果没有这样的函数。</font><font style="vertical-align: inherit;">该函数采用两个参数来表示选项名称和一个指向其值的指针。</font><font style="vertical-align: inherit;">该函数成功返回零，失败返回非零。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            对于给定的客户端插件类型，公共描述符成员可能会跟随其他成员来实现该类型的插件。</font><font style="vertical-align: inherit;">例如，</font></font><code class="literal">st_mysql_client_plugin_AUTHENTICATION</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            身份验证插件</font><font style="vertical-align: inherit;">的
             </font><font style="vertical-align: inherit;">结构在客户端库调用以执行身份验证的最后有一个函数。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            要声明插件，请使用
             </font></font><code class="literal">mysql_declare_client_plugin()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
             </font></font><code class="literal">mysql_end_client_plugin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">宏：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql_declare_client_plugin（</font></font><em class="replaceable"><code>plugin_type</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   ... </font></font><em class="replaceable"><code>members common to all client plugins</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">...</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   ... </font></font><em class="replaceable"><code>type-specific extra members</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">...</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql_end_client_plugin;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            不要</font><font style="vertical-align: inherit;">明确</font><font style="vertical-align: inherit;">指定</font></font><code class="literal">type</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
             </font></font><code class="literal">interface_version</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">成员。</font><font style="vertical-align: inherit;">该
             </font></font><code class="literal">mysql_declare_client_plugin()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">宏使用</font></font><em class="replaceable"><code>plugin_type</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参数来自动生成它们的值。</font><font style="vertical-align: inherit;">例如，像这样声明一个认证客户端插件：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql_declare_client_plugin（认证）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “my_auth_plugin”</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “作者姓名”，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “我的客户端身份验证插件”，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  {1,0,0}，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “GPL”</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  空值，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  my_auth_init，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  my_auth_deinit，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  my_auth_options，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  my_auth_main</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql_end_client_plugin;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            该声明使用</font></font><code class="literal">AUTHENTICATION</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            参数来设置</font></font><code class="literal">type</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
             </font></font><code class="literal">interface_version</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">成员
             </font></font><code class="literal">MYSQL_CLIENT_AUTHENTICATION_PLUGIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
             </font></font><code class="literal">MYSQL_CLIENT_AUTHENTICATION_PLUGIN_INTERFACE_VERSION</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            根据插件类型的不同，描述符可能会有其他成员遵循公共成员。</font><font style="vertical-align: inherit;">例如，对于一个认证插件，有一个函数（</font></font><code class="literal">my_auth_main()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在刚刚显示的描述符中）处理与服务器的通信。</font><font style="vertical-align: inherit;">请参见
             </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#writing-authentication-plugins" title="28.2.4.9编写认证插件"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.2.4.9节“编写身份验证插件”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            通常，支持使用身份验证插件的客户端程序会通过调用</font></font><a class="link" href="/mysql-5.7-google-zh/connectors-apis.html#mysql-options" title="27.8.7.50 mysql_options（）"><code class="literal">mysql_options()</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以设置</font></font><code class="literal">MYSQL_DEFAULT_AUTH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
             </font></font><code class="literal">MYSQL_PLUGIN_DIR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">选项</font><font style="vertical-align: inherit;">来</font><font style="vertical-align: inherit;">导致插件被加载</font><font style="vertical-align: inherit;">：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">char * plugin_dir =“ </font></font><em class="replaceable"><code>path_to_plugin_dir</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">”;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
char * default_auth =“ </font></font><em class="replaceable"><code>plugin_name</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">”;</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
/ * ...进程命令行选项... * /</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql_options（＆mysql，MYSQL_PLUGIN_DIR，plugin_dir）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql_options（＆mysql，MYSQL_DEFAULT_AUTH，default_auth）;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            通常情况下，该程序还将接受
             </font></font><code class="option">--plugin-dir</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
             </font></font><code class="option">--default-auth</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用户能够覆盖默认值的选项。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            如果客户端程序需要较低级别的插件管理，则客户端库包含接受</font></font><code class="literal">st_mysql_client_plugin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参数的函数。</font><font style="vertical-align: inherit;">请参见
             </font></font><a class="xref" href="/mysql-5.7-google-zh/connectors-apis.html#c-api-plugin-functions" title="27.8.14 C API客户端插件功能"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第27.8.14节“C API客户端插件函数”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p>
</div>

</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h4 class="title"><a name="compiling-plugin-libraries"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.4.3编译和安装插件库</font></font></h4>

</div>

</div>

</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          编写插件后，您必须编译并安装它。</font><font style="vertical-align: inherit;">编译共享对象的过程因系统而异。</font><font style="vertical-align: inherit;">如果使用构建库
           </font></font><code class="literal">CMake</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，它应该能够为您的系统生成正确的编译命令。</font><font style="vertical-align: inherit;">如果该库被命名</font></font><code class="literal">somepluglib</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，则最终应该有一个名称类似的共享库文件
           </font></font><code class="filename">somepluglib.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">（
           </font></font><code class="filename">.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文件名后缀可能与您的系统不同。）
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          要使用</font></font><code class="literal">CMake</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，您需要设置配置文件以启用该插件的编译和安装。</font><font style="vertical-align: inherit;">使用</font></font><code class="filename">plugin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL源代码分发目录</font><font style="vertical-align: inherit;">下的插件示例
           </font><font style="vertical-align: inherit;">作为指导。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          创建</font></font><code class="filename">CMakeLists.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，应该看起来像这样：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MYSQL_ADD_PLUGIN（somepluglib somepluglib.c</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MODULE_ONLY MODULE_OUTPUT_NAME“somepluglib”）</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          在</font></font><code class="literal">CMake</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">生成时
           </font></font><code class="filename">Makefile</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，应该注意传递给编译命令
           </font></font><code class="literal">-DMYSQL_DYNAMIC_PLUGIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">标志，并将标志传递给链接器，该</font></font><code class="literal">-lmysqlservices</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">标志需要通过插件服务接口提供的服务链接到任何功能。</font><font style="vertical-align: inherit;">请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#plugin-services" title="28.3用于插件的MySQL服务"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.3节“用于插件的MySQL服务”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          运行</font></font><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CMake</font></font></strong></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，然后运行
           </font></font><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">make</font></font></strong></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shell&gt; </font></font><strong class="userinput"><code>cmake .</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
shell&gt;</font></font><strong class="userinput"><code>make</code></strong>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          如果您需要为</font></font><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CMake</font></font></strong></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指定配置选项
           </font><font style="vertical-align: inherit;">，请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/installing.html#source-configuration-options" title="2.9.4 MySQL源配置选项"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第2.9.4节“MySQL源配置选项”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以获取列表。</font><font style="vertical-align: inherit;">例如，您可能希望指定
           </font></font><a class="link" href="/mysql-5.7-google-zh/installing.html#option_cmake_cmake_install_prefix"><code class="option">CMAKE_INSTALL_PREFIX</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指示安装插件的MySQL基本目录。</font><font style="vertical-align: inherit;">你可以看到这个选项使用什么值
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-variables" title="13.7.5.39 SHOW VARIABLES语法"><code class="literal">SHOW VARIABLES</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL的&gt; </font></font><strong class="userinput"><code>SHOW VARIABLES LIKE 'basedir';</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ --------------- + ------------------ +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">变量名| </font><font style="vertical-align: inherit;">值|</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ --------------- + ------------------ +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">基地| </font><font style="vertical-align: inherit;">/ usr / local / mysql |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ --------------- + ------------------ +</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_plugin_dir"><code class="literal">plugin_dir</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统变量</font><font style="vertical-align: inherit;">
          给出了应该安装库的插件目录的位置
           </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">例如：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL的&gt; </font></font><strong class="userinput"><code>SHOW VARIABLES LIKE 'plugin_dir';</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ --------------- + --------------------------------- -  +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">变量名| </font><font style="vertical-align: inherit;">值|</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ --------------- + --------------------------------- -  +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">plugin_dir | </font><font style="vertical-align: inherit;">/ usr / local / mysql / lib / mysql / plugin |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ --------------- + --------------------------------- -  +</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          要安装插件库，请使用</font></font><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">make</font></font></strong></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">外壳&gt; </font></font><strong class="userinput"><code>make install</code></strong>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          验证</font></font><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">make install</font></font></strong></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是否</font><font style="vertical-align: inherit;">将插件库安装在正确的目录中。</font><font style="vertical-align: inherit;">安装完成后，请确保库许可权允许它由服务器执行。
</font></font></p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h4 class="title"><a name="writing-full-text-plugins"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.4.4编写全文解析器插件</font></font></h4>

</div>

</div>

</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          MySQL支持带有</font></font><a class="link" href="/mysql-5.7-google-zh/storage-engines.html#myisam-storage-engine" title="15.2 MyISAM存储引擎"><code class="literal">MyISAM</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和的
           </font><font style="vertical-align: inherit;">服务器端全文分析器插件
           </font></font><a class="link" href="/mysql-5.7-google-zh/innodb-storage-engine.html" title="第14章InnoDB存储引擎"><code class="literal">InnoDB</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">有关全文分析器插件的介绍性信息，请参阅
           </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#full-text-plugin-type" title="全文解析器插件"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">全文分析器插件</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          全文分析器插件可用于替换或修改内置的全文分析器。</font><font style="vertical-align: inherit;">本节介绍如何编写一个名为的全文分析器插件
           </font></font><code class="literal">simple_parser</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">此插件基于比MySQL内置全文解析器所使用的规则更简单的规则执行解析：单词是空白字符的非空运行。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          这些指令使用</font></font><code class="filename">plugin/fulltext</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL源代码分发目录中</font><font style="vertical-align: inherit;">的源代码
           </font><font style="vertical-align: inherit;">，因此将位置更改为该目录。</font><font style="vertical-align: inherit;">以下过程描述了如何创建插件库：
</font></font></p>
<div class="orderedlist">
<ol class="orderedlist" type="1"><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              要编写全文解析器插件，请在插件源文件中包含以下头文件。</font><font style="vertical-align: inherit;">其他MySQL或通用头文件也可能需要，具体取决于插件的功能和要求。
            </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#include &lt;mysql / plugin.h&gt;
</font></font></pre><p>
              <code class="filename">plugin.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">定义了</font></font><code class="literal">MYSQL_FTPARSER_PLUGIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">声明该插件所需</font><font style="vertical-align: inherit;">的
               </font><font style="vertical-align: inherit;">服务器插件类型和数据结构。
            </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              设置插件库文件的库描述符。
            </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              该描述符包含服务器插件的常规插件描述符。</font><font style="vertical-align: inherit;">对于全文分析器插件，类型必须是</font></font><code class="literal">MYSQL_FTPARSER_PLUGIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这是将插件标识为在</font></font><code class="literal">WITH PARSER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">创建</font></font><code class="literal">FULLTEXT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">索引</font><font style="vertical-align: inherit;">时</font><font style="vertical-align: inherit;">适用于</font><font style="vertical-align: inherit;">子句的</font><font style="vertical-align: inherit;">值。</font><font style="vertical-align: inherit;">（没有其他插件类型对此子句是合法的。）
            </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              例如，包含一个名为单个全文分析器插件的库的库描述符
               </font></font><code class="literal">simple_parser</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如下所示：
            </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql_declare_plugin（ftexample）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_FTPARSER_PLUGIN，/ * type * /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  ＆simple_parser_descriptor，/ *描述符* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “simple_parser”，/ *名称* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “Oracle Corporation”，/ *作者* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “简单的全文解析器”，/ *描述* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  PLUGIN_LICENSE_GPL，/ *插件许可* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  simple_parser_plugin_init，/ * init函数（加载时）* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  simple_parser_plugin_deinit，/ * deinit函数（卸载时）* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  0x0001，/ *版本* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  simple_status，/ *状态变量* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  simple_system_variables，/ *系统变量* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  空值，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  0</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql_declare_plugin_end;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              所述</font></font><code class="literal">name</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">构件（</font></font><code class="literal">simple_parser</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）指示要用于如在语句中的插件的引用名称
               </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#install-plugin" title="13.7.3.3安装PLUGIN语法"><code class="literal">INSTALL PLUGIN</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
               </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#uninstall-plugin" title="13.7.3.4卸载PLUGIN语法"><code class="literal">UNINSTALL PLUGIN</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这也是由</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-plugins" title="13.7.5.25 SHOW PLUGINS语法"><code class="literal">SHOW
              PLUGINS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
               </font><font style="vertical-align: inherit;">显示的名称</font></font><a class="link" href="/mysql-5.7-google-zh/information-schema.html#plugins-table" title="24.16 INFORMATION_SCHEMA插件表"><code class="literal">INFORMATION_SCHEMA.PLUGINS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
            </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              有关更多信息，请参见
               </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#server-plugin-descriptors" title="28.2.4.2.1服务器插件库和插件描述符"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.2.4.2.1节“服务器插件库和插件描述符”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
            </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              设置特定于类型的插件描述符。
            </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              库描述符中的每个常规插件描述符都指向一个类型特定的描述符。</font><font style="vertical-align: inherit;">对于全文分析器插件，类型特定描述符是</font><font style="vertical-align: inherit;">文件中</font></font><code class="literal">st_mysql_ftparser</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结构的</font><font style="vertical-align: inherit;">一个实例</font></font><code class="filename">plugin.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：
            </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">struct st_mysql_ftparser</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  int interface_version;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  int（* parse）（MYSQL_FTPARSER_PARAM * param）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  int（* init）（MYSQL_FTPARSER_PARAM * param）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  int（* deinit）（MYSQL_FTPARSER_PARAM * param）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
};</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              如结构定义所示，描述符具有接口版本号并包含指向三个函数的指针。
            </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              接口版本号使用符号来指定，符号格式如下：
               </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">对于全文分析器插件，符号是
               </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">在源代码中，您将找到在其中定义的全文分析器插件的实际接口版本号
               </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">随着全文解析器插件支持的引入
               </font><font style="vertical-align: inherit;">，接口版本号在MySQL 5.7中从
               </font><font style="vertical-align: inherit;">增加到了</font><font style="vertical-align: inherit;">。
            </font></font><code class="literal">MYSQL_<em class="replaceable"><code>xxx</code></em>_INTERFACE_VERSION</code><font style="vertical-align: inherit;"></font><code class="literal">MYSQL_FTPARSER_INTERFACE_VERSION</code><font style="vertical-align: inherit;"></font><code class="filename">include/mysql/plugin_ftparser.h</code><font style="vertical-align: inherit;"></font><code class="literal">InnoDB</code><font style="vertical-align: inherit;"></font><code class="literal">0x0100</code><font style="vertical-align: inherit;"></font><code class="literal">0x0101</code><font style="vertical-align: inherit;"></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              的</font></font><code class="literal">init</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><code class="literal">deinit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              成员应指向的函数，或者如果不需要该函数被设置为0。</font><font style="vertical-align: inherit;">该</font></font><code class="literal">parse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              构件必须指向执行解析的功能。
            </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              在</font></font><code class="literal">simple_parser</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">声明中，该描述符由标识
               </font></font><code class="literal">&amp;simple_parser_descriptor</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">描述符指定全文插件接口的版本号（如给出的
               </font></font><code class="literal">MYSQL_FTPARSER_INTERFACE_VERSION</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">），插件的解析，初始化和反初始化函数：
            </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">static struct st_mysql_ftparser simple_parser_descriptor =</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_FTPARSER_INTERFACE_VERSION，/ *接口版本* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  simple_parser_parse，/ *解析函数* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  simple_parser_init，/ *解析器初始化函数* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  simple_parser_deinit / *解析器deinit函数* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
};</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              全文分析器插件用于两种不同的上下文中，即索引和搜索。</font><font style="vertical-align: inherit;">在这两种情况下，服务器在处理每个导致插件被调用的SQL语句的开始和结束时调用初始化和取消初始化函数。</font><font style="vertical-align: inherit;">但是，在语句处理期间，服务器以上下文特定的方式调用主解析函数：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                  对于索引，服务器调用解析器为每个列值进行索引。
                </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                  为了搜索，服务器调用解析器来解析搜索字符串。</font><font style="vertical-align: inherit;">语法分析器也可能会调用由语句处理的行。</font><font style="vertical-align: inherit;">在自然语言模式下，服务器不需要调用解析器。</font><font style="vertical-align: inherit;">对于具有查询扩展的布尔模式短语搜索或自然语言搜索，解析器用于解析列值以查找不在索引中的信息。</font><font style="vertical-align: inherit;">另外，如果对没有</font></font><code class="literal">FULLTEXT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">索引</font><font style="vertical-align: inherit;">的列进行布尔模式搜索
                   </font><font style="vertical-align: inherit;">，则将调用内置解析器。</font><font style="vertical-align: inherit;">（插件与特定索引相关联，如果没有索引，则不使用插件。）
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              在普通的插件描述符中的插件声明有</font></font><code class="literal">init</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><code class="literal">deinit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              指向初始化和还原功能的部件，因此不会对特定类型的插件描述它所指向。</font><font style="vertical-align: inherit;">但是，这些函数对具有不同的目的，并且由于不同的原因被调用：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                  对于通用插件描述符中的插件声明，在插件被加载和卸载时调用初始化和取消初始化函数。
                </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                  对于特定于类型的插件描述符，将使用插件的每个SQL语句调用初始化和取消初始化函数。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              在插件描述符中命名的每个接口函数都应该返回0表示成功，否则返回非零表示失败，并且每个接口函数都会收到一个参数，该参数指向</font></font><code class="literal">MYSQL_FTPARSER_PARAM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">包含解析上下文</font><font style="vertical-align: inherit;">的
               </font><font style="vertical-align: inherit;">结构。</font><font style="vertical-align: inherit;">该结构具有这样的定义：
            </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">typedef struct st_mysql_ftparser_param</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  int（* mysql_parse）（struct st_mysql_ftparser_param *，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                     char * doc，int doc_len）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  int（* mysql_add_word）（struct st_mysql_ftparser_param *，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                        char *字，int word_len，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                        MYSQL_FTPARSER_BOOLEAN_INFO * boolean_info）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  void * ftparser_state;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  void * mysql_ftparam;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  struct charset_info_st * cs;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  char * doc;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  int长度;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  int标志;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  枚举enum_ftparser_mode模式;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
} MYSQL_FTPARSER_PARAM;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              结构成员使用如下：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
                  <code class="literal">mysql_parse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：指向调用服务器内置解析器的回调函数的指针。</font><font style="vertical-align: inherit;">当插件充当内置解析器的前端时使用此回调。</font><font style="vertical-align: inherit;">也就是说，当调用插件解析函数时，它应该处理输入以提取文本并将文本传递给
                   </font></font><code class="literal">mysql_parse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">回调。
                </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                  这个回调函数的第一个参数应该是</font></font><code class="literal">param</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">它本身</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">值：
                </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">param-&gt; mysql_parse（param，...）;
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                  前端插件可以提取文本并将其一次全部传递给内置解析器，或者一次提取并传递文本到内置解析器。</font><font style="vertical-align: inherit;">然而，在这种情况下，内置的解析器将这些文本看作是在它们之间存在隐含的单词中断。
                </font></font></p></li><li class="listitem"><p>
                  <code class="literal">mysql_add_word</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：指向一个回调函数的指针，该函数将一个单词添加到全文索引或搜索项的列表中。</font><font style="vertical-align: inherit;">当解析器插件替换内置解析器时使用此回调。</font><font style="vertical-align: inherit;">也就是说，当调用插件解析函数时，它应该将输入解析为单词并</font></font><code class="literal">mysql_add_word</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为每个单词</font><font style="vertical-align: inherit;">调用</font><font style="vertical-align: inherit;">回调。
                </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                  这个回调函数的第一个参数应该是</font></font><code class="literal">param</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">它本身</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">值：
                </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">param-&gt; mysql_add_word（param，...）;
</font></font></pre></li><li class="listitem"><p>
                  <code class="literal">ftparser_state</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：这是一个通用指针。</font><font style="vertical-align: inherit;">该插件可以将其设置为指向内部用于自身目的的信息。
                </font></font></p></li><li class="listitem"><p>
                  <code class="literal">mysql_ftparam</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：这是由服务器设置的。</font><font style="vertical-align: inherit;">它作为第一个参数传递给
                   </font></font><code class="literal">mysql_parse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
                   </font></font><code class="literal">mysql_add_word</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">回调。
                </font></font></p></li><li class="listitem"><p>
                  <code class="literal">cs</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：指向文本字符集信息的指针，如果没有可用信息，则为0。
                </font></font></p></li><li class="listitem"><p>
                  <code class="literal">doc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：指向要解析的文本的指针。
                </font></font></p></li><li class="listitem"><p>
                  <code class="literal">length</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：要分析的文本的长度，以字节为单位。
                </font></font></p></li><li class="listitem"><p>
                  <code class="literal">flags</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：解析器标志。</font><font style="vertical-align: inherit;">如果没有特殊标志，这个值为零。</font><font style="vertical-align: inherit;">唯一的非零标志是</font></font><code class="literal">MYSQL_FTFLAGS_NEED_COPY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，这意味着</font></font><code class="literal">mysql_add_word()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">必须保存一个单词的副本（也就是说，它不能使用指向该单词的指针，因为该单词位于将被覆盖的缓冲区中。）
                </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                  在调用解析器插件，解析器插件本身或</font></font><code class="literal">mysql_parse()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                  函数</font><font style="vertical-align: inherit;">之前，该标志可能由MySQL设置或重置</font><font style="vertical-align: inherit;">。
                </font></font></p></li><li class="listitem"><p>
                  <code class="literal">mode</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：解析模式。</font><font style="vertical-align: inherit;">该值将是以下常量之一：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
                      <code class="literal">MYSQL_FTPARSER_SIMPLE_MODE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：以快速和简单的模式解析，用于索引和自然语言查询。</font><font style="vertical-align: inherit;">解析器应该只将那些应该被索引的单词传递给服务器。</font><font style="vertical-align: inherit;">如果解析器使用长度限制或停用词列表来确定要忽略哪些单词，则不应将这些单词传递给服务器。
                    </font></font></p></li><li class="listitem"><p>
                      <code class="literal">MYSQL_FTPARSER_WITH_STOPWORDS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：以停用词模式解析。</font><font style="vertical-align: inherit;">这用于布尔搜索词组匹配。</font><font style="vertical-align: inherit;">解析器应该将所有单词传递给服务器，即使是不含任何​​正常长度限制的停用词或单词。
                    </font></font></p></li><li class="listitem"><p>
                      <code class="literal">MYSQL_FTPARSER_FULL_BOOLEAN_INFO</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：以布尔模式解析。</font><font style="vertical-align: inherit;">这用于解析布尔查询字符串。</font><font style="vertical-align: inherit;">解析器不仅可以识别单词，还可以识别布尔模式运算符，并将它们作为使用</font></font><code class="literal">mysql_add_word</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">回调的</font><font style="vertical-align: inherit;">令牌传递给服务器
                       </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">为了告诉服务器传递哪种令牌，插件需要填写一个
                       </font></font><code class="literal">MYSQL_FTPARSER_BOOLEAN_INFO</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                      结构并传递一个指针。
</font></font></p></li></ul>
</div>
</li></ul>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">
<div class="admon-title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
注意
</font></font></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                因为</font></font><code class="literal">MyISAM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，停用词列表和
                 </font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_ft_min_word_len"><code class="literal">ft_min_word_len</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
                 </font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_ft_max_word_len"><code class="literal">ft_max_word_len</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在分词器内被检查。</font><font style="vertical-align: inherit;">因为
                 </font></font><code class="literal">InnoDB</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font><font style="vertical-align: inherit;">在标记器之外检查</font><font style="vertical-align: inherit;">停用词列表和等效字长变量设置（</font></font><a class="link" href="/mysql-5.7-google-zh/innodb-storage-engine.html#sysvar_innodb_ft_min_token_size"><code class="literal">innodb_ft_min_token_size</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                和
                 </font></font><a class="link" href="/mysql-5.7-google-zh/innodb-storage-engine.html#sysvar_innodb_ft_max_token_size"><code class="literal">innodb_ft_max_token_size</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">因此，
                 </font></font><code class="literal">InnoDB</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">插件解析器不需要检查停用词列表
                 </font></font><a class="link" href="/mysql-5.7-google-zh/innodb-storage-engine.html#sysvar_innodb_ft_min_token_size"><code class="literal">innodb_ft_min_token_size</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，或
                 </font></font><a class="link" href="/mysql-5.7-google-zh/innodb-storage-engine.html#sysvar_innodb_ft_max_token_size"><code class="literal">innodb_ft_max_token_size</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">相反，建议将所有单词返回
                 </font></font><code class="literal">InnoDB</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">但是，如果您想检查插件解析器中的停用词，请使用
                </font></font><code class="literal">MYSQL_FTPARSER_SIMPLE_MODE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，用于全文搜索索引和自然语言搜索。</font><font style="vertical-align: inherit;">对于</font></font><code class="literal">MYSQL_FTPARSER_WITH_STOPWORDS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
                 </font></font><code class="literal">MYSQL_FTPARSER_FULL_BOOLEAN_INFO</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                模式，建议</font></font><code class="literal">InnoDB</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在短语搜索的情况下</font><font style="vertical-align: inherit;">将所有单词返回为
                 </font><font style="vertical-align: inherit;">包含停用词。
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              如果以布尔模式调用解析器，则
               </font></font><code class="literal">param-&gt;mode</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值将为
               </font></font><code class="literal">MYSQL_FTPARSER_FULL_BOOLEAN_INFO</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">该
               </font></font><code class="literal">MYSQL_FTPARSER_BOOLEAN_INFO</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">解析器用来传送令牌信息到服务器结构如下：
            </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">typedef struct st_mysql_ftparser_boolean_info</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  枚举enum_ft_token_type类型;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  int yesno;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  int weight_adjust;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  charignign;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  char trunc;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  int position;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  / *这些是解析器状态，必须删除。</font><font style="vertical-align: inherit;">* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  char prev;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  char *“</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
} MYSQL_FTPARSER_BOOLEAN_INFO;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              解析器应该如下填写结构成员：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
                  <code class="literal">type</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：令牌类型。</font><font style="vertical-align: inherit;">下表显示了允许的类型。
</font></font></p>
<div class="table">
<a name="idm140527955816960"></a><p class="title"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表28.3全文解析器标记类型</font></font></b></p>
<div class="table-contents">
<table><colgroup><col width="40%"><col width="60%"></colgroup><thead><tr>
                      <th scope="col"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">令牌值</font></font></th>
                      <th scope="col"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">含义</font></font></th>
                    </tr></thead><tbody><tr>
                      <td scope="row"><code class="literal">FT_TOKEN_EOF</code></td>
                      <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数据结束</font></font></td>
                    </tr><tr>
                      <td scope="row"><code class="literal">FT_TOKEN_WORD</code></td>
                      <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一个正常的词</font></font></td>
                    </tr><tr>
                      <td scope="row"><code class="literal">FT_TOKEN_LEFT_PAREN</code></td>
                      <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一个组或子表达式的开始</font></font></td>
                    </tr><tr>
                      <td scope="row"><code class="literal">FT_TOKEN_RIGHT_PAREN</code></td>
                      <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一个组或子表达式的结尾</font></font></td>
                    </tr><tr>
                      <td scope="row"><code class="literal">FT_TOKEN_STOPWORD</code></td>
                      <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一个停止词</font></font></td>
</tr></tbody></table>
</div>

</div>
<br class="table-break"></li><li class="listitem"><p>
                  <code class="literal">yesno</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：单词是否必须出现以便匹配发生。</font><font style="vertical-align: inherit;">0意味着这个词是可选的，但是如果它存在则增加匹配相关性。</font><font style="vertical-align: inherit;">大于0的值表示该单词必须存在。</font><font style="vertical-align: inherit;">小于0的值意味着该单词不能存在。
                </font></font></p></li><li class="listitem"><p>
                  <code class="literal">weight_adjust</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：决定单词匹配数量的权重因子。</font><font style="vertical-align: inherit;">它可以用来增加或减少单词在相关性计算中的重要性。</font><font style="vertical-align: inherit;">值为零表示没有重量调整。</font><font style="vertical-align: inherit;">大于或小于零的值分别意味着更高或更低的权重。</font><font style="vertical-align: inherit;">在这些例子
                   </font></font><a class="xref" href="/mysql-5.7-google-zh/functions.html#fulltext-boolean" title="12.9.2布尔全文搜索"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第12.9.2，“布尔全文搜索”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，即使用
                   </font></font><code class="literal">&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><code class="literal">&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                  运营商说明如何加权作品。
                </font></font></p></li><li class="listitem"><p>
                  <code class="literal">wasign</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：权重因子的符号。</font><font style="vertical-align: inherit;">负值就像
                   </font></font><code class="literal">~</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">布尔搜索运算符一样，这​​会导致单词对相关性的贡献为负。
                </font></font></p></li><li class="listitem"><p>
                  <code class="literal">trunc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：是否应该像布尔模式</font></font><code class="literal">*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                  截断算子一样进行</font><font style="vertical-align: inherit;">匹配</font><font style="vertical-align: inherit;">。
                </font></font></p></li><li class="listitem"><p>
                  <code class="literal">position</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：文档中单词的起始位置，以字节为单位。</font><font style="vertical-align: inherit;">通过
                   </font></font><code class="literal">InnoDB</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">全文搜索使用。</font><font style="vertical-align: inherit;">对于以布尔模式调用的现有插件，必须为位置成员添加支持。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              插件不应该使用</font></font><code class="literal">prev</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，并
               </font></font><code class="literal">quot</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在成员
               </font></font><code class="literal">MYSQL_FTPARSER_BOOLEAN_INFO</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结构。
</font></font></p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
注意
</font></font></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                插件解析器框架不支持：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                    该</font></font><code class="literal">@distance</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">布尔运算符。
                  </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                    前导加号（</font></font><code class="literal">+</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）或减号（</font></font><code class="literal">-</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）布尔运算符，后跟空格，然后是单词（</font></font><code class="literal">'+
                    apple'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或</font></font><code class="literal">'- apple'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">前导正号或负号必须与单词直接相邻，例如：
                     </font></font><code class="literal">'+apple'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
                     </font></font><code class="literal">'-apple'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                有关布尔全文搜索运算符的信息，请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/functions.html#fulltext-boolean" title="12.9.2布尔全文搜索"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第12.9.2节“布尔全文搜索”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p>
</div>
</li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              设置插件界面功能。
            </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              库描述符中的常规插件描述符命名服务器在加载和卸载插件时应调用的初始化和取消初始化函数。</font><font style="vertical-align: inherit;">因为</font></font><code class="literal">simple_parser</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，这些函数什么也不做，只是返回零来表示他们成功了：
            </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">static int simple_parser_plugin_init（void * arg __attribute __（（unused）））</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  返回（0）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
static int simple_parser_plugin_deinit（void * arg __attribute __（（unused）））</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  返回（0）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              因为这些函数实际上没有做任何事情，所以可以忽略它们，并在插件声明中为它们中的每个指定0。
            </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              特定于类型的插件描述符，用于
               </font></font><code class="literal">simple_parser</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">名称使用插件时服务器调用的初始化，解除初始化和解析函数。</font><font style="vertical-align: inherit;">因为
               </font></font><code class="literal">simple_parser</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">初始化和去初始化函数什么都不做：
            </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">static int simple_parser_init（MYSQL_FTPARSER_PARAM * param</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                              __attribute __（（未使用的）））</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  返回（0）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
static int simple_parser_deinit（MYSQL_FTPARSER_PARAM * param</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                                __attribute __（（未使用的）））</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  返回（0）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              在这里，因为这些函数什么都不做，你可以忽略它们，并在插件描述符中为它们中的每一个指定0。
            </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              主解析函数
               </font></font><code class="literal">simple_parser_parse()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">作为内置全文解析器的替代品，因此需要将文本分割为单词并将每个单词传递给服务器。</font><font style="vertical-align: inherit;">解析函数的第一个参数是指向包含解析上下文的结构的指针。</font><font style="vertical-align: inherit;">该结构具有</font></font><code class="literal">doc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指向要分析的文本的</font></font><code class="literal">length</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              成员</font><font style="vertical-align: inherit;">，以及</font><font style="vertical-align: inherit;">指示文本有多长的成员。</font><font style="vertical-align: inherit;">由插件完成的简单解析将空白字符的非空运行视为单词，因此它识别如下单词：
            </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">static int simple_parser_parse（MYSQL_FTPARSER_PARAM * param）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  char * end，* start，* docend = param-&gt; doc + param-&gt; length;</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  for（end = start = param-&gt; doc ;; end ++）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  {</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    如果（end == docend）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    {</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      如果（结束&gt;开始）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        add_word（param，start，end  -  start）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      打破;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    }</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    else if（isspace（* end））</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    {</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      如果（结束&gt;开始）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        add_word（param，start，end  -  start）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      start = end + 1;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    }</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  }</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  返回（0）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              当解析器找到每个单词时，它会调用一个函数
               </font></font><code class="literal">add_word()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将该单词传递给服务器。</font></font><code class="literal">add_word()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">只是一个帮手功能; </font><font style="vertical-align: inherit;">它不是插件界面的一部分。</font><font style="vertical-align: inherit;">解析器将解析上下文指针传递
               </font></font><code class="literal">add_word()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">给该单词和一个长度值的指针：
            </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">static void add_word（MYSQL_FTPARSER_PARAM * param，char * word，size_t len）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_FTPARSER_BOOLEAN_INFO bool_info =</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    {FT_TOKEN_WORD，0，0，0，0，0，''，0};</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  param-&gt; mysql_add_word（param，word，len，＆bool_info）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font>
</pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
注意
</font></font></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                在MySQL 5.7.3之前，第六位
                 </font></font><code class="literal">MYSQL_FTPARSER_BOOLEAN_INFO</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">成员（就在</font></font><code class="literal">'&nbsp;'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">成员</font><font style="vertical-align: inherit;">之前</font><font style="vertical-align: inherit;">）不在场。
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              对于布尔模式解析，</font><font style="vertical-align: inherit;">
              按照前面在</font><font style="vertical-align: inherit;">
              结构</font><font style="vertical-align: inherit;">讨论中所述</font><font style="vertical-align: inherit;">的方式</font></font><code class="literal">add_word()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              填充</font></font><code class="literal">bool_info</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结构
               </font><font style="vertical-align: inherit;">成员</font></font><code class="literal">st_mysql_ftparser_boolean_info</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
            </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              设置状态变量。</font><font style="vertical-align: inherit;">对于
               </font></font><code class="literal">simple_parser</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">插件，以下状态变量数组设置一个状态变量，其值为静态文本，另一个值存储在长整数变量中：
            </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">long number_of_calls = 0;</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
struct st_mysql_show_var simple_status [] =</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  {“simple_parser_static”，（char *）“只是一个静态文本”，SHOW_CHAR}，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  {“simple_parser_called”，（char *）和number_of_calls，SHOW_LONG}，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  {0,0,0}</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
};</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              通过使用以插件名称开头的状态变量名称，您可以轻松地显示插件的变量</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-status" title="13.7.5.35 SHOW STATUS语法"><code class="literal">SHOW STATUS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：
            </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL的&gt; </font></font><strong class="userinput"><code>SHOW STATUS LIKE 'simple_parser%';</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ---------------------- + -------------------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">变量名| </font><font style="vertical-align: inherit;">值|</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ---------------------- + -------------------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">simple_parser_static | </font><font style="vertical-align: inherit;">只是一个静态文本|</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">simple_parser_called | </font><font style="vertical-align: inherit;">0 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ---------------------- + -------------------- +</font></font><font></font>
</pre></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              要编译和安装插件库文件，请使用
               </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#compiling-plugin-libraries" title="28.2.4.3编译和安装插件库"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.2.4.3节“编译和安装插件库”中的说明</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">要使库文件可供使用，请将其安装在插件目录（由</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_plugin_dir"><code class="literal">plugin_dir</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统变量</font><font style="vertical-align: inherit;">命名的目录
               </font><font style="vertical-align: inherit;">）中。</font><font style="vertical-align: inherit;">对于</font></font><code class="literal">simple_parser</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              插件，它是在从源代码构建MySQL时编译和安装的。</font><font style="vertical-align: inherit;">它也包含在二进制发行版中。</font><font style="vertical-align: inherit;">构建过程会生成一个名称为</font></font><code class="filename">mypluglib.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（
               </font></font><code class="filename">.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">后缀可能因您的平台而异）</font><font style="vertical-align: inherit;">的共享对象库</font><font style="vertical-align: inherit;">。
            </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              要使用该插件，请将其注册到服务器。</font><font style="vertical-align: inherit;">例如，要在运行时注册插件，请使用以下语句（</font></font><code class="filename">.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">根据需要为您的平台</font><font style="vertical-align: inherit;">调整</font><font style="vertical-align: inherit;">后缀）：
            </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">安装插件simple_parser SONAME'mypluglib.so';
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              有关插件加载的更多信息，请参见
               </font></font><a class="xref" href="/mysql-5.7-google-zh/server-administration.html#server-plugin-loading" title="5.5.1安装和卸载插件"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第5.5.1节“安装和卸载插件”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
            </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              要验证插件安装，请检查该
               </font></font><a class="link" href="/mysql-5.7-google-zh/information-schema.html#plugins-table" title="24.16 INFORMATION_SCHEMA插件表"><code class="literal">INFORMATION_SCHEMA.PLUGINS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              表或使用该</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-plugins" title="13.7.5.25 SHOW PLUGINS语法"><code class="literal">SHOW
              PLUGINS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句。</font><font style="vertical-align: inherit;">请参见
               </font></font><a class="xref" href="/mysql-5.7-google-zh/server-administration.html#obtaining-plugin-information" title="5.5.2获取服务器插件信息"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第5.5.2节“获取服务器插件信息”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
            </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              测试插件以验证它是否正常工作。
            </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              创建一个包含字符串列的表并将解析器插件与</font></font><code class="literal">FULLTEXT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">列上的索引</font><font style="vertical-align: inherit;">相关联</font><font style="vertical-align: inherit;">：
            </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql&gt; </font></font><strong class="userinput"><code>CREATE TABLE t (c VARCHAR(255),</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    - &gt; </font></font><strong class="userinput"><code>  FULLTEXT (c) WITH PARSER simple_parser</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    - &gt;</font></font><strong class="userinput"><code>) ENGINE=MyISAM;</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
查询OK，0行受影响（0.01秒）</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              在表格中插入一些文字并尝试一些搜索。</font><font style="vertical-align: inherit;">这些应该验证解析器插件将所有非空白字符视为单词字符：
            </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql&gt; </font></font><strong class="userinput"><code>INSERT INTO t VALUES</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    - &gt; </font></font><strong class="userinput"><code>  ('latin1_general_cs is a case-sensitive collation'),</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    - &gt; </font></font><strong class="userinput"><code>  ('I\'d like a case of oranges'),</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    - &gt; </font></font><strong class="userinput"><code>  ('this is sensitive information'),</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    - &gt; </font></font><strong class="userinput"><code>  ('another row'),</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    - &gt;</font></font><strong class="userinput"><code>  ('yet another row');</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
查询OK，5行受影响（0.02秒）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
记录：5个重复：0个警告：0</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MySQL的&gt; </font></font><strong class="userinput"><code>SELECT c FROM t;</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------------------------------------------------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">c |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------------------------------------------------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">latin1_general_cs是一个区分大小写的排序规则|</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">我想要一箱桔子|</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">这是敏感信息|</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">另一行|</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">又一行|</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------------------------------------------------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5行（0.00秒）</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MySQL的&gt; </font></font><strong class="userinput"><code>SELECT MATCH(c) AGAINST('case') FROM t;</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ -------------------------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">MATCH（c）反对（'case'）|</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ -------------------------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">0 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">1.2968142032623 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">0 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">0 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">0 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ -------------------------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5行（0.00秒）</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MySQL的&gt; </font></font><strong class="userinput"><code>SELECT MATCH(c) AGAINST('sensitive') FROM t;</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------------------------------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">MATCH（c）反对（'敏感'）|</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------------------------------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">0 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">0 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">1.3253291845322 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">0 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">0 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------------------------------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5行（0.01秒）</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MySQL的&gt; </font></font><strong class="userinput"><code>SELECT MATCH(c) AGAINST('case-sensitive') FROM t;</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------------------------------------ +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">MATCH（c）反对（'区分大小写'）|</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------------------------------------ +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">1.3109166622162 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">0 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">0 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">0 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">0 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------------------------------------ +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5行（0.01秒）</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MySQL的&gt; </font></font><strong class="userinput"><code>SELECT MATCH(c) AGAINST('I\'d') FROM t;</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ -------------------------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">MATCH（c）反对（'我\'）|</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ -------------------------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">0 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">1.2968142032623 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">0 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">0 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">0 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ -------------------------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5行（0.01秒）</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              无论是</font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">情况</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">也</font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不敏感</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
              匹配</font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不区分大小写</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的方式，他们会为内置解析器。
</font></font></p></li></ol>
</div>

</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h4 class="title"><a name="writing-daemon-plugins"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.4.5编写守护进程插件</font></font></h4>

</div>

</div>

</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          守护进程插件是一种简单类型的插件，用于应该由服务器运行但不与其通信的代码。</font><font style="vertical-align: inherit;">本节介绍如何使用</font></font><code class="literal">plugin/daemon_example</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL源代码分发目录中</font><font style="vertical-align: inherit;">的示例插件编写守护程序服务器插件
           </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">该目录包含</font></font><code class="literal">daemon_example.cc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一个名为daemon插件</font><font style="vertical-align: inherit;">的
           </font><font style="vertical-align: inherit;">源文件，该文件</font></font><code class="literal">daemon_example</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">定期将心跳字符串写入</font></font><code class="filename">mysql-heartbeat.log</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数据目录中</font><font style="vertical-align: inherit;">指定的文件
           </font><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          要编写一个守护进程插件，请在插件源文件中包含以下头文件。</font><font style="vertical-align: inherit;">其他MySQL或通用头文件也可能需要，具体取决于插件的功能和要求。
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#include &lt;mysql / plugin.h&gt;
</font></font></pre><p>
          <code class="filename">plugin.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">定义了</font></font><code class="literal">MYSQL_DAEMON_PLUGIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">声明该插件所需</font><font style="vertical-align: inherit;">的
           </font><font style="vertical-align: inherit;">服务器插件类型和数据结构。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          该</font></font><code class="filename">daemon_example.cc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文件如下设置库描述符。</font><font style="vertical-align: inherit;">库描述符包括一个通用服务器插件描述符。
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql_declare_plugin（daemon_example）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_DAEMON_PLUGIN，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  ＆daemon_example_plugin，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “daemon_example”</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “Brian Aker”，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “守护程序示例，在mysql-heartbeat.log中创建心跳节拍文件”，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  PLUGIN_LICENSE_GPL，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  daemon_example_plugin_init，/ * Plugin Init * /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  daemon_example_plugin_deinit，/ * Plugin Deinit * /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  0x0100 / * 1.0 * /，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  NULL，/ *状态变量* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  NULL，/ *系统变量* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  NULL，/ * config选项* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  0，/ * flags * /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql_declare_plugin_end;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          所述</font></font><code class="literal">name</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">构件（</font></font><code class="literal">daemon_example</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）指示要用于如在语句中的插件的引用名称
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#install-plugin" title="13.7.3.3安装PLUGIN语法"><code class="literal">INSTALL PLUGIN</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#uninstall-plugin" title="13.7.3.4卸载PLUGIN语法"><code class="literal">UNINSTALL PLUGIN</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这也是由</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-plugins" title="13.7.5.25 SHOW PLUGINS语法"><code class="literal">SHOW
          PLUGINS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
           </font><font style="vertical-align: inherit;">显示的名称</font></font><a class="link" href="/mysql-5.7-google-zh/information-schema.html#plugins-table" title="24.16 INFORMATION_SCHEMA插件表"><code class="literal">INFORMATION_SCHEMA.PLUGINS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          插件描述符的第二个成员
           </font></font><code class="literal">daemon_example_plugin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指向特定于类型的守护进程插件描述符。</font><font style="vertical-align: inherit;">此结构仅包含特定于类型的API版本号：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">struct st_mysql_daemon daemon_example_plugin =</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{MYSQL_DAEMON_INTERFACE_VERSION};</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          类型特定的结构没有接口功能。</font><font style="vertical-align: inherit;">服务器和插件之间没有通信，除了服务器从通用插件描述符调用初始化和取消初始化函数来启动和停止插件：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              <code class="literal">daemon_example_plugin_init()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 打开心跳文件并产生一个定期唤醒的线程并将下一条消息写入文件。
            </font></font></p></li><li class="listitem"><p>
              <code class="literal">daemon_example_plugin_deinit()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 关闭文件并执行其他清理。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          要编译和安装插件库文件，请使用</font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#compiling-plugin-libraries" title="28.2.4.3编译和安装插件库"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.2.4.3节“编译和安装插件库”中的说明</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">要使库文件可供使用，请将其安装在插件目录（由</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_plugin_dir"><code class="literal">plugin_dir</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统变量</font><font style="vertical-align: inherit;">命名的目录
           </font><font style="vertical-align: inherit;">）中。</font><font style="vertical-align: inherit;">对于</font></font><code class="literal">daemon_example</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">插件，它是在从源代码构建MySQL时编译和安装的。</font><font style="vertical-align: inherit;">它也包含在二进制发行版中。</font><font style="vertical-align: inherit;">构建过程会生成一个名称为</font></font><code class="filename">libdaemon_example.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（
           </font></font><code class="filename">.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">后缀可能因您的平台而异）</font><font style="vertical-align: inherit;">的共享对象库
           </font><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          要使用该插件，请将其注册到服务器。</font><font style="vertical-align: inherit;">例如，要在运行时注册插件，请使用以下语句（</font></font><code class="filename">.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">根据需要为您的平台</font><font style="vertical-align: inherit;">调整</font><font style="vertical-align: inherit;">后缀）：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">INSTALL PLUGIN daemon_example SONAME'libdaemon_example.so';
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          有关插件加载的更多信息，请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/server-administration.html#server-plugin-loading" title="5.5.1安装和卸载插件"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第5.5.1节“安装和卸载插件”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          要验证插件安装，请检查该
           </font></font><a class="link" href="/mysql-5.7-google-zh/information-schema.html#plugins-table" title="24.16 INFORMATION_SCHEMA插件表"><code class="literal">INFORMATION_SCHEMA.PLUGINS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表或使用该</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-plugins" title="13.7.5.25 SHOW PLUGINS语法"><code class="literal">SHOW PLUGINS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          语句。</font><font style="vertical-align: inherit;">请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/server-administration.html#obtaining-plugin-information" title="5.5.2获取服务器插件信息"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第5.5.2节“获取服务器插件信息”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          加载插件时，它会定期将心跳字符串写入</font></font><code class="filename">mysql-heartbeat.log</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数据目录中</font><font style="vertical-align: inherit;">指定的文件
           </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这个文件不受限制地增长，所以在你确认插件正确运行之后，卸载它：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UNINSTALL PLUGIN daemon_example;
</font></font></pre>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h4 class="title"><a name="writing-information-schema-plugins"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.4.6编写INFORMATION_SCHEMA插件</font></font></h4>

</div>

</div>

</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          本节介绍如何编写服务器端
           </font></font><code class="literal">INFORMATION_SCHEMA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表格插件。</font><font style="vertical-align: inherit;">例如，实现这些插件的代码，请参阅</font></font><code class="literal">sql/sql_show.cc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL源代码分发</font><font style="vertical-align: inherit;">的
           </font><font style="vertical-align: inherit;">文件。</font><font style="vertical-align: inherit;">您还可以查看</font></font><code class="literal">InnoDB</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">源代码中</font><font style="vertical-align: inherit;">找到的示例插件</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">见
           </font></font><code class="filename">handler/i_s.cc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">与
           </font></font><code class="filename">handler/ha_innodb.cc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">该范围内的文件
           </font></font><code class="literal">InnoDB</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">源代码树（在
           </font></font><code class="filename">storage/innobase</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">目录）。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          要编写</font></font><code class="literal">INFORMATION_SCHEMA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表格插件，请在插件源文件中包含以下头文件。</font><font style="vertical-align: inherit;">其他MySQL或通用头文件也可能需要，具体取决于插件的功能和要求。
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#include &lt;sql_class.h&gt;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
#include &lt;table.h&gt;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          这些头文件位于</font></font><code class="filename">sql</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          MySQL源代码分发</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">目录中。</font><font style="vertical-align: inherit;">它们包含C ++结构，因此</font></font><code class="literal">INFORMATION_SCHEMA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">插件</font><font style="vertical-align: inherit;">的源文件
           </font><font style="vertical-align: inherit;">必须编译为C ++（而不是C）代码。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          这里开发的示例插件的源文件被命名
           </font></font><code class="filename">simple_i_s_table.cc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">它创建一个</font></font><code class="literal">INFORMATION_SCHEMA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">名为</font><font style="vertical-align: inherit;">的简单
           </font><font style="vertical-align: inherit;">表格
           </font></font><code class="literal">SIMPLE_I_S_TABLE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，其中有两列名为
           </font></font><code class="literal">NAME</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code class="literal">VALUE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">实现该表的插件库的一般描述符如下所示：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql_declare_plugin（simple_i_s_library）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_INFORMATION_SCHEMA_PLUGIN，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  ＆simple_table_info，/ *类型特定描述符* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “SIMPLE_I_S_TABLE”，/ *表名* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “作者姓名”，/ *作者* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “简单的INFORMATION_SCHEMA表”，/ *描述* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  PLUGIN_LICENSE_GPL，/ *许可证类型* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  simple_table_init，/ * init函数* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  空值，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  0x0100，/ *版本= 1.0 * /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  NULL，/ *没有状态变量* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  NULL，/ *没有系统变量* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  NULL，/ *没有保留的信息* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  0 / *没有标志* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql_declare_plugin_end;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          所述</font></font><code class="literal">name</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">构件（</font></font><code class="literal">SIMPLE_I_S_TABLE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）指示要用于如在语句中的插件的引用名称
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#install-plugin" title="13.7.3.3安装PLUGIN语法"><code class="literal">INSTALL PLUGIN</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#uninstall-plugin" title="13.7.3.4卸载PLUGIN语法"><code class="literal">UNINSTALL PLUGIN</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这也是由</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-plugins" title="13.7.5.25 SHOW PLUGINS语法"><code class="literal">SHOW
          PLUGINS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
           </font><font style="vertical-align: inherit;">显示的名称</font></font><a class="link" href="/mysql-5.7-google-zh/information-schema.html#plugins-table" title="24.16 INFORMATION_SCHEMA插件表"><code class="literal">INFORMATION_SCHEMA.PLUGINS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"></font><code class="literal">simple_table_info</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一般描述符</font><font style="vertical-align: inherit;">
          的</font><font style="vertical-align: inherit;">成员指向特定于类型的描述符，它仅包含特定于类型的API版本号：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">static struct st_mysql_information_schema simple_table_info =</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{MYSQL_INFORMATION_SCHEMA_INTERFACE_VERSION};</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          一般描述符指向初始化和去初始化函数：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              初始化函数提供有关表结构的信息和填充表的函数。
            </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              去初始化函数执行任何所需的清理。</font><font style="vertical-align: inherit;">如果不需要清理，则此描述符成员可以</font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（如示例中所示）。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          初始化函数应该返回0表示成功，如果发生错误则返回1。</font><font style="vertical-align: inherit;">该函数接收一个通用指针，它应该将其解释为指向表结构的指针：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">static int table_init（void * ptr）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  ST_SCHEMA_TABLE * schema_table =（ST_SCHEMA_TABLE *）ptr;</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  schema_table-&gt; fields_info = simple_table_fields;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  schema_table-&gt; fill_table = simple_fill_table;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  返回0;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          该函数应该设置表结构的这两个成员：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              <code class="literal">fields_info</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><code class="literal">ST_FIELD_INFO</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">包含有关每列的信息</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">结构</font><font style="vertical-align: inherit;">数组
               </font><font style="vertical-align: inherit;">。
            </font></font></p></li><li class="listitem"><p>
              <code class="literal">fill_table</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：填充表格的函数。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          指向的数组</font></font><code class="literal">fields_info</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">应该包含</font></font><code class="literal">INFORMATION_SCHEMA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">加一个终止元素的</font><font style="vertical-align: inherit;">每列中的
           </font><font style="vertical-align: inherit;">一个元素。</font></font><code class="literal">simple_table_fields</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          示例插件</font><font style="vertical-align: inherit;">的以下</font><font style="vertical-align: inherit;">数组表示
           </font></font><code class="literal">SIMPLE_I_S_TABLE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">有两列。
          </font></font><code class="literal">NAME</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是长度为10的字符串值，</font></font><code class="literal">VALUE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是整数值，显示宽度为20.最后一个结构标记数组的末尾。
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">静态ST_FIELD_INFO simple_table_fields [] =</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  {“NAME”，10，MYSQL_TYPE_STRING，0，0 0，0}，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  {“VALUE”，6，MYSQL_TYPE_LONG，0，MY_I_S_UNSIGNED，0，0}，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  {0，0，MYSQL_TYPE_NULL，0，0，0，0}</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
};</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          有关列的信息结构的更多信息，请参阅的定义</font></font><code class="literal">ST_FIELD_INFO</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在
           </font></font><code class="literal">table.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">头文件中。</font><font style="vertical-align: inherit;">允许的
           </font><font style="vertical-align: inherit;">
          类型值是在C API中使用的值; </font><font style="vertical-align: inherit;">请参见
           </font><a class="xref" href="/mysql-5.7-google-zh/connectors-apis.html#c-api-data-structures" title="27.8.5 C API数据结构"><font style="vertical-align: inherit;">第27.8.5节“C API数据结构”</font></a><font style="vertical-align: inherit;">。
        </font></font><code class="literal">MYSQL_TYPE_<em class="replaceable"><code>xxx</code></em></code><font style="vertical-align: inherit;"></font><a class="xref" href="/mysql-5.7-google-zh/connectors-apis.html#c-api-data-structures" title="27.8.5 C API数据结构"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          的</font></font><code class="literal">fill_table</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">构件应该被设置为用于填充该表，并且如果发生错误的成功返回0，1的功能。</font><font style="vertical-align: inherit;">对于示例插件，该
           </font></font><code class="literal">simple_fill_table()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数如下所示：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">static int simple_fill_table（THD * thd，TABLE_LIST * tables，Item * cond）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  TABLE * table = tables-&gt; table;</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  table-&gt; field [0]  - &gt; store（“Name 1”，6，system_charset_info）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  表 - &gt;字段[1]  - &gt;存储（1）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  if（schema_table_store_record（thd，table））</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    返回1;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  table-&gt; field [0]  - &gt; store（“Name 2”，6，system_charset_info）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  表 - &gt;字段[1]  - &gt;存储器（2）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  if（schema_table_store_record（thd，table））</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    返回1;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  返回0;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          对于</font></font><code class="literal">INFORMATION_SCHEMA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          表的</font><font style="vertical-align: inherit;">每一行</font><font style="vertical-align: inherit;">，此函数初始化每一列，然后调用
           </font></font><code class="literal">schema_table_store_record()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">安装行。</font><font style="vertical-align: inherit;">该</font></font><code class="literal">store()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参数取决于的值的类型的方法来被存储。</font><font style="vertical-align: inherit;">对于第0列（</font></font><code class="literal">NAME</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一个字符串），
           </font></font><code class="literal">store()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">需要一个指向字符串的指针，其长度以及有关字符串字符集的信息：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">store（const char * to，uint length，CHARSET_INFO * cs）;
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          对于第1列（</font></font><code class="literal">VALUE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">整数），
           </font></font><code class="literal">store()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">取值和一个标志，指示它是否是未签名的：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">存储（longlong nr，bool unsigned_value）;
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          有关如何填充</font></font><code class="literal">INFORMATION_SCHEMA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表格的</font><font style="vertical-align: inherit;">其他示例
           </font><font style="vertical-align: inherit;">，请搜索</font></font><code class="literal">schema_table_store_record()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in的
           </font><font style="vertical-align: inherit;">实例</font></font><code class="filename">sql_show.cc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          要编译和安装插件库文件，请使用</font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#compiling-plugin-libraries" title="28.2.4.3编译和安装插件库"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.2.4.3节“编译和安装插件库”中的说明</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">要使库文件可供使用，请将其安装在插件目录（由</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_plugin_dir"><code class="literal">plugin_dir</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统变量</font><font style="vertical-align: inherit;">命名的目录
           </font><font style="vertical-align: inherit;">）中。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          要测试插件，请安装它：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL的&gt; </font></font><strong class="userinput"><code>INSTALL PLUGIN SIMPLE_I_S_TABLE SONAME 'simple_i_s_table.so';</code></strong>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          验证该表是否存在：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql&gt; </font></font><strong class="userinput"><code>SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    - &gt;</font></font><strong class="userinput"><code>WHERE TABLE_NAME = 'SIMPLE_I_S_TABLE';</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------------------ +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">TABLE_NAME |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------------------ +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">SIMPLE_I_S_TABLE |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------------------ +</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          尝试从中选择：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL的&gt; </font></font><strong class="userinput"><code>SELECT * FROM INFORMATION_SCHEMA.SIMPLE_I_S_TABLE;</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ -------- + ------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">NAME | </font><font style="vertical-align: inherit;">VALUE |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ -------- + ------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">名字1 | </font><font style="vertical-align: inherit;">1 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">名称2 | </font><font style="vertical-align: inherit;">2 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ -------- + ------- +</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          卸载它：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL的&gt; </font></font><strong class="userinput"><code>UNINSTALL PLUGIN SIMPLE_I_S_TABLE;</code></strong>
</pre>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h4 class="title"><a name="writing-semisynchronous-replication-plugins"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.4.7编写半同步复制插件</font></font></h4>

</div>

</div>

</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          本节介绍如何使用</font></font><code class="literal">plugin/semisync</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL源代码分发目录中</font><font style="vertical-align: inherit;">的示例插件编写服务器端半异步复制插件</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">该目录包含名为</font></font><code class="literal">rpl_semi_sync_master</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
           </font><font style="vertical-align: inherit;">主和从属插件的源文件
           </font></font><code class="literal">rpl_semi_sync_slave</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这里的信息仅包括如何设置插件框架。</font><font style="vertical-align: inherit;">有关插件如何实现复制功能的详细信息，请参阅源代码。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          要编写一个半同步复制插件，请将以下头文件包含在插件源文件中。</font><font style="vertical-align: inherit;">其他MySQL或通用头文件也可能需要，具体取决于插件的功能和要求。
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#include &lt;mysql / plugin.h&gt;
</font></font></pre><p>
          <code class="filename">plugin.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">定义了</font></font><code class="literal">MYSQL_REPLICATION_PLUGIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">声明该插件所需</font><font style="vertical-align: inherit;">的
           </font><font style="vertical-align: inherit;">服务器插件类型和数据结构。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          对于主方，
           </font></font><code class="filename">semisync_master_plugin.cc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">包含一个名为的插件的一般描述符
           </font></font><code class="literal">rpl_semi_sync_master</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql_declare_plugin（semi_sync_master）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_REPLICATION_PLUGIN，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  ＆semi_sync_master_plugin，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “rpl_semi_sync_master”</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “何振兴”，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “半同步复制大师”，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  PLUGIN_LICENSE_GPL，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  semi_sync_master_plugin_init，/ * Plugin Init * /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  semi_sync_master_plugin_deinit，/ * Plugin Deinit * /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  0x0100 / * 1.0 * /，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  semi_sync_master_status_vars，/ *状态变量* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  semi_sync_master_system_vars，/ *系统变量* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  NULL，/ * config选项* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  0，/ * flags * /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql_declare_plugin_end;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          对于从属端来说，它
           </font></font><code class="filename">semisync_slave_plugin.cc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">包含一个名为的插件的一般描述符
           </font></font><code class="literal">rpl_semi_sync_slave</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql_declare_plugin（semi_sync_slave）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_REPLICATION_PLUGIN，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  ＆semi_sync_slave_plugin，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “rpl_semi_sync_slave”</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “何振兴”，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “半同步复制从属”，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  PLUGIN_LICENSE_GPL，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  semi_sync_slave_plugin_init，/ * Plugin Init * /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  semi_sync_slave_plugin_deinit，/ * Plugin Deinit * /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  0x0100 / * 1.0 * /，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  semi_sync_slave_status_vars，/ *状态变量* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  semi_sync_slave_system_vars，/ *系统变量* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  NULL，/ * config选项* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  0，/ * flags * /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql_declare_plugin_end;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          对于主插件和从插件，通用描述符都具有指向特定类型描述符的指针，初始化和取消初始化函数以及由插件实现的状态和系统变量。</font><font style="vertical-align: inherit;">有关变量设置的信息，请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#plugin-status-system-variables" title="28.2.4.2.2服务器插件状态和系统变量"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.2.4.2.2节“服务器插件状态和系统变量”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">以下注释讨论了主插件的类型特定描述符以及初始化和取消初始化函数，但同样适用于从插件。
        </font></font></p><p><font style="vertical-align: inherit;"></font><code class="literal">semi_sync_master_plugin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">主通用描述符</font><font style="vertical-align: inherit;">
          的</font><font style="vertical-align: inherit;">成员指向特定于类型的描述符，该描述符只包含特定于类型的API版本号：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">struct Mysql_replication semi_sync_master_plugin = {</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_REPLICATION_INTERFACE_VERSION</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
};</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          初始化和取消初始化函数声明如下所示：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">static int semi_sync_master_plugin_init（void * p）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
static int semi_sync_master_plugin_deinit（void * p）;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          初始化函数使用指针向服务器注册事务和二进制日志记录</font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">观察者</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">初始化成功后，服务器负责在适当的时候调用观察者。</font><font style="vertical-align: inherit;">（有关观察者的详细信息，请参阅源文件。）通过取消注册观察者来消除初始化函数。</font><font style="vertical-align: inherit;">每个函数在成功时返回0，如果发生错误则返回1。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          要编译和安装插件库文件，请使用</font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#compiling-plugin-libraries" title="28.2.4.3编译和安装插件库"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.2.4.3节“编译和安装插件库”中的说明</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">要使库文件可供使用，请将其安装在插件目录（由</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_plugin_dir"><code class="literal">plugin_dir</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统变量</font><font style="vertical-align: inherit;">命名的目录
           </font><font style="vertical-align: inherit;">）中。</font><font style="vertical-align: inherit;">对于</font></font><code class="literal">rpl_semi_sync_master</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
           </font></font><code class="literal">rpl_semi_sync_slave</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">插件，当您从源代码构建MySQL时，它们会被编译和安装。</font><font style="vertical-align: inherit;">它们也包含在二进制发行版中。</font><font style="vertical-align: inherit;">构建过程会生成名称为</font></font><code class="filename">semisync_master.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和的
           </font><font style="vertical-align: inherit;">共享对象库
           </font></font><code class="filename">semisync_slave.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（
           </font></font><code class="filename">.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">后缀可能因您的平台而异）。
</font></font></p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h4 class="title"><a name="writing-audit-plugins"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.4.8编写审计插件</font></font></h4>

</div>

</div>

</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          本节介绍如何使用</font></font><code class="literal">plugin/audit_null</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL源代码分发目录中</font><font style="vertical-align: inherit;">的示例插件编写服务器端审计插件
           </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">在</font></font><code class="filename">audit_null.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">与
           </font></font><code class="filename">audit_null_variables.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">该目录中的源文件实现一个名为审核插件
           </font></font><code class="literal">NULL_AUDIT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
注意
</font></font></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            在MySQL 5.7.8中进行了更改，将查询重写插件重新实现为审计插件，然后在5.7.9中对审计插件API本身进行了广泛修改（包括查询重写插件的部分）。</font><font style="vertical-align: inherit;">由于这些原因，这里的讨论描述了从MySQL 5.7.9开始的审计插件API。</font><font style="vertical-align: inherit;">5.7.8之前的API与MySQL 5.6非常相似。</font><font style="vertical-align: inherit;">要针对旧API </font></font><a class="ulink" href="http://dev.mysql.com/doc/refman/5.6/en/writing-audit-plugins.html" target="_top"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">编写审计插件</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，请参阅
             </font><font style="vertical-align: inherit;">在
             </font></font><a class="ulink" href="http://dev.mysql.com/doc/refman/5.6/en/" target="_top"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL 5.6参考手册中</font></font></a><font style="vertical-align: inherit;"><a class="ulink" href="http://dev.mysql.com/doc/refman/5.6/en/writing-audit-plugins.html" target="_top"><font style="vertical-align: inherit;">编写审计插件</font></a><font style="vertical-align: inherit;">。
</font></font></p>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">
<div class="admon-title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
注意
</font></font></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            其他使用审计插件API的插件示例是查询重写插件（请参阅
             </font></font><a class="xref" href="/mysql-5.7-google-zh/server-administration.html#rewriter-query-rewrite-plugin" title="5.5.4重写器查询重写插件"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第5.5.4节“重写器查询重写插件”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）和版本令牌插件（请参阅
             </font></font><a class="xref" href="/mysql-5.7-google-zh/server-administration.html#version-tokens" title="5.5.5版本令牌"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第5.5.5节“版本令牌”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          在服务器中，可插拔接口审计在实施</font></font><code class="filename">sql_audit.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
           </font></font><code class="filename">sql_audit.cc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文件在
           </font></font><code class="filename">sql</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL源码分发版的目录。</font><font style="vertical-align: inherit;">此外，服务器中的多个位置在发生可审计事件时调用审计接口，以便可以在必要时通知已注册的审计插件。</font><font style="vertical-align: inherit;">要查看此类调用发生的位置，请搜索服务器源文件以调用具有该表单名称的函数
           </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">对于这些服务器操作发生审计通知：
</font></font><code class="filename">mysql_audit_<em class="replaceable"><code>xxx</code></em>()</code><font style="vertical-align: inherit;"></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              客户端连接和断开事件
            </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              将消息写入常规查询日志（如果日志已启用）
            </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              将消息写入错误日志
            </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              将查询结果发送给客户端
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          要编写审计插件，请将以下头文件包含在插件源文件中。</font><font style="vertical-align: inherit;">其他MySQL或通用头文件也可能需要，具体取决于插件的功能和要求。
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#include &lt;mysql / plugin_audit.h&gt;
</font></font></pre><p>
          <code class="filename">plugin_audit.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">包括
           </font></font><code class="filename">plugin.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，所以你不需要明确地包含后一个文件。</font></font><code class="filename">plugin.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">定义了</font></font><code class="literal">MYSQL_AUDIT_PLUGIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">声明该插件所需</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">服务器插件类型和数据结构。
          </font></font><code class="filename">plugin_audit.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">定义特定于审计插件的数据结构。
</font></font></p>
<div class="simplesect">

<div class="titlepage">
<div>

<div class="simple">
<h5 class="title"><a name="writing-audit-plugins-general-descriptor"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">审计插件通用描述符</font></font></h5>
</div>
</div>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            与任何MySQL服务器插件一样，审计插件具有通用插件描述符（请参见
             </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#server-plugin-descriptors" title="28.2.4.2.1服务器插件库和插件描述符"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.2.4.2.1节“服务器插件库和插件描述符”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）以及类型特定的插件描述符。</font><font style="vertical-align: inherit;">在
             </font></font><code class="filename">audit_null.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，一般描述符</font></font><code class="literal">audit_null</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">看起来像这样：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql_declare_plugin（audit_null）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_AUDIT_PLUGIN，/ * type * /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  ＆audit_null_descriptor，/ *描述符* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “NULL_AUDIT”，/ *名称* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “Oracle Corp”，/ *作者* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “简单空值审计”，/ *描述* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  PLUGIN_LICENSE_GPL，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  audit_null_plugin_init，/ * init函数（加载时）* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  audit_null_plugin_deinit，/ * deinit函数（卸载时）* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  0x0003，/ *版本* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  simple_status，/ *状态变量* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  system_variables，/ *系统变量* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  空值，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  0，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql_declare_plugin_end;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            第一个成员，</font></font><code class="literal">MYSQL_AUDIT_PLUGIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将此插件标识为审计插件。
          </font></font></p><p>
            <code class="literal">audit_null_descriptor</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 指向特定于类型的插件描述符，稍后介绍。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            所述</font></font><code class="literal">name</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">构件（</font></font><code class="literal">NULL_AUDIT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）指示要用于如在语句中的插件的引用名称
             </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#install-plugin" title="13.7.3.3安装PLUGIN语法"><code class="literal">INSTALL PLUGIN</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
             </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#uninstall-plugin" title="13.7.3.4卸载PLUGIN语法"><code class="literal">UNINSTALL PLUGIN</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这也是由</font></font><a class="link" href="/mysql-5.7-google-zh/information-schema.html#plugins-table" title="24.16 INFORMATION_SCHEMA插件表"><code class="literal">INFORMATION_SCHEMA.PLUGINS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
             </font><font style="vertical-align: inherit;">显示的名称
             </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-plugins" title="13.7.5.25 SHOW PLUGINS语法"><code class="literal">SHOW PLUGINS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            该</font></font><code class="literal">audit_null_plugin_init</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">被加载插件时初始化函数执行插件初始化。</font><font style="vertical-align: inherit;">该</font></font><code class="literal">audit_null_plugin_deinit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            功能在插件卸载时执行清理。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            通用插件描述符也指代
             </font></font><code class="literal">simple_status</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
             </font></font><code class="literal">system_variables</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，暴露几个状态和系统变量的结构。</font><font style="vertical-align: inherit;">当启用插件时，可以使用</font></font><code class="literal">SHOW</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句（</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-status" title="13.7.5.35 SHOW STATUS语法"><code class="literal">SHOW STATUS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
             </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-variables" title="13.7.5.39 SHOW VARIABLES语法"><code class="literal">SHOW VARIABLES</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）或适当的性能模式表</font><font style="vertical-align: inherit;">检查这些变量
             </font><font style="vertical-align: inherit;">。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            该</font></font><code class="literal">simple_status</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结构声明了几个状态变量与表单的名称
             </font><font style="vertical-align: inherit;">。
            </font><font style="vertical-align: inherit;">为每个收到的通知</font><font style="vertical-align: inherit;">递增
             </font><font style="vertical-align: inherit;">状态变量。</font><font style="vertical-align: inherit;">其他状态变量更加具体，并且
             </font><font style="vertical-align: inherit;">只会针对特定事件的通知才会增加它们。
          </font></font><code class="literal">Audit_null_<em class="replaceable"><code>xxx</code></em></code><font style="vertical-align: inherit;"></font><code class="literal">NULL_AUDIT</code><font style="vertical-align: inherit;"></font><code class="literal">Audit_null_called</code><font style="vertical-align: inherit;"></font><code class="literal">NULL_AUDIT</code><font style="vertical-align: inherit;"></font></p><p>
            <code class="literal">system_variables</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是一个系统变量元素的数组，每个元素都是使用</font><font style="vertical-align: inherit;">
            宏</font><font style="vertical-align: inherit;">定义的
             </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这些系统变量具有表单的名称
             </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这些变量可用于在运行时与插件进行通信。
</font></font><code class="literal">MYSQL_THDVAR_<em class="replaceable"><code>xxx</code></em></code><font style="vertical-align: inherit;"></font><code class="literal">null_audit_<em class="replaceable"><code>xxx</code></em></code><font style="vertical-align: inherit;"></font></p>
</div>
<div class="simplesect">
<div class="titlepage">
<div>
<div class="simple">
<h5 class="title"><a name="writing-audit-plugins-type-specific-descriptor"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">审计插件类型特定描述符</font></font></h5>

</div>

</div>

</div>
<p><font style="vertical-align: inherit;"></font><code class="literal">audit_null_descriptor</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通用插件描述符中</font><font style="vertical-align: inherit;">
            的</font><font style="vertical-align: inherit;">值指向特定于类型的插件描述符。</font><font style="vertical-align: inherit;">对于审计插件，这个描述符具有以下结构（定义在
             </font></font><code class="filename">plugin_audit.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）中：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">struct st_mysql_audit</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  int interface_version;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  void（* release_thd）（MYSQL_THD）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  int（* event_notify）（MYSQL_THD，mysql_event_class_t，const void *）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  unsigned long class_mask [MYSQL_AUDIT_CLASS_MASK_SIZE];</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
};</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            审计插件的类型特定描述符具有以下成员：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
                <code class="literal">interface_version</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：按照惯例，类型特定的插件描述符以给定插件类型的接口版本开头。</font><font style="vertical-align: inherit;">服务器</font></font><code class="literal">interface_version</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在加载插件时</font><font style="vertical-align: inherit;">检查</font><font style="vertical-align: inherit;">插件是否与其兼容。</font><font style="vertical-align: inherit;">对于审计插件，</font></font><code class="literal">interface_version</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">成员</font><font style="vertical-align: inherit;">的值
                 </font><font style="vertical-align: inherit;">是
                 </font></font><code class="literal">MYSQL_AUDIT_INTERFACE_VERSION</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                （定义在</font></font><code class="literal">plugin_audit.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）中。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">release_thd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：服务器调用的一个函数，用于通知插件它正在与其线程上下文分离。</font><font style="vertical-align: inherit;">这应该是
                 </font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果没有这样的功能。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">event_notify</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：服务器调用来通知插件发生可审计事件的函数。</font><font style="vertical-align: inherit;">这个功能不应该是
                 </font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">; </font><font style="vertical-align: inherit;">这是没有道理的，因为不会发生审计。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">class_mask</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：一组
                 </font></font><code class="literal">MYSQL_AUDIT_CLASS_MASK_SIZE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">元素。</font><font style="vertical-align: inherit;">每个元素都为给定的事件类指定一个位掩码，以指示插件想要通知的子类。</font><font style="vertical-align: inherit;">（这是插件
                 </font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">订阅</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">感兴趣事件的方式。）元素应该为0，以忽略相应事件类别的事件。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            服务器</font><font style="vertical-align: inherit;">一起</font><font style="vertical-align: inherit;">使用</font></font><code class="literal">event_notify</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
             </font></font><code class="literal">release_thd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">功能。</font><font style="vertical-align: inherit;">它们在特定线程的上下文中调用，并且线程可能会执行产生多个事件通知的活动。</font><font style="vertical-align: inherit;">服务器第一次调用
             </font></font><code class="literal">event_notify</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">线程时，它会创建该插件与线程的绑定。</font><font style="vertical-align: inherit;">该绑定存在时，该插件不能被卸载。</font><font style="vertical-align: inherit;">当没有更多的线程事件发生时，服务器通过调用通知插件</font></font><code class="literal">release_thd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">功能，然后破坏绑定。</font><font style="vertical-align: inherit;">例如，当客户端发出语句时，处理语句的线程可能会通知审计插件关于语句产生的结果集以及有关正在记录的语句。</font><font style="vertical-align: inherit;">发生这些通知后，服务器在将线程置于睡眠状态之前释放该插件，直到客户端发出另一个语句。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            这种设计使得插件可以在给</font></font><code class="literal">event_notify</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数</font><font style="vertical-align: inherit;">的第一次调用中分配给定线程所需的资源，并在
             </font><font style="vertical-align: inherit;">函数中释放它们</font></font><code class="literal">release_thd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">event_notify功能：</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  如果需要内存来为线程提供服务</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    分配内存</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  ...通知处理的其余部分...</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
release_thd函数：</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  如果分配内存</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    释放内存</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  ...发布处理的其余部分...</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            这比在通知功能中重复分配和释放内存更有效。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            对于</font></font><code class="literal">NULL_AUDIT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">审计插件，类型特定的插件描述符如下所示：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">static struct st_mysql_audit audit_null_descriptor =</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_AUDIT_INTERFACE_VERSION，/ *接口版本* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  NULL，/ * release_thd函数* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  audit_null_notify，/ *通知功能* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  {（无符号长整型）MYSQL_AUDIT_GENERAL_ALL，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    （无符号长）MYSQL_AUDIT_CONNECTION_ALL，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    （无符号长）MYSQL_AUDIT_PARSE_ALL，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    （无符号长）MYSQL_AUDIT_AUTHORIZATION_ALL，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    （无符号长整型）MYSQL_AUDIT_TABLE_ACCESS_ALL，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    （无符号长）MYSQL_AUDIT_GLOBAL_VARIABLE_ALL，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    （无符号长）MYSQL_AUDIT_SERVER_STARTUP_ALL，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    （无符号长）MYSQL_AUDIT_SERVER_SHUTDOWN_ALL，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    （无符号长整型）MYSQL_AUDIT_COMMAND_ALL，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    （无符号长整型）MYSQL_AUDIT_QUERY_ALL，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    （无符号长）MYSQL_AUDIT_STORED_PROGRAM_ALL}</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
};</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            服务器调用</font></font><code class="literal">audit_null_notify()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将审计事件信息传递给插件。</font><font style="vertical-align: inherit;">没有
             </font></font><code class="literal">release_thd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">功能。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            该</font></font><code class="literal">class_mask</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">成员是一个数组，指示插件订阅哪些事件类。</font><font style="vertical-align: inherit;">如图所示，数组内容订阅所有可用的事件类的所有子类。</font><font style="vertical-align: inherit;">要忽略给定事件类的所有通知，请将相应的</font></font><code class="literal">class_mask</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">元素</font><font style="vertical-align: inherit;">指定</font><font style="vertical-align: inherit;">为0。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            的数目</font></font><code class="literal">class_mask</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的元素对应于事件类，其中的每一个列在数量</font></font><code class="literal">mysql_event_class_t</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            枚举所定义</font></font><code class="filename">plugin_audit.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">typedef枚举</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_AUDIT_GENERAL_CLASS = 0，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_AUDIT_CONNECTION_CLASS = 1，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_AUDIT_PARSE_CLASS = 2，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_AUDIT_AUTHORIZATION_CLASS = 3，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_AUDIT_TABLE_ACCESS_CLASS = 4，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_AUDIT_GLOBAL_VARIABLE_CLASS = 5，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_AUDIT_SERVER_STARTUP_CLASS = 6，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_AUDIT_SERVER_SHUTDOWN_CLASS = 7，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_AUDIT_COMMAND_CLASS = 8，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_AUDIT_QUERY_CLASS = 9，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_AUDIT_STORED_PROGRAM_CLASS = 10，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  / *此项目必须是列表中的最后一个。</font><font style="vertical-align: inherit;">* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_AUDIT_CLASS_MASK_SIZE</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
} mysql_event_class_t;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            对于任何给定的事件类，</font></font><code class="filename">plugin_audit.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为个别事件子</font><font style="vertical-align: inherit;">类
             </font><font style="vertical-align: inherit;">定义位掩码符号，以及为</font></font><code class="literal"><em class="replaceable"><code>xxx</code></em>_ALL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">所有子类</font><font style="vertical-align: inherit;">位掩码</font><font style="vertical-align: inherit;">联合</font><font style="vertical-align: inherit;">的
             </font><font style="vertical-align: inherit;">符号。</font><font style="vertical-align: inherit;">例如，对于</font></font><code class="literal">MYSQL_AUDIT_CONNECTION_CLASS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（涵盖连接和断开事件的类），
             </font></font><code class="filename">plugin_audit.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">定义这些符号：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">typedef枚举</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  / **在认证阶段完成后发生。</font><font style="vertical-align: inherit;">* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_AUDIT_CONNECTION_CONNECT = 1 &lt;&lt; 0，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  / **在连接终止后发生。</font><font style="vertical-align: inherit;">* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_AUDIT_CONNECTION_DISCONNECT = 1 &lt;&lt; 1，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  / **在COM_CHANGE_USER RPC完成后发生。</font><font style="vertical-align: inherit;">* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_AUDIT_CONNECTION_CHANGE_USER = 1 &lt;&lt; 2，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  / **在认证之前发生。</font><font style="vertical-align: inherit;">* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_AUDIT_CONNECTION_PRE_AUTHENTICATE = 1 &lt;&lt; 3</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
} mysql_event_connection_subclass_t;</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
#define MYSQL_AUDIT_CONNECTION_ALL（MYSQL_AUDIT_CONNECTION_CONNECT | \</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                                    MYSQL_AUDIT_CONNECTION_DISCONNECT | </font><font style="vertical-align: inherit;">\</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                                    MYSQL_AUDIT_CONNECTION_CHANGE_USER | </font><font style="vertical-align: inherit;">\</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                                    MYSQL_AUDIT_CONNECTION_PRE_AUTHENTICATE）</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            为了订阅连接事件类的所有子类（如</font></font><code class="literal">NULL_AUDIT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">插件那样），插件</font></font><code class="literal">MYSQL_AUDIT_CONNECTION_ALL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在相应的</font></font><code class="literal">class_mask</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">元素中</font><font style="vertical-align: inherit;">指定</font><font style="vertical-align: inherit;">（</font></font><code class="literal">class_mask[1]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在这种情况下）。</font><font style="vertical-align: inherit;">要仅订阅一些子类，插件将该</font></font><code class="literal">class_mask</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">元素</font><font style="vertical-align: inherit;">设置
             </font><font style="vertical-align: inherit;">为感兴趣的子类的联合。</font><font style="vertical-align: inherit;">例如，要仅订阅连接和更改用户子类，该插件将设置
             </font></font><code class="literal">class_mask[1]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为以下值：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MYSQL_AUDIT_CONNECTION_CONNECT | </font><font style="vertical-align: inherit;">MYSQL_AUDIT_CONNECTION_CHANGE_USER
</font></font></pre>
</div>
<div class="simplesect">
<div class="titlepage">
<div>
<div class="simple">
<h5 class="title"><a name="writing-audit-plugins-notification-function"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">审计插件通知函数</font></font></h5>

</div>

</div>

</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            审计插件的大部分工作都发生在通知函数（</font></font><code class="literal">event_notify</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            特定于类型的插件描述符</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">成员）中。</font><font style="vertical-align: inherit;">服务器为每个可审计事件调用此函数。</font><font style="vertical-align: inherit;">审计插件通知函数有这样的原型：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">int（* event_notify）（MYSQL_THD，mysql_event_class_t，const void *）;
</font></font></pre><p><font style="vertical-align: inherit;"></font><code class="literal">event_notify</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数原型</font><font style="vertical-align: inherit;">
            的第二个和第三个参数
             </font><font style="vertical-align: inherit;">表示事件类和指向事件结构的通用指针。</font><font style="vertical-align: inherit;">（不同类中的事件具有不同的结构，通知函数可以使用事件类的值来确定哪个事件结构适用）。该函数处理事件并返回一个状态，指示服务器是继续处理事件还是终止事件。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            因为</font></font><code class="literal">NULL_AUDIT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，通知功能是</font></font><code class="literal">audit_null_notify()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">该函数增加一个全局事件计数器（插件公开为</font></font><code class="literal">Audit_null_called</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            状态值的值），然后检查事件类以确定如何处理事件结构：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">static int audit_null_notify（MYSQL_THD thd __attribute __（（unused）），</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                             mysql_event_class_t event_class，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                             const void * event）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  ...</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  number_of_calls ++;</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  如果（event_class == MYSQL_AUDIT_GENERAL_CLASS）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  {</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    const struct mysql_event_general * event_general =</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                                    （const struct mysql_event_general *）事件;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    ...</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  }</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  else if（event_class == MYSQL_AUDIT_CONNECTION_CLASS）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  {</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    const struct mysql_event_connection * event_connection =</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                                （const struct mysql_event_connection *）事件;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    ...</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  }</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  else if（event_class == MYSQL_AUDIT_PARSE_CLASS）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  {</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    const struct mysql_event_parse * event_parse =</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                                      （const struct mysql_event_parse *）事件;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    ...</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  }</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  ...</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            通知函数</font></font><code class="literal">event</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">根据值来</font><font style="vertical-align: inherit;">解释
             </font><font style="vertical-align: inherit;">参数
             </font></font><code class="literal">event_class</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">所述</font></font><code class="literal">event</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            参数是一个通用的指针事件记录，其结构的每个事件类不同。</font><font style="vertical-align: inherit;">（该
             </font></font><code class="filename">plugin_audit.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文件包含定义每个事件类内容的结构。）对于每个类，</font></font><code class="literal">audit_null_notify()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将事件转换为适当的特定于类的结构，然后检查其子类以确定要增加哪个子类计数器。</font><font style="vertical-align: inherit;">例如，处理连接事件类中的事件的代码如下所示：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">else if（event_class == MYSQL_AUDIT_CONNECTION_CLASS）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  const struct mysql_event_connection * event_connection =</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                              （const struct mysql_event_connection *）事件;</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  开关（event_connection-&gt; event_subclass）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  {</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  情况下MYSQL_AUDIT_CONNECTION_CONNECT：</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    number_of_calls_connection_connect ++;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    打破;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  情况下MYSQL_AUDIT_CONNECTION_DISCONNECT：</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    number_of_calls_connection_disconnect ++;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    打破;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  大小写MYSQL_AUDIT_CONNECTION_CHANGE_USER：</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    number_of_calls_connection_change_user ++;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    打破;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  大小写MYSQL_AUDIT_CONNECTION_PRE_AUTHENTICATE：</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    number_of_calls_connection_pre_authenticate ++;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      打破;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  默认：</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    打破;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  }</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font>
</pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
注意
</font></font></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              通用事件类（</font></font><code class="literal">MYSQL_AUDIT_GENERAL_CLASS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）从MySQL 5.7.9开始已弃用，并将在未来的MySQL版本中删除。</font><font style="vertical-align: inherit;">为了减少插件开销，最好仅订阅感兴趣的更具体的事件类别。
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            对于某些事件类别，</font></font><code class="literal">NULL_AUDIT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            除了增加计数器外</font><font style="vertical-align: inherit;">，</font><font style="vertical-align: inherit;">插件还执行其他处理。</font><font style="vertical-align: inherit;">在任何情况下，当通知函数完成事件处理时，它应返回一个状态，指示服务器是继续处理事件还是终止事件。
</font></font></p>
</div>
<div class="simplesect">
<div class="titlepage">
<div>
<div class="simple">
<h5 class="title"><a name="writing-audit-plugins-error-handling"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">审计插件错误处理</font></font></h5>

</div>

</div>

</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            审计插件通知函数可以通过两种方式报告当前事件的状态值：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                使用通知函数返回值。</font><font style="vertical-align: inherit;">在这种情况下，如果服务器应该继续处理事件，则函数返回0;如果服务器应该终止事件，则返回非零值。
              </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"></font><code class="literal">my_message()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在从通知函数返回之前</font><font style="vertical-align: inherit;">
                调用</font><font style="vertical-align: inherit;">函数来设置错误状态。</font><font style="vertical-align: inherit;">在这种情况下，通知函数返回值将被忽略，并且服务器将终止具有错误的事件处理。</font><font style="vertical-align: inherit;">该
                 </font></font><code class="literal">my_message()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参数指示哪些错误报告，它的消息。</font><font style="vertical-align: inherit;">例如：
              </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">my_message（ER_AUDIT_API_ABORT，“这是我的错误信息。”，MYF（0））;
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                有些事件不能中止。</font><font style="vertical-align: inherit;">不考虑非零返回值，
                 </font></font><code class="literal">my_message()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">错误调用必须经过</font></font><code class="literal">is_error()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">检查。</font><font style="vertical-align: inherit;">例如：
              </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if（！thd-&gt; get_stmt_da（） - &gt; is_error（））</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  my_message（ER_AUDIT_API_ABORT，“这是我的错误信息。”，MYF（0））;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font>
</pre></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            有些事件无法终止：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
                <code class="literal">MYSQL_AUDIT_CONNECTION_DISCONNECT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：服务器无法阻止客户端断开连接。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">MYSQL_AUDIT_COMMAND_END</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：这个事件提供了一个已经完成执行的命令的状态，所以没有终止它的目的。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            如果审计插件为非终止事件返回非零状态，则服务器将忽略状态并继续处理该事件。</font><font style="vertical-align: inherit;">从MySQL 5.7.9开始，如果一个审计插件使用该</font></font><code class="literal">my_message()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数来终止一个无法终止的事件</font><font style="vertical-align: inherit;">，也是如此
             </font><font style="vertical-align: inherit;">。
</font></font></p>
</div>
<div class="simplesect">
<div class="titlepage">
<div>
<div class="simple">
<h5 class="title"><a name="writing-audit-plugins-usage"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">审计插件用法</font></font></h5>

</div>

</div>

</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            要编译和安装插件库文件，请使用
             </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#compiling-plugin-libraries" title="28.2.4.3编译和安装插件库"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.2.4.3节“编译和安装插件库”中的说明</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">要使库文件可供使用，请将其安装在插件目录（由</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_plugin_dir"><code class="literal">plugin_dir</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统变量</font><font style="vertical-align: inherit;">命名的目录
             </font><font style="vertical-align: inherit;">）中。</font><font style="vertical-align: inherit;">对于</font></font><code class="literal">NULL_AUDIT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">插件，它是在从源代码构建MySQL时编译和安装的。</font><font style="vertical-align: inherit;">它也包含在二进制发行版中。</font><font style="vertical-align: inherit;">构建过程会生成一个名称为</font></font><code class="filename">adt_null.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（
             </font></font><code class="filename">.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">后缀可能因您的平台而异）</font><font style="vertical-align: inherit;">的共享对象库
             </font><font style="vertical-align: inherit;">。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            要在运行时注册插件，请使用以下语句（</font></font><code class="filename">.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">根据需要为您的平台</font><font style="vertical-align: inherit;">调整</font><font style="vertical-align: inherit;">后缀）：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">INSTALL PLUGIN NULL_AUDIT SONAME'adt_null.so';
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            有关插件加载的更多信息，请参见
             </font></font><a class="xref" href="/mysql-5.7-google-zh/server-administration.html#server-plugin-loading" title="5.5.1安装和卸载插件"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第5.5.1节“安装和卸载插件”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            要验证插件安装，请检查该
             </font></font><a class="link" href="/mysql-5.7-google-zh/information-schema.html#plugins-table" title="24.16 INFORMATION_SCHEMA插件表"><code class="literal">INFORMATION_SCHEMA.PLUGINS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            表或使用该</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-plugins" title="13.7.5.25 SHOW PLUGINS语法"><code class="literal">SHOW PLUGINS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            语句。</font><font style="vertical-align: inherit;">请参见
             </font></font><a class="xref" href="/mysql-5.7-google-zh/server-administration.html#obtaining-plugin-information" title="5.5.2获取服务器插件信息"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第5.5.2节“获取服务器插件信息”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            在安装审计插件的同时，它会公开状态变量，以指示插件已被调用的事件：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL的&gt; </font></font><strong class="userinput"><code>SHOW STATUS LIKE 'Audit_null%';</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ---------------------------------------- + -------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">变量名| </font><font style="vertical-align: inherit;">值|</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ---------------------------------------- + -------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">Audit_null_authorization_column | </font><font style="vertical-align: inherit;">0 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">Audit_null_authorization_db | </font><font style="vertical-align: inherit;">0 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">Audit_null_authorization_procedure | </font><font style="vertical-align: inherit;">0 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">Audit_null_authorization_proxy | </font><font style="vertical-align: inherit;">0 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">Audit_null_authorization_table | </font><font style="vertical-align: inherit;">0 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">Audit_null_authorization_user | </font><font style="vertical-align: inherit;">0 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">Audit_null_called | </font><font style="vertical-align: inherit;">185547 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">Audit_null_command_end | </font><font style="vertical-align: inherit;">20999 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">Audit_null_command_start | </font><font style="vertical-align: inherit;">21001 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">Audit_null_connection_change_user | </font><font style="vertical-align: inherit;">0 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">Audit_null_connection_connect | </font><font style="vertical-align: inherit;">5823 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">Audit_null_connection_disconnect | </font><font style="vertical-align: inherit;">5818 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">Audit_null_connection_pre_authenticate | </font><font style="vertical-align: inherit;">5823 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">Audit_null_general_error | </font><font style="vertical-align: inherit;">1 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">Audit_null_general_log | </font><font style="vertical-align: inherit;">26559 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">Audit_null_general_result | </font><font style="vertical-align: inherit;">19922 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">Audit_null_general_status | </font><font style="vertical-align: inherit;">21000 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">Audit_null_global_variable_get | </font><font style="vertical-align: inherit;">0 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">Audit_null_global_variable_set | </font><font style="vertical-align: inherit;">0 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">Audit_null_parse_postparse | </font><font style="vertical-align: inherit;">14648 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">Audit_null_parse_preparse | </font><font style="vertical-align: inherit;">14648 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">Audit_null_query_nested_start | </font><font style="vertical-align: inherit;">6 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">Audit_null_query_nested_status_end | </font><font style="vertical-align: inherit;">6 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">Audit_null_query_start | </font><font style="vertical-align: inherit;">14648 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">Audit_null_query_status_end | </font><font style="vertical-align: inherit;">14647 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">Audit_null_server_shutdown | </font><font style="vertical-align: inherit;">0 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">Audit_null_server_startup | </font><font style="vertical-align: inherit;">1 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">Audit_null_table_access_delete | </font><font style="vertical-align: inherit;">104 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">Audit_null_table_access_insert | </font><font style="vertical-align: inherit;">2839 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">Audit_null_table_access_read | </font><font style="vertical-align: inherit;">97842 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">Audit_null_table_access_update | </font><font style="vertical-align: inherit;">278 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ---------------------------------------- + -------- +</font></font><font></font>
</pre><p>
            <code class="literal">Audit_null_called</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">统计所有事件，其他变量统计特定事件子类的实例。</font><font style="vertical-align: inherit;">例如，前面的
             </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-status" title="13.7.5.35 SHOW STATUS语法"><code class="literal">SHOW STATUS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句会导致服务器将结果发送给客户端，并在日志启用时向通用查询日志写入消息。</font><font style="vertical-align: inherit;">因此，客户端发出的声明重复导致
             </font></font><code class="literal">Audit_null_called</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
             </font></font><code class="literal">Audit_null_general_result</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以及
             </font></font><code class="literal">Audit_null_general_log</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将每次递增。</font><font style="vertical-align: inherit;">（在MySQL 5.7.5之前，只有在启用了通用查询日志的情况下才会发出通用查询日志的事件通知。从5.7.5开始，无论是否启用该日志，都会发出通知。）
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            状态变量值在所有会话中汇总。</font><font style="vertical-align: inherit;">没有个别会议的柜台。
          </font></font></p><p>
            <code class="literal">NULL_AUDIT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 暴露了几个系统变量，可以在运行时与插件通信：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL的&gt; </font></font><strong class="userinput"><code>SHOW VARIABLES LIKE 'null_audit%';</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------------------------------------ + ------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">变量名| </font><font style="vertical-align: inherit;">值|</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------------------------------------ + ------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">null_audit_abort_message | </font><font style="vertical-align: inherit;">|</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">null_audit_abort_value | </font><font style="vertical-align: inherit;">1 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">null_audit_event_order_check | </font><font style="vertical-align: inherit;">|</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">null_audit_event_order_check_exact | </font><font style="vertical-align: inherit;">1 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">null_audit_event_order_started | </font><font style="vertical-align: inherit;">0 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">null_audit_event_record | </font><font style="vertical-align: inherit;">|</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">null_audit_event_record_def | </font><font style="vertical-align: inherit;">|</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------------------------------------ + ------- +</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            要检查审计API调用的顺序，请将该
             </font></font><code class="literal">null_audit_event_order_check</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">变量设置为预期的事件顺序。</font><font style="vertical-align: inherit;">例如：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SET null_audit_event_order_check =</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      'MYSQL_AUDIT_CONNECTION_PRE_AUTHENTICATE ;;;'</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      'MYSQL_AUDIT_GENERAL_LOG ;;;'</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      'MYSQL_AUDIT_CONNECTION_CONNECT ;;';</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            该语句利用将相邻字符串连接成单个字符串的SQL语法。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            值的格式是：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">' </font></font><em class="replaceable"><code>event_name</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">; </font></font><em class="replaceable"><code>event_data</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">; </font></font><em class="replaceable"><code>command</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'['; </font></font><em class="replaceable"><code>event_name</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">; </font></font><em class="replaceable"><code>event_data</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">; </font></font><em class="replaceable"><code>command</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'] ...
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            事件顺序匹配后，
             </font></font><code class="literal">null_audit_event_order_check</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值将被值替换</font></font><code class="literal">EVENT-ORDER-OK</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            通过指定命令值，</font></font><code class="literal">ABORT_RET</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            可以中止指定事件上的审核API调用。</font><font style="vertical-align: inherit;">以下示例</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#insert" title="13.2.5 INSERT语法"><code class="literal">INSERT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在</font></font><code class="literal">MYSQL_AUDIT_QUERY_STATUS_END</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            发生事件时</font><font style="vertical-align: inherit;">中止
             </font><font style="vertical-align: inherit;">语句执行</font><font style="vertical-align: inherit;">：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SET null_audit_event_order_check =</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   'MYSQL_AUDIT_COMMAND_START; command_id的= “3” ;;'</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   'MYSQL_AUDIT_GENERAL_LOG ;;;'</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   'MYSQL_AUDIT_QUERY_START ;;;'</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   'MYSQL_AUDIT_QUERY_STATUS_END ;; ABORT_RET';</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            在审计插件与前面的序列相匹配之后，它会中止事件处理并向客户端发送错误消息：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">错误3164（HY000）：由审核API（'MYSQL_AUDIT_QUERY_STATUS_END'; 1）中止。
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            从审计API通知例程中返回一个非零值是中止事件执行的标准方法。</font><font style="vertical-align: inherit;">也可以通过将</font></font><code class="literal">null_audit_abort_value</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">变量</font><font style="vertical-align: inherit;">设置</font><font style="vertical-align: inherit;">为通知例程应返回的值</font><font style="vertical-align: inherit;">来指定自定义错误代码
             </font><font style="vertical-align: inherit;">：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SET null_audit_abort_value = 123;
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            使用自定义错误代码中止序列会生成标准消息。</font><font style="vertical-align: inherit;">假设您设置了审计日志系统变量，如下所示：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SET null_audit_abort_value = 123;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SET null_audit_event_order_check =</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    'MYSQL_AUDIT_COMMAND_START; command_id的= “3” ;;'</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    'MYSQL_AUDIT_GENERAL_LOG ;;;'</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    'MYSQL_AUDIT_QUERY_START ;; ABORT_RET';</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            然后</font></font><code class="literal">SELECT 1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在这个错误中</font><font style="vertical-align: inherit;">执行</font><font style="vertical-align: inherit;">结果：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">错误3164（HY000）：由审核API中止（'MYSQL_AUDIT_QUERY_START'; 123）。
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            通过设置</font></font><code class="literal">null_audit_abort_message</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">变量</font><font style="vertical-align: inherit;">指定的自定义消息也可以中止事件
             </font><font style="vertical-align: inherit;">：假设您设置审计日志系统变量，如下所示：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SET null_audit_abort_message ='自定义错误文本。';</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SET null_audit_event_order_check =</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    'MYSQL_AUDIT_COMMAND_START; command_id的= “3” ;;'</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    'MYSQL_AUDIT_GENERAL_LOG ;;;'</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    'MYSQL_AUDIT_QUERY_START ;; ABORT_RET';</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            然后中止一个序列会导致以下错误：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">错误3164（HY000）：自定义错误文本。
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            为了创建测试目的，可以记录通过插件传递的事件。</font><font style="vertical-align: inherit;">录制通过在</font></font><code class="literal">null_audit_event_record_def</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">变量中</font><font style="vertical-align: inherit;">指定开始和结束事件开始
             </font><font style="vertical-align: inherit;">：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SET null_audit_event_record_def =</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    'MYSQL_AUDIT_COMMAND_START; MYSQL_AUDIT_COMMAND_END';</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            语句执行导致存储</font></font><code class="literal">null_audit_event_record</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">变量</font><font style="vertical-align: inherit;">中发生的事件</font><font style="vertical-align: inherit;">。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            要在测试后禁用插件，请使用以下语句卸载它：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UNINSTALL PLUGIN NULL_AUDIT;
</font></font></pre>
</div>

</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h4 class="title"><a name="writing-authentication-plugins"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.4.9编写认证插件</font></font></h4>

</div>

</div>

</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          MySQL支持可插入的身份验证，其中调用插件来验证客户端连接。</font><font style="vertical-align: inherit;">身份验证插件允许使用除</font></font><code class="literal">mysql.user</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表中</font><font style="vertical-align: inherit;">存储的内置密码方法之外的身份验证方法
           </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">例如，可以编写插件来访问外部认证方法。</font><font style="vertical-align: inherit;">此外，身份验证插件可以支持代理用户功能，从而连接用户是另一个用户的代理，并且为了访问控制的目的而被视为具有不同用户的特权。</font><font style="vertical-align: inherit;">有关更多信息，请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/security.html#pluggable-authentication" title="6.3.9可插入认证"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第6.3.9节“可插入验证”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
           </font></font><a class="xref" href="/mysql-5.7-google-zh/security.html#proxy-users" title="6.3.10代理用户"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第6.3.10节“代理用户”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          可以为服务器端或客户端编写身份验证插件。</font><font style="vertical-align: inherit;">服务器端插件使用相同的插件API，用于其他服务器插件类型，例如全文分析器或审计插件（尽管使用不同类型的特定描述符）。</font><font style="vertical-align: inherit;">客户端插件使用客户端插件API。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          几个头文件包含与认证插件相关的信息：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              <code class="filename">plugin.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：定义
               </font></font><code class="literal">MYSQL_AUTHENTICATION_PLUGIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">服务器插件类型。
            </font></font></p></li><li class="listitem"><p>
              <code class="filename">client_plugin.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：定义客户端插件的API。</font><font style="vertical-align: inherit;">这包括用于客户端插件C API调用的客户端插件描述符和函数原型（参见
               </font></font><a class="xref" href="/mysql-5.7-google-zh/connectors-apis.html#c-api-plugin-functions" title="27.8.14 C API客户端插件功能"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第27.8.14节“C API客户端插件函数”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。
            </font></font></p></li><li class="listitem"><p>
              <code class="filename">plugin_auth.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：定义特定于身份验证插件的服务器插件API的一部分。</font><font style="vertical-align: inherit;">这包括服务器端认证插件的类型特定描述符和
               </font></font><code class="literal">MYSQL_SERVER_AUTH_INFO</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结构。
            </font></font></p></li><li class="listitem"><p>
              <code class="filename">plugin_auth_common.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：包含客户端和服务器身份验证插件的通用元素。</font><font style="vertical-align: inherit;">这包括返回值定义和
               </font></font><code class="literal">MYSQL_PLUGIN_VIO</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结构。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          要编写身份验证插件，请将以下头文件包含在插件源文件中。</font><font style="vertical-align: inherit;">其他MySQL或通用头文件也可能需要，具体取决于插件的功能和要求。
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              对于实现服务器身份验证插件的源文件，请包含以下文件：
            </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#include &lt;mysql / plugin_auth.h&gt;
</font></font></pre></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              对于实现客户端身份验证插件或同时包含客户端和服务器插件的源文件，请包含以下文件：
            </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#include &lt;mysql / plugin_auth.h&gt;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
#include &lt;mysql / client_plugin.h&gt;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
#include &lt;mysql.h&gt;</font></font><font></font>
</pre></li></ul>
</div>
<p>
          <code class="filename">plugin_auth.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">包括
           </font></font><code class="filename">plugin.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
           </font></font><code class="filename">plugin_auth_common.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，所以你不需要明确地包含后面的文件。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          本节介绍如何编写一对简单的服务器和客户端身份验证插件。
</font></font></p>
<div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
警告
</font></font></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            这些插件接受任何非空密码并以明文形式发送密码。</font><font style="vertical-align: inherit;">这是不安全的，所以</font><span class="emphasis"><em><font style="vertical-align: inherit;">不应该在生产环境中使用</font></em></span><font style="vertical-align: inherit;">插件
             </font></font><span class="emphasis"><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></em></span>
</p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          这里开发的服务器端和客户端插件都被命名</font></font><code class="literal">auth_simple</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">如
           </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#plugin-data-structures" title="28.2.4.2插件数据结构"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.2.4.2节“插件数据结构”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">中所述，插件库文件必须与客户端插件具有相同的基本名称，因此源文件名为，</font></font><code class="filename">auth_simple.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并生成一个名为</font></font><code class="filename">auth_simple.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          （假设您的系统</font></font><code class="filename">.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用作后缀库文件）。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          在MySQL源代码分发中，身份验证插件源位于</font></font><code class="filename">plugin/auth</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">目录中，可以作为编写其他身份验证插件的指南进行检查。</font><font style="vertical-align: inherit;">另外，要了解内置身份验证插件的实现方式，请参阅</font></font><code class="filename">sql/sql_acl.cc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内置于MySQL服务器</font></font><code class="filename">sql-common/client.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的插件</font><font style="vertical-align: inherit;">和
           </font><font style="vertical-align: inherit;">内置于</font></font><code class="literal">libmysqlclient</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">客户端库的</font><font style="vertical-align: inherit;">插件</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">（对于内置的客户端插件，请注意，这里</font></font><code class="literal">auth_plugin_t</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用</font><font style="vertical-align: inherit;">的
           </font><font style="vertical-align: inherit;">结构不同于通常的客户端插件声明宏所使用的结构，特别是前两个成员是显式提供的，而不是声明宏。）
</font></font></p>
<div class="section">

<div class="titlepage">
<div>
<div>
<h5 class="title"><a name="writing-authentication-plugins-server-side"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.4.9.1编写服务器端身份验证插件</font></font></h5>
</div>
</div>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            用所有服务器插件类型通用的一般描述符格式声明服务器端插件（参见</font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#server-plugin-descriptors" title="28.2.4.2.1服务器插件库和插件描述符"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.2.4.2.1节“服务器插件库和插件描述符”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">对于
             </font></font><code class="literal">auth_simple</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">插件，描述符如下所示：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql_declare_plugin（auth_simple）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_AUTHENTICATION_PLUGIN，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  ＆auth_simple_handler，/ *类型特定描述符* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “auth_simple”，/ *插件名称* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “作者姓名”，/ *作者* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “任何密码认证插件”，/ *描述* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  PLUGIN_LICENSE_GPL，/ *许可证类型* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  NULL，/ *没有初始化函数* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  NULL，/ *没有deinit函数* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  0x0100，/ *版本= 1.0 * /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  NULL，/ *没有状态变量* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  NULL，/ *没有系统变量* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  NULL，/ *没有保留的信息* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  0 / *没有标志* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql_declare_plugin_end;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            所述</font></font><code class="literal">name</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">构件（</font></font><code class="literal">auth_simple</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）指示要用于如在语句中的插件的引用名称
             </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#install-plugin" title="13.7.3.3安装PLUGIN语法"><code class="literal">INSTALL PLUGIN</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
             </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#uninstall-plugin" title="13.7.3.4卸载PLUGIN语法"><code class="literal">UNINSTALL PLUGIN</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这也是由</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-plugins" title="13.7.5.25 SHOW PLUGINS语法"><code class="literal">SHOW
            PLUGINS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
             </font><font style="vertical-align: inherit;">显示的名称</font></font><a class="link" href="/mysql-5.7-google-zh/information-schema.html#plugins-table" title="24.16 INFORMATION_SCHEMA插件表"><code class="literal">INFORMATION_SCHEMA.PLUGINS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
          </font></font></p><p><font style="vertical-align: inherit;"></font><code class="literal">auth_simple_handler</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一般描述符</font><font style="vertical-align: inherit;">
            的</font><font style="vertical-align: inherit;">成员指向特定于类型的描述符。</font><font style="vertical-align: inherit;">对于认证插件，类型特定的描述符是</font></font><code class="literal">st_mysql_auth</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            结构</font><font style="vertical-align: inherit;">的实例</font><font style="vertical-align: inherit;">（定义在</font></font><code class="filename">plugin_auth.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）中：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">struct st_mysql_auth</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  int interface_version;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  const char * client_auth_plugin;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  int（* authenticate_user）（MYSQL_PLUGIN_VIO * vio，MYSQL_SERVER_AUTH_INFO * info）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  int（* generate_authentication_string）（char * outbuf，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      unsigned int * outbuflen，const char * inbuf，unsigned int inbuflen）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  int（* validate_authentication_string）（char * const inbuf，unsigned int buflen）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  int（* set_salt）（const char *密码，unsigned int password_len，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                  unsigned char * salt，unsigned char * salt_len）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  const unsigned long authentication_flags;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
};</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            该</font></font><code class="literal">st_mysql_auth</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结构具有以下成员：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
                <code class="literal">interface_version</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：始终是特定于类型的API版本号
                </font></font><code class="literal">MYSQL_AUTHENTICATION_INTERFACE_VERSION</code>
              </p></li><li class="listitem"><p>
                <code class="literal">client_auth_plugin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：客户端插件名称
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">authenticate_user</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：指向与客户端通信的主插件函数的指针
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">generate_authentication_string</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：一个指向插件函数的指针，它从认证字符串生成密码摘要（在MySQL 5.7.6中添加）
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">validate_authentication_string</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：一个指向插件函数的指针，用于验证密码摘要（在MySQL 5.7.6中添加）
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">set_salt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：一个指向一个插件函数的指针，它将密码转换为二进制形式（在MySQL 5.7.6中添加）
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">authentication_flags</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：一个标志字（在MySQL 5.7.8中添加）
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"></font><code class="literal">client_auth_plugin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果需要特定的插件</font><font style="vertical-align: inherit;">
            ，</font><font style="vertical-align: inherit;">成员应该指出客户端插件的名称。</font><font style="vertical-align: inherit;">值的</font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">意思是
             </font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">任何插件。</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在后一种情况下，无论客户使用什么插件都可以。</font><font style="vertical-align: inherit;">如果服务器插件不关心客户端插件或它发送的用户名或密码，这很有用。</font><font style="vertical-align: inherit;">例如，如果服务器插件只验证本地客户端并使用操作系统的某些属性，而不是客户端插件发送的信息，则情况可能如此。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            因为</font></font><code class="literal">auth_simple</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，类型特定的描述符如下所示：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">static struct st_mysql_auth auth_simple_handler =</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_AUTHENTICATION_INTERFACE_VERSION，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “auth_simple”，/ *需要客户端插件名称* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  auth_simple_server / *服务器端插件主要功能* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  generate_auth_string_hash，/ *从密码字符串中生成摘要* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  validate_auth_string_hash，/ *验证密码摘要* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  set_salt，/ *生成密码salt值* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  AUTH_FLAG_PRIVILEGED_USER_FOR_PASSWORD_CHANGE</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
};</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            主函数，</font></font><code class="literal">auth_simple_server()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">需要两个参数来表示一个I / O结构和一个
             </font></font><code class="literal">MYSQL_SERVER_AUTH_INFO</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结构。</font><font style="vertical-align: inherit;">结构定义
             </font></font><code class="filename">plugin_auth.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如下所示：
          </font></font></p><a class="indexterm" name="idm140527955307472"></a><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">typedef struct st_mysql_server_auth_info</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  char * user_name;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  unsigned int user_name_length;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  const char * auth_string;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  unsigned long auth_string_length;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  char authenticated_as [MYSQL_USERNAME_LENGTH + 1];</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  char external_user [512];</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  int password_used;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  const char * host_or_ip;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  unsigned int host_or_ip_length;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
} MYSQL_SERVER_AUTH_INFO;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            字符串成员的字符集是UTF-8。</font><font style="vertical-align: inherit;">如果存在</font></font><code class="literal">_length</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">与字符串关联</font><font style="vertical-align: inherit;">的
             </font><font style="vertical-align: inherit;">成员，则表示字符串的字节长度。</font><font style="vertical-align: inherit;">字符串也是空终止的。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            当一个认证插件被服务器调用时，它应该</font></font><code class="literal">MYSQL_SERVER_AUTH_INFO</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如下</font><font style="vertical-align: inherit;">解释
             </font><font style="vertical-align: inherit;">结构成员。</font><font style="vertical-align: inherit;">其中一些用于设置客户端会话中的SQL函数或系统变量的值，如图所示。
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
                <code class="literal">user_name</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：客户端发送的用户名。</font><font style="vertical-align: inherit;">该值成为
                 </font></font><a class="link" href="/mysql-5.7-google-zh/functions.html#function_user"><code class="literal">USER()</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数值。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">user_name_length</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><code class="literal">user_name</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以字节</font><font style="vertical-align: inherit;">为</font><font style="vertical-align: inherit;">单位</font><font style="vertical-align: inherit;">的长度
                 </font><font style="vertical-align: inherit;">。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">auth_string</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font><font style="vertical-align: inherit;">匹配帐户名称（即与客户端用户名和主机名相匹配的行以及服务器用于确定如何验证客户端的行）</font></font><code class="literal">authentication_string</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的
                 </font></font><code class="literal">mysql.user</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表行列</font><font style="vertical-align: inherit;">的值
                 </font><font style="vertical-align: inherit;">。
              </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                假设您使用以下语句创建帐户：
              </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CREATE USER'my_user'@'localhost'</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  用my_plugin AS'my_auth_string'识别;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                当</font></font><code class="literal">my_user</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从本地主机连接时，服务器将调用</font></font><code class="literal">my_plugin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                并传递</font></font><code class="literal">'my_auth_string'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">给它作为</font></font><code class="literal">auth_string</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">auth_string_length</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><code class="literal">auth_string</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以字节</font><font style="vertical-align: inherit;">为</font><font style="vertical-align: inherit;">单位</font><font style="vertical-align: inherit;">的长度
                 </font><font style="vertical-align: inherit;">。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">authenticated_as</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：服务器将其设置为用户名（值
                 </font></font><code class="literal">user_name</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">该插件可以改变它以表明客户端应该拥有不同用户的权限。</font><font style="vertical-align: inherit;">例如，如果插件支持代理用户，则初始值是连接（代理）用户的名称，插件可以将此成员更改为代理用户名。</font><font style="vertical-align: inherit;">然后，服务器将代理用户视为具有代理用户的特权（假设满足代理用户支持的其他条件;请参见
                 </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#writing-authentication-plugins-proxy-users" title="28.2.4.9.4在认证插件中实现代理用户支持"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.2.4.9.4节“在验证插件中实现代理用户支持”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">该值表示为</font></font><code class="literal">MYSQL_USER_NAME_LENGTH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最长字节</font><font style="vertical-align: inherit;">的字符串
                 </font><font style="vertical-align: inherit;">，加上终止的空值。</font><font style="vertical-align: inherit;">该值成为
                 </font></font><a class="link" href="/mysql-5.7-google-zh/functions.html#function_current-user"><code class="literal">CURRENT_USER()</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数值。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">external_user</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：服务器将其设置为空字符串（空终止）。</font><font style="vertical-align: inherit;">它的值成为</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_external_user"><code class="literal">external_user</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                系统变量值。</font><font style="vertical-align: inherit;">如果插件希望该系统变量具有不同的值，则应该相应地设置该成员; </font><font style="vertical-align: inherit;">例如，连接到用户名。</font><font style="vertical-align: inherit;">该值表示为长度最多为511个字节的字符串，加上终止的空值。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">password_used</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：此成员在身份验证失败时适用。</font><font style="vertical-align: inherit;">该插件可以设置它或忽略它。</font><font style="vertical-align: inherit;">该值用于构造失败错误消息</font></font><code class="literal">Authentication fails. Password
                used: %s</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">如下表所示</font><font style="vertical-align: inherit;">，</font></font><code class="literal">password_used</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">决定如何
                 </font></font><code class="literal">%s</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">处理</font><font style="vertical-align: inherit;">的值
                 </font><font style="vertical-align: inherit;">。
</font></font></p>
<div class="informaltable">
<a name="mysql-server-auth-info-password-used-member"></a><table summary="Values for the password_used member and how values are handled in the construction of Authentication fails. Password used: %s messages."><colgroup><col width="25%"><col width="75%"></colgroup><thead><tr>
                    <th scope="col"><code class="literal">password_used</code></th>
                    <th scope="col"><code class="literal">%s</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 处理</font></font></th>
                  </tr></thead><tbody><tr>
                    <td scope="row"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
                    <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">没有</font></font></td>
                  </tr><tr>
                    <td scope="row"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
                    <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是</font></font></td>
                  </tr><tr>
                    <td scope="row"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></td>
                    <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将没有 </font></font><code class="literal">%s</code></td>
</tr></tbody></table>
</div>
</li><li class="listitem"><p>
                <code class="literal">host_or_ip</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：客户端主机的名称（如果可以解析），否则为IP地址。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">host_or_ip_length</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><code class="literal">host_or_ip</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以字节</font><font style="vertical-align: inherit;">为</font><font style="vertical-align: inherit;">单位</font><font style="vertical-align: inherit;">的长度
                 </font><font style="vertical-align: inherit;">。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            的</font></font><code class="literal">auth_simple</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">主要功能，
             </font></font><code class="literal">auth_simple_server()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，读取来自客户端的密码（一个空终止字符串）和成功，如果密码不为空（第一个字节不是null）：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">static int auth_simple_server（MYSQL_PLUGIN_VIO * vio，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                               MYSQL_SERVER_AUTH_INFO * info）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  无符号字符* pkt;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  int pkt_len;</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  / *读取密码为空终止的字符串，失败时出错* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  如果（（pkt_len = vio-&gt; read_packet（vio，＆pkt））&lt;0）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    返回CR_ERROR;</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  / *空密码失败* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  if（！pkt_len || * pkt =='\ 0'）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  {</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    info-&gt; password_used = PASSWORD_USED_NO;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    返回CR_ERROR;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  }</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  / *接受任何非空密码* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  info-&gt; password_used = PASSWORD_USED_YES;</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  返回CR_OK;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            主函数应返回下表中显示的错误代码之一。
</font></font></p>
<div class="informaltable">
<a name="auth-simple-server-error-codes"></a><table summary="Error codes for the auth_simple main function, auth_simple_server(), and the meaning of each error code."><colgroup><col width="40%"><col width="60%"></colgroup><thead><tr>
                <th scope="col"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">错误代码</font></font></th>
                <th scope="col"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">含义</font></font></th>
              </tr></thead><tbody><tr>
                <td scope="row"><code class="literal">CR_OK</code></td>
                <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">成功</font></font></td>
              </tr><tr>
                <td scope="row"><code class="literal">CR_OK_HANDSHAKE_COMPLETE</code></td>
                <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不要将状态数据包发送回客户端</font></font></td>
              </tr><tr>
                <td scope="row"><code class="literal">CR_ERROR</code></td>
                <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">错误</font></font></td>
              </tr><tr>
                <td scope="row"><code class="literal">CR_AUTH_USER_CREDENTIALS</code></td>
                <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">验证失败</font></font></td>
              </tr><tr>
                <td scope="row"><code class="literal">CR_AUTH_HANDSHAKE</code></td>
                <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">身份验证握手失败</font></font></td>
              </tr><tr>
                <td scope="row"><code class="literal">CR_AUTH_PLUGIN_ERROR</code></td>
                <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内部插件错误</font></font></td>
</tr></tbody></table>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            有关握手如何工作的示例，请参阅
             </font></font><code class="filename">plugin/auth/dialog.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">源文件。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            服务器计算性能模式</font></font><a class="link" href="/mysql-5.7-google-zh/performance-schema.html#host-cache-table" title="25.11.16.1 host_cache表"><code class="literal">host_cache</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表</font><font style="vertical-align: inherit;">中的插件错误
             </font><font style="vertical-align: inherit;">。
          </font></font></p><p>
            <code class="literal">auth_simple_server()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 是非常基本的，除了设置指示是否接收到密码的成员之外，它不使用认证信息结构。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            支持代理用户的插件必须向服务器返回代理用户（具有客户端用户应具有的权限的MySQL用户）的名称。</font><font style="vertical-align: inherit;">为此，插件必须将
             </font></font><code class="literal">info-&gt;authenticated_as</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">成员设置为代理用户名。</font><font style="vertical-align: inherit;">有关代理的信息，请参见
             </font></font><a class="xref" href="/mysql-5.7-google-zh/security.html#proxy-users" title="6.3.10代理用户"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第6.3.10节“代理用户”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
             </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#writing-authentication-plugins-proxy-users" title="28.2.4.9.4在认证插件中实现代理用户支持"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.2.4.9.4节“在认证插件中实现代理用户支持”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
          </font></font></p><p><font style="vertical-align: inherit;"></font><code class="literal">generate_authentication_string</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">插件描述符</font><font style="vertical-align: inherit;">
            的</font><font style="vertical-align: inherit;">成员接收密码并从中生成密码哈希（摘要）：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                前两个参数是指向输出缓冲区的指针及其最大长度（以字节为单位）。</font><font style="vertical-align: inherit;">该函数应该将密码散列写入输出缓冲区，并将长度重置为实际的散列长度。
              </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                后面的两个参数指示密码输入缓冲区及其以字节为单位的长度。
              </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                该函数返回0表示成功，如果发生错误则返回1。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            对于</font></font><code class="literal">auth_simple</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">插件，该
             </font></font><code class="literal">generate_auth_string_hash()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数实现该
             </font></font><code class="literal">generate_authentication_string</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">成员。</font><font style="vertical-align: inherit;">它只是创建一个密码的副本，除非它太长而不适合输出缓冲区。
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">int generate_auth_string_hash（char * outbuf，unsigned int * buflen，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                              const char * inbuf，unsigned int inbuflen）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  / *</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    如果服务器指定的缓冲区不能复制到输出缓冲区，则失败</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  * /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  如果（* buflen &lt;inbuflen）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    返回1; </font><font style="vertical-align: inherit;">/ *错误* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  strncpy（outbuf，inbuf，inbuflen）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  * buflen = strlen（inbuf）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  返回0; </font><font style="vertical-align: inherit;">/ *成功* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"></font><code class="literal">validate_authentication_string</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">插件描述符</font><font style="vertical-align: inherit;">
            的</font><font style="vertical-align: inherit;">成员验证密码哈希值：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                这些参数是一个指向密码散列的指针及其以字节为单位的长度。
              </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                该函数返回0表示成功，如果密码哈希无法验证，则返回1。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            对于</font></font><code class="literal">auth_simple</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">插件，该
             </font></font><code class="literal">validate_auth_string_hash()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数实现该
             </font></font><code class="literal">validate_authentication_string</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">成员。</font><font style="vertical-align: inherit;">它无条件地回报成功：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">int validate_auth_string_hash（char * const inbuf __attribute __（（未使用）），</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                              unsigned int buflen __attribute __（（未使用）））</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  返回0; </font><font style="vertical-align: inherit;">/ *成功* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font>
<font></font>
</pre><p><font style="vertical-align: inherit;"></font><code class="literal">set_salt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">插件描述符</font><font style="vertical-align: inherit;">
            的</font><font style="vertical-align: inherit;">成员仅由
             </font></font><code class="literal">mysql_native_password</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">插件使用（请参见
             </font></font><a class="xref" href="/mysql-5.7-google-zh/security.html#native-pluggable-authentication" title="6.5.1.1本地可插拔认证"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第6.5.1.1节“本机可插入验证”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">对于其他身份验证插件，您可以使用这个微不足道的实现：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">int set_salt（const char * password __attribute __（（未使用）），</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
             unsigned int password_len __attribute __（（未使用）），</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
             unsigned char * salt __attribute __（（未使用）），</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
             无符号字符* salt_len）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  * salt_len = 0;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  返回0; </font><font style="vertical-align: inherit;">/ *成功* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"></font><code class="literal">authentication_flags</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">插件描述符</font><font style="vertical-align: inherit;">
            的</font><font style="vertical-align: inherit;">成员包含影响插件操作的标志。</font><font style="vertical-align: inherit;">允许的标志是：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
                <code class="literal">AUTH_FLAG_PRIVILEGED_USER_FOR_PASSWORD_CHANGE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：凭据更改是特权操作。</font><font style="vertical-align: inherit;">如果设置了此标志，则服务器要求用户具有</font><font style="vertical-align: inherit;">数据库</font><font style="vertical-align: inherit;">的全局</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_create-user"><code class="literal">CREATE USER</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                特权或</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_update"><code class="literal">UPDATE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                特权</font></font><code class="literal">mysql</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">AUTH_FLAG_USES_INTERNAL_STORAGE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：插件是否使用内部存储（</font><font style="vertical-align: inherit;">在行</font><font style="vertical-align: inherit;">的
                 </font></font><code class="literal">authentication_string</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">列中
                 </font></font><code class="literal">mysql.user</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">如果未设置此标志，则尝试设置密码失败，服务器将发出警告。
</font></font></p></li></ul>
</div>

</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h5 class="title"><a name="writing-authentication-plugins-client-side"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.4.9.2编写客户端身份验证插件</font></font></h5>

</div>

</div>

</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            使用</font></font><code class="literal">mysql_declare_client_plugin()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
             </font></font><code class="literal">mysql_end_client_plugin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">宏</font><font style="vertical-align: inherit;">声明客户端插件描述符
             </font><font style="vertical-align: inherit;">（请参见
             </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#client-plugin-descriptors" title="28.2.4.2.3客户端插件描述符"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.2.4.2.3节“客户端插件描述符”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">对于
             </font></font><code class="literal">auth_simple</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">插件，描述符如下所示：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql_declare_client_plugin（认证）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “auth_simple”，/ *插件名称* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “作者姓名”，/ *作者* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “任何密码认证插件”，/ *描述* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  {1,0,0}，/ *版本= 1.0.0 * /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “GPL”，/ *许可证类型* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  NULL，/ *供内部使用* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  NULL，/ *没有初始化函数* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  NULL，/ *没有deinit函数* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  NULL，/ *没有选项处理函数* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  auth_simple_client / *主要功能* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql_end_client_plugin;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            插件名称到选项处理函数的描述符成员对于所有客户端插件类型都是通用的。</font><font style="vertical-align: inherit;">（有关说明，请参见
             </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#client-plugin-descriptors" title="28.2.4.2.3客户端插件描述符"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.2.4.2.3节“客户端插件描述符”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。）在常见成员之后，描述符具有特定于验证插件的其他成员。</font><font style="vertical-align: inherit;">这是</font><font style="vertical-align: inherit;">处理与服务器通信</font><font style="vertical-align: inherit;">的
             </font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">主</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">功能。</font><font style="vertical-align: inherit;">该函数接受两个表示I / O结构和连接处理程序的参数。</font><font style="vertical-align: inherit;">对于我们简单的任何密码插件，主函数只会向服务器写入用户提供的密码：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">static int auth_simple_client（MYSQL_PLUGIN_VIO * vio，MYSQL * mysql）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  int res;</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  / *以明文形式发送密码为空终止的字符串* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  res = vio-&gt; write_packet（vio，（const unsigned char *）mysql-&gt; passwd，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                         strlen（mysql-&gt; passwd）+ 1）;</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  返回资源？</font><font style="vertical-align: inherit;">CR_ERROR：CR_OK;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            主函数应返回下表中显示的错误代码之一。
</font></font></p>
<div class="informaltable">
<a name="auth-simple-client-error-codes"></a><table summary="Error codes for the authentication main function and the meaning of each function."><colgroup><col width="40%"><col width="60%"></colgroup><thead><tr>
                <th scope="col"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">错误代码</font></font></th>
                <th scope="col"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">含义</font></font></th>
              </tr></thead><tbody><tr>
                <td scope="row"><code class="literal">CR_OK</code></td>
                <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">成功</font></font></td>
              </tr><tr>
                <td scope="row"><code class="literal">CR_OK_HANDSHAKE_COMPLETE</code></td>
                <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">成功，客户完成</font></font></td>
              </tr><tr>
                <td scope="row"><code class="literal">CR_ERROR</code></td>
                <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">错误</font></font></td>
</tr></tbody></table>
</div>
<p>
            <code class="literal">CR_OK_HANDSHAKE_COMPLETE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表示客户端已成功完成并读取了最后一个数据包。</font></font><code class="literal">CR_OK_HANDSHAKE_COMPLETE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果认证协议中的往返次数未知，并且插件必须读取另一个数据包以确定认证是否完成，则</font><font style="vertical-align: inherit;">客户端插件可能会返回
             </font><font style="vertical-align: inherit;">。
</font></font></p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h5 class="title"><a name="writing-authentication-plugins-setup"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.4.9.3使用认证插件</font></font></h5>

</div>

</div>

</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            要编译和安装插件库文件，请使用
             </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#compiling-plugin-libraries" title="28.2.4.3编译和安装插件库"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.2.4.3节“编译和安装插件库”中的说明</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">要使库文件可供使用，请将其安装在插件目录（由</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_plugin_dir"><code class="literal">plugin_dir</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统变量</font><font style="vertical-align: inherit;">命名的目录
             </font><font style="vertical-align: inherit;">）中。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            向服务器注册服务器端插件。</font><font style="vertical-align: inherit;">例如，要在服务器启动时加载插件，请使用
             </font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#option_mysqld_plugin-load"><code class="option">--plugin-load=auth_simple.so</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            选项（</font></font><code class="filename">.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">必要时根据您的平台</font><font style="vertical-align: inherit;">调整</font><font style="vertical-align: inherit;">后缀）。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            创建一个用户，服务器将使用该
             </font></font><code class="literal">auth_simple</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">插件进行身份验证：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql&gt; </font></font><strong class="userinput"><code>CREATE USER 'x'@'localhost'</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    - &gt;</font></font><strong class="userinput"><code>IDENTIFIED WITH auth_simple;</code></strong>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            使用客户端程序以用户身份连接到服务器
             </font></font><code class="literal">x</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">服务器端
             </font></font><code class="literal">auth_simple</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">插件与客户端程序通信，它应该使用客户端
             </font></font><code class="literal">auth_simple</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">插件，后者将密码发送到服务器。</font><font style="vertical-align: inherit;">服务器插件应拒绝发送空密码的连接，并接受发送非空密码的连接。</font><font style="vertical-align: inherit;">通过各种方式调用客户端程序来验证这一点：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">外壳&gt; </font></font><strong class="userinput"><code>mysql --user=x --skip-password</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
错误1045（28000）：拒绝访问用户'x'@'localhost'（使用密码：否）</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
shell&gt; </font></font><strong class="userinput"><code>mysql --user=x --password</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
输入密码：</font></font><strong class="userinput"><code>abc</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MySQL的&gt;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            由于服务器插件接受任何非空密码，因此应将其视为不安全。</font><font style="vertical-align: inherit;">在测试插件以验证它是否正常工作之后，请重新启动服务器而不使用该
             </font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#option_mysqld_plugin-load"><code class="option">--plugin-load</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">选项，以便不会无意中使加载了不安全身份验证插件的服务器运行。</font><font style="vertical-align: inherit;">另外，请放下用户</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#drop-user" title="13.7.1.3 DROP USER语法"><code class="literal">DROP USER
            'x'@'localhost'</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            有关加载和使用身份验证插件的其他信息，请参见
             </font></font><a class="xref" href="/mysql-5.7-google-zh/server-administration.html#server-plugin-loading" title="5.5.1安装和卸载插件"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第5.5.1节“安装和卸载插件”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以及
             </font></font><a class="xref" href="/mysql-5.7-google-zh/security.html#pluggable-authentication" title="6.3.9可插入认证"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第6.3.9节“可插入身份验证”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            如果您正在编写支持使用身份验证插件的客户端程序，通常这样的程序会通过调用</font></font><a class="link" href="/mysql-5.7-google-zh/connectors-apis.html#mysql-options" title="27.8.7.50 mysql_options（）"><code class="literal">mysql_options()</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以设置
             </font></font><code class="literal">MYSQL_DEFAULT_AUTH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
             </font></font><code class="literal">MYSQL_PLUGIN_DIR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">选项</font><font style="vertical-align: inherit;">来加载插件
             </font><font style="vertical-align: inherit;">：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">char * plugin_dir =“ </font></font><em class="replaceable"><code>path_to_plugin_dir</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">”;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
char * default_auth =“ </font></font><em class="replaceable"><code>plugin_name</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">”;</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
/ * ...进程命令行选项... * /</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql_options（＆mysql，MYSQL_PLUGIN_DIR，plugin_dir）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql_options（＆mysql，MYSQL_DEFAULT_AUTH，default_auth）;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            通常情况下，该程序还将接受
             </font></font><code class="option">--plugin-dir</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
             </font></font><code class="option">--default-auth</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用户能够覆盖默认值的选项。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            如果客户端程序需要较低级别的插件管理，则客户端库包含接受</font></font><code class="literal">st_mysql_client_plugin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参数的函数。</font><font style="vertical-align: inherit;">请参见
             </font></font><a class="xref" href="/mysql-5.7-google-zh/connectors-apis.html#c-api-plugin-functions" title="27.8.14 C API客户端插件功能"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第27.8.14节“C API客户端插件函数”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h5 class="title"><a name="writing-authentication-plugins-proxy-users"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.4.9.4在认证插件中实现代理用户支持</font></font></h5>

</div>

</div>

</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            代理用户可以使用可插入认证的功能之一（见</font></font><a class="xref" href="/mysql-5.7-google-zh/security.html#proxy-users" title="6.3.10代理用户"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第6.3.10节“代理用户”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">要使服务器端身份验证插件参与代理用户支持，必须满足以下条件：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                当连接客户端应被视为代理用户时，插件必须</font></font><code class="literal">authenticated_as</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在</font></font><code class="literal">MYSQL_SERVER_AUTH_INFO</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结构</font><font style="vertical-align: inherit;">成员中
                 </font><font style="vertical-align: inherit;">返回不同的名称
                 </font><font style="vertical-align: inherit;">，以指示代理用户名。</font><font style="vertical-align: inherit;">它也可以选择设置</font></font><code class="literal">external_user</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">成员来设置</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_external_user"><code class="literal">external_user</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统变量</font><font style="vertical-align: inherit;">的值
                 </font><font style="vertical-align: inherit;">。
              </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                代理用户帐户必须设置为由插件进行认证。</font><font style="vertical-align: inherit;">使用</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#create-user" title="13.7.1.2 CREATE USER语法"><code class="literal">CREATE
                USER</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#grant" title="13.7.1.4 GRANT语法"><code class="literal">GRANT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                语句将帐户与插件相关联。
              </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                代理用户帐户必须具有</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_proxy"><code class="literal">PROXY</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">代理帐户</font><font style="vertical-align: inherit;">的
                 </font><font style="vertical-align: inherit;">权限。</font><font style="vertical-align: inherit;">使用该
                 </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#grant" title="13.7.1.4 GRANT语法"><code class="literal">GRANT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句来授予此特权。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            换句话说，插件所需的代理用户支持的唯一方面是它设置
             </font></font><code class="literal">authenticated_as</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为代理用户名。</font><font style="vertical-align: inherit;">其余部分是可选的（设置
             </font></font><code class="literal">external_user</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）或由DBA使用SQL语句完成。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            身份验证插件如何确定代理用户连接时要返回哪个代理用户？</font><font style="vertical-align: inherit;">这取决于插件。</font><font style="vertical-align: inherit;">通常，插件根据服务器传递给它的认证字符串将客户端映射到代理用户。</font><font style="vertical-align: inherit;">这个字符串来自于</font></font><code class="literal">AS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            。的</font></font><code class="literal">IDENTIFIED WITH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">子句
             </font><font style="vertical-align: inherit;">部分</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#create-user" title="13.7.1.2 CREATE USER语法"><code class="literal">CREATE USER</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">声明</font><font style="vertical-align: inherit;">指定使用插件进行身份验证。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            插件开发者确定认证字符串的语法规则并根据这些规则实现插件。</font><font style="vertical-align: inherit;">假设一个插件需要一个逗号分隔的列表，将外部用户映射到MySQL用户。</font><font style="vertical-align: inherit;">例如：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CREATE USER''@'％。example.com'</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  用my_plugin AS'extuser1 = mysqlusera，extuser2 = mysqluserb'</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CREATE USER''@'％。example.org'</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  IDENTIFIED WITH my_plugin AS'extuser1 = mysqluserc，extuser2 = mysqluserd'</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            当服务器调用插件来认证客户端时，它会将相应的认证字符串传递给插件。</font><font style="vertical-align: inherit;">该插件负责：
</font></font></p>
<div class="orderedlist">
<ol class="orderedlist" type="1"><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                将字符串解析为其组件以确定要使用的映射
              </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                将客户端用户名与映射进行比较
              </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                返回正确的MySQL用户名
</font></font></p></li></ol>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            例如，如果</font></font><code class="literal">extuser2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从</font></font><code class="literal">example.com</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">主机</font><font style="vertical-align: inherit;">连接
             </font><font style="vertical-align: inherit;">，则服务器传递
             </font></font><code class="literal">'extuser1=mysqlusera,
            extuser2=mysqluserb'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">给插件，插件应该复制</font></font><code class="literal">mysqluserb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">到
             </font></font><code class="literal">authenticated_as</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">终止空字节。</font><font style="vertical-align: inherit;">如果</font></font><code class="literal">extuser2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从</font></font><code class="literal">example.org</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">主机</font><font style="vertical-align: inherit;">连接
             </font><font style="vertical-align: inherit;">，则服务器通过
             </font></font><code class="literal">'extuser1=mysqluserc,
            extuser2=mysqluserd'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，插件应该复制
             </font></font><code class="literal">mysqluserd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            如果映射中没有匹配，则操作取决于插件。</font><font style="vertical-align: inherit;">如果需要匹配，该插件可能会返回错误。</font><font style="vertical-align: inherit;">或者插件可能只是返回客户端名称; </font><font style="vertical-align: inherit;">在这种情况下，它不应该改变
             </font></font><code class="literal">authenticated_as</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，并且服务器不会将客户端视为代理。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            以下示例演示如何使用名为的插件处理代理用户</font></font><code class="literal">auth_simple_proxy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">像</font></font><code class="literal">auth_simple</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前面介绍</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">插件一样，</font></font><code class="literal">auth_simple_proxy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">接受任何非空密码作为有效（因此不应在生产环境中使用）。</font><font style="vertical-align: inherit;">另外，它检查
             </font></font><code class="literal">auth_string</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">认证字符串成员并使用这些非常简单的规则来解释它：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                如果字符串为空，则该插件返回给定的用户名并且不发生代理。</font><font style="vertical-align: inherit;">也就是说，插件</font></font><code class="literal">authenticated_as</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                保持不变</font><font style="vertical-align: inherit;">的值</font><font style="vertical-align: inherit;">。
              </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                如果字符串非空，插件会将其视为代理用户的名称并将其复制到</font></font><code class="literal">authenticated_as</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">代理</font><font style="vertical-align: inherit;">，
                 </font><font style="vertical-align: inherit;">以便进行代理。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            要进行测试，请根据上述规则设置一个未被代理的帐户，并且该帐户为。</font><font style="vertical-align: inherit;">这意味着一个帐户没有</font></font><code class="literal">AS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">子句，并且</font><font style="vertical-align: inherit;">一个帐户</font><font style="vertical-align: inherit;">包含一个</font></font><code class="literal">AS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">名称为被代理用户</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">子句：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CREATE USER'plugin_user1'@'localhost'</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  通过auth_simple_proxy进行身份识别;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CREATE USER'plugin_user2'@'localhost'</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  用auth_simple_proxy作为'proxied_user'识别;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            此外，由代理用户创建一个帐户，并授予</font></font><code class="literal">plugin_user2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的
             </font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_proxy"><code class="literal">PROXY</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特权吧：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CREATE USER'proxied_user'@'localhost'</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  被'proxied_user_pass'识别;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
授予代理</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  ON'proxied_user'@'localhost'</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  TO'plugin_user2'@'localhost';</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            在服务器调用认证插件之前，它将设置
             </font></font><code class="literal">authenticated_as</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为客户端用户名。</font><font style="vertical-align: inherit;">为了表明用户是代理，插件应该设置
             </font></font><code class="literal">authenticated_as</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为代理用户名。</font><font style="vertical-align: inherit;">因为</font></font><code class="literal">auth_simple_proxy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这意味着它必须检查该</font></font><code class="literal">auth_string</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            值，如果该值非空，则将其复制到
             </font></font><code class="literal">authenticated_as</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">成员以将其作为代理用户的名称返回。</font><font style="vertical-align: inherit;">另外，当代理发生时，插件将</font></font><code class="literal">external_user</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            成员设置为客户端用户名; </font><font style="vertical-align: inherit;">这成为</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_external_user"><code class="literal">external_user</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统变量</font><font style="vertical-align: inherit;">的值</font><font style="vertical-align: inherit;">。
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">static int auth_simple_proxy_server（MYSQL_PLUGIN_VIO * vio，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                                     MYSQL_SERVER_AUTH_INFO * info）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  无符号字符* pkt;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  int pkt_len;</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  / *读取密码为空终止的字符串，失败时出错* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  如果（（pkt_len = vio-&gt; read_packet（vio，＆pkt））&lt;0）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    返回CR_ERROR;</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  / *空密码失败* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  if（！pkt_len || * pkt =='\ 0'）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  {</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    info-&gt; password_used = PASSWORD_USED_NO;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    返回CR_ERROR;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  }</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  / *接受任何非空密码* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  info-&gt; password_used = PASSWORD_USED_YES;</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  / *如果认证字符串不为空，则用作代理用户名* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  / *并使用客户端名称作为external_user值* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  如果（info-&gt; auth_string_length&gt; 0）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  {</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    strcpy（info-&gt; authenticated_as，info-&gt; auth_string）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    strcpy（info-&gt; external_user，info-&gt; user_name）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  }</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  返回CR_OK;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            连接成功后，该
             </font></font><a class="link" href="/mysql-5.7-google-zh/functions.html#function_user"><code class="literal">USER()</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">功能应指示连接的客户端用户名和主机名，并
             </font></font><a class="link" href="/mysql-5.7-google-zh/functions.html#function_current-user"><code class="literal">CURRENT_USER()</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">应指出在会话期间特权适用的帐户。</font><font style="vertical-align: inherit;">后者的值应该是连接用户帐户，如果没有代理发生或代理帐户，如果代理确实发生。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            编译并安装插件，然后测试它。</font><font style="vertical-align: inherit;">首先，连接为</font></font><code class="literal">plugin_user1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shell&gt; </font></font><strong class="userinput"><code>mysql --user=plugin_user1 --password</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
输入密码：</font></font><strong class="userinput"><code>x</code></strong>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            在这种情况下，不应该有代理：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL的&gt; </font></font><strong class="userinput"><code>SELECT USER(), CURRENT_USER(), @@proxy_user, @@external_user\G</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
*************************** 1. row ******************** *******</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
         USER（）：plugin_user1 @ localhost</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 CURRENT_USER（）：plugin_user1 @ localhost</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   @@ proxy_user：NULL</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
@@ external_user：NULL</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            然后连接为</font></font><code class="literal">plugin_user2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shell&gt; </font></font><strong class="userinput"><code>mysql --user=plugin_user2 --password</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
输入密码：</font></font><strong class="userinput"><code>x</code></strong>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            在这种情况下，</font></font><code class="literal">plugin_user2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">应该代理到</font></font><code class="literal">proxied_user</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL的&gt; </font></font><strong class="userinput"><code>SELECT USER(), CURRENT_USER(), @@proxy_user, @@external_user\G</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
*************************** 1. row ******************** *******</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
         USER（）：plugin_user2 @ localhost</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 CURRENT_USER（）：proxied_user @ localhost</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   @@ proxy_user：'plugin_user2'@'localhost'</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
@@ external_user：'plugin_user2'@'localhost'</font></font><font></font>
</pre>
</div>

</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h4 class="title"><a name="writing-password-validation-plugins"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.4.10编写密码验证插件</font></font></h4>

</div>

</div>

</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          本节介绍如何编写服务器端密码验证插件。</font><font style="vertical-align: inherit;">这些指令基于</font></font><code class="literal">plugin/password_validation</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL源代码分发目录中</font><font style="vertical-align: inherit;">的源代码
           </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">该</font></font><code class="filename">validate_password.cc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">目录中</font><font style="vertical-align: inherit;">的
           </font><font style="vertical-align: inherit;">源文件实现了名为的插件
           </font></font><code class="literal">validate_password</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          要编写密码验证插件，请将以下头文件包含在插件源文件中。</font><font style="vertical-align: inherit;">其他MySQL或通用头文件也可能需要，具体取决于插件的功能和要求。
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#include &lt;mysql / plugin_validate_password.h&gt;
</font></font></pre><p>
          <code class="filename">plugin_validate_password.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">包括
           </font></font><code class="filename">plugin.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，所以你不需要明确地包含后一个文件。</font></font><code class="filename">plugin.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">定义了</font></font><code class="literal">MYSQL_VALIDATE_PASSWORD_PLUGIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">声明该插件所需</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">服务器插件类型和数据结构。</font></font><code class="filename">plugin_validate_password.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          定义特定于密码验证插件的数据结构。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          与任何MySQL服务器插件一样，密码验证插件具有通用插件描述符（请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#server-plugin-descriptors" title="28.2.4.2.1服务器插件库和插件描述符"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.2.4.2.1节“服务器插件库和插件描述符”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">在
           </font></font><code class="filename">validate_password.cc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，一般描述符</font></font><code class="literal">validate_password</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">看起来像这样：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql_declare_plugin（validate_password）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_VALIDATE_PASSWORD_PLUGIN，/ * type * /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  ＆validate_password_descriptor，/ *描述符* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “validate_password”，/ *名称* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “Oracle Corporation”，/ *作者* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “检查密码强度”，/ *描述* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  PLUGIN_LICENSE_GPL，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  validate_password_init，/ * init函数（加载时）* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  validate_password_deinit，/ * deinit函数（卸载时）* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  0x0100，/ *版本* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  空值，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  validate_password_system_variables，/ *系统变量* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  空值，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  0，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql_declare_plugin_end;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          所述</font></font><code class="literal">name</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">构件（</font></font><code class="literal">validate_password</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）指示要用于如在语句中的插件的引用名称
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#install-plugin" title="13.7.3.3安装PLUGIN语法"><code class="literal">INSTALL PLUGIN</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#uninstall-plugin" title="13.7.3.4卸载PLUGIN语法"><code class="literal">UNINSTALL PLUGIN</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这也是由</font></font><a class="link" href="/mysql-5.7-google-zh/information-schema.html#plugins-table" title="24.16 INFORMATION_SCHEMA插件表"><code class="literal">INFORMATION_SCHEMA.PLUGINS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
           </font><font style="vertical-align: inherit;">显示的名称
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-plugins" title="13.7.5.25 SHOW PLUGINS语法"><code class="literal">SHOW PLUGINS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          一般描述符也指的是
           </font></font><code class="literal">validate_password_system_variables</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一个将几个系统变量暴露给
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-variables" title="13.7.5.39 SHOW VARIABLES语法"><code class="literal">SHOW VARIABLES</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句的结构：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">static struct st_mysql_sys_var * validate_password_system_variables [] = {</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_SYSVAR（长度），</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_SYSVAR（NUMBER_SHOWN列）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_SYSVAR（mixed_case_count）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_SYSVAR（special_char_count）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_SYSVAR（政策），</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_SYSVAR（dictionary_file）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  空值</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
};</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          的</font></font><code class="literal">validate_password_init</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">初始化函数读取字典文件如果指定一个，并且</font></font><code class="literal">validate_password_deinit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数释放与文件关联的数据结构。
        </font></font></p><p><font style="vertical-align: inherit;"></font><code class="literal">validate_password_descriptor</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一般描述符中</font><font style="vertical-align: inherit;">
          的</font><font style="vertical-align: inherit;">值指向特定于类型的描述符。</font><font style="vertical-align: inherit;">对于密码验证插件，此描述符具有以下结构：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">struct st_mysql_validate_password</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  int interface_version;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  / *</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    对于满足密码的密码，此函数返回TRUE</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    策略（由插件变量选择）以及所有其他的FALSE</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    密码</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  * /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  int（* validate_password）（mysql_string_handle password）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  / *</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    此函数返回密码强度（0-100）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    根据政策</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  * /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  int（* get_password_strength）（mysql_string_handle密码）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
};</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          类型特定的描述符具有这些成员：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              <code class="literal">interface_version</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：按照惯例，类型特定的插件描述符以给定插件类型的接口版本开头。</font><font style="vertical-align: inherit;">服务器</font></font><code class="literal">interface_version</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在加载插件时</font><font style="vertical-align: inherit;">检查
               </font><font style="vertical-align: inherit;">插件是否与其兼容。</font><font style="vertical-align: inherit;">对于密码验证插件，</font></font><code class="literal">interface_version</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">成员</font><font style="vertical-align: inherit;">的值
               </font><font style="vertical-align: inherit;">是
               </font></font><code class="literal">MYSQL_VALIDATE_PASSWORD_INTERFACE_VERSION</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              （定义在
               </font></font><code class="literal">plugin_validate_password.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）中。
            </font></font></p></li><li class="listitem"><p>
              <code class="literal">validate_password</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：服务器调用以测试密码是否满足当前密码策略的函数。</font><font style="vertical-align: inherit;">如果密码正常，它返回1，否则返回0。</font><font style="vertical-align: inherit;">参数是密码，作为一个</font></font><code class="literal">mysql_string_handle</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值</font><font style="vertical-align: inherit;">传递</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">该数据类型由
               </font></font><code class="literal">mysql_string</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">服务器服务实现。</font><font style="vertical-align: inherit;">有关详细信息，请参阅</font><font style="vertical-align: inherit;">目录中</font><font style="vertical-align: inherit;">的</font></font><code class="filename">string_service.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
               </font></font><code class="filename">string_service.cc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">源文件
               </font></font><code class="filename">sql</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
            </font></font></p></li><li class="listitem"><p>
              <code class="literal">get_password_strength</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：服务器调用以评估密码强度的函数。</font><font style="vertical-align: inherit;">它返回一个从0（弱）到100（强）的值。</font><font style="vertical-align: inherit;">参数是密码，作为一个</font></font><code class="literal">mysql_string_handle</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值</font><font style="vertical-align: inherit;">传递
               </font><font style="vertical-align: inherit;">。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          对于</font></font><code class="literal">validate_password</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">插件，类型特定的描述符如下所示：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">static struct st_mysql_validate_password validate_password_descriptor =</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_VALIDATE_PASSWORD_INTERFACE_VERSION，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  validate_password，/ *验证功能* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  get_password_strength / *验证强度函数* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
};</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          要编译和安装插件库文件，请使用</font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#compiling-plugin-libraries" title="28.2.4.3编译和安装插件库"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.2.4.3节“编译和安装插件库”中的说明</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">要使库文件可供使用，请将其安装在插件目录（由</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_plugin_dir"><code class="literal">plugin_dir</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统变量</font><font style="vertical-align: inherit;">命名的目录
           </font><font style="vertical-align: inherit;">）中。</font><font style="vertical-align: inherit;">对于</font></font><code class="literal">validate_password</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">插件，它是在从源代码构建MySQL时编译和安装的。</font><font style="vertical-align: inherit;">它也包含在二进制发行版中。</font><font style="vertical-align: inherit;">构建过程会生成一个名称为</font></font><code class="filename">validate_password.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（
           </font></font><code class="filename">.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">后缀可能因您的平台而异）</font><font style="vertical-align: inherit;">的共享对象库
           </font><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          要在运行时注册插件，请使用以下语句（</font></font><code class="filename">.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">根据需要为您的平台</font><font style="vertical-align: inherit;">调整</font><font style="vertical-align: inherit;">后缀）：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">INSTALL PLUGIN validate_password SONAME'validate_password.so';
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          有关插件加载的更多信息，请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/server-administration.html#server-plugin-loading" title="5.5.1安装和卸载插件"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第5.5.1节“安装和卸载插件”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          要验证插件安装，请检查该
           </font></font><a class="link" href="/mysql-5.7-google-zh/information-schema.html#plugins-table" title="24.16 INFORMATION_SCHEMA插件表"><code class="literal">INFORMATION_SCHEMA.PLUGINS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表或使用该</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-plugins" title="13.7.5.25 SHOW PLUGINS语法"><code class="literal">SHOW PLUGINS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          语句。</font><font style="vertical-align: inherit;">请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/server-administration.html#obtaining-plugin-information" title="5.5.2获取服务器插件信息"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第5.5.2节“获取服务器插件信息”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          在</font></font><code class="literal">validate_password</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">安装插件时，它会公开显示密码检查参数的系统变量：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL的&gt; </font></font><strong class="userinput"><code>SHOW VARIABLES LIKE 'validate_password%';</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ -------------------------------------- + -------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">变量名| </font><font style="vertical-align: inherit;">值|</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ -------------------------------------- + -------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">validate_password_dictionary_file | </font><font style="vertical-align: inherit;">|</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">validate_password_length | </font><font style="vertical-align: inherit;">8 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">validate_password_mixed_case_count | </font><font style="vertical-align: inherit;">1 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">validate_password_number_count | </font><font style="vertical-align: inherit;">1 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">validate_password_policy | </font><font style="vertical-align: inherit;">MEDIUM |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">validate_password_special_char_count | </font><font style="vertical-align: inherit;">1 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ -------------------------------------- + -------- +</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          有关这些变量的说明，请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/security.html#validate-password-options-variables" title="6.5.3.2密码验证插件选项和变量"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第6.5.3.2节“密码验证插件选项和变量”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          要在测试后禁用插件，请使用以下语句卸载它：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UNINSTALL PLUGIN validate_password;
</font></font></pre>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h4 class="title"><a name="writing-protocol-trace-plugins"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.4.11编写协议跟踪插件</font></font></h4>

</div>

</div>

</div>
<a class="indexterm" name="idm140527955000832"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          MySQL支持使用协议跟踪插件：使用客户端/服务器协议实现客户端与服务器之间通信跟踪的客户端插件。</font><font style="vertical-align: inherit;">此功能可以在MySQL 5.7.2及更高版本中使用。
</font></font></p>
<div class="section">

<div class="titlepage">
<div>
<div>
<h5 class="title"><a name="test-protocol-trace-plugin"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.4.11.1使用测试协议跟踪插件</font></font></h5>
</div>
</div>
</div>
<a class="indexterm" name="idm140527954997504"></a><a class="indexterm" name="idm140527954996416"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            MySQL包含一个测试协议跟踪插件，用于说明这些插件提供的信息，以及作为编写其他协议跟踪插件的指南。</font><font style="vertical-align: inherit;">要查看测试插件的工作方式，请使用MySQL源代码分发; </font><font style="vertical-align: inherit;">二进制发行版是在禁用测试插件的情况下构建的。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            通过启用</font><span class="command"><strong><font style="vertical-align: inherit;">CMake</font></strong></span><font style="vertical-align: inherit;">选项</font><font style="vertical-align: inherit;">配置MySQL来启用测试协议跟踪插件
             </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这会导致构建测试跟踪插件并且MySQL客户端程序加载它，但插件默认情况下不起作用。</font><font style="vertical-align: inherit;">使用这些环境变量来控制插件：
</font></font><a class="link" href="/mysql-5.7-google-zh/installing.html#option_cmake_with_test_trace_plugin"><code class="option">WITH_TEST_TRACE_PLUGIN</code></a>
            <span class="command"><strong><font style="vertical-align: inherit;"></font></strong></span><font style="vertical-align: inherit;"></font></p><a class="indexterm" name="idm140527954991664"></a><a class="indexterm" name="idm140527954990560"></a><a class="indexterm" name="idm140527954989072"></a><a class="indexterm" name="idm140527954987968"></a>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
                <code class="literal">MYSQL_TEST_TRACE_DEBUG</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：将此变量设置为0以外的值以使测试插件生成诊断输出
                 </font></font><code class="literal">stderr</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">MYSQL_TEST_TRACE_CRASH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：如果此变量检测到无效的跟踪事件，则将此变量设置为0以外的值以使测试插件中止客户端程序。
</font></font></p></li></ul>
</div>
<div class="caution" style="margin-left: 0.5in; margin-right: 0.5in;">
<div class="admon-title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
警告
</font></font></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              测试协议跟踪插件的诊断输出可以公开密码和其他敏感信息。
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            如果在启用了测试插件的情况下从源代码构建MySQL，则可以看到</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysql" title="4.5.1 mysql  -  MySQL命令行工具"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">客户端和MySQL服务器</font><font style="vertical-align: inherit;">之间的通信跟踪</font><font style="vertical-align: inherit;">如下：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shell&gt; </font></font><strong class="userinput"><code>export MYSQL_TEST_TRACE_DEBUG=1</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
shqll&gt;</font></font><strong class="userinput"><code>mysql</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
test_trace：测试跟踪插件已初始化</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
test_trace：在阶段CONNECTING中开始跟踪</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
test_trace：阶段：CONNECTING，事件：CONNECTING</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
test_trace：stage：CONNECTING，event：CONNECTED</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
test_trace：阶段：WAIT_FOR_INIT_PACKET，事件：READ_PACKET</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
test_trace：阶段：WAIT_FOR_INIT_PACKET，事件：PACKET_RECEIVED</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
test_trace：收到的数据包：87字节</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  0A 35 2E 37 2E 33 2D 6D 31 33 2D 64 65 62 75 67 .5.7.3-m13-debug</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  2D 6C 6F 67 00 04 00 00 00 2B 7C 4F 55 3F 79 67 -log ..... + | OU？yg</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
test_trace：004：阶段：WAIT_FOR_INIT_PACKET，事件：INIT_PACKET_RECEIVED</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
test_trace：004：阶段：AUTHENTICATE，事件：AUTH_PLUGIN</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
test_trace：004：使用认证插件：mysql_native_password</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
test_trace：004：阶段：AUTHENTICATE，事件：SEND_AUTH_RESPONSE</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
test_trace：004：发送数据包：188字节</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  85 A6 7F 00 00 00 00 01 21 00 00 00 00 00 00 00。？......！.......</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MySQL的&gt; </font></font><strong class="userinput"><code>quit</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
test_trace：008：阶段：READY_FOR_COMMAND，事件：SEND_COMMAND</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
test_trace：008：QUIT</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
test_trace：008：阶段：READY_FOR_COMMAND，事件：PACKET_SENT</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
test_trace：008：发送数据包：0字节</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
test_trace：008：阶段：READY_FOR_COMMAND，事件：DISCONNECTED</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
test_trace：008：连接关闭</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
test_trace：008：跟踪连接已结束</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
再见</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
test_trace：测试跟踪插件已初始化</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            要禁用跟踪输出，请执行以下操作：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">外壳&gt; </font></font><strong class="userinput"><code>MYSQL_TEST_TRACE_DEBUG=</code></strong>
</pre>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h5 class="title"><a name="using-own-protocol-trace-plugins"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.4.11.2使用您自己的协议跟踪插件</font></font></h5>

</div>

</div>

</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">
<div class="admon-title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
注意
</font></font></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              要使用您自己的协议跟踪插件，您必须配置MySQL并
               </font><span class="emphasis"><em><font style="vertical-align: inherit;">禁用</font></em></span><span class="command"><strong><font style="vertical-align: inherit;">CMake</font></strong></span><font style="vertical-align: inherit;">选项，
               </font><font style="vertical-align: inherit;">因为一次只能加载一个协议跟踪插件，而尝试加载第二个协议跟踪插件时会发生错误。</font><font style="vertical-align: inherit;">如果您已经使用启用了测试协议跟踪插件的MySQL来构建MySQL以查看其工作方式，则必须在不使用它的情况下重建MySQL，然后才能使用自己的插件。
</font></font><a class="link" href="/mysql-5.7-google-zh/installing.html#option_cmake_with_test_trace_plugin"><code class="option">WITH_TEST_TRACE_PLUGIN</code></a>
              <span class="command"><strong><font style="vertical-align: inherit;"></font></strong></span><font style="vertical-align: inherit;"></font><span class="emphasis"><em><font style="vertical-align: inherit;"></font></em></span><font style="vertical-align: inherit;"></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            本节讨论如何编写名为的基本协议跟踪插件</font></font><code class="literal">simple_trace</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">该插件提供了一个框架，展示了如何设置客户端插件描述符并创建跟踪相关的回调函数。</font><font style="vertical-align: inherit;">在</font></font><code class="literal">simple_trace</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这些功能中，这些功能是基本的，除了说明所需的参数之外别无其他。</font><font style="vertical-align: inherit;">要详细了解跟踪插件如何使用跟踪事件信息，请检查测试协议跟踪插件的源文件（</font></font><code class="filename">test_trace_plugin.cc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在
            </font></font><code class="filename">libmysql</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MySQL源代码发布</font><font style="vertical-align: inherit;">目录中）。</font><font style="vertical-align: inherit;">但是，请注意
            </font></font><code class="literal">st_mysql_client_plugin_TRACE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">那里使用的结构不同于通常的客户端插件声明宏所使用的结构。</font><font style="vertical-align: inherit;">特别是前两个成员是明确定义的，而不是由声明宏隐式定义的。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            几个头文件包含与协议跟踪插件相关的信息：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
                <code class="filename">client_plugin.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：定义客户端插件的API。</font><font style="vertical-align: inherit;">这包括用于客户端插件C API调用的客户端插件描述符和函数原型（参见
                 </font></font><a class="xref" href="/mysql-5.7-google-zh/connectors-apis.html#c-api-plugin-functions" title="27.8.14 C API客户端插件功能"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第27.8.14节“C API客户端插件函数”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。
              </font></font></p></li><li class="listitem"><p>
                <code class="filename">plugin_trace.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：包含对类型的客户端插件的声明
                 </font></font><code class="literal">MYSQL_CLIENT_TRACE_PLUGIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">它还包含允许的协议阶段的描述，阶段之间的转换以及每个阶段允许的事件类型。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            要编写一个协议跟踪插件，请将以下头文件包含在插件源文件中。</font><font style="vertical-align: inherit;">其他MySQL或通用头文件也可能需要，具体取决于插件的功能和要求。
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#include &lt;mysql / plugin_trace.h&gt;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
#include &lt;mysql.h&gt;</font></font><font></font>
</pre><p>
            <code class="filename">plugin_trace.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">包括
             </font></font><code class="filename">client_plugin.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，所以你不需要明确地包含后一个文件。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            使用</font></font><code class="literal">mysql_declare_client_plugin()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
             </font></font><code class="literal">mysql_end_client_plugin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">宏</font><font style="vertical-align: inherit;">声明客户端插件描述符
             </font><font style="vertical-align: inherit;">（请参见
             </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#client-plugin-descriptors" title="28.2.4.2.3客户端插件描述符"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.2.4.2.3节“客户端插件描述符”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">对于
             </font></font><code class="literal">simple_trace</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">插件，描述符如下所示：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql_declare_client_plugin（TRACE）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “simple_trace”，/ *插件名称* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “作者姓名”，/ *作者* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “简单协议跟踪插件”，/ *描述* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  {1,0,0}，/ *版本= 1.0.0 * /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “GPL”，/ *许可证类型* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  NULL，/ *供内部使用* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  plugin_init，/ *初始化函数* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  plugin_deinit，/ *去初始化函数* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  plugin_options，/ *选项处理函数* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  trace_start，/ *启动跟踪功能* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  trace_stop，/ *停止跟踪功能* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  trace_event / *事件处理函数* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql_end_client_plugin;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            插件名称到选项处理函数的描述符成员对于所有客户端插件类型都是通用的。</font><font style="vertical-align: inherit;">跟随普通成员的成员实现跟踪事件处理。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            插件不需要处理的函数成员可以</font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在描述符中</font><font style="vertical-align: inherit;">声明</font><font style="vertical-align: inherit;">，在这种情况下，您不需要编写任何相应的函数。</font><font style="vertical-align: inherit;">为了说明目的并显示参数语法，下面的讨论实现了描述符中列出的所有功能，即使它们中的一些不起作用，
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            所有客户端插件的通用初始化，解除初始化和选项功能声明如下。</font><font style="vertical-align: inherit;">有关参数和返回值的说明，请参见
             </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#client-plugin-descriptors" title="28.2.4.2.3客户端插件描述符"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.2.4.2.3节“客户端插件描述符”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">static int</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
plugin_init（char * errbuf，size_t errbuf_len，int argc，va_list args）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  返回0;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
static int</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
plugin_deinit（）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  返回0;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
static int</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
plugin_options（const char *选项，const void *值）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  返回0;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            客户端插件描述符的跟踪特定成员是回调函数。</font><font style="vertical-align: inherit;">以下描述提供了有关如何使用它们的更多详细信息。</font><font style="vertical-align: inherit;">每个实例都有一个第一个参数，它是指向插件实例的指针，以防您的实现需要访问它。
          </font></font></p><p>
            <code class="literal">trace_start()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：该函数在每个跟踪连接的开始时调用（每个连接在插件加载后启动）。</font><font style="vertical-align: inherit;">它通过连接处理程序和跟踪开始的协议阶段。</font></font><code class="literal">trace_start()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分配</font></font><code class="literal">trace_event()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数</font><font style="vertical-align: inherit;">所需的内存</font><font style="vertical-align: inherit;">（如果有的话），并返回一个指向它的指针。</font><font style="vertical-align: inherit;">如果不需要内存，则此函数返回</font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">static void *</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
trace_start（struct st_mysql_client_plugin_TRACE * self，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            MYSQL * conn，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            枚举protocol_stage阶段）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  struct st_trace_data * plugin_data = malloc（sizeof（struct st_trace_data））;</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  fprintf（stderr，“Initializing trace：stage％d \ n”，stage）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  如果（plugin_data）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  {</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    memset（plugin_data，0，sizeof（struct st_trace_data））;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    fprintf（stderr，“跟踪初始化\ n”）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    返回plugin_data;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  }</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  fprintf（stderr，“无法初始化跟踪\ n”）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  出口（1）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font>
</pre><p>
            <code class="literal">trace_stop()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：在追踪连接结束时调用此函数。</font><font style="vertical-align: inherit;">这通常发生在连接关闭时，但可以更早发生。</font><font style="vertical-align: inherit;">例如，</font></font><code class="literal">trace_event()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可以随时返回一个非零值，并导致连接的跟踪终止。</font></font><code class="literal">trace_stop()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">然后被调用，即使连接尚未结束。
          </font></font></p><p>
            <code class="literal">trace_stop()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">传递连接处理程序和指向由</font></font><code class="literal">trace_start()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果没有）</font><font style="vertical-align: inherit;">分配的内存的指针
             </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">如果指针是非指针</font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
             </font></font><code class="literal">trace_stop()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">应该释放内存。</font><font style="vertical-align: inherit;">该函数不返回任何值。
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">静态无效</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
trace_stop（struct st_mysql_client_plugin_TRACE * self，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
           MYSQL * conn，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
           void * plugin_data）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  fprintf（stderr，“终止跟踪\ n”）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  如果（plugin_data）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    自由（plugin_data）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font>
</pre><p>
            <code class="literal">trace_event()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：为每个事件发生调用此函数。</font><font style="vertical-align: inherit;">它传递一个指向由</font></font><code class="literal">trace_start()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            （</font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果没有），连接处理程序，当前协议阶段和事件代码以及事件数据</font><font style="vertical-align: inherit;">分配的内存的指针</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">此函数返回0以继续跟踪，如果跟踪应停止，则返回非零值。
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">static int</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
trace_event（struct st_mysql_client_plugin_TRACE * self，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            void * plugin_data，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            MYSQL * conn，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            枚举protocol_stage阶段，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            枚举trace_event事件，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            struct st_trace_event_args args）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  fprintf（stderr，“接收的跟踪事件：阶段％d，事件％d \ n”，阶段，事件）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  如果（event == TRACE_EVENT_DISCONNECTED）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    fprintf（stderr，“连接关闭\ n”）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  返回0;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            跟踪框架在连接结束时关闭连接的跟踪，因此
             </font></font><code class="literal">trace_event()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">只有在想要尽早终止跟踪时才返回非零值。</font><font style="vertical-align: inherit;">假设您只想跟踪某个MySQL帐户的连接。</font><font style="vertical-align: inherit;">认证后，您可以检查连接的用户名，如果不是您感兴趣的用户，则停止跟踪。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            对于每次调用</font></font><code class="literal">trace_event()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
             </font></font><code class="literal">st_trace_event_args</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结构都包含事件数据。</font><font style="vertical-align: inherit;">它有这样的定义：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">struct st_trace_event_args</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  const char * plugin_name;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  int cmd;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  const unsigned char * hdr;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  size_t hdr_len;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  const unsigned char * pkt;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  size_t pkt_len;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
};</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            对于不同的事件类型，
             </font></font><code class="literal">st_trace_event_args</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结构包含以下信息。</font><font style="vertical-align: inherit;">所有长度均以字节为单位。</font><font style="vertical-align: inherit;">未使用的成员设置为
             </font></font><code class="literal">0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ </font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
          </font></font></p><p>
            <code class="literal">AUTH_PLUGIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 事件：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">plugin_name插件的名称
</font></font></pre><p>
            <code class="literal">SEND_COMMAND</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 事件：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cmd命令代码</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
hdr指向命令包头的指针</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
hdr_len头部的长度</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
pkt指向命令参数的指针</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
pkt_len参数的长度</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            其他</font><font style="vertical-align: inherit;">
            和
             </font><font style="vertical-align: inherit;">
            事件：
          </font></font><code class="literal">SEND_<em class="replaceable"><code>xxx</code></em></code><font style="vertical-align: inherit;"></font><code class="literal"><em class="replaceable"><code>xxx</code></em>_RECEIVED</code><font style="vertical-align: inherit;"></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pkt指向发送或接收的数据的指针</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
pkt_len数据的长度</font></font><font></font>
</pre><p>
            <code class="literal">PACKET_SENT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 事件：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pkt_len发送的字节数
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            要编译和安装插件库文件，请使用
             </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#compiling-plugin-libraries" title="28.2.4.3编译和安装插件库"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.2.4.3节“编译和安装插件库”中的说明</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">要使库文件可供使用，请将其安装在插件目录（由</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_plugin_dir"><code class="literal">plugin_dir</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统变量</font><font style="vertical-align: inherit;">命名的目录
             </font><font style="vertical-align: inherit;">）中。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            将插件库文件编译并安装到插件目录后，可以通过将</font></font><code class="literal">LIBMYSQL_PLUGINS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">环境变量设置为插件名称来</font><font style="vertical-align: inherit;">轻松进行测试
             </font><font style="vertical-align: inherit;">，该插件名称会影响使用该变量的任何客户端程序。</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysql" title="4.5.1 mysql  -  MySQL命令行工具"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">就是这样一个程序：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shell&gt; </font></font><strong class="userinput"><code>export LIBMYSQL_PLUGINS=simple_trace</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
shqll&gt;</font></font><strong class="userinput"><code>mysql</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
初始化轨迹：阶段0</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
跟踪初始化</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
跟踪事件收到：阶段0，事件1</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
跟踪事件收到：阶段0，事件2</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
欢迎来到MySQL监视器。</font><font style="vertical-align: inherit;">命令结束于; </font><font style="vertical-align: inherit;">或\ g。</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
跟踪事件收到</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
跟踪事件收到</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MySQL的&gt; </font></font><strong class="userinput"><code>SELECT 1;</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
跟踪事件收到：阶段4，事件12</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
跟踪事件收到：阶段4，事件16</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
跟踪事件收到：阶段8，事件14</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
跟踪事件收到：阶段8，事件15</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ --- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">1 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ --- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">1 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ --- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一排（0.00秒）</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MySQL的&gt; </font></font><strong class="userinput"><code>quit</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
跟踪事件收到：阶段4，事件12</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
跟踪事件收到：阶段4，事件16</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
跟踪事件收到：阶段4，事件3</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
连接关闭</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
终止跟踪</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
再见</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            要停止加载跟踪插件，请执行以下操作：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">外壳&gt; </font></font><strong class="userinput"><code>LIBMYSQL_PLUGINS=</code></strong>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            编写直接加载插件的客户端程序也是可能的。</font><font style="vertical-align: inherit;">您可以通过调用</font></font><a class="link" href="/mysql-5.7-google-zh/connectors-apis.html#mysql-options" title="27.8.7.50 mysql_options（）"><code class="literal">mysql_options()</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">设置
             </font></font><code class="literal">MYSQL_PLUGIN_DIR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">选项</font><font style="vertical-align: inherit;">来告诉客户端插件目录所在的位置
             </font><font style="vertical-align: inherit;">：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">char * plugin_dir =“ </font></font><em class="replaceable"><code>path_to_plugin_dir</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">”;</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
/ * ...进程命令行选项... * /</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql_options（＆mysql，MYSQL_PLUGIN_DIR，plugin_dir）;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            通常，程序还会接受一个
             </font></font><code class="option">--plugin-dir</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">选项，使用户可以覆盖默认值。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            如果客户端程序需要较低级别的插件管理，则客户端库包含接受</font></font><code class="literal">st_mysql_client_plugin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参数的函数。</font><font style="vertical-align: inherit;">请参见
             </font></font><a class="xref" href="/mysql-5.7-google-zh/connectors-apis.html#c-api-plugin-functions" title="27.8.14 C API客户端插件功能"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第27.8.14节“C API客户端插件函数”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p>
</div>

</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h4 class="title"><a name="writing-keyring-plugins"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.2.4.12编写密钥环插件</font></font></h4>

</div>

</div>

</div>
<a class="indexterm" name="idm140527954890720"></a><a class="indexterm" name="idm140527954889648"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          MySQL服务器支持密钥环服务，可以使内部服务器组件和插件安全地存储敏感信息以供日后检索。</font><font style="vertical-align: inherit;">本节介绍如何编写可由服务功能用于执行密钥管理操作的服务器端密钥环插件。</font><font style="vertical-align: inherit;">有关一般密钥环信息，请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/security.html#keyring" title="6.5.4 MySQL Keyring"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第6.5.4节“MySQL密钥环”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          这里的说明基于</font></font><code class="literal">plugin/keyring</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL源代码分发目录中</font><font style="vertical-align: inherit;">的源代码
           </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">该目录中的源文件实现了一个名为的插件</font></font><code class="literal">keyring_file</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font><font style="vertical-align: inherit;">该插件</font><font style="vertical-align: inherit;">使用服务器主机本地的文件进行数据存储。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          要编写密钥环插件，请将以下头文件包含在插件源文件中。</font><font style="vertical-align: inherit;">其他MySQL或通用头文件也可能需要，具体取决于插件的功能和要求。
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#include &lt;mysql / plugin_keyring.h&gt;
</font></font></pre><p>
          <code class="filename">plugin_keyring.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">包括
           </font></font><code class="filename">plugin.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，所以你不需要明确地包含后一个文件。</font></font><code class="filename">plugin.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">定义了</font></font><code class="literal">MYSQL_KEYRING_PLUGIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">声明该插件所需</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">服务器插件类型和数据结构。
          </font></font><code class="filename">plugin_keyring.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">定义特定于密钥环插件的数据结构。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          像任何MySQL服务器插件一样，密钥环插件具有通用插件描述符（请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#server-plugin-descriptors" title="28.2.4.2.1服务器插件库和插件描述符"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.2.4.2.1节“服务器插件库和插件描述符”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">在
           </font></font><code class="filename">keyring.cc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，一般描述符
           </font></font><code class="literal">keyring_file</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">看起来像这样：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql_declare_plugin（keyring_file）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_KEYRING_PLUGIN，/ * type * /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  ＆keyring_descriptor，/ *描述符* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “keyring_file”，/ *名称* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “Oracle Corporation”，/ *作者* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  “存储/从平面文件中获取认证数据”，/ * description * /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  PLUGIN_LICENSE_GPL，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  keyring_init，/ * init函数（加载时）* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  keyring_deinit，/ * deinit函数（卸载时）* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  0x0100，/ *版本* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  NULL，/ *状态变量* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  keyring_system_variables，/ *系统变量* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  空值，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  0，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql_declare_plugin_end;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          所述</font></font><code class="literal">name</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">构件（</font></font><code class="literal">keyring_file</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）表示插件名称。</font><font style="vertical-align: inherit;">这是</font></font><a class="link" href="/mysql-5.7-google-zh/information-schema.html#plugins-table" title="24.16 INFORMATION_SCHEMA插件表"><code class="literal">INFORMATION_SCHEMA.PLUGINS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或者
           </font><font style="vertical-align: inherit;">显示的名字
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-plugins" title="13.7.5.25 SHOW PLUGINS语法"><code class="literal">SHOW PLUGINS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          一般描述符还指的是
           </font></font><code class="literal">keyring_system_variables</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一种将系统变量暴露给</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-variables" title="13.7.5.39 SHOW VARIABLES语法"><code class="literal">SHOW
          VARIABLES</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句的结构：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">static struct st_mysql_sys_var * keyring_system_variables [] = {</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_SYSVAR（数据），</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  空值</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
};</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          在</font></font><code class="literal">keyring_init</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">初始化函数创建数据文件，如果它不存在，然后读取它并初始化密钥库。</font><font style="vertical-align: inherit;">该
           </font></font><code class="literal">keyring_deinit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数释放与文件关联的数据结构。
        </font></font></p><p><font style="vertical-align: inherit;"></font><code class="literal">keyring_descriptor</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一般描述符中</font><font style="vertical-align: inherit;">
          的</font><font style="vertical-align: inherit;">值指向特定于类型的描述符。</font><font style="vertical-align: inherit;">对于密钥环插件，此描述符具有以下结构：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">struct st_mysql_keyring</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  int interface_version;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  my_bool（* mysql_key_store）（const char * key_id，const char * key_type，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                             const char * user_id，const void * key，size_t key_len）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  my_bool（* mysql_key_fetch）（const char * key_id，char ** key_type，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                             const char * user_id，void ** key，size_t * key_len）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  my_bool（* mysql_key_remove）（const char * key_id，const char * user_id）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  my_bool（* mysql_key_generate）（const char * key_id，const char * key_type，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                                const char * user_id，size_t key_len）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
};</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          类型特定的描述符具有这些成员：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              <code class="literal">interface_version</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：按照惯例，类型特定的插件描述符以给定插件类型的接口版本开头。</font><font style="vertical-align: inherit;">服务器</font></font><code class="literal">interface_version</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在加载插件时</font><font style="vertical-align: inherit;">检查
               </font><font style="vertical-align: inherit;">插件是否与其兼容。</font><font style="vertical-align: inherit;">对于keyring插件，</font></font><code class="literal">interface_version</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">成员</font><font style="vertical-align: inherit;">的值
               </font><font style="vertical-align: inherit;">是
               </font></font><code class="literal">MYSQL_KEYRING_INTERFACE_VERSION</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              （定义在</font></font><code class="literal">plugin_keyring.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）中。
            </font></font></p></li><li class="listitem"><p>
              <code class="literal">mysql_key_store</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：将密钥混淆并存储在密钥环中的函数。
            </font></font></p></li><li class="listitem"><p>
              <code class="literal">mysql_key_fetch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：从密匙环去混淆和检索密钥的函数。
            </font></font></p></li><li class="listitem"><p>
              <code class="literal">mysql_key_remove</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：从密钥环中删除密钥的功能。
            </font></font></p></li><li class="listitem"><p>
              <code class="literal">mysql_key_generate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：生成新的随机密钥并将其存储在密钥环中的函数。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          对于</font></font><code class="literal">keyring_file</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">插件，类型特定的描述符如下所示：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">static struct st_mysql_keyring keyring_descriptor =</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MYSQL_KEYRING_INTERFACE_VERSION，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  mysql_key_store，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  mysql_key_fetch，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  mysql_key_remove，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  mysql_key_generate</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
};</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          由密钥环插件实现</font><font style="vertical-align: inherit;">
          的
           </font><font style="vertical-align: inherit;">功能类似于</font><font style="vertical-align: inherit;">
          由密钥环服务API公开</font><font style="vertical-align: inherit;">的
           </font><font style="vertical-align: inherit;">功能。</font><font style="vertical-align: inherit;">例如，
           </font><font style="vertical-align: inherit;">插件功能类似于</font><font style="vertical-align: inherit;">钥匙圈服务功能。</font><font style="vertical-align: inherit;">有关密钥环服务函数的参数以及如何使用它们的信息，请参见
           </font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#keyring-service" title="28.3.2钥匙圈服务"><font style="vertical-align: inherit;">第28.3.2节“密钥环服务”</font></a><font style="vertical-align: inherit;">。
        </font></font><code class="literal">mysql_key_<em class="replaceable"><code>xxx</code></em></code><font style="vertical-align: inherit;"></font><code class="literal">my_key_<em class="replaceable"><code>xxx</code></em></code><font style="vertical-align: inherit;"></font><code class="literal">mysql_key_store</code><font style="vertical-align: inherit;"></font><code class="literal">my_key_store</code><font style="vertical-align: inherit;"></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#keyring-service" title="28.3.2钥匙圈服务"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          要编译和安装插件库文件，请使用</font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#compiling-plugin-libraries" title="28.2.4.3编译和安装插件库"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.2.4.3节“编译和安装插件库”中的说明</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">要使库文件可供使用，请将其安装在插件目录（由</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_plugin_dir"><code class="literal">plugin_dir</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统变量</font><font style="vertical-align: inherit;">命名的目录
           </font><font style="vertical-align: inherit;">）中。</font><font style="vertical-align: inherit;">对于</font></font><code class="literal">keyring_file</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">插件，它是在从源代码构建MySQL时编译和安装的。</font><font style="vertical-align: inherit;">它也包含在二进制发行版中。</font><font style="vertical-align: inherit;">构建过程会生成一个名称为</font></font><code class="filename">keyring_file.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（
           </font></font><code class="filename">.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">后缀可能因您的平台而异）</font><font style="vertical-align: inherit;">的共享对象库
           </font><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          密钥环插件通常在服务器启动过程中提前加载，以便它们可用于可能依赖于它们的内置插件和存储引擎。</font><font style="vertical-align: inherit;">对于
           </font></font><code class="literal">keyring_file</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，在服务器</font></font><code class="filename">my.cnf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文件中</font><font style="vertical-align: inherit;">使用这些行
           </font><font style="vertical-align: inherit;">（</font></font><code class="filename">.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">根据需要</font><font style="vertical-align: inherit;">调整</font><font style="vertical-align: inherit;">您的平台</font><font style="vertical-align: inherit;">的
           </font><font style="vertical-align: inherit;">后缀）：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的[mysqld]</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
早期插件负荷= keyring_file.so</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          有关插件加载的更多信息，请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/server-administration.html#server-plugin-loading" title="5.5.1安装和卸载插件"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第5.5.1节“安装和卸载插件”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          要验证插件安装，请检查该
           </font></font><a class="link" href="/mysql-5.7-google-zh/information-schema.html#plugins-table" title="24.16 INFORMATION_SCHEMA插件表"><code class="literal">INFORMATION_SCHEMA.PLUGINS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表或使用该</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#show-plugins" title="13.7.5.25 SHOW PLUGINS语法"><code class="literal">SHOW PLUGINS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          语句（请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/server-administration.html#obtaining-plugin-information" title="5.5.2获取服务器插件信息"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第5.5.2节“获取服务器插件信息”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">例如：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL的&gt; </font></font><strong class="userinput"><code>SELECT PLUGIN_NAME, PLUGIN_STATUS</code></strong>
       <strong class="userinput"><code>FROM INFORMATION_SCHEMA.PLUGINS</code></strong>
       <strong class="userinput"><code>WHERE PLUGIN_NAME LIKE 'keyring%';</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ -------------- + --------------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">PLUGIN_NAME | </font><font style="vertical-align: inherit;">PLUGIN_STATUS |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ -------------- + --------------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">keyring_file | </font><font style="vertical-align: inherit;">ACTIVE |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ -------------- + --------------- +</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          在</font></font><code class="literal">keyring_file</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">安装插件时，它会公开一个系统变量，指出用于安全信息存储的数据文件的位置：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL的&gt; </font></font><strong class="userinput"><code>SHOW VARIABLES LIKE 'keyring_file%';</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------------------- + ----------------------------- ----- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">变量名| </font><font style="vertical-align: inherit;">值|</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------------------- + ----------------------------- ----- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">keyring_file_data | </font><font style="vertical-align: inherit;">/ usr / local / mysql / keyring / keyring |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------------------- + ----------------------------- ----- +</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          有关该</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#sysvar_keyring_file_data"><code class="literal">keyring_file_data</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">变量</font><font style="vertical-align: inherit;">的说明
           </font><font style="vertical-align: inherit;">，请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/server-administration.html#server-system-variables" title="5.1.5服务器系统变量"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第5.1.5节“服务器系统变量”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          要在测试后禁用该插件，请重新启动服务器，而不使用</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#option_mysqld_early-plugin-load"><code class="option">--early-plugin-load</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          指定插件</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">选项。
</font></font></p>
</div>

</div>

</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h2 class="title" style="clear: both"><a name="plugin-services"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.3用于插件的MySQL服务</font></font></h2>

</div>

</div>

</div>
<div class="toc">
<dl class="toc"><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#locking-service"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.3.1锁定服务</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#keyring-service"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.3.2钥匙圈服务</font></font></a></span></dt></dl>
</div>
<a class="indexterm" name="idm140527954818016"></a><a class="indexterm" name="idm140527954816976"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      MySQL服务器插件可以访问服务器</font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">插件服务”。</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">插件服务接口公开了插件可以调用的服务器功能。</font><font style="vertical-align: inherit;">它补充了插件API并具有以下特征：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          服务使插件可以使用普通函数调用访问服务器内的代码。</font><font style="vertical-align: inherit;">服务也可用于用户定义的函数（UDF）。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          服务是可移植的，可在多个平台上工作。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          该接口包含一个版本控制机制，以便在加载时可以根据插件版本检查服务器支持的服务版本。</font><font style="vertical-align: inherit;">版本控制可以防止服务器提供的服务版本与插件期望或需要的服务版本之间的不兼容。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          有关测试插件服务插件的信息，请参阅
           </font></font><a class="ulink" href="http://dev.mysql.com/doc/dev/mysql-server/latest/PAGE_PLUGINS.html" target="_top"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">插件测试插件服务</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      插件服务接口与插件API不同，如下所示：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          插件API使得插件可以被服务器使用。</font><font style="vertical-align: inherit;">调用主动权在于服务器调用插件。</font><font style="vertical-align: inherit;">这使得插件可以扩展服务器功能或注册以接收有关服务器处理的通知。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          插件服务接口使插件能够在服务器内调用代码。</font><font style="vertical-align: inherit;">调用主动权在于插件调用服务功能。</font><font style="vertical-align: inherit;">这使得服务器中已经实现的功能可以被许多插件使用; </font><font style="vertical-align: inherit;">他们不需要单独实施。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      要确定存在哪些服务以及它们提供了哪些功能，请查看</font></font><code class="filename">include/mysql</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL源代码发布</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">目录。</font><font style="vertical-align: inherit;">相关文件是：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
          <code class="filename">plugin.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">包括
           </font></font><code class="filename">services.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，它是</font><font style="vertical-align: inherit;">包含所有可用服务特定头文件</font><font style="vertical-align: inherit;">的
           </font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">伞</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">头。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          特定于服务的标题具有该表单的名称
           </font><font style="vertical-align: inherit;">。
</font></font><code class="filename">service_<em class="replaceable"><code>xxx</code></em>.h</code><font style="vertical-align: inherit;"></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      每个特定于服务的头文件应包含提供给定服务的完整使用文档的注释，包括可用的服务功能，其调用序列和返回值。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      对于希望修改服务器以添加新服务的开发人员，请参阅
       </font></font><a class="ulink" href="http://dev.mysql.com/doc/internals/en/mysql-services-for-plugins.html" target="_top"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL内部：针对插件的MySQL服务</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      可用的服务包括以下内容：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
          <code class="literal">locking_service</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：一种实现具有三个属性的锁的服务：锁名称空间，锁名称和锁定模式。</font><font style="vertical-align: inherit;">这个锁定接口有两个级别可用：1）作为C语言接口，可作为来自服务器插件或用户定义函数的插件服务调用; </font><font style="vertical-align: inherit;">2）在SQL级别，作为一组映射到服务例程的调用的用户定义函数。</font><font style="vertical-align: inherit;">有关更多信息，请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#locking-service" title="28.3.1锁定服务"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.3.1节“锁定服务”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><a class="indexterm" name="idm140527954794864"></a><a class="indexterm" name="idm140527954793376"></a></li><li class="listitem"><p>
          <code class="literal">my_plugin_log_service</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：使插件能够报告错误并指定错误消息的服务。</font><font style="vertical-align: inherit;">服务器将消息写入其错误日志。
        </font></font></p><a class="indexterm" name="idm140527954790672"></a><a class="indexterm" name="idm140527954789184"></a></li><li class="listitem"><p>
          <code class="literal">my_snprintf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：跨平台产生一致结果的字符串格式服务。
        </font></font></p><a class="indexterm" name="idm140527954786528"></a><a class="indexterm" name="idm140527954785040"></a></li><li class="listitem"><p>
          <code class="literal">my_thd_scheduler</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：插件选择线程调度程序的服务。
        </font></font></p><a class="indexterm" name="idm140527954782416"></a><a class="indexterm" name="idm140527954780928"></a></li><li class="listitem"><p>
          <code class="literal">mysql_keyring</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：密钥环存储服务。</font><font style="vertical-align: inherit;">有关更多信息，请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#keyring-service" title="28.3.2钥匙圈服务"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.3.2节“密钥环服务”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><a class="indexterm" name="idm140527954777616"></a><a class="indexterm" name="idm140527954776128"></a></li><li class="listitem"><p>
          <code class="literal">mysql_password_policy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：用于密码验证和强度检查的服务。
        </font></font></p><a class="indexterm" name="idm140527954773504"></a><a class="indexterm" name="idm140527954772016"></a></li><li class="listitem"><p>
          <code class="literal">mysql_string</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：用于字符串操作的服务。
        </font></font></p><a class="indexterm" name="idm140527954769408"></a><a class="indexterm" name="idm140527954767920"></a></li><li class="listitem"><p>
          <code class="literal">security_context</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：一种使插件能够检查或操纵线程安全上下文的服务。</font><font style="vertical-align: inherit;">此服务提供setter和getter例程以访问服务器</font></font><code class="literal">Security_context</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          类的属性，其中包括诸如登录用户和主机，经过身份验证的用户和主机以及客户端IP地址等属性。
        </font></font></p><a class="indexterm" name="idm140527954764336"></a><a class="indexterm" name="idm140527954762848"></a></li><li class="listitem"><p>
          <code class="literal">thd_alloc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：内存分配服务。
        </font></font></p><a class="indexterm" name="idm140527954760256"></a><a class="indexterm" name="idm140527954758768"></a></li><li class="listitem"><p>
          <code class="literal">thd_wait</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：插件在他们要睡觉或失速时进行报告的服务。
</font></font></p><a class="indexterm" name="idm140527954756128"></a><a class="indexterm" name="idm140527954754640"></a></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      本节的其余部分描述了插件如何使用可用作服务的服务器功能。</font><font style="vertical-align: inherit;">另请参阅</font><font style="vertical-align: inherit;">使用该</font><font style="vertical-align: inherit;">服务</font><font style="vertical-align: inherit;">的</font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">守护程序</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">示例插件
       </font><font style="vertical-align: inherit;">的源代码</font></font><code class="literal">my_snprintf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">在MySQL源代码分发中，该插件位于该
       </font></font><code class="filename">plugin/daemon_example</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">目录中。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      要使用插件中的服务或多个服务，插件源文件必须包含</font></font><code class="filename">plugin.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">头文件以访问与服务相关的信息：
    </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#include &lt;mysql / plugin.h&gt;
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      这并不代表任何额外的设置成本。</font><font style="vertical-align: inherit;">无论如何，插件必须包含该文件，因为它包含每个插件所需的定义和结构。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      为了访问服务，插件像任何其他功能一样调用服务功能。</font><font style="vertical-align: inherit;">例如，要将字符串格式化为要打印的缓冲区，请调用</font></font><code class="literal">my_snprintf()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">由相同名称的服务提供</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">功能：
    </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">字符缓冲区[BUFFER_SIZE];</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
my_snprintf（缓冲液，的sizeof（缓冲液）， </font></font><em class="replaceable"><code>format_string</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><em class="replaceable"><code>argument_to_format</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，...）;
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      要报告服务器将写入错误日志的错误，请首先选择错误级别。
      </font></font><code class="filename">mysql/service_my_plugin_log.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">定义这些级别：
    </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">枚举plugin_log_level</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MY_ERROR_LEVEL，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MY_WARNING_LEVEL，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  MY_INFORMATION_LEVEL</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
};</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      然后调用</font></font><code class="literal">my_plugin_log_message()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：
    </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">int my_plugin_log_message（MYSQL_PLUGIN *插件，enum plugin_log_level级别，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                          const char *格式，...）;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      例如：
    </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">my_plugin_log_message（plugin_ptr，MY_ERROR_LEVEL，“无法初始化插件”）;
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      有些服务</font></font><span class="emphasis"><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的</font></font></em></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">插件，可以提供
       </font></font><span class="emphasis"><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通过</font></font></em></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">插件，因此只有当提供服务的插件加载可用。</font><font style="vertical-align: inherit;">任何使用这种服务的MySQL组件都应该检查服务是否可用。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      当您构建插件时，请</font></font><code class="literal">-lmysqlservices</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在链接时</font><font style="vertical-align: inherit;">使用该
       </font><font style="vertical-align: inherit;">标记链接</font></font><code class="literal">libmysqlservices</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">库中的内容。</font><font style="vertical-align: inherit;">例如，对于
       </font></font><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CMake</font></font></strong></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，把它放在顶层
       </font></font><code class="filename">CMakeLists.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文件中：
    </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FIND_LIBRARY（MYSQLSERVICES_LIB mysqlservices</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 PATHS“$ {MYSQL_SRCDIR} / libservices”NO_DEFAULT_PATH）</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      把它放在</font></font><code class="filename">CMakeLists.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">包含插件源的目录</font><font style="vertical-align: inherit;">中的</font><font style="vertical-align: inherit;">文件中：
    </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃插件需要mysql服务库进行错误记录</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
TARGET_LINK_LIBRARIES（</font></font><em class="replaceable"><code>your_plugin_library_name</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ {MYSQLSERVICES_LIB}）
</font></font></pre>
<div class="section">

<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="locking-service"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.3.1锁定服务</font></font></h3>

</div>

</div>

</div>

<div class="toc">
<dl class="toc"><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#locking-service-c-interface"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.3.1.1锁定服务C接口</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#locking-service-udf-interface"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.3.1.2锁定服务UDF接口</font></font></a></span></dt></dl>
</div>
<a class="indexterm" name="idm140527954730912"></a><a class="indexterm" name="idm140527954729424"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        MySQL 5.7.8或更高版本的分发提供了一个锁定界面，可以在两个级别上使用：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            作为C语言接口，可从服务器插件或用户定义的函数调用为插件服务
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            在SQL级别，作为映射到服务例程的调用的一组用户定义的函数
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        有关插件服务的一般信息，请参见
         </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#plugin-services" title="28.3用于插件的MySQL服务"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.3节“用于插件的MySQL服务”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">有关用户定义函数的一般信息，请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#adding-udf" title="28.4.2添加新的用户定义函数"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.4.2节“添加新的用户定义函数”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
      </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        锁定界面具有以下特征：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            锁有三个属性：锁名称空间，锁名称和锁定模式：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                锁由名称空间和锁名称的组合来标识。</font><font style="vertical-align: inherit;">通过在不同的名称空间中创建锁定，命名空间使不同的应用程序能够使用相同的锁定名称而不会发生冲突。</font><font style="vertical-align: inherit;">例如，如果应用程序A和B使用的名称空间
                 </font></font><code class="literal">ns1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><code class="literal">ns2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，分别，每个应用可以使用锁的名称
                 </font></font><code class="literal">lock1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><code class="literal">lock2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                不与其它应用干扰。
              </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                锁定模式是读取或写入。</font><font style="vertical-align: inherit;">读锁是共享的：如果会话对给定的锁标识符具有读锁，则其他会话可以获得对相同标识符的读锁。</font><font style="vertical-align: inherit;">写锁定是独占的：如果会话对给定的锁定标识符具有写入锁定，则其他会话无法获取相同标识符上的读取或写入锁定。
</font></font></p></li></ul>
</div>
</li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            名称空间和锁名称必须是非</font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">空的，并且最大长度为64个字符。</font><font style="vertical-align: inherit;">指定为名称空间或锁定名称</font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的空字符串或超过64个字符的字符串会导致
             </font></font><a class="link" href="/mysql-5.7-google-zh/error-handling.html#error_er_locking_service_wrong_name"><code class="literal">ER_LOCKING_SERVICE_WRONG_NAME</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            错误。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            锁定界面将名称空间和锁定名称视为二进制字符串，因此比较区分大小写。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            锁定界面提供了获取锁定和释放锁定的功能。</font><font style="vertical-align: inherit;">调用这些函数不需要特殊的权限。</font><font style="vertical-align: inherit;">特权检查是调用应用程序的责任。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            如果不立即可用，可以等待锁。</font><font style="vertical-align: inherit;">锁定采集调用需要一个整数超时值，指示在放弃之前等待获取锁的秒数。</font><font style="vertical-align: inherit;">如果在没有成功获取锁定的情况下达到超时，
             </font></font><a class="link" href="/mysql-5.7-google-zh/error-handling.html#error_er_locking_service_timeout"><code class="literal">ER_LOCKING_SERVICE_TIMEOUT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            则会发生错误。</font><font style="vertical-align: inherit;">如果超时为0，则不会等待，如果无法立即获取锁，则调用会产生错误。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            锁定界面检测不同会话中锁定捕获呼叫之间的死锁。</font><font style="vertical-align: inherit;">在这种情况下，锁定服务会选择一个调用者并终止其锁定请求并发生
             </font></font><a class="link" href="/mysql-5.7-google-zh/error-handling.html#error_er_locking_service_deadlock"><code class="literal">ER_LOCKING_SERVICE_DEADLOCK</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            错误。</font><font style="vertical-align: inherit;">此错误不会导致事务回滚。</font><font style="vertical-align: inherit;">要在发生死锁时选择一个会话，锁定服务首选会话，这些会话在保持写入锁定的会话上保持读取锁定。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            一个会话可以通过一次锁定获取呼叫获取多个锁。</font><font style="vertical-align: inherit;">对于给定的调用，锁定获取是原子的：如果获取所有锁定，则调用成功。</font><font style="vertical-align: inherit;">如果获取任何锁定失败，则该调用不会获取锁定并失败，通常会
             </font><font style="vertical-align: inherit;">
            出现错误</font></font><a class="link" href="/mysql-5.7-google-zh/error-handling.html#error_er_locking_service_timeout"><code class="literal">ER_LOCKING_SERVICE_TIMEOUT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            或
             </font></font><a class="link" href="/mysql-5.7-google-zh/error-handling.html#error_er_locking_service_deadlock"><code class="literal">ER_LOCKING_SERVICE_DEADLOCK</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">错误。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            会话可以获取同一个锁标识符（名称空间和锁名称组合）的多个锁。</font><font style="vertical-align: inherit;">这些锁定实例可以是读取锁定，写入锁定或两者的组合。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            会话中获取的锁通过调用释放锁功能来显式释放，或者在会话终止时（通常或异常）隐式释放。</font><font style="vertical-align: inherit;">事务提交或回滚时，不会释放锁。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            在会话中，发布时给定名称空间的所有锁都一起发布。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        锁定服务提供的接口</font></font><a class="link" href="/mysql-5.7-google-zh/functions.html#function_get-lock"><code class="literal">GET_LOCK()</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">与SQL函数</font><font style="vertical-align: inherit;">提供的接口不同</font><font style="vertical-align: inherit;">（参见
         </font></font><a class="xref" href="/mysql-5.7-google-zh/functions.html#miscellaneous-functions" title="12.20杂项功能"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第12.20节“其他函数”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">例如，
         </font></font><a class="link" href="/mysql-5.7-google-zh/functions.html#function_get-lock"><code class="literal">GET_LOCK()</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不实现名称空间并仅提供排他锁，而不提供不同的读取和写入锁。
</font></font></p>
<div class="section">

<div class="titlepage">
<div>
<div>
<h4 class="title"><a name="locking-service-c-interface"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.3.1.1锁定服务C接口</font></font></h4>
</div>
</div>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          本节介绍如何使用锁定服务C语言界面。</font><font style="vertical-align: inherit;">要改为使用UDF接口，请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#locking-service-udf-interface" title="28.3.1.2锁定服务UDF接口"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.3.1.2节“锁定服务UDF接口”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">有关锁定服务接口的一般特性，请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#locking-service" title="28.3.1锁定服务"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.3.1节“锁定服务”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">有关插件服务的一般信息，请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#plugin-services" title="28.3用于插件的MySQL服务"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.3节“用于插件的MySQL服务”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          使用锁定服务的源文件应包含以下头文件：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#include &lt;mysql / service_locking.h&gt;
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          要获取一个或多个锁，请调用此函数：
        </font></font></p><a class="indexterm" name="idm140527954688752"></a><a class="indexterm" name="idm140527954687232"></a><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">int mysql_acquire_locking_service_locks（MYSQL_THD opaque_thd，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                                        const char * lock_namespace，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                                        const char ** lock_names，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                                        size_t lock_num，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                                        enum enum_locking_service_lock_type lock_type，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                                        unsigned long lock_timeout）;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          这些论据具有这些意义：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              <code class="literal">opaque_thd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：一个线程句柄。</font><font style="vertical-align: inherit;">如果指定为</font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，则使用当前线程的句柄。
            </font></font></p></li><li class="listitem"><p>
              <code class="literal">lock_namespace</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：一个以空字符结尾的字符串，表示锁定名称空间。
            </font></font></p></li><li class="listitem"><p>
              <code class="literal">lock_names</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：一个以null结尾的字符串数组，提供要获取的锁的名称。
            </font></font></p></li><li class="listitem"><p>
              <code class="literal">lock_num</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><code class="literal">lock_names</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数组中</font><font style="vertical-align: inherit;">的名称数量
               </font><font style="vertical-align: inherit;">。
            </font></font></p></li><li class="listitem"><p>
              <code class="literal">lock_type</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：锁定模式，
               </font></font><code class="literal">LOCKING_SERVICE_READ</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
               </font></font><code class="literal">LOCKING_SERVICE_WRITE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分别获取读取锁定或写入锁定。
            </font></font></p></li><li class="listitem"><p>
              <code class="literal">lock_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：在放弃之前等待获取锁的整数秒数。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          要释放为给定名称空间获取的锁，请调用此函数：
        </font></font></p><a class="indexterm" name="idm140527954671024"></a><a class="indexterm" name="idm140527954669504"></a><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">int mysql_release_locking_service_locks（MYSQL_THD opaque_thd，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                                        const char * lock_namespace）;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          这些论据具有这些意义：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              <code class="literal">opaque_thd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：一个线程句柄。</font><font style="vertical-align: inherit;">如果指定为</font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，则使用当前线程的句柄。
            </font></font></p></li><li class="listitem"><p>
              <code class="literal">lock_namespace</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：一个以空字符结尾的字符串，表示锁定名称空间。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          可以使用性能模式在SQL级别监控锁定服务获取或等待的锁定。</font><font style="vertical-align: inherit;">有关详细信息，请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#locking-service-monitoring" title="28.3.1.2.3锁定服务监控"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.3.1.2.3节“锁定服务监控”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h4 class="title"><a name="locking-service-udf-interface"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.3.1.2锁定服务UDF接口</font></font></h4>

</div>

</div>

</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          本节介绍如何使用锁定服务用户定义函数（UDF）接口。</font><font style="vertical-align: inherit;">要改为使用C语言接口，请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#locking-service-c-interface" title="28.3.1.1锁定服务C接口"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.3.1.1节“锁定服务C接口”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">有关锁定服务接口的一般特性，请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#locking-service" title="28.3.1锁定服务"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.3.1节“锁定服务”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">有关用户定义函数的一般信息，请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#adding-udf" title="28.4.2添加新的用户定义函数"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.4.2节“添加新的用户定义函数”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p>
<div class="section">

<div class="titlepage">
<div>
<div>
<h5 class="title"><a name="locking-service-udf-installation"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.3.1.2.1安装或卸载UDF锁定界面</font></font></h5>
</div>
</div>
</div>
<a class="indexterm" name="idm140527954655872"></a><a class="indexterm" name="idm140527954654384"></a><p><font style="vertical-align: inherit;"></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#locking-service-c-interface" title="28.3.1.1锁定服务C接口"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.3.1.1节“锁定服务C接口”中</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
            描述的锁定服务例程
             </font><font style="vertical-align: inherit;">无需安装，因为它们内置于服务器中。</font><font style="vertical-align: inherit;">对调用服务例程的用户定义函数（UDF）也是如此：UDF必须在使用之前安装。</font><font style="vertical-align: inherit;">本节介绍如何做到这一点。</font><font style="vertical-align: inherit;">有关UDF安装的一般信息，请参见
             </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#udf-compiling" title="28.4.2.5 UDF编译和安装"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.4.2.5节“UDF编译和安装”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            锁定服务UDF在位于由</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_plugin_dir"><code class="literal">plugin_dir</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统变量</font><font style="vertical-align: inherit;">命名的目录中的插件库文件中实现
             </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">文件基本名称是</font></font><code class="literal">locking_service</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">每个平台的文件名后缀都不相同（例如，
             </font></font><code class="filename">.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">对于Unix和类Unix系统，
             </font></font><code class="filename">.dll</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">对于Windows）。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            要安装锁定服务UDF，请使用该
             </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#create-function" title="13.1.13 CREATE FUNCTION语法"><code class="literal">CREATE FUNCTION</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句（</font></font><code class="filename">.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">根据需要</font><font style="vertical-align: inherit;">调整</font><font style="vertical-align: inherit;">您的平台</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">后缀）：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CREATE FUNCTION service_get_read_locks RETURNS INT SONAME'locking_service.so';</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CREATE FUNCTION service_get_write_locks RETURNS INT SONAME'locking_service.so';</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CREATE FUNCTION service_release_locks RETURNS INT SONAME'locking_service.so';</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            如果在主复制服务器上使用UDF，请将它们安装在所有从属服务器上以避免复制问题。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            安装完成后，UDF将保持安装状态直到卸载。</font><font style="vertical-align: inherit;">要删除它们，请使用以下</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#drop-function" title="13.1.24 DROP FUNCTION语法"><code class="literal">DROP
            FUNCTION</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DROP FUNCTION service_get_read_locks;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DROP FUNCTION service_get_write_locks;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DROP FUNCTION service_release_locks;</font></font><font></font>
</pre>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h5 class="title"><a name="locking-service-udf-usage"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.3.1.2.2使用UDF锁定接口</font></font></h5>

</div>

</div>

</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            在使用锁定服务UDF之前，请按照</font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#locking-service-udf-installation" title="28.3.1.2.1安装或卸载UDF锁定界面"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.3.1.2.1节“安装或卸载UDF锁定界面”中</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">提供的说明进行
             </font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#locking-service-udf-installation" title="28.3.1.2.1安装或卸载UDF锁定界面"><font style="vertical-align: inherit;">安装</font></a><font style="vertical-align: inherit;">。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            要获取一个或多个读锁，请调用此函数：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL的&gt; </font></font><strong class="userinput"><code>SELECT service_get_read_locks('mynamespace', 'rlock1', 'rlock2', 10);</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------------------------------------------------- -------------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">service_get_read_locks（'mynamespace'，'rlock1'，'rlock2'，10）|</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------------------------------------------------- -------------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">1 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------------------------------------------------- -------------- +</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            第一个参数是锁名称空间。</font><font style="vertical-align: inherit;">最后一个参数是一个整数超时值，表示在放弃之前需要等待几秒才能获取锁。</font><font style="vertical-align: inherit;">中间的参数是锁名称。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            对于刚刚显示的示例，该函数获取带有锁标识符</font></font><code class="literal">(mynamespace, rlock1)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            和</font><font style="vertical-align: inherit;">锁的锁</font></font><code class="literal">(mynamespace, rlock2)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            要获取写入锁而不是读取锁，请调用此函数：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL的&gt; </font></font><strong class="userinput"><code>SELECT service_get_write_locks('mynamespace', 'wlock1', 'wlock2', 10);</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------------------------------------------------- --------------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">service_get_write_locks（'mynamespace'，'wlock1'，'wlock2'，10）|</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------------------------------------------------- --------------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">1 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------------------------------------------------- --------------- +</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            在这种情况下，锁标识符
             </font></font><code class="literal">(mynamespace, wlock1)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
             </font></font><code class="literal">(mynamespace, wlock2)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            要释放名称空间的所有锁，请使用此函数：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL的&gt; </font></font><strong class="userinput"><code>SELECT service_release_locks('mynamespace');</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ -------------------------------------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">service_release_locks（'mynamespace'）|</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ -------------------------------------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">1 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ -------------------------------------- +</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            每个锁定函数返回非零值以获得成功。</font><font style="vertical-align: inherit;">如果该功能失败，则会发生错误。</font><font style="vertical-align: inherit;">例如，发生以下错误，因为锁名称不能为空：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL的&gt; </font></font><strong class="userinput"><code>SELECT service_get_read_locks('mynamespace', '', 10);</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
错误3131（42000）：锁定服务锁定名称''错误。</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            会话可以获取同一个锁标识符的多个锁。</font><font style="vertical-align: inherit;">只要不同的会话没有对标识符的写入锁定，会话就可以获取任意数量的读取或写入锁定。</font><font style="vertical-align: inherit;">标识符的每个锁定请求都会获取一个新的锁定。</font><font style="vertical-align: inherit;">以下语句获取具有相同标识符的三个写锁，然后针对相同标识符获取三个读锁：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SELECT service_get_write_locks（'ns'，'lock1'，'lock1'，'lock1'，0）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SELECT service_get_read_locks（'ns'，'lock1'，'lock1'，'lock1'，0）;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            如果您此时检查Performance Schema
             </font></font><code class="literal">metadata_locks</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表，您会发现会话拥有六个具有相同</font></font><code class="literal">(ns, lock1)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">标识符的</font><font style="vertical-align: inherit;">不同锁</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">（详情请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#locking-service-monitoring" title="28.3.1.2.3锁定服务监控"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.3.1.2.3节“锁定服务监控”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。）
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            由于会话保持至少一个写入锁定
             </font></font><code class="literal">(ns, lock1)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，所以其他会话无法读取或写入锁定。</font><font style="vertical-align: inherit;">如果会话只持有对该标识符的读取锁定，则其他会话可能会为其获取读取锁定，但不会写入锁定。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            单个锁定捕获呼叫的锁定是以原子方式获取的，但是原子性不支持呼叫。</font><font style="vertical-align: inherit;">因此，对于像下面这样的陈述，
             </font></font><code class="literal">service_get_write_locks()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结果集的每一行被调用一次，原子性对于每个单独的调用都成立，而不是作为一个整体的陈述：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SELECT service_get_write_locks（'ns'，'lock1'，'lock2'，0）FROM t1 WHERE ...;
</font></font></pre>
<div class="caution" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
警告
</font></font></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              由于锁定服务为给定的锁定标识符的每个成功请求返回一个单独的锁定，因此单个语句可能获取大量锁定。</font><font style="vertical-align: inherit;">例如：
            </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">INSERT INTO ... SELECT service_get_write_locks（'ns'，t1.col_name，0）FROM t1;
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              这些类型的陈述可能会有一定的不利影响。</font><font style="vertical-align: inherit;">例如，如果语句部分通过并回滚，则获取到故障点的锁仍然存在。</font><font style="vertical-align: inherit;">如果意图是在插入行和获取锁之间存在对应关系，那么该意图将不会被满足。</font><font style="vertical-align: inherit;">此外，如果以特定顺序授予锁定非常重要，请注意，结果集顺序可能因优化程序选择的执行计划而异。</font><font style="vertical-align: inherit;">由于这些原因，最好将应用程序限制为每个语句的一次锁定购买调用。
</font></font></p>
</div>

</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h5 class="title"><a name="locking-service-monitoring"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.3.1.2.3锁定服务监控</font></font></h5>

</div>

</div>

</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            锁定服务使用MySQL服务器元数据锁定框架实现，因此您可以通过检查性能模式</font></font><code class="literal">metadata_locks</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表</font><font style="vertical-align: inherit;">来监视获取或等待的锁定服务锁定</font><font style="vertical-align: inherit;">。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            首先，启用元数据锁定工具：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql&gt; </font></font><strong class="userinput"><code>UPDATE performance_schema.setup_instruments SET ENABLED = 'YES'</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    - &gt;</font></font><strong class="userinput"><code>WHERE NAME = 'wait/lock/metadata/sql/mdl';</code></strong>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            然后获取一些锁并检查</font></font><code class="literal">metadata_locks</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表</font><font style="vertical-align: inherit;">的内容
             </font><font style="vertical-align: inherit;">：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL的&gt; </font></font><strong class="userinput"><code>SELECT service_get_write_locks('mynamespace', 'lock1', 0);</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------------------------------------------------- --- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">service_get_write_locks（'mynamespace'，'lock1'，0）|</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------------------------------------------------- --- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">1 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------------------------------------------------- --- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MySQL的&gt; </font></font><strong class="userinput"><code>SELECT service_get_read_locks('mynamespace', 'lock2', 0);</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------------------------------------------------- -  +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">service_get_read_locks（'mynamespace'，'lock2'，0）|</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------------------------------------------------- -  +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">1 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ------------------------------------------------- -  +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql&gt; </font></font><strong class="userinput"><code>SELECT OBJECT_TYPE, OBJECT_SCHEMA, OBJECT_NAME, LOCK_TYPE, LOCK_STATUS</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    - &gt; </font></font><strong class="userinput"><code>FROM performance_schema.metadata_locks</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    - &gt;</font></font><strong class="userinput"><code>WHERE OBJECT_TYPE = 'LOCKING SERVICE'\G</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
*************************** 1. row ******************** *******</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  OBJECT_TYPE：锁定服务</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OBJECT_SCHEMA：mynamespace</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  OBJECT_NAME：lock1</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    LOCK_TYPE：EXCLUSIVE</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  LOCK_STATUS：授予</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
*************************** 2. row ******************** *******</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  OBJECT_TYPE：锁定服务</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OBJECT_SCHEMA：mynamespace</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  OBJECT_NAME：lock2</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    LOCK_TYPE：共享</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  LOCK_STATUS：授予</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            锁定服务锁具有</font></font><code class="literal">OBJECT_TYPE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            值</font></font><code class="literal">LOCKING SERVICE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这是不同于，例如，与所获取的锁
             </font></font><a class="link" href="/mysql-5.7-google-zh/functions.html#function_get-lock"><code class="literal">GET_LOCK()</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">功能，其具有</font></font><code class="literal">OBJECT_TYPE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的</font></font><code class="literal">USER
            LEVEL LOCK</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            锁命名空间，名称和模式出现在
             </font></font><code class="literal">OBJECT_SCHEMA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
             </font></font><code class="literal">OBJECT_NAME</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
             </font></font><code class="literal">LOCK_TYPE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">列。</font><font style="vertical-align: inherit;">读写锁的</font></font><code class="literal">LOCK_TYPE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值</font><font style="vertical-align: inherit;">分别</font><font style="vertical-align: inherit;">为
             </font></font><code class="literal">SHARED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><code class="literal">EXCLUSIVE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            该</font></font><code class="literal">LOCK_STATUS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值
             </font></font><code class="literal">GRANTED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用于获取的锁，
             </font></font><code class="literal">PENDING</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用于正在等待的锁。</font><font style="vertical-align: inherit;">您将看到</font></font><code class="literal">PENDING</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一个会话是否持有写入锁定，而另一个会话正在尝试获取具有相同标识符的锁定。
</font></font></p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h5 class="title"><a name="locking-service-udf-reference"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.3.1.2.4锁定服务UDF接口参考</font></font></h5>

</div>

</div>

</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            锁定服务的SQL接口实现本节中描述的用户定义的函数。</font><font style="vertical-align: inherit;">有关使用示例，请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#locking-service-udf-usage" title="28.3.1.2.2使用UDF锁定接口"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.3.1.2.2节“使用UDF锁定接口”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            这些功能具有以下特点：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                成功返回值不为零。</font><font style="vertical-align: inherit;">否则，会发生错误。
              </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                名称空间和锁名称必须是非</font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">空的，并且最大长度为64个字符。
              </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                超时值必须是整数，表示在放弃错误之前等待获取锁的秒数。</font><font style="vertical-align: inherit;">如果超时为0，则不会等待，并且如果不能立即获取锁，则函数会产生错误。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            这些锁定服务UDF可用：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
                <code class="literal">service_get_read_locks(<em class="replaceable"><code>namespace</code></em>,
                <em class="replaceable"><code>lock_name</code></em>[,
                <em class="replaceable"><code>lock_name</code></em>] ...,
                <em class="replaceable"><code>timeout</code></em>)</code>
              </p><a class="indexterm" name="idm140527954576992"></a><a class="indexterm" name="idm140527954575536"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                使用给定的锁名获取给定名称空间中的一个或多个读（共享）锁，如果在给定的超时值内没有获取锁，则会发生错误超时。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">service_get_write_locks(<em class="replaceable"><code>namespace</code></em>,
                <em class="replaceable"><code>lock_name</code></em>[,
                <em class="replaceable"><code>lock_name</code></em>] ...,
                <em class="replaceable"><code>timeout</code></em>)</code>
              </p><a class="indexterm" name="idm140527954570144"></a><a class="indexterm" name="idm140527954568640"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                使用给定的锁名称获取给定名称空间中的一个或多个写（独占）锁，如果在给定超时值内没有获取到锁，则超时并返回错误。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">service_release_locks(<em class="replaceable"><code>namespace</code></em>)</code>
              </p><a class="indexterm" name="idm140527954564608"></a><a class="indexterm" name="idm140527954563104"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                对于给定的名称空间，使用</font></font><code class="literal">service_get_read_locks()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
                 </font><font style="vertical-align: inherit;">释放在当前会话中获取的所有锁
                 </font></font><code class="literal">service_get_write_locks()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
              </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                在命名空间中没有锁定不是错误。
</font></font></p></li></ul>
</div>

</div>

</div>

</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="keyring-service"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.3.2钥匙圈服务</font></font></h3>

</div>

</div>

</div>
<a class="indexterm" name="idm140527954557328"></a><a class="indexterm" name="idm140527954555840"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        MySQL服务器支持密钥环服务，可以使内部服务器组件和插件安全地存储敏感信息以供日后检索。</font><font style="vertical-align: inherit;">本节介绍如何使用密钥环服务函数来存储，检索和删除MySQL密钥环密钥库中的密钥。</font><font style="vertical-align: inherit;">密匙环服务功能的SQL接口也可作为一组用户定义的函数（UDF）提供; </font><font style="vertical-align: inherit;">请参见
         </font></font><a class="xref" href="/mysql-5.7-google-zh/security.html#keyring-udfs-general-purpose" title="6.5.4.8通用密钥环密钥管理功能"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第6.5.4.8节“通用密钥环密钥管理功能”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">有关一般密钥环信息，请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/security.html#keyring" title="6.5.4 MySQL Keyring"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第6.5.4节“MySQL密钥环”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
      </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        密钥环服务使用任何底层的密钥环插件，如果有的话。</font><font style="vertical-align: inherit;">如果未启用密钥环插件，则密钥环服务调用失败。
      </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        阿</font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">记录</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在密钥库中包含的数据（密钥本身）和一个唯一的标识符，通过该键被访问。</font><font style="vertical-align: inherit;">标识符有两部分：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            <code class="literal">key_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：密钥ID或名称。
            </font><font style="vertical-align: inherit;">以MySQL服务器保留的</font></font><code class="literal">key_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值开头
             </font></font><code class="literal">mysql_</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
          </font></font></p></li><li class="listitem"><p>
            <code class="literal">user_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：会话有效的用户ID。</font><font style="vertical-align: inherit;">如果没有用户上下文，则该值可以是
             </font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">价值不一定是一个
             </font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用户</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ; </font><font style="vertical-align: inherit;">其含义取决于应用程序。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            实现密钥环UDF接口的函数将值</font></font><a class="link" href="/mysql-5.7-google-zh/functions.html#function_current-user"><code class="literal">CURRENT_USER()</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">作为</font></font><code class="literal">user_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值传递给密钥环服务函数。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        钥匙圈服务功能具有以下共同特征：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            每个函数返回0表示成功，1表示失败。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            在</font></font><code class="literal">key_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><code class="literal">user_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            参数形成指示要使用哪个键在钥匙圈一个独特的组合。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            该</font></font><code class="literal">key_type</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参数提供了有关密钥的其他信息，例如其加密方法或预期用途。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            密钥环服务函数将密钥ID，用户名，类型和值视为二进制字符串，因此比较区分大小写。</font><font style="vertical-align: inherit;">例如，ID </font></font><code class="literal">MyKey</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
             </font></font><code class="literal">mykey</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">引用不同的密钥。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        这些密钥环服务功能可用：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            <code class="literal">my_key_fetch()</code>
          </p><a class="indexterm" name="idm140527954532032"></a><a class="indexterm" name="idm140527954530944"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            反密码并从密钥环中检索密钥及其类型。</font><font style="vertical-align: inherit;">该函数为用于存储返回的密钥和密钥类型的缓冲区分配内存。</font><font style="vertical-align: inherit;">调用者应该在不再需要时将内存归零或混淆，然后释放它。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            句法：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">my_bool my_key_fetch（const char * key_id，const char ** key_type，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                     const char * user_id，void ** key，size_t * key_len）</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            参数：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
                <code class="literal">key_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><code class="literal">user_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：作为一对的空终止字符串形成唯一标识符，指示要提取哪个密钥。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">key_type</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：缓冲区指针的地址。</font><font style="vertical-align: inherit;">该函数存储一个指向空终止字符串的指针，该字符串提供有关该键的附加信息（添加键时存储）。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">key</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：缓冲区指针的地址。</font><font style="vertical-align: inherit;">该函数在其中存储一个指向包含提取的密钥数据的缓冲区的指针。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">key_len</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：函数用于存储</font></font><code class="literal">*key</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">缓冲区</font><font style="vertical-align: inherit;">字节大小的变量地址
                 </font><font style="vertical-align: inherit;">。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            返回值：
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            成功返回0，失败返回1。
          </font></font></p></li><li class="listitem"><p>
            <code class="literal">my_key_generate()</code>
          </p><a class="indexterm" name="idm140527954516352"></a><a class="indexterm" name="idm140527954515248"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            生成一个给定类型和长度的新随机密钥并将其存储在密钥环中。</font><font style="vertical-align: inherit;">该密钥的长度
             </font></font><code class="literal">key_len</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和与由</font></font><code class="literal">key_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
             </font><font style="vertical-align: inherit;">形成的标识符相关联</font></font><code class="literal">user_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">类型和长度值必须与基础密钥环插件支持的值一致。</font><font style="vertical-align: inherit;">请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/security.html#keyring-key-types" title="6.5.4.7支持的密钥环密钥类型"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第6.5.4.7节“支持的密钥环密钥类型”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            句法：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">my_bool my_key_generate（const char * key_id，const char * key_type，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                        const char * user_id，size_t key_len）</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            参数：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
                <code class="literal">key_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><code class="literal">user_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：作为一对的空终止字符串形成要生成的密钥的唯一标识符。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">key_type</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：以空字符结尾的字符串，提供有关密钥的其他信息。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">key_len</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：要生成的密钥的字节大小。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            返回值：
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            成功返回0，失败返回1。
          </font></font></p></li><li class="listitem"><p>
            <code class="literal">my_key_remove()</code>
          </p><a class="indexterm" name="idm140527954500352"></a><a class="indexterm" name="idm140527954499248"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            从钥匙圈中删除钥匙。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            句法：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">my_bool my_key_remove（const char * key_id，const char * user_id）
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            参数：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
                <code class="literal">key_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><code class="literal">user_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：作为一对的空终止字符串形成要删除的密钥的唯一标识符。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            返回值：
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            成功返回0，失败返回1。
          </font></font></p></li><li class="listitem"><p>
            <code class="literal">my_key_store()</code>
          </p><a class="indexterm" name="idm140527954490656"></a><a class="indexterm" name="idm140527954489568"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            混淆并存储密钥环中的密钥。
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            句法：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">my_bool my_key_store（const char * key_id，const char * key_type，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                     const char * user_id，void * key，size_t key_len）</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            参数：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
                <code class="literal">key_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><code class="literal">user_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：作为一对的空终止字符串形成要存储的密钥的唯一标识符。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">key_type</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：以空字符结尾的字符串，提供有关密钥的其他信息。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">key</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：包含要存储的关键数据的缓冲区。
              </font></font></p></li><li class="listitem"><p>
                <code class="literal">key_len</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><code class="literal">key</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">缓冲区</font><font style="vertical-align: inherit;">的大小（以字节为单位）
                 </font><font style="vertical-align: inherit;">。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            返回值：
          </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            成功返回0，失败返回1。
</font></font></p></li></ul>
</div>

</div>

</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h2 class="title" style="clear: both"><a name="adding-functions"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.4为MySQL添加新功能</font></font></h2>

</div>

</div>

</div>
<div class="toc">
<dl class="toc"><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#udf-features"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.4.1用户定义的功能接口的功能</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#adding-udf"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.4.2添加新的用户定义函数</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#adding-native-function"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.4.3添加一个新的本地函数</font></font></a></span></dt></dl>
</div>
<a class="indexterm" name="idm140527954475440"></a><a class="indexterm" name="idm140527954474016"></a><a class="indexterm" name="idm140527954472528"></a><a class="indexterm" name="idm140527954471040"></a><a class="indexterm" name="idm140527954469552"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      有三种方法可以为MySQL添加新功能：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          您可以通过用户定义的函数（UDF）接口添加函数。</font><font style="vertical-align: inherit;">用户定义的函数被编译为库文件，然后使用</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#create-function" title="13.1.13 CREATE FUNCTION语法"><code class="literal">CREATE
          FUNCTION</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#drop-function" title="13.1.24 DROP FUNCTION语法"><code class="literal">DROP
          FUNCTION</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句</font><font style="vertical-align: inherit;">动态地添加到服务器并从服务器中删除</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/sql-syntax.html#create-function-udf" title="13.7.3.1用户定义函数的CREATE FUNCTION语法"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第13.7.3.1节“用户自定义函数的CREATE FUNCTION语法”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          您可以将函数添加为本地（内置）MySQL函数。</font><font style="vertical-align: inherit;">原生函数被编译到
           </font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">服务器中并永久可用。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          另一种添加函数的方法是创建存储函数。</font><font style="vertical-align: inherit;">这些是使用SQL语句编写的，而不是编译目标代码。</font><font style="vertical-align: inherit;">这里没有介绍编写存储函数的语法。</font><font style="vertical-align: inherit;">请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/stored-programs-views.html#stored-routines" title="23.2使用存储例程（过程和函数）"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第23.2节“使用存储例程（过程和函数）”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      创建编译函数的每种方法都有优点和缺点：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          如果您编写用户定义的函数，则除了服务器本身之外，还必须安装对象文件。</font><font style="vertical-align: inherit;">如果您将函数编译到服务器中，则不需要这样做。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          本机功能需要您修改源分配。</font><font style="vertical-align: inherit;">UDF不。</font><font style="vertical-align: inherit;">您可以将UDF添加到二进制MySQL发行版中。</font><font style="vertical-align: inherit;">不需要访问MySQL源代码。
        </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          如果升级MySQL发行版，则可以继续使用先前安装的UDF，除非升级到UDF接口更改的较新版本。</font><font style="vertical-align: inherit;">对于本地功能，每次升级时都必须重复修改。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      无论您使用哪种方法添加新函数，都可以在SQL语句中调用它们，就像本地函数（如
       </font></font><a class="link" href="/mysql-5.7-google-zh/functions.html#function_abs"><code class="literal">ABS()</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or）一样
       </font></font><a class="link" href="/mysql-5.7-google-zh/functions.html#function_soundex"><code class="literal">SOUNDEX()</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      有关</font><font style="vertical-align: inherit;">描述服务器如何解释对不同类型函数的引用的规则</font></font><a class="xref" href="/mysql-5.7-google-zh/language-structure.html#function-resolution" title="9.2.4函数名称解析和解析"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">请参见</font><a class="xref" href="/mysql-5.7-google-zh/language-structure.html#function-resolution" title="9.2.4函数名称解析和解析"><font style="vertical-align: inherit;">第9.2.4节“函数名称解析和解析”</font></a><font style="vertical-align: inherit;">。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      以下各节介绍了UDF接口的功能，提供了编写UDF的说明，讨论了MySQL为防止UDF滥用而采取的安全防范措施，并介绍了如何添加本机MySQL功能。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      例如说明如何编写UDF的源代码，请查看</font></font><code class="filename">sql/udf_example.cc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL源代码分发中提供</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">文件。
</font></font></p>
<div class="section">

<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="udf-features"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.4.1用户定义的功能接口的功能</font></font></h3>
</div>
</div>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        用户定义函数的MySQL接口提供以下特性和功能：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            函数可以返回字符串，整数或实数值，并可以接受这些相同类型的参数。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            您可以定义一次操作一行的简单函数，也可以定义对一组行进行操作的聚合函数。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            信息提供给函数，使他们能够检查传递给它们的参数的数量，类型和名称。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            你可以告诉MySQL在将它们传递给一个函数之前强制给定类型的参数。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            您可以指示函数返回
             </font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或发生错误。
</font></font></p></li></ul>
</div>

</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="adding-udf"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.4.2添加新的用户定义函数</font></font></h3>

</div>

</div>

</div>
<div class="toc">
<dl class="toc"><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#udf-calling"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.4.2.1简单函数的UDF调用序列</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#udf-aggr-calling"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.4.2.2用于聚合函数的UDF调用序列</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#udf-arguments"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.4.2.3 UDF参数处理</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#udf-return-values"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.4.2.4 UDF返回值和错误处理</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#udf-compiling"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.4.2.5 UDF编译和安装</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#udf-security"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.4.2.6 UDF安全注意事项</font></font></a></span></dt></dl>
</div>
<a class="indexterm" name="idm140527954439632"></a><a class="indexterm" name="idm140527954438176"></a><a class="indexterm" name="idm140527954436688"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        为了使UDF机制起作用，函数必须用C或C ++编写，并且操作系统必须支持动态加载。</font><font style="vertical-align: inherit;">MySQL源代码分发包含一个</font></font><code class="filename">sql/udf_example.cc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">定义了五个UDF函数</font><font style="vertical-align: inherit;">的文件
         </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">请参阅此文件以了解UDF调用约定是如何工作的。</font><font style="vertical-align: inherit;">该</font></font><code class="filename">include/mysql_com.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">头文件定义UDF相关的符号和数据结构，虽然你不必直接包含这个头文件; </font><font style="vertical-align: inherit;">它被包括在内
         </font></font><code class="filename">mysql.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
      </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        UDF包含的代码成为正在运行的服务器的一部分，因此，当您编写UDF时，您受到适用于编写服务器代码的任何和所有约束的约束。</font><font style="vertical-align: inherit;">例如，如果尝试使用</font></font><code class="literal">libstdc++</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">库中的</font><font style="vertical-align: inherit;">函数，可能会遇到问题
         </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这些约束可能在服务器的未来版本中发生变化，因此服务器升级可能需要修改最初为旧服务器编写的UDF。</font><font style="vertical-align: inherit;">有关这些约束的信息，请参见
         </font></font><a class="xref" href="/mysql-5.7-google-zh/installing.html#source-configuration-options" title="2.9.4 MySQL源配置选项"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第2.9.4节“MySQL源配置选项”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
         </font></font><a class="xref" href="/mysql-5.7-google-zh/installing.html#compilation-problems" title="2.9.5处理编译MySQL的问题"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第2.9.5节“处理编译MySQL的问题”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
      </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        为了能够使用UDF，您必须</font><font style="vertical-align: inherit;">
        动态</font><font style="vertical-align: inherit;">链接</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">如果你想使用一个需要从访问符号的UDF </font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（例如，
         </font></font><code class="literal">metaphone</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在功能
         </font></font><code class="filename">sql/udf_example.cc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用途
         </font></font><code class="literal">default_charset_info</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">），必须链接与程序</font></font><code class="option">-rdynamic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（见</font></font><code class="literal">man
        dlopen</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。
      </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        对于要在SQL语句中使用的每个函数，您应该定义相应的C（或C ++）函数。</font><font style="vertical-align: inherit;">在下面的讨论中，名称</font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xxx</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用于示例函数名称。</font><font style="vertical-align: inherit;">为区分SQL和C / C ++用法，</font></font><code class="literal">XXX()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（大写）表示SQL函数调用，</font></font><code class="literal">xxx()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（小写）表示C / C ++函数调用。
</font></font></p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
注意
</font></font></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          当使用C ++时，你可以将你的C函数封装在：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">extern“C”{...}
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          这可确保您的C ++函数名称在完成的UDF中保持可读。
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        以下列表描述了您为编写名为函数的接口而编写的C / C ++函数
         </font></font><code class="literal">XXX()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">主要功能
         </font></font><code class="literal">xxx()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是必需的。</font><font style="vertical-align: inherit;">此外，由于</font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#udf-security" title="28.4.2.6 UDF安全注意事项"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.4.2.6节“UDF安全注意事项”中</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">讨论的原因，UDF至少需要此处所述的其他功能之一</font><font style="vertical-align: inherit;">。
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            <code class="literal">xxx()</code>
          </p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            主要功能。</font><font style="vertical-align: inherit;">这是计算函数结果的地方。</font><font style="vertical-align: inherit;">这里显示了SQL函数数据类型和C / C ++函数的返回类型之间的对应关系。
</font></font></p>
<div class="informaltable">
<a name="adding-udf-sql-c-cpp-data-types"></a><table summary="SQL function data types and corresponding C/C++ data types."><colgroup><col width="25%"><col width="25%"></colgroup><thead><tr>
                <th scope="col"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SQL类型</font></font></th>
                <th scope="col"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C / C ++类型</font></font></th>
              </tr></thead><tbody><tr>
                <td scope="row"><code class="literal">STRING</code></td>
                <td><code class="literal">char *</code></td>
              </tr><tr>
                <td scope="row"><a class="link" href="/mysql-5.7-google-zh/data-types.html#integer-types" title="11.2.1整型（精确值） -  INTEGER，INT，SMALLINT，TINYINT，MEDIUMINT，BIGINT"><code class="literal">INTEGER</code></a></td>
                <td><code class="literal">long long</code></td>
              </tr><tr>
                <td scope="row"><a class="link" href="/mysql-5.7-google-zh/data-types.html#floating-point-types" title="11.2.3浮点类型（近似值） -  FLOAT，DOUBLE"><code class="literal">REAL</code></a></td>
                <td><code class="literal">double</code></td>
</tr></tbody></table>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            也可以声明一个
             </font></font><a class="link" href="/mysql-5.7-google-zh/data-types.html#fixed-point-types" title="11.2.2定点类型（准确值） -  DECIMAL，NUMERIC"><code class="literal">DECIMAL</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数，但是当前的值是以字符串形式返回的，所以您应该像编写</font></font><code class="literal">STRING</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            函数</font><font style="vertical-align: inherit;">一样编写UDF </font><font style="vertical-align: inherit;">。</font></font><code class="literal">ROW</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">功能没有实现。
          </font></font></p></li><li class="listitem"><p>
            <code class="literal">xxx_init()</code>
          </p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            初始化函数</font></font><code class="literal">xxx()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">如果存在，它可以用于以下目的：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                检查参数的数量
                 </font></font><code class="literal">XXX()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
              </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                验证参数是否为必需类型，或者可以告诉MySQL在主函数被调用时将参数强制转换为所需的类型。
              </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                分配主函数所需的任何内存。
              </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                指定结果的最大长度。
              </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                指定（对于</font></font><a class="link" href="/mysql-5.7-google-zh/data-types.html#floating-point-types" title="11.2.3浮点类型（近似值） -  FLOAT，DOUBLE"><code class="literal">REAL</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                函数）结果中的最大小数位数。
              </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                指定结果是否可以
                 </font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p></li></ul>
</div>
</li><li class="listitem"><p>
            <code class="literal">xxx_deinit()</code>
          </p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            解除初始化函数</font></font><code class="literal">xxx()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">如果存在，它应该释放由初始化函数分配的任何内存。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        当一个SQL语句调用时</font></font><code class="literal">XXX()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，MySQL调用初始化函数</font></font><code class="literal">xxx_init()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        让它执行任何必需的设置，例如参数检查或内存分配。</font><font style="vertical-align: inherit;">如果</font></font><code class="literal">xxx_init()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">返回一个错误，MySQL会用错误消息中止SQL语句，并且不会调用main或deinitialization函数。</font><font style="vertical-align: inherit;">否则，MySQL会</font></font><code class="literal">xxx()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为每一行</font><font style="vertical-align: inherit;">调用</font><font style="vertical-align: inherit;">一次</font><font style="vertical-align: inherit;">主函数
         </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">所有行都被处理后，MySQL调用去初始化函数，
         </font></font><code class="literal">xxx_deinit()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以便它可以执行任何所需的清理。
      </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        对于像这样工作的集合函数
         </font></font><a class="link" href="/mysql-5.7-google-zh/functions.html#function_sum"><code class="literal">SUM()</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，您还必须提供以下功能：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            <code class="literal">xxx_clear()</code>
          </p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            重置当前的聚合值，但不要插入参数作为新组的初始聚合值。
          </font></font></p></li><li class="listitem"><p>
            <code class="literal">xxx_add()</code>
          </p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            将参数添加到当前的聚合值。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        MySQL如下处理集合UDF：
</font></font></p>
<div class="orderedlist">
<ol class="orderedlist" type="1"><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            调用</font></font><code class="literal">xxx_init()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">让聚集函数分配它存储结果所需的任何内存。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            根据</font></font><code class="literal">GROUP BY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            表达式</font><font style="vertical-align: inherit;">对表格进行排序</font><font style="vertical-align: inherit;">。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            呼叫</font></font><code class="literal">xxx_clear()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">每个新组中的第一行。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            调用</font></font><code class="literal">xxx_add()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">属于同一组的每一行。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"></font><code class="literal">xxx()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在组更改或处理最后一行后</font><font style="vertical-align: inherit;">
            调用</font><font style="vertical-align: inherit;">以获取聚合结果。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            重复步骤3到5，直到处理完所有行
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            调用</font></font><code class="literal">xxx_deinit()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以让UDF释放它分配的任何内存。
</font></font></p></li></ol>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        所有功能必须是线程安全的。</font><font style="vertical-align: inherit;">这不仅包括主函数，还包括初始化和去初始化函数，以及聚合函数所需的附加函数。</font><font style="vertical-align: inherit;">这个要求的后果是，你不能分配任何改变的全局或静态变量！</font><font style="vertical-align: inherit;">如果你需要记忆，你应该分配它
         </font></font><code class="literal">xxx_init()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并释放它
         </font></font><code class="literal">xxx_deinit()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p>
<div class="section">

<div class="titlepage">
<div>
<div>
<h4 class="title"><a name="udf-calling"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.4.2.1简单函数的UDF调用序列</font></font></h4>
</div>
</div>
</div>
<a class="indexterm" name="idm140527954352848"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          本节介绍创建简单UDF时需要定义的不同功能。
          </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#adding-udf" title="28.4.2添加新的用户定义函数"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.4.2节“添加一个新的用户定义的函数”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，描述了MySQL调用这些函数的顺序。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          主要</font></font><code class="literal">xxx()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">功能应该如本节所示进行声明。</font><font style="vertical-align: inherit;">请注意，返回类型和参数不同，这取决于你是否声明SQL函数</font></font><code class="literal">XXX()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">返回
           </font></font><code class="literal">STRING</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
           </font></font><a class="link" href="/mysql-5.7-google-zh/data-types.html#integer-types" title="11.2.1整型（精确值） -  INTEGER，INT，SMALLINT，TINYINT，MEDIUMINT，BIGINT"><code class="literal">INTEGER</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
           </font></font><a class="link" href="/mysql-5.7-google-zh/data-types.html#floating-point-types" title="11.2.3浮点类型（近似值） -  FLOAT，DOUBLE"><code class="literal">REAL</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#create-function" title="13.1.13 CREATE FUNCTION语法"><code class="literal">CREATE FUNCTION</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句：
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          对于</font></font><code class="literal">STRING</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">功能：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">char * xxx（UDF_INIT * initid，UDF_ARGS * args，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          char *结果，无符号长*长度，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          char * is_null，char * error）;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          对于</font></font><a class="link" href="/mysql-5.7-google-zh/data-types.html#integer-types" title="11.2.1整型（精确值） -  INTEGER，INT，SMALLINT，TINYINT，MEDIUMINT，BIGINT"><code class="literal">INTEGER</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">功能：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">long long xxx（UDF_INIT * initid，UDF_ARGS * args，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              char * is_null，char * error）;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          对于</font></font><a class="link" href="/mysql-5.7-google-zh/data-types.html#floating-point-types" title="11.2.3浮点类型（近似值） -  FLOAT，DOUBLE"><code class="literal">REAL</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">功能：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">双xxx（UDF_INIT * initid，UDF_ARGS * args，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              char * is_null，char * error）;</font></font><font></font>
</pre><p>
          <a class="link" href="/mysql-5.7-google-zh/data-types.html#fixed-point-types" title="11.2.2定点类型（准确值） -  DECIMAL，NUMERIC"><code class="literal">DECIMAL</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数返回字符串值，并且应该以与</font></font><code class="literal">STRING</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数</font><font style="vertical-align: inherit;">相同的方式声明
           </font><font style="vertical-align: inherit;">。</font></font><code class="literal">ROW</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          功能没有实现。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          初始化和去初始化函数是这样声明的：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">my_bool xxx_init（UDF_INIT * initid，UDF_ARGS * args，char * message）;</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
void xxx_deinit（UDF_INIT * initid）;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          该</font></font><code class="literal">initid</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参数被传递给所有三个函数。</font><font style="vertical-align: inherit;">它指向一个</font></font><code class="literal">UDF_INIT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          用于在函数之间传递信息</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">结构。</font><font style="vertical-align: inherit;">该</font></font><code class="literal">UDF_INIT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结构成员遵循。</font><font style="vertical-align: inherit;">初始化函数应该填写任何想要更改的成员。</font><font style="vertical-align: inherit;">（要使用成员的默认值，请保持不变。）
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              <code class="literal">my_bool maybe_null</code>
            </p><p>
              <code class="literal">xxx_init()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">应该设置
               </font></font><code class="literal">maybe_null</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为</font></font><code class="literal">1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果
               </font></font><code class="literal">xxx()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可以返回
               </font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">默认值是
               </font></font><code class="literal">1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果任何参数被声明
               </font></font><code class="literal">maybe_null</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
            </font></font></p></li><li class="listitem"><p>
              <code class="literal">unsigned int decimals</code>
            </p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              小数点右侧的小数位数。</font><font style="vertical-align: inherit;">默认值是传递给主函数的参数中的最大小数位数。</font><font style="vertical-align: inherit;">例如，如果函数传递
               </font></font><code class="literal">1.34</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><code class="literal">1.345</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
               </font></font><code class="literal">1.3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，默认是3，因为
               </font></font><code class="literal">1.345</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">有3个十进制数字。
            </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              对于具有小数的没有固定数量的参数，所述
               </font></font><code class="literal">decimals</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值被设置为31，这比允许的小数的最大数量更多的
               </font></font><a class="link" href="/mysql-5.7-google-zh/data-types.html#fixed-point-types" title="11.2.2定点类型（准确值） -  DECIMAL，NUMERIC"><code class="literal">DECIMAL</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
               </font></font><a class="link" href="/mysql-5.7-google-zh/data-types.html#floating-point-types" title="11.2.3浮点类型（近似值） -  FLOAT，DOUBLE"><code class="literal">FLOAT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
               </font></font><a class="link" href="/mysql-5.7-google-zh/data-types.html#floating-point-types" title="11.2.3浮点类型（近似值） -  FLOAT，DOUBLE"><code class="literal">DOUBLE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数据类型。</font><font style="vertical-align: inherit;">该值可以作为</font><font style="vertical-align: inherit;">头文件中</font><font style="vertical-align: inherit;">的常量
               </font></font><code class="literal">NOT_FIXED_DEC</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用
               </font></font><code class="filename">mysql_com.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
            </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              甲</font></font><code class="literal">decimals</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的31值用于在箱子参数诸如
               </font></font><a class="link" href="/mysql-5.7-google-zh/data-types.html#floating-point-types" title="11.2.3浮点类型（近似值） -  FLOAT，DOUBLE"><code class="literal">FLOAT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
               </font></font><a class="link" href="/mysql-5.7-google-zh/data-types.html#floating-point-types" title="11.2.3浮点类型（近似值） -  FLOAT，DOUBLE"><code class="literal">DOUBLE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">柱无小数的明确声明数（例如，
               </font></font><a class="link" href="/mysql-5.7-google-zh/data-types.html#floating-point-types" title="11.2.3浮点类型（近似值） -  FLOAT，DOUBLE"><code class="literal">FLOAT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">而不是
               </font></font><code class="literal">FLOAT(10,3)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）和浮点常数如</font></font><code class="literal">1345E-3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">它也用于字符串和其他可能在函数内转换为数字形式的非数字参数。
            </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              到的值</font></font><code class="literal">decimals</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">构件被初始化仅仅是一个缺省值。</font><font style="vertical-align: inherit;">它可以在函数内进行更改以反映所执行的实际计算。</font><font style="vertical-align: inherit;">默认值是使用参数的最大小数位数来确定的。</font><font style="vertical-align: inherit;">如果</font></font><code class="literal">NOT_FIXED_DEC</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">即使其中一个参数</font><font style="vertical-align: inherit;">的小数位数是</font><font style="vertical-align: inherit;">用于的值
               </font></font><code class="literal">decimals</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
            </font></font></p></li><li class="listitem"><p>
              <code class="literal">unsigned int max_length</code>
            </p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              结果的最大长度。</font><font style="vertical-align: inherit;">默认
               </font></font><code class="literal">max_length</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值因功能的结果类型而异。</font><font style="vertical-align: inherit;">对于字符串函数，默认值是最长参数的长度。</font><font style="vertical-align: inherit;">对于整数函数，默认值是21位数。</font><font style="vertical-align: inherit;">对于实际功能，默认值为13加上表示的小数位数</font></font><code class="literal">initid-&gt;decimals</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">（对于数字函数，长度包括任何符号或小数点字符。）
            </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              如果你想返回一个BLOB值，你可以设置
               </font></font><code class="literal">max_length</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为65KB或16MB。</font><font style="vertical-align: inherit;">该内存未分配，但是如果需要临时存储数据，则使用该值来决定使用哪种数据类型。
            </font></font></p></li><li class="listitem"><p>
              <code class="literal">char *ptr</code>
            </p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              函数可以用于自己的目的的指针。</font><font style="vertical-align: inherit;">例如，函数可以用来
               </font></font><code class="literal">initid-&gt;ptr</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在它们之间传递分配的内存。</font></font><code class="literal">xxx_init()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              应分配内存并将其分配给此指针：
            </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">initid-&gt; ptr = allocated_memory;
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              在</font></font><code class="literal">xxx()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和中
               </font></font><code class="literal">xxx_deinit()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，请参阅
               </font></font><code class="literal">initid-&gt;ptr</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用或取消分配内存。
            </font></font></p></li><li class="listitem"><p>
              <code class="literal">my_bool const_item</code>
            </p><p>
              <code class="literal">xxx_init()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">应该设置
               </font></font><code class="literal">const_item</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为</font></font><code class="literal">1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果
               </font></font><code class="literal">xxx()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">总是返回相同的值，</font></font><code class="literal">0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">否则。
</font></font></p></li></ul>
</div>

</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h4 class="title"><a name="udf-aggr-calling"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.4.2.2用于聚合函数的UDF调用序列</font></font></h4>

</div>

</div>

</div>
<a class="indexterm" name="idm140527954282240"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          本节介绍创建集合UDF时需要定义的不同功能。
          </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#adding-udf" title="28.4.2添加新的用户定义函数"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.4.2节“添加一个新的用户定义的函数”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，描述了MySQL调用这些函数的顺序。
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              <code class="literal">xxx_reset()</code>
            </p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              当MySQL在新组中找到第一行时，会调用此函数。</font><font style="vertical-align: inherit;">它应该重置任何内部摘要变量，然后使用给定的
               </font></font><code class="literal">UDF_ARGS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参数作为组的内部摘要值中的第一个值。</font><font style="vertical-align: inherit;">声明
               </font></font><code class="literal">xxx_reset()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如下：
            </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">void xxx_reset（UDF_INIT * initid，UDF_ARGS * args，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
               char * is_null，char * error）;</font></font><font></font>
</pre><p>
              <code class="literal">xxx_reset()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在MySQL 5.7中不需要或使用，其中UDF接口使用它
               </font></font><code class="literal">xxx_clear()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">但是，您可以定义两者，</font></font><code class="literal">xxx_reset()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以及
               </font></font><code class="literal">xxx_clear()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是否希望让UDF与旧版服务器一起工作。</font><font style="vertical-align: inherit;">（如果包含这两个函数，则</font></font><code class="literal">xxx_reset()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              在许多情况下</font><font style="vertical-align: inherit;">该</font><font style="vertical-align: inherit;">函数可以通过调用</font></font><code class="literal">xxx_clear()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以重置所有变量，然后调用</font></font><code class="literal">xxx_add()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              以将该</font></font><code class="literal">UDF_ARGS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参数</font><font style="vertical-align: inherit;">添加</font><font style="vertical-align: inherit;">为组中的第一个值来实现。）
            </font></font></p></li><li class="listitem"><p>
              <code class="literal">xxx_clear()</code>
            </p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              这个函数在MySQL需要重置汇总结果时被调用。</font><font style="vertical-align: inherit;">它在每个新组的开始时被调用，但也可以调用它来重置没有匹配行的查询的值。</font><font style="vertical-align: inherit;">声明
               </font></font><code class="literal">xxx_clear()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如下：
            </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">void xxx_clear（UDF_INIT * initid，char * is_null，char * error）;
</font></font></pre><p>
              <code class="literal">is_null</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">被设置为</font></font><code class="literal">CHAR(0)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在调用之前
               </font><font style="vertical-align: inherit;">指向
               </font></font><code class="literal">xxx_clear()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
            </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              如果出现问题，您可以将值存储在</font></font><code class="literal">error</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参数指向</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">变量中。</font></font><code class="literal">error</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指向一个单字节变量，而不是字符串缓冲区。
            </font></font></p><p>
              <code class="literal">xxx_clear()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 是MySQL 5.7要求的。
            </font></font></p></li><li class="listitem"><p>
              <code class="literal">xxx_add()</code>
            </p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              此功能针对属于同一组的所有行调用。</font><font style="vertical-align: inherit;">您应该使用它将</font></font><code class="literal">UDF_ARGS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参数中</font><font style="vertical-align: inherit;">的值添加
               </font><font style="vertical-align: inherit;">到内部摘要变量中。
            </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">void xxx_add（UDF_INIT * initid，UDF_ARGS * args，</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
             char * is_null，char * error）;</font></font><font></font>
</pre></li></ul>
</div>
<p><font style="vertical-align: inherit;"></font><code class="literal">xxx()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">应该以与非聚合UDF相同的方式声明集合UDF </font><font style="vertical-align: inherit;">
          的</font><font style="vertical-align: inherit;">功能。</font><font style="vertical-align: inherit;">请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#udf-calling" title="28.4.2.1简单函数的UDF调用序列"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.4.2.1节“简单函数的UDF调用序列”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          对于集合UDF，MySQL </font></font><code class="literal">xxx()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          在组中的所有行都被处理后</font><font style="vertical-align: inherit;">调用该</font><font style="vertical-align: inherit;">函数。</font><font style="vertical-align: inherit;">你通常不应该</font></font><code class="literal">UDF_ARGS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          在这里</font><font style="vertical-align: inherit;">访问它的</font><font style="vertical-align: inherit;">参数，而是根据你的内部总结变量返回一个值。
        </font></font></p><p><font style="vertical-align: inherit;"></font><code class="literal">xxx()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">应该按照与非聚合UDF相同的方式完成</font><font style="vertical-align: inherit;">
          返回值处理</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#udf-return-values" title="28.4.2.4 UDF返回值和错误处理"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.4.2.4节“UDF返回值和错误处理”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          在</font></font><code class="literal">xxx_reset()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
           </font></font><code class="literal">xxx_add()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数处理他们的
           </font></font><code class="literal">UDF_ARGS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">论据的方式与非聚集UDF的功能相同。</font><font style="vertical-align: inherit;">请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#udf-arguments" title="28.4.2.3 UDF参数处理"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.4.2.3节“UDF参数处理”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          指针参数</font></font><code class="literal">is_null</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
           </font></font><code class="literal">error</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是相同的所有来电
           </font></font><code class="literal">xxx_reset()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
           </font></font><code class="literal">xxx_clear()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><code class="literal">xxx_add()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          和</font></font><code class="literal">xxx()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">你可以用它来记住你有错误或</font></font><code class="literal">xxx()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          函数</font><font style="vertical-align: inherit;">是否</font><font style="vertical-align: inherit;">应该返回</font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">你不应该存储一个字符串</font></font><code class="literal">*error</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">！
          </font></font><code class="literal">error</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指向一个单字节变量，而不是字符串缓冲区。
        </font></font></p><p>
          <code class="literal">*is_null</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为每个组重置（在调用之前</font></font><code class="literal">xxx_clear()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。
          </font></font><code class="literal">*error</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">永远不会重置。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          如果</font></font><code class="literal">*is_null</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或者</font></font><code class="literal">*error</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          在</font></font><code class="literal">xxx()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">返回</font><font style="vertical-align: inherit;">时设置</font><font style="vertical-align: inherit;">，则MySQL返回
           </font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">组结果作为组函数。
</font></font></p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h4 class="title"><a name="udf-arguments"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.4.2.3 UDF参数处理</font></font></h4>

</div>

</div>

</div>
<a class="indexterm" name="idm140527954230784"></a><a class="indexterm" name="idm140527954229712"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          该</font></font><code class="literal">args</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参数指向</font></font><code class="literal">UDF_ARGS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">具有此处列出的成员</font><font style="vertical-align: inherit;">的
           </font><font style="vertical-align: inherit;">结构：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              <code class="literal">unsigned int arg_count</code>
            </p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              参数的数量。</font><font style="vertical-align: inherit;">如果您需要使用特定数量的参数调用函数，请在初始化函数中检查此值。</font><font style="vertical-align: inherit;">例如：
            </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果（args-&gt; arg_count！= 2）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    strcpy（message，“XXX（）需要两个参数”）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    返回1;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              对于</font></font><code class="literal">UDF_ARGS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数组的</font><font style="vertical-align: inherit;">其他</font><font style="vertical-align: inherit;">成员值，数组引用是从零开始的。</font><font style="vertical-align: inherit;">也就是说，引用使用索引值从0到</font></font><code class="literal">args-&gt;arg_count</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-1的</font><font style="vertical-align: inherit;">数组成员
               </font><font style="vertical-align: inherit;">。
            </font></font></p></li><li class="listitem"><p>
              <code class="literal">enum Item_result *arg_type</code>
            </p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              指向包含每个参数类型的数组的指针。</font><font style="vertical-align: inherit;">可能的类型的值是
               </font></font><code class="literal">STRING_RESULT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
               </font></font><code class="literal">INT_RESULT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
               </font></font><code class="literal">REAL_RESULT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，和
               </font></font><code class="literal">DECIMAL_RESULT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
            </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              要确保参数是给定类型的参数，并且如果它们不是，则返回错误，请检查</font></font><code class="literal">arg_type</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">初始化函数中</font><font style="vertical-align: inherit;">的
               </font><font style="vertical-align: inherit;">数组。</font><font style="vertical-align: inherit;">例如：
            </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if（args-&gt; arg_type [0]！= STRING_RESULT ||</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    args-&gt; arg_type [1]！= INT_RESULT）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    strcpy（消息，“XXX（）需要一个字符串和一个整数”）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    返回1;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              类型的参数</font></font><code class="literal">DECIMAL_RESULT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">作为字符串传递，所以你应该像处理</font></font><code class="literal">STRING_RESULT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值</font><font style="vertical-align: inherit;">一样处理它们</font><font style="vertical-align: inherit;">。
            </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              作为要求函数参数具有特定类型的替代方法，可以使用初始化函数将</font></font><code class="literal">arg_type</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">元素</font><font style="vertical-align: inherit;">设置</font><font style="vertical-align: inherit;">为所需的类型。</font><font style="vertical-align: inherit;">这会导致MySQL将参数强制转换为每次调用的类型
               </font></font><code class="literal">xxx()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">例如，要指定前两个参数分别强制为字符串和整数，请在</font></font><code class="literal">xxx_init()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以下位置</font><font style="vertical-align: inherit;">执行此操作
               </font><font style="vertical-align: inherit;">：
            </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">args-&gt; arg_type [0] = STRING_RESULT;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
args-&gt; arg_type [1] = INT_RESULT;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              精确值小数参数（例如
               </font></font><code class="literal">1.3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
               </font></font><a class="link" href="/mysql-5.7-google-zh/data-types.html#fixed-point-types" title="11.2.2定点类型（准确值） -  DECIMAL，NUMERIC"><code class="literal">DECIMAL</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">列值）以类型传递</font></font><code class="literal">DECIMAL_RESULT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">但是，这些值是作为字符串传递的。</font><font style="vertical-align: inherit;">如果你想接收一个数字，使用初始化函数来指定参数应该被强制为一个
               </font></font><code class="literal">REAL_RESULT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值：
            </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">args-&gt; arg_type [2] = REAL_RESULT;
</font></font></pre></li><li class="listitem"><p>
              <code class="literal">char **args</code>
            </p><p>
              <code class="literal">args-&gt;args</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">向初始化函数传递有关传递给函数的参数的一般性质的信息。</font><font style="vertical-align: inherit;">对于一个常量参数</font></font><code class="literal">i</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
               </font></font><code class="literal">args-&gt;args[i]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指向参数值。</font><font style="vertical-align: inherit;">（请参阅后面有关如何正确访问该值的说明。）对于非常数参数，
               </font></font><code class="literal">args-&gt;args[i]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是
               </font></font><code class="literal">0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">常量参数是只使用常量的表达式，如</font></font><code class="literal">3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or
               </font></font><code class="literal">4*7-2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
               </font></font><a class="link" href="/mysql-5.7-google-zh/functions.html#function_sin"><code class="literal">SIN(3.14)</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">非常数参数是一个表达式，它引用可能在行之间更改的值，例如列名或使用非常数参数调用的函数。
            </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              对于主函数的每次调用，都
               </font></font><code class="literal">args-&gt;args</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">包含为当前正在处理的行传递的实际参数。
            </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              如果参数</font></font><code class="literal">i</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表示
               </font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
               </font></font><code class="literal">args-&gt;args[i]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是一个空指针（0）。</font><font style="vertical-align: inherit;">如果参数不是</font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，函数可以引用它如下：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                  类型的参数</font></font><code class="literal">STRING_RESULT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                  是作为字符串指针加上长度给出的，以便能够处理二进制数据或任意长度的数据。</font><font style="vertical-align: inherit;">字符串内容可用，
                   </font></font><code class="literal">args-&gt;args[i]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">字符串长度为</font></font><code class="literal">args-&gt;lengths[i]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">不要认为该字符串是以null结尾的。
                </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                  对于一个类型的参数</font></font><code class="literal">INT_RESULT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，你必须转换</font></font><code class="literal">args-&gt;args[i]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为一个
                   </font></font><code class="literal">long long</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值：
                </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">long long int_val;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
int_val = *（（long long *）args-&gt; args [i]）;</font></font><font></font>
</pre></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                  对于一个类型的参数
                   </font></font><code class="literal">REAL_RESULT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，你必须转换
                   </font></font><code class="literal">args-&gt;args[i]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为一个
                   </font></font><code class="literal">double</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值：
                </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">双real_val;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
real_val = *（（double *）args-&gt; args [i]）;</font></font><font></font>
</pre></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                  对于一个类型的参数
                   </font></font><code class="literal">DECIMAL_RESULT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，该值作为一个字符串传递，应该像一个</font></font><code class="literal">STRING_RESULT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值</font><font style="vertical-align: inherit;">一样处理
                   </font><font style="vertical-align: inherit;">。
                </font></font></p></li><li class="listitem"><p>
                  <code class="literal">ROW_RESULT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 参数没有实现。
</font></font></p></li></ul>
</div>
</li><li class="listitem"><p>
              <code class="literal">unsigned long *lengths</code>
            </p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              对于初始化函数，
               </font></font><code class="literal">lengths</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数组指示每个参数的最大字符串长度。</font><font style="vertical-align: inherit;">你不应该改变这些。</font><font style="vertical-align: inherit;">对于主函数的每次调用，都
               </font></font><code class="literal">lengths</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">包含为当前正在处理的行传递的任何字符串参数的实际长度。</font><font style="vertical-align: inherit;">对于类型的参数
               </font></font><code class="literal">INT_RESULT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
               </font></font><code class="literal">REAL_RESULT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><code class="literal">lengths</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              仍包含该参数的最大长度（作为用于初始化功能）。
            </font></font></p></li><li class="listitem"><p>
              <code class="literal">char *maybe_null</code>
            </p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              对于初始化函数，
               </font></font><code class="literal">maybe_null</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数组为每个参数指示参数值是否为空（如果不是，则为0，如果是，则为1）。
            </font></font></p></li><li class="listitem"><p>
              <code class="literal">char **attributes</code>
            </p><p>
              <code class="literal">args-&gt;attributes</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">传达有关UDF参数名称的信息。</font><font style="vertical-align: inherit;">对于参数</font></font><code class="literal">i</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，属性名称可用作字符串，
               </font></font><code class="literal">args-&gt;attributes[i]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">属性长度为
               </font></font><code class="literal">args-&gt;attribute_lengths[i]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">不要认为该字符串是以null结尾的。
            </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              默认情况下，UDF参数的名称是用于指定参数的表达式的文本。</font><font style="vertical-align: inherit;">对于UDF，参数也可以有一个可选的</font><font style="vertical-align: inherit;">子句，在这种情况下参数名称是
               </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">因此</font><font style="vertical-align: inherit;">，每个参数</font><font style="vertical-align: inherit;">的
               </font><font style="vertical-align: inherit;">值取决于是否给出别名。
            </font></font><code class="literal">[AS]
              <em class="replaceable"><code>alias_name</code></em></code><font style="vertical-align: inherit;"></font><em class="replaceable"><code>alias_name</code></em><font style="vertical-align: inherit;"></font><code class="literal">attributes</code><font style="vertical-align: inherit;"></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              假设</font></font><code class="literal">my_udf()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如下调用</font><font style="vertical-align: inherit;">UDF </font><font style="vertical-align: inherit;">：
            </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SELECT my_udf（expr1，expr2 AS alias1，expr3 alias2）;
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              在这种情况下，</font></font><code class="literal">attributes</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
               </font></font><code class="literal">attribute_lengths</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">阵列将是这些值：
            </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">args-&gt; attributes [0] =“expr1”</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
args-&gt; attribute_lengths [0] = 5</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
args-&gt; attributes [1] =“alias1”</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
args-&gt; attribute_lengths [1] = 6</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
args-&gt; attributes [2] =“alias2”</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
args-&gt; attribute_lengths [2] = 6</font></font><font></font>
</pre></li><li class="listitem"><p>
              <code class="literal">unsigned long *attribute_lengths</code>
            </p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              该</font></font><code class="literal">attribute_lengths</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数组指示每个参数名称的长度。
</font></font></p></li></ul>
</div>

</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h4 class="title"><a name="udf-return-values"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.4.2.4 UDF返回值和错误处理</font></font></h4>

</div>

</div>

</div>
<a class="indexterm" name="idm140527954149104"></a><a class="indexterm" name="idm140527954147648"></a><a class="indexterm" name="idm140527954146160"></a><a class="indexterm" name="idm140527954144672"></a><p><font style="vertical-align: inherit;"></font><code class="literal">0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          如果没有发生错误，</font></font><code class="literal">1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">则</font><font style="vertical-align: inherit;">
          返回初始化函数</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">如果发生错误，</font></font><code class="literal">xxx_init()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">应该在</font></font><code class="literal">message</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参数中</font><font style="vertical-align: inherit;">存储以null结尾的错误消息
           </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">该消息被返回给客户端。</font><font style="vertical-align: inherit;">消息缓冲区是
           </font></font><code class="literal">MYSQL_ERRMSG_SIZE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">字符长，但您应该尽量保持消息少于80个字符，以便它符合标准终端屏幕的宽度。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          主函数的返回值</font></font><code class="literal">xxx()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          是函数值，</font><font style="vertical-align: inherit;">函数</font></font><code class="literal">long long</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
           </font></font><code class="literal">double</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数。</font><font style="vertical-align: inherit;">一个字符串函数应该返回一个指向结果的指针，并设置
           </font></font><code class="literal">*length</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">返回值的长度（以字节为单位）。</font><font style="vertical-align: inherit;">例如：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memcpy（result，“result string”，13）;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
*长度= 13;</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          MySQL </font></font><code class="literal">xxx()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用</font></font><code class="literal">result</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参数</font><font style="vertical-align: inherit;">将缓冲区传递给</font><font style="vertical-align: inherit;">函数</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">该缓冲区足够长以容纳255个字符，可以是多字节字符。</font><font style="vertical-align: inherit;">该</font></font><code class="literal">xxx()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数可以将结果存储在此缓冲区中（如果它适合），在这种情况下，返回值应该是指向缓冲区的指针。</font><font style="vertical-align: inherit;">如果函数将结果存储在不同的缓冲区中，则应该返回指向该缓冲区的指针。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          如果你的字符串函数没有使用提供的缓冲区（例如，如果它需要返回一个长度超过255个字符的字符串），你必须</font></font><code class="literal">malloc()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在你的
           </font></font><code class="literal">xxx_init()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数或
           </font></font><code class="literal">xxx()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数中</font><font style="vertical-align: inherit;">为你自己的缓冲区分配空间，</font><font style="vertical-align: inherit;">并将它释放到
           </font></font><code class="literal">xxx_deinit()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数中。</font><font style="vertical-align: inherit;">您可以将分配的内存存储在</font><font style="vertical-align: inherit;">结构</font><font style="vertical-align: inherit;">中的</font></font><code class="literal">ptr</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">插槽中，
           </font></font><code class="literal">UDF_INIT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">供将来的</font></font><code class="literal">xxx()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">呼叫</font><font style="vertical-align: inherit;">重复使用
           </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#udf-calling" title="28.4.2.1简单函数的UDF调用序列"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.4.2.1节“简单函数的UDF调用序列”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          要指示</font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">主函数</font><font style="vertical-align: inherit;">的返回值</font><font style="vertical-align: inherit;">，请设置</font></font><code class="literal">*is_null</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为
           </font></font><code class="literal">1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* is_null = 1;
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          要在主功能中指示错误返回，请设置
           </font></font><code class="literal">*error</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为</font></font><code class="literal">1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">*错误= 1;
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          如果</font></font><code class="literal">xxx()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">套</font></font><code class="literal">*error</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">到
           </font></font><code class="literal">1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">任何行，函数值是
           </font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">当前行，并通过在该语句处理任何后续行
           </font></font><code class="literal">XXX()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">被调用。</font><font style="vertical-align: inherit;">（</font></font><code class="literal">xxx()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">甚至不需要后续行）。
</font></font></p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h4 class="title"><a name="udf-compiling"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.4.2.5 UDF编译和安装</font></font></h4>

</div>

</div>

</div>
<a class="indexterm" name="idm140527954113248"></a><a class="indexterm" name="idm140527954111792"></a><a class="indexterm" name="idm140527954110304"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          实现UDF的文件必须编译并安装在运行服务器的主机上。</font><font style="vertical-align: inherit;">下面介绍</font></font><code class="filename">sql/udf_example.cc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">了MySQL源代码分发包含</font><font style="vertical-align: inherit;">的示例UDF文件
           </font><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          如果将在复制到从服务器的语句中引用UDF，则必须确保每个从服务器都具有可用的功能。</font><font style="vertical-align: inherit;">否则，当它们试图调用该函数时，复制将在从站上失败。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          紧随其后的说明适用于Unix。</font><font style="vertical-align: inherit;">Windows的说明在本节后面给出。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          该</font></font><code class="filename">udf_example.cc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文件包含以下功能：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              <code class="literal">metaphon()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">返回字符串参数的一个元字符串。</font><font style="vertical-align: inherit;">这就像一个soundex字符串，但它更适合英语。
            </font></font></p></li><li class="listitem"><p>
              <code class="literal">myfunc_double()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 返回参数中字符的ASCII值的总和除以参数长度的总和。
            </font></font></p></li><li class="listitem"><p>
              <code class="literal">myfunc_int()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 返回其参数长度的总和。
            </font></font></p></li><li class="listitem"><p>
              <code class="literal">sequence([const int])</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 返回从给定数字开始的序列，如果没有给出数字，则返回1。
            </font></font></p></li><li class="listitem"><p>
              <code class="literal">lookup()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 返回主机名的IP地址。
            </font></font></p></li><li class="listitem"><p>
              <code class="literal">reverse_lookup()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">返回IP地址的主机名。</font><font style="vertical-align: inherit;">该函数可以通过表单的单个字符串参数</font></font><code class="literal">'xxx.xxx.xxx.xxx'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或四个数字</font><font style="vertical-align: inherit;">来调用
               </font><font style="vertical-align: inherit;">。
            </font></font></p></li><li class="listitem"><p>
              <code class="literal">avgcost()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">返回平均成本。</font><font style="vertical-align: inherit;">这是一个聚合函数。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          一个动态加载的文件应该被编译为一个可共享的库文件，使用如下命令：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">外壳&gt; </font></font><strong class="userinput"><code>gcc -shared -o udf_example.so udf_example.cc</code></strong>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          如果你正在使用</font></font><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GCC</font></font></strong></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">与
           </font></font><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CMake的</font></font></strong></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（这是MySQL是如何配置的），你应该能够创建
           </font></font><code class="filename">udf_example.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一个简单的命令：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">外壳&gt; </font></font><strong class="userinput"><code>make udf_example</code></strong>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          编译包含UDF的共享对象后，您必须安装并告诉MySQL。</font><font style="vertical-align: inherit;">直接</font></font><code class="filename">udf_example.cc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用
           </font></font><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gcc</font></font></strong></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">编译共享对象</font><font style="vertical-align: inherit;">会生成一个名为的文件
           </font></font><code class="filename">udf_example.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">将共享对象复制到服务器的插件目录并命名
           </font></font><code class="filename">udf_example.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">该目录由</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_plugin_dir"><code class="literal">plugin_dir</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统变量</font><font style="vertical-align: inherit;">的值给出
           </font><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          在某些系统上，</font><font style="vertical-align: inherit;">配置动态链接程序</font><font style="vertical-align: inherit;">的</font></font><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ldconfig</font></font></strong></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">程序无法识别共享对象，除非其名称以开头</font></font><code class="literal">lib</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">在这种情况下，你应该在文件重命名，例如
           </font></font><code class="filename">udf_example.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">到
           </font></font><code class="filename">libudf_example.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          在Windows上，可以使用以下过程编译用户定义的函数：
</font></font></p>
<div class="orderedlist">
<ol class="orderedlist" type="1"><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              获取MySQL源代码分发。</font><font style="vertical-align: inherit;">请参见
               </font></font><a class="xref" href="/mysql-5.7-google-zh/installing.html#getting-mysql" title="2.1.2如何获取MySQL"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第2.1.2节“如何获取MySQL”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
            </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如有必要，从</font><a class="ulink" href="http://www.cmake.org/" target="_top"><font style="vertical-align: inherit;">http://www.cmake.org</font></a><font style="vertical-align: inherit;"> 
              获取</font></font><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CMake</font></font></strong></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">构建实用程序</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">（需要版本2.6或更高版本）。
            </font></font><a class="ulink" href="http://www.cmake.org/" target="_top"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              在源代码树中，查看</font></font><code class="filename">sql</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              目录。</font><font style="vertical-align: inherit;">有那里命名的文件
               </font></font><code class="filename">udf_example.def</code>
              <code class="filename">udf_example.cc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">将这两个文件从这个目录复制到你的工作目录。
            </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用这些内容</font><font style="vertical-align: inherit;">
              创建一个</font></font><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CMake</font></font></strong></span>
              <code class="filename">makefile</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
              （</font></font><code class="filename">CMakeLists.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）：
            </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PROJECT（udf_example）</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MySQL的路径包括目录</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
INCLUDE_DIRECTORIES（ “C：/ MySQL的/包括”）</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ADD_DEFINITIONS（ “ -  DHAVE_DLOPEN”）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ADD_LIBRARY（udf_example MODULE udf_example.cc udf_example.def）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
TARGET_LINK_LIBRARIES（udf_example wsock32）</font></font><font></font>
</pre></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              创建VC项目和解决方案文件：
            </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cmake -G“&lt;发生器&gt;”
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              调用</font></font><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cmake --help会</font></font></strong></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">显示一个有效的生成器列表。
            </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              创建</font></font><code class="filename">udf_example.dll</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：
            </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">devenv udf_example.sln / build版本
</font></font></pre></li></ol>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          共享库文件安装完成后，</font><font style="vertical-align: inherit;">使用以下语句</font><font style="vertical-align: inherit;">通知
           </font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">有关新函数。</font><font style="vertical-align: inherit;">如果库文件的后缀与</font></font><code class="filename">.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统中</font><font style="vertical-align: inherit;">的后缀不同</font><font style="vertical-align: inherit;">，则始终替换正确的后缀（例如，
           </font></font><code class="filename">.dll</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在Windows上）。
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql&gt; </font></font><strong class="userinput"><code>CREATE FUNCTION metaphon RETURNS STRING SONAME 'udf_example.so';</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql&gt; </font></font><strong class="userinput"><code>CREATE FUNCTION myfunc_double RETURNS REAL SONAME 'udf_example.so';</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql&gt; </font></font><strong class="userinput"><code>CREATE FUNCTION myfunc_int RETURNS INTEGER SONAME 'udf_example.so';</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql&gt; </font></font><strong class="userinput"><code>CREATE FUNCTION sequence RETURNS INTEGER SONAME 'udf_example.so';</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql&gt; </font></font><strong class="userinput"><code>CREATE FUNCTION lookup RETURNS STRING SONAME 'udf_example.so';</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql&gt; </font></font><strong class="userinput"><code>CREATE FUNCTION reverse_lookup</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    - &gt;         </font></font><strong class="userinput"><code>RETURNS STRING SONAME 'udf_example.so';</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql&gt; </font></font><strong class="userinput"><code>CREATE AGGREGATE FUNCTION avgcost</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    - &gt;        </font></font><strong class="userinput"><code>RETURNS REAL SONAME 'udf_example.so';</code></strong>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          安装完成后，功能将保持安装状态，直到它被卸载。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          要删除功能，请使用</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#drop-function" title="13.1.24 DROP FUNCTION语法"><code class="literal">DROP
          FUNCTION</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql&gt; </font></font><strong class="userinput"><code>DROP FUNCTION metaphon;</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql&gt; </font></font><strong class="userinput"><code>DROP FUNCTION myfunc_double;</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql&gt; </font></font><strong class="userinput"><code>DROP FUNCTION myfunc_int;</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql&gt; </font></font><strong class="userinput"><code>DROP FUNCTION sequence;</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql&gt; </font></font><strong class="userinput"><code>DROP FUNCTION lookup;</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql&gt; </font></font><strong class="userinput"><code>DROP FUNCTION reverse_lookup;</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql&gt;</font></font><strong class="userinput"><code>DROP FUNCTION avgcost;</code></strong>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          该</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#create-function" title="13.1.13 CREATE FUNCTION语法"><code class="literal">CREATE FUNCTION</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#drop-function" title="13.1.24 DROP FUNCTION语法"><code class="literal">DROP FUNCTION</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句更新</font></font><code class="literal">func</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统表
           </font></font><code class="literal">mysql</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数据库。</font><font style="vertical-align: inherit;">该函数的名称，类型和共享库名称保存在表中。</font><font style="vertical-align: inherit;">您必须具有</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_insert"><code class="literal">INSERT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
           </font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_delete"><code class="literal">DELETE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特权的
           </font></font><code class="literal">mysql</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数据库中分别创建或删除功能。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          您不应该使用</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#create-function" title="13.1.13 CREATE FUNCTION语法"><code class="literal">CREATE
          FUNCTION</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">添加先前创建的函数。</font><font style="vertical-align: inherit;">如果你需要重新安装一个功能，你应该删除它，</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#drop-function" title="13.1.24 DROP FUNCTION语法"><code class="literal">DROP FUNCTION</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          然后重新安装它</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#create-function" title="13.1.13 CREATE FUNCTION语法"><code class="literal">CREATE
          FUNCTION</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">例如，如果您重新编译函数的新版本，那么您需要执行此操作，以便
           </font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">获取新版本。</font><font style="vertical-align: inherit;">否则，服务器将继续使用旧版本。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          一个活动函数是一个已经加载</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#create-function" title="13.1.13 CREATE FUNCTION语法"><code class="literal">CREATE FUNCTION</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并且没有被删除的</font><font style="vertical-align: inherit;">函数
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#drop-function" title="13.1.24 DROP FUNCTION语法"><code class="literal">DROP FUNCTION</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">除非您</font><font style="vertical-align: inherit;">使用该
           </font><font style="vertical-align: inherit;">选项</font><font style="vertical-align: inherit;">启动</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，否则每次启动服务器时都会重新加载所有活动函数</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#option_mysqld_skip-grant-tables"><code class="option">--skip-grant-tables</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">在这种情况下，UDF初始化会被跳过并且UDF不可用。
</font></font></p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h4 class="title"><a name="udf-security"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.4.2.6 UDF安全注意事项</font></font></h4>

</div>

</div>

</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          MySQL采取了多种措施来防止误用用户定义的函数。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          UDF库文件不能放置在任意目录中。</font><font style="vertical-align: inherit;">它们必须位于服务器的插件目录中。</font><font style="vertical-align: inherit;">该目录由</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_plugin_dir"><code class="literal">plugin_dir</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统变量</font><font style="vertical-align: inherit;">的值给出
           </font><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          要使用</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#create-function" title="13.1.13 CREATE FUNCTION语法"><code class="literal">CREATE FUNCTION</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或者
           </font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#drop-function" title="13.1.24 DROP FUNCTION语法"><code class="literal">DROP FUNCTION</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，您必须拥有</font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_insert"><code class="literal">INSERT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
           </font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_delete"><code class="literal">DELETE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特权，分别为</font></font><code class="literal">mysql</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数据库。</font><font style="vertical-align: inherit;">这是必要的，因为这些语句添加和删除</font></font><code class="literal">mysql.func</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表中的</font><font style="vertical-align: inherit;">行
           </font><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          除了</font></font><code class="literal">xxx</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">与主</font></font><code class="literal">xxx()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数</font><font style="vertical-align: inherit;">对应</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">符号
           </font><font style="vertical-align: inherit;">之外，UDF还应至少定义一个符号</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这些辅助符号对应</font></font><code class="literal">xxx_init()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
           </font></font><code class="literal">xxx_deinit()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
           </font></font><code class="literal">xxx_reset()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
           </font></font><code class="literal">xxx_clear()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，和
           </font></font><code class="literal">xxx_add()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">功能。
          </font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">还支持一个
           </font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#option_mysqld_allow-suspicious-udfs"><code class="option">--allow-suspicious-udfs</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">选项，用于控制是否</font></font><code class="literal">xxx</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可以加载</font><font style="vertical-align: inherit;">只有</font><font style="vertical-align: inherit;">符号的</font><font style="vertical-align: inherit;">UDF
           </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">默认情况下，该选项处于关闭状态，以防止尝试从除包含合法UDF的共享库文件以外的共享库文件加载功能。</font><font style="vertical-align: inherit;">如果您的旧UDF只包含
          </font></font><code class="literal">xxx</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">符号，并且不能重新编译以包含辅助符号，则可能需要指定</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#option_mysqld_allow-suspicious-udfs"><code class="option">--allow-suspicious-udfs</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          选项。</font><font style="vertical-align: inherit;">否则，您应该避免启用此功能。
</font></font></p>
</div>

</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="adding-native-function"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.4.3添加一个新的本地函数</font></font></h3>

</div>

</div>

</div>
<a class="indexterm" name="idm140527954001520"></a><a class="indexterm" name="idm140527954000064"></a><a class="indexterm" name="idm140527953998576"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        要添加新的本机MySQL函数，请使用此处所述的过程，这需要您使用源分布。</font><font style="vertical-align: inherit;">您不能将本地函数添加到二进制分发版中，因为它需要修改MySQL源代码并从修改的源代码编译MySQL。</font><font style="vertical-align: inherit;">如果您迁移到其他版本的MySQL（例如，发布新版本时），则必须使用新版本重复该过程。
      </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        如果将在复制到从属服务器的语句中引用新的本地函数，则必须确保每个从属服务器都具有可用的功能。</font><font style="vertical-align: inherit;">否则，当它们尝试调用该函数时，复制将在从服务器上失败。
      </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        要添加新的本机功能，请按照以下步骤修改目录中的源文件</font></font><code class="filename">sql</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：
</font></font></p>
<div class="orderedlist">
<ol class="orderedlist" type="1"><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            在以下内容中为函数创建一个子类
             </font></font><code class="filename">item_create.cc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                如果函数采用的参数的固定数，创建的一个子类
                 </font></font><code class="literal">Create_func_arg0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
                 </font></font><code class="literal">Create_func_arg1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
                 </font></font><code class="literal">Create_func_arg2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，或
                 </font></font><code class="literal">Create_func_arg3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，分别取决于功能是否需要零个，一个，两个或三个参数。</font><font style="vertical-align: inherit;">举例来说，看到的
                 </font></font><code class="literal">Create_func_uuid</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
                 </font></font><code class="literal">Create_func_abs</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
                 </font></font><code class="literal">Create_func_pow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，和
                 </font></font><code class="literal">Create_func_lpad</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">类。
              </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                如果函数采用可变数量的参数，则创建一个子类
                 </font></font><code class="literal">Create_native_func</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">有关示例，请参阅</font></font><code class="literal">Create_func_concat</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p></li></ul>
</div>
</li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            要提供可以在SQL语句中引用函数的名称，请</font></font><code class="filename">item_create.cc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通过向此数组添加一行来</font><font style="vertical-align: inherit;">注册名称
             </font><font style="vertical-align: inherit;">：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">static Native_func_registry func_array []
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            您可以为同一功能注册多个名称。</font><font style="vertical-align: inherit;">例如，请参阅线</font></font><code class="literal">"LCASE"</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
             </font></font><code class="literal">"LOWER"</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，这是别名
             </font></font><code class="literal">Create_func_lcase</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            在</font></font><code class="filename">item_func.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">声明一个继承自</font></font><code class="literal">Item_num_func</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
             </font><font style="vertical-align: inherit;">的类</font></font><code class="literal">Item_str_func</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，这取决于你的函数是否返回一个数字或字符串。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            在中</font></font><code class="filename">item_func.cc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，添加以下声明之一，具体取决于您是定义数字还是字符串函数：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">double Item_func_newname :: val（）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
longlong Item_func_newname :: val_int（）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
字符串* Item_func_newname :: Str（String * str）</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            如果您从任何标准项目（如</font></font><code class="literal">Item_num_func</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">继承对象</font><font style="vertical-align: inherit;">，则可能只需定义其中一个函数，并让父对象处理其他函数。</font><font style="vertical-align: inherit;">例如，
             </font></font><code class="literal">Item_str_func</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">该类定义了一个</font></font><code class="literal">val()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数，</font><font style="vertical-align: inherit;">该
             </font><font style="vertical-align: inherit;">函数</font></font><code class="literal">atof()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在返回的值
             </font><font style="vertical-align: inherit;">上执行
             </font></font><code class="literal">::str()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            如果函数不确定，则在项目构造函数中包含以下语句以指示不应缓存函数结果：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">current_thd-&gt; lex-&gt; safe_to_cache_query = 0;
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            如果给定参数的固定值，它可以为不同的调用返回不同的结果，函数是非确定性的。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            你应该也可以定义下面的对象函数：
          </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">void Item_func_newname :: fix_length_and_dec（）
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            这个函数至少应该</font></font><code class="literal">max_length</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">根据给定的参数进行</font><font style="vertical-align: inherit;">计算
             </font><font style="vertical-align: inherit;">。
            </font></font><code class="literal">max_length</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是函数可能返回的最大字符数。</font><font style="vertical-align: inherit;">这个功能也应该设置</font></font><code class="literal">maybe_null = 0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果主函数不能返回</font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值，</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">该函数可以</font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通过检查参数的
             </font></font><code class="literal">maybe_null</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">变量</font><font style="vertical-align: inherit;">来检查是否有任何函数参数可以返回</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">看看
             </font></font><code class="literal">Item_func_mod::fix_length_and_dec</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如何做到这一点的典型例子。
</font></font></p></li></ol>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        所有功能必须是线程安全的。</font><font style="vertical-align: inherit;">换句话说，不要在函数中使用任何全局变量或静态变量，也不要使用互斥锁来保护它们。
      </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        如果你想返回 </font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的
         </font></font><code class="literal">::val()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><code class="literal">::val_int()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或者
         </font></font><code class="literal">::str()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，你应该设置
         </font></font><code class="literal">null_value</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为1，并返回0。
      </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        对于 </font></font><code class="literal">::str()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">对象函数，还需要注意以下其他注意事项：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            该 </font></font><code class="literal">String *str</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参数提供了一个可用于保存结果的字符串缓冲区。</font><font style="vertical-align: inherit;">（有关该</font></font><code class="literal">String</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">类型的</font><font style="vertical-align: inherit;">更多信息</font><font style="vertical-align: inherit;">，请查看该</font></font><code class="filename">sql_string.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文件。）
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            该 </font></font><code class="literal">::str()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数应返回保存结果的字符串，或者返回</font></font><code class="literal">(char*)
            0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结果</font></font><code class="literal">NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            除非绝对必要，所有当前字符串函数都尽量避免分配任何内存！
</font></font></p></li></ul>
</div>

</div>

</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h2 class="title" style="clear: both"><a name="porting"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.5调试和移植MySQL</font></font></h2>

</div>

</div>

</div>
<div class="toc">
<dl class="toc"><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#debugging-server"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.5.1调试MySQL服务器</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#debugging-client"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.5.2调试MySQL客户端</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#dbug-package"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.5.3 DBUG包</font></font></a></span></dt></dl>
</div>
<a class="indexterm" name="idm140527953942544"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      本节帮助您将MySQL移植到其他操作系统。</font><font style="vertical-align: inherit;">首先检查当前支持的操作系统列表。</font><font style="vertical-align: inherit;">请参阅
       </font></font><a class="ulink" href="http://www.mysql.com/support/supportedplatforms/database.html" target="_top"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http://www.mysql.com/support/supportedplatforms/database.html</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">如果您已经创建了一个新的MySQL端口，请告诉我们，以便我们可以在此处和我们的网站（</font></font><a class="ulink" href="http://www.mysql.com/" target="_top"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http://www.mysql.com/</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">上列出，并将其</font><font style="vertical-align: inherit;">推荐给其他用户。
</font></font></p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
注意
</font></font></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        如果你创建了一个新的MySQL端口，你可以自由地在GPL许可下复制和分发它，但它不会让你成为MySQL的版权所有者。
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      服务器需要一个工作的POSIX线程库。
    </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      要从源代码构建MySQL，您的系统必须满足</font></font><a class="xref" href="/mysql-5.7-google-zh/installing.html#source-installation" title="2.9从源代码安装MySQL"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第2.9节“从源代码安装MySQL”中</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">列出的工具要求</font><font style="vertical-align: inherit;">。
</font></font></p><a class="indexterm" name="idm140527953936640"></a><a class="indexterm" name="idm140527953935184"></a>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
重要
</font></font></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        如果您尝试</font><font style="vertical-align: inherit;">在IA64平台上</font><font style="vertical-align: inherit;">使用</font></font><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">icc</font></font></strong></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">创建MySQL 5.7
         </font><font style="vertical-align: inherit;">并需要支持NDB群集，则应首先确保您使用的是
         </font></font><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">icc</font></font></strong></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">版本9.1.043或更高版本。</font><font style="vertical-align: inherit;">（详情请参阅错误＃21875。）
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      如果遇到新端口的问题，您可能需要对MySQL进行一些调试！</font><font style="vertical-align: inherit;">请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#debugging-server" title="28.5.1调试MySQL服务器"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.5.1节“调试MySQL服务器”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
注意
</font></font></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        在开始调试</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">之前</font><font style="vertical-align: inherit;">，首先让测试程序</font></font><code class="literal">mysys/thr_lock</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">工作。</font><font style="vertical-align: inherit;">这可确保您的线程安装甚至有远程工作的机会！
</font></font></p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="debugging-server"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.5.1调试MySQL服务器</font></font></h3>

</div>

</div>

</div>
<div class="toc">
<dl class="toc"><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#compiling-for-debugging"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.5.1.1编译MySQL以进行调试</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#making-trace-files"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.5.1.2创建跟踪文件</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#making-windows-dumps"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.5.1.3使用WER和PDB创建Windows故障转储</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#using-gdb-on-mysqld"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.5.1.4在gdb下调试mysqld</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#using-stack-trace"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.5.1.5使用堆栈跟踪</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#using-log-files"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.5.1.6使用服务器日志查找mysqld中的错误原因</font></font></a></span></dt><dt><span class="section"><a href="/mysql-5.7-google-zh/extending-mysql.html#reproducible-test-case"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.5.1.7如果您遇到表损坏，则制作测试用例</font></font></a></span></dt></dl>
</div>
<a class="indexterm" name="idm140527953926000"></a><a class="indexterm" name="idm140527953924544"></a><a class="indexterm" name="idm140527953923056"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        如果您使用的一些功能是在MySQL很新，你可以尝试运行</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld的</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">与
         </font></font><code class="option">--skip-new</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（即禁用所有新的，潜在的不安全功能）。</font><font style="vertical-align: inherit;">参见</font></font><a class="xref" href="/mysql-5.7-google-zh/error-handling.html#crashing" title="B.5.3.3如果MySQL保持崩溃，该怎么办"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第B.5.3.3节“如果MySQL保持崩溃怎么办”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
      </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        如果</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不想启动，请确认您没有</font></font><code class="filename">my.cnf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文件干扰您的设置！</font><font style="vertical-align: inherit;">您可以</font></font><code class="filename">my.cnf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        使用</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld --print-defaults</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">检查您的</font><font style="vertical-align: inherit;">参数，</font><font style="vertical-align: inherit;">并避免以</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld --no-defaults ...</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">开头来使用它们</font><font style="vertical-align: inherit;">。
      </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        如果</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">开始消耗CPU或内存，或者如果它</font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">挂起</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，则可以使用</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqladmin" title="4.5.2 mysqladmin  - 用于管理MySQL服务器的客户端"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqladmin processlist状态</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">来确定是否有人正在执行需要很长时间的查询。</font><font style="vertical-align: inherit;">如果您遇到性能问题或新客户端无法连接时出现问题，在某个窗口中</font><font style="vertical-align: inherit;">运行</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqladmin" title="4.5.2 mysqladmin  - 用于管理MySQL服务器的客户端"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqladmin -i10 processlist状态</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可能是一个好主意
         </font><font style="vertical-align: inherit;">。
      </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        命令</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqladmin" title="4.5.2 mysqladmin  - 用于管理MySQL服务器的客户端"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqladmin debug</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">会将有关正在使用的锁的一些信息，使用的内存和查询用法转储到MySQL日志文件中。</font><font style="vertical-align: inherit;">这可能有助于解决一些问题。</font><font style="vertical-align: inherit;">即使您没有编译MySQL进行调试，该命令也提供了一些有用的信息！
      </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        如果问题在于某些表格变得越来越慢，则应尝试使用</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#optimize-table" title="13.7.2.4 OPTIMIZE TABLE语法"><code class="literal">OPTIMIZE TABLE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or
         </font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#myisamchk" title="4.6.3 myisamchk  -  MyISAM表维护实用程序"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">myisamchk</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">优化表格
         </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">请参阅
         </font></font><a class="xref" href="/mysql-5.7-google-zh/server-administration.html" title="第5章MySQL服务器管理"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第5章</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL服务器管理</font></font></i></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">你也应该用慢速查询来检查</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#explain" title="13.8.2 EXPLAIN语法"><code class="literal">EXPLAIN</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
      </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        您还应该阅读本手册中特定于操作系统的部分，了解可能对您的环境特有的问题。</font><font style="vertical-align: inherit;">请参见
         </font></font><a class="xref" href="/mysql-5.7-google-zh/installing.html#general-installation-issues" title="2.1一般安装指南"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第2.1节“常规安装指南”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p>
<div class="section">

<div class="titlepage">
<div>
<div>
<h4 class="title"><a name="compiling-for-debugging"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.5.1.1编译MySQL以进行调试</font></font></h4>
</div>
</div>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          如果你有一些非常具体的问题，你可以随时尝试调试MySQL。</font><font style="vertical-align: inherit;">为此，您必须使用该</font></font><a class="link" href="/mysql-5.7-google-zh/installing.html#option_cmake_with_debug"><code class="option">-DWITH_DEBUG=1</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">选项</font><font style="vertical-align: inherit;">配置MySQL
           </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">您可以通过执行</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld --help</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">来检查是否通过调试来编译MySQL
           </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">如果该
           </font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#option_mysqld_debug"><code class="option">--debug</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">标志与选项一起列出，那么您已启用调试。</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqladmin" title="4.5.2 mysqladmin  - 用于管理MySQL服务器的客户端"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqladmin ver</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">也列出</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">版本为</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysql" title="4.5.1 mysql  -  MySQL命令行工具"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql ... --debug</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在这种情况下。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          如果</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在使用</font></font><a class="link" href="/mysql-5.7-google-zh/installing.html#option_cmake_with_debug"><code class="option">-DWITH_DEBUG=1</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CMake选项进行</font><font style="vertical-align: inherit;">配置时停止崩溃</font><font style="vertical-align: inherit;">，则可能在MySQL中发现了编译器错误或计时错误。</font><font style="vertical-align: inherit;">在这种情况下，您可以尝试</font></font><code class="option">-g</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用
           </font></font><a class="link" href="/mysql-5.7-google-zh/installing.html#option_cmake_cmake_c_flags"><code class="option">CMAKE_C_FLAGS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><a class="link" href="/mysql-5.7-google-zh/installing.html#option_cmake_cmake_cxx_flags"><code class="option">CMAKE_CXX_FLAGS</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CMake选项</font><font style="vertical-align: inherit;">进行添加
           </font><font style="vertical-align: inherit;">，
           </font><font style="vertical-align: inherit;">而不是使用</font></font><a class="link" href="/mysql-5.7-google-zh/installing.html#option_cmake_with_debug"><code class="option">-DWITH_DEBUG=1</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">如果
           </font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld的</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">死了，你至少可以附加到它与</font></font><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GDB</font></font></strong></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或使用</font></font><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GDB</font></font></strong></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的核心文件，以找出发生了什么。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          当你配置MySQL进行调试时，你会自动启用许多额外的安全检查功能来监视</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的健康状况</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">如果他们发现某些
           </font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">意外事件</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，则会写入一个条目
           </font></font><code class="literal">stderr</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，其中
           </font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld-safe" title="4.3.2 mysqld_safe  -  MySQL服务器启动脚本"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld_safe</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指向错误日志！</font><font style="vertical-align: inherit;">这也意味着，如果您在使用MySQL时遇到一些意想不到的问题并且正在使用源代码分发，那么您应该做的第一件事就是配置MySQL进行调试！</font><font style="vertical-align: inherit;">（第二件事是将邮件发送到MySQL邮件列表并寻求帮助。请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/introduction.html#mailing-lists" title="1.6.2 MySQL邮件列表"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第1.6.2节“MySQL邮件列表”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">如果您认为您发现了错误，请使用
           </font></font><a class="xref" href="/mysql-5.7-google-zh/introduction.html#bug-reports" title="1.7如何报告错误或问题"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第1.7节“如何报告错误或问题”中的说明</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h4 class="title"><a name="making-trace-files"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.5.1.2创建跟踪文件</font></font></h4>

</div>

</div>

</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          如果</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">服务器没有启动或容易崩溃，您可以尝试创建一个跟踪文件来查找问题。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          为此，你必须有一个</font><font style="vertical-align: inherit;">已经用调试支持编译</font><font style="vertical-align: inherit;">的</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">你可以通过执行来检查</font></font><code class="literal">mysqld -V</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">如果版本号结尾</font></font><code class="literal">-debug</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，则编译时支持跟踪文件。</font><font style="vertical-align: inherit;">（在Windows上，调试服务器被命名为</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld-debug</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">而不是
           </font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。）
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在Unix或</font><font style="vertical-align: inherit;">Windows </font><font style="vertical-align: inherit;">上
           </font><font style="vertical-align: inherit;">使用跟踪登录</font><font style="vertical-align: inherit;">
          启动</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">服务器
           </font><font style="vertical-align: inherit;">：
        </font></font><code class="filename">/tmp/mysqld.trace</code><font style="vertical-align: inherit;"></font><code class="filename">\mysqld.trace</code><font style="vertical-align: inherit;"></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">外壳&gt; </font></font><strong class="userinput"><code>mysqld --debug</code></strong>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          在Windows上，您还应该使用
           </font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#option_mysqld_standalone"><code class="option">--standalone</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">标志来启动
           </font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">作为服务。</font><font style="vertical-align: inherit;">在控制台窗口中，使用以下命令：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C：\&gt; </font></font><strong class="userinput"><code>mysqld-debug --debug --standalone</code></strong>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          之后，您可以</font></font><code class="literal">mysql.exe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          在第二个控制台窗口中</font><font style="vertical-align: inherit;">使用</font><font style="vertical-align: inherit;">命令行工具来重现问题。</font><font style="vertical-align: inherit;">你可以</font><font style="vertical-align: inherit;">用</font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqladmin" title="4.5.2 mysqladmin  - 用于管理MySQL服务器的客户端"><span class="command"><strong><font style="vertical-align: inherit;">mysqladmin shutdown</font></strong></span></a><font style="vertical-align: inherit;">来停止</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">服务器</font><font style="vertical-align: inherit;">。
        </font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqladmin" title="4.5.2 mysqladmin  - 用于管理MySQL服务器的客户端"><span class="command"><strong><font style="vertical-align: inherit;"></font></strong></span></a><font style="vertical-align: inherit;"></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          跟踪文件可能会变得</font></font><span class="bold"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">非常大</font></font></strong></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">！</font><font style="vertical-align: inherit;">要生成较小的跟踪文件，可以使用如下所示的调试选项：
        </font></font></p><p>
          <a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld --debug = d，info，error，query，general，其中：O，/ tmp / mysqld.trace</font></font></strong></span></a>
        </p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          这只会将具有最感兴趣标签的信息打印到跟踪文件中。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          如果您提交了关于此问题的错误报告，请仅将跟踪文件中的行发送到相应的邮件列表，以防出现问题！</font><font style="vertical-align: inherit;">如果您找不到错误的地方，您可以打开一个错误报告并将跟踪文件上传到报告中，以便MySQL开发人员可以查看它。</font><font style="vertical-align: inherit;">有关说明，请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/introduction.html#bug-reports" title="1.7如何报告错误或问题"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第1.7节“如何报告错误或问题”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          跟踪文件</font><font style="vertical-align: inherit;">由Fred Fish </font><font style="vertical-align: inherit;">的
           </font></font><span class="bold"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DBUG</font></font></strong></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">包创建。</font><font style="vertical-align: inherit;">请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#dbug-package" title="28.5.3 DBUG包"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.5.3节“DBUG包”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h4 class="title"><a name="making-windows-dumps"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.5.1.3使用WER和PDB创建Windows故障转储</font></font></h4>

</div>

</div>

</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          程序数据库文件（带后缀</font></font><code class="filename">pdb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）包含在</font><font style="vertical-align: inherit;">MySQL </font><font style="vertical-align: inherit;">的</font></font><span class="bold"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZIP Archive调试二进制和测试套件</font></font></strong></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分发中。</font><font style="vertical-align: inherit;">这些文件提供了在发生问题时调试MySQL安装的信息。</font><font style="vertical-align: inherit;">这是从标准MSI或Zip文件单独下载的。
</font></font></p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
注意
</font></font></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            从MySQL 5.7.6开始，PDB文件在一个单独的标有“ZIP Archive Debug Binaries＆Test Suite”的文件中提供。
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          PDB文件包含有关更多详细信息
           </font></font><code class="literal">mysqld</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以及其他工具，可以创建更详细的跟踪和转储文件。</font><font style="vertical-align: inherit;">您可以将这些与</font></font><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WinDbg</font></font></strong></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或Visual Studio一起用于调试
           </font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
注意
</font></font></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在Microsoft Vista中删除了</font><font style="vertical-align: inherit;">
            较旧的</font></font><span class="emphasis"><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dr.Watson</font></font></em></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">调试工具，其中</font></font><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WinDbg</font></font></strong></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
            是一种常见的替代方法。
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          有关PDB文件的更多信息，请参阅
           </font></font><a class="ulink" href="http://support.microsoft.com/kb/121366/" target="_top"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Microsoft知识库文章121366</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">有关可用调试选项的更多信息，请参阅
           </font></font><a class="ulink" href="http://www.microsoft.com/whdc/devtools/debugging/default.mspx" target="_top"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows调试工具</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          要使用WinDbg，请安装完整的Windows驱动程序工具包（WDK）或安装独立版本。
</font></font></p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
重要
</font></font></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            在</font></font><code class="filename">.exe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><code class="filename">.pbd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            文件必须完全匹配（包括版本号和MySQL服务器版），或尝试加载符号的WinDBG会抱怨。
</font></font></p>
</div>
<div class="orderedlist">
<ol class="orderedlist" type="1"><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              要生成小型转储</font></font><code class="filename">mysqld.dmp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，请启用</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#option_mysqld_core-file"><code class="option">core-file</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[mysqld]部分中</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">选项</font></font><code class="filename">my.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">进行这些更改后重新启动MySQL服务器。
            </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              创建一个目录来存储生成的文件，例如
              </font></font><code class="filename">c:\symbols</code>
            </p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              使用Find GUI或从命令行</font><font style="vertical-align: inherit;">
              确定</font></font><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">windbg.exe</font></font></strong></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可执行文件</font><font style="vertical-align: inherit;">的路径</font><font style="vertical-align: inherit;">，例如：</font></font><code class="literal">dir /s /b windbg.exe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- 一个常见的默认值是</font></font><span class="emphasis"><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows的C：\ Program Files \ Debugging Tools（x64）\ windbg.exe</font></font></em></span>
            </p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              启动</font></font><code class="filename">windbg.exe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">给它的路径</font></font><code class="filename">mysqld-debug.exe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
               </font></font><code class="filename">mysqld.pdb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
               </font></font><code class="filename">mysqld.dmp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，和源代码。</font><font style="vertical-align: inherit;">或者，从WinDbg GUI传入每个路径。</font><font style="vertical-align: inherit;">例如：
            </font></font></p><pre class="programlisting"><strong class="userinput"><code><font></font>
windbg.exe -i "C:\mysql-5.7.23-winx64\bin\"^<font></font>
 -z "C:\mysql-5.7.23-winx64\data\mysqld.dmp"^<font></font>
 -srcpath "E:\ade\mysql_archives\5.7\5.7.23\mysql-5.7.23"^<font></font>
 -y "C:\mysql-5.7.23-winx64\bin;SRV*c:\symbols*http://msdl.microsoft.com/download/symbols"^<font></font>
 -v -n -c "!analyze -vvvvv"<font></font>
</code></strong>
</pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
注意
</font></font></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                该</font></font><code class="literal">^</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">字符和换行符由Windows命令行处理器断电，所以一定的空间保持不变。
</font></font></p>
</div>
</li></ol>
</div>

</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h4 class="title"><a name="using-gdb-on-mysqld"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.5.1.4在gdb下调试mysqld</font></font></h4>

</div>

</div>

</div>
<a class="indexterm" name="idm140527953817376"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          在大多数系统上，</font><font style="vertical-align: inherit;">如果</font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;">mysqld</font></strong></span></a><font style="vertical-align: inherit;">崩溃，</font><font style="vertical-align: inherit;">您还可以</font><font style="vertical-align: inherit;">
          从</font><span class="command"><strong><font style="vertical-align: inherit;">gdb</font></strong></span><font style="vertical-align: inherit;">启动</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以获取更多信息
           </font><font style="vertical-align: inherit;">。
        </font></font><span class="command"><strong><font style="vertical-align: inherit;"></font></strong></span><font style="vertical-align: inherit;"></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"></font></strong></span></a><font style="vertical-align: inherit;"></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果您想要调试</font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;">mysqld</font></strong></span></a><font style="vertical-align: inherit;">线程，</font><font style="vertical-align: inherit;">那么</font><font style="vertical-align: inherit;">在Linux上</font><font style="vertical-align: inherit;">
          使用一些较旧的</font></font><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gdb</font></font></strong></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">版本时必须使用</font></font><code class="literal">run --one-thread</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">它</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">在这种情况下，一次只能有一个线程处于活动状态。</font><font style="vertical-align: inherit;">最好升级到</font><span class="command"><strong><font style="vertical-align: inherit;">gdb</font></strong></span><font style="vertical-align: inherit;"> 5.1，因为线程调试在这个版本中效果更好！
        </font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"></font></strong></span></a><font style="vertical-align: inherit;"></font><span class="command"><strong><font style="vertical-align: inherit;"></font></strong></span><font style="vertical-align: inherit;"></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在</font><span class="command"><strong><font style="vertical-align: inherit;">gdb</font></strong></span><font style="vertical-align: inherit;">下</font><font style="vertical-align: inherit;">
          运行</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld时</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
           </font><font style="vertical-align: inherit;">NPTL线程（Linux上的新线程库）可能会导致问题</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">一些症状是：
</font></font><span class="command"><strong><font style="vertical-align: inherit;"></font></strong></span><font style="vertical-align: inherit;"></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              <a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在启动过程中挂起（写入之前</font></font><code class="literal">ready for connections</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。
            </font></font></p></li><li class="listitem"><p>
              <a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在</font></font><code class="literal">pthread_mutex_lock()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
              </font></font><code class="literal">pthread_mutex_unlock()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">呼叫</font><font style="vertical-align: inherit;">期间</font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"> mysqld</font></strong></span></a><font style="vertical-align: inherit;">崩溃
              </font><font style="vertical-align: inherit;">。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          在这种情况下，您应该在启动</font></font><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gdb</font></font></strong></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">之前在shell中设置以下环境变量</font><font style="vertical-align: inherit;">：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LD_ASSUME_KERNEL = 2.4.1</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
导出LD_ASSUME_KERNEL</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在</font><span class="command"><strong><font style="vertical-align: inherit;">gdb</font></strong></span><font style="vertical-align: inherit;">下
           </font><font style="vertical-align: inherit;">
          运行</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld时</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，应该禁用堆栈跟踪，</font><font style="vertical-align: inherit;">以便能够捕获</font><span class="command"><strong><font style="vertical-align: inherit;">gdb中的段错误</font></strong></span><font style="vertical-align: inherit;">。
        </font></font><span class="command"><strong><font style="vertical-align: inherit;"></font></strong></span><font style="vertical-align: inherit;"></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#option_mysqld_skip-stack-trace"><code class="option">--skip-stack-trace</code></a><font style="vertical-align: inherit;"></font><span class="command"><strong><font style="vertical-align: inherit;"></font></strong></span><font style="vertical-align: inherit;"></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          使用</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#option_mysqld_gdb"><code class="option">--gdb</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">选项
           </font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld的</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">安装了中断处理程序
           </font></font><code class="literal">SIGINT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（停止所需
           </font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">与</font></font><code class="literal">^C</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">设置断点），并且禁止堆栈跟踪和核心文件处理。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          在</font></font><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gdb</font></font></strong></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">下调试MySQL是非常困难的，</font><font style="vertical-align: inherit;">如果你一直做很多新的连接，因为
           </font></font><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gdb</font></font></strong></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">没有为旧线程释放内存。</font><font style="vertical-align: inherit;">您可以通过启动</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并将其
           </font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_thread_cache_size"><code class="literal">thread_cache_size</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">设置为等于</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_max_connections"><code class="literal">max_connections</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">+ 1 </font><font style="vertical-align: inherit;">的值
           </font><font style="vertical-align: inherit;">来避免此问题
           </font><font style="vertical-align: inherit;">。在大多数情况下，只是使用
           </font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_thread_cache_size"><code class="option">--thread_cache_size=5'</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">帮助很大！
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          如果你想在Linux上获得核心转储，如果
           </font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以SIGSEGV信号死亡，你可以</font><font style="vertical-align: inherit;">使用该
           </font><font style="vertical-align: inherit;">选项</font><font style="vertical-align: inherit;">启动</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#option_mysqld_core-file"><code class="option">--core-file</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这个核心文件可以用来做一个回溯，可以帮助你找出为什么</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">死了：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">外壳&gt; </font></font><strong class="userinput"><code>gdb mysqld core</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
gdb&gt; backtrace已满</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
gdb&gt;退出</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          参见</font></font><a class="xref" href="/mysql-5.7-google-zh/error-handling.html#crashing" title="B.5.3.3如果MySQL保持崩溃，该怎么办"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第B.5.3.3节“如果MySQL保持崩溃怎么办”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          如果您</font><font style="vertical-align: inherit;">在Linux </font><font style="vertical-align: inherit;">上使用</font></font><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gdb</font></font></strong></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 4.17.x或更高版本，则应该</font></font><code class="filename">.gdb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在当前目录中</font><font style="vertical-align: inherit;">安装一个</font><font style="vertical-align: inherit;">包含以下信息的文件：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">设置打印七位关闭</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
处理SIGUSR1 nostop noprint</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
处理SIGUSR2 nostop noprint</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
处理SIGWAITING nostop noprint</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
处理SIGLWP nostop noprint</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
处理SIGPIPE nostop</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
处理SIGALRM nostop</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
处理SIGHUP nostop</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
处理SIGTERM nostop noprint</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          如果你在用</font></font><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gdb</font></font></strong></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">调试线程时遇到问题
           </font><font style="vertical-align: inherit;">，你应该下载gdb 5.x，然后试试这个。</font><font style="vertical-align: inherit;">新的</font></font><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gdb</font></font></strong></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">版本具有非常好的线程处理能力！
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          这里是一个如何调试</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的例子</font><font style="vertical-align: inherit;">：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">外壳&gt; </font></font><strong class="userinput"><code>gdb /usr/local/libexec/mysqld</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
gdb&gt;运行</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
backtrace full＃当mysqld崩溃时执行此操作</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          将上述输出包含在一个错误报告中，您可以使用</font></font><a class="xref" href="/mysql-5.7-google-zh/introduction.html#bug-reports" title="1.7如何报告错误或问题"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第1.7节“如何报告错误或问题”中</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的说明</font><a class="xref" href="/mysql-5.7-google-zh/introduction.html#bug-reports" title="1.7如何报告错误或问题"><font style="vertical-align: inherit;">进行提交</font></a><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          如果</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">挂起，你可以尝试使用一些系统工具，</font></font><code class="literal">strace</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或者
           </font></font><code class="literal">/usr/proc/bin/pstack</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">检查
           </font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">挂起的位置。
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">strace / tmp / log libexec / mysqld
</font></font></pre><a class="indexterm" name="idm140527953759088"></a><a class="indexterm" name="idm140527953758016"></a><a class="indexterm" name="idm140527953756944"></a><a class="indexterm" name="idm140527953755856"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          如果您使用的是Perl </font></font><code class="literal">DBI</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">接口，则可以使用该</font></font><code class="literal">trace</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方法或通过设置
           </font></font><code class="literal">DBI_TRACE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">环境变量</font><font style="vertical-align: inherit;">来打开调试信息
           </font><font style="vertical-align: inherit;">。
</font></font></p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h4 class="title"><a name="using-stack-trace"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.5.1.5使用堆栈跟踪</font></font></h4>

</div>

</div>

</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          在某些操作系统上，如果</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">意外死亡</font><font style="vertical-align: inherit;">，错误日志将包含堆栈跟踪</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">你可以用它来找出</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在哪里（以及为什么）
           </font><font style="vertical-align: inherit;">死亡。</font><font style="vertical-align: inherit;">请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/server-administration.html#error-log" title="5.4.2错误日志"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第5.4.2节“错误日志”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">要获得堆栈跟踪，您不能</font><font style="vertical-align: inherit;">使用
           </font><font style="vertical-align: inherit;">gcc选项</font><font style="vertical-align: inherit;">编译</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"></font><code class="option">-fomit-frame-pointer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#compiling-for-debugging" title="28.5.1.1编译MySQL以进行调试"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.5.1.1节“编译MySQL以进行调试”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          错误日志中的堆栈跟踪如下所示：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld得到信号11;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
试图回溯。</font><font style="vertical-align: inherit;">您可以使用以下信息</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
找出mysqld在哪里死亡。</font><font style="vertical-align: inherit;">如果你以后看不到消息</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这是一件非常糟糕的事情</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
stack_bottom = 0x41fd0110 thread_stack 0x40000</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
的mysqld（my_print_stacktrace + 0x32）[0x9da402]</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
的mysqld（handle_segfault + 0x28a）[0x6648e9]</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
/lib/libpthread.so.0[0x7f1a5af000f0]</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
/lib/libc.so.6(strcmp+0x2)[0x7f1a5a10f0f2]</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
的mysqld（_Z21check_change_passwordP3THDPKcS2_Pcj + 0x7c）[0x7412cb]</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
的mysqld（_ZN16set_var_password5checkEP3THD + 0xd0）[0x688354]</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
的mysqld（_Z17sql_set_variablesP3THDP4ListI12set_var_baseE + 0x68）中[0x688494]</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
的mysqld（_Z21mysql_execute_commandP3THD + 0x41a0）[0x67a170]</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
的mysqld（_Z11mysql_parseP3THDPKcjPS2_ + 0x282）[0x67f0ad]</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
的mysqld（_Z16dispatch_command19enum_server_commandP3THDPcj + 0xbb7 [0x67fdf8]</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
的mysqld（_Z10do_commandP3THD + 0x24d）[0x6811b6]</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
的mysqld（handle_one_connection + 0x11c）[0x66e05e]</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          如果跟踪的函数名称解析失败，则跟踪包含的信息较少：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld得到信号11;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
试图回溯。</font><font style="vertical-align: inherit;">您可以使用以下信息</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
找出mysqld在哪里死亡。</font><font style="vertical-align: inherit;">如果你以后看不到消息</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这是一件非常糟糕的事情</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
stack_bottom = 0x41fd0110 thread_stack 0x40000</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[0x9da402]</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[0x6648e9]</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[0x7f1a5af000f0]</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[0x7f1a5a10f0f2]</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[0x7412cb]</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[0x688354]</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[0x688494]</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[0x67a170]</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[0x67f0ad]</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[0x67fdf8]</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[0x6811b6]</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[0x66e05e]</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          在后一种情况下，可以使用
           </font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#resolve-stack-dump" title="4.7.3 resolve_stack_dump  - 将数值堆栈跟踪转储解析为符号"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">resolve_stack_dump</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">实用程序</font><font style="vertical-align: inherit;">通过使用以下过程</font><font style="vertical-align: inherit;">来确定</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">何处</font><font style="vertical-align: inherit;">死亡：
</font></font></p>
<div class="orderedlist">
<ol class="orderedlist" type="1"><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              例如，将堆栈跟踪中的数字复制到文件中</font></font><code class="filename">mysqld.stack</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">数字不应包括周围的方括号：
            </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x9da402</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0x6648e9</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0x7f1a5af000f0</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0x7f1a5a10f0f2</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0x7412cb</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0x688354</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0x688494</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0x67a170</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0x67f0ad</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0x67fdf8</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0x6811b6</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0x66e05e</font></font><font></font>
</pre></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              为</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
              服务器创建</font><font style="vertical-align: inherit;">一个符号文件</font><font style="vertical-align: inherit;">：
            </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">外壳&gt; </font></font><strong class="userinput"><code>nm -n libexec/mysqld &gt; /tmp/mysqld.sym</code></strong>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              如果</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">没有静态链接，请改用以下命令：
            </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">外壳&gt; </font></font><strong class="userinput"><code>nm -D -n libexec/mysqld &gt; /tmp/mysqld.sym</code></strong>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              如果要解码C ++符号，请使用
               </font><span class="command"><strong><font style="vertical-align: inherit;">nm</font></strong></span></font><code class="option">--demangle</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（如果可用）
               </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">如果你的</font><span class="command"><strong><font style="vertical-align: inherit;">nm</font></strong></span><font style="vertical-align: inherit;">版本
               </font><font style="vertical-align: inherit;">没有这个选项，你将需要</font><font style="vertical-align: inherit;">在生成堆栈转储之后</font><font style="vertical-align: inherit;">使用</font><span class="command"><strong><font style="vertical-align: inherit;">c ++ filt</font></strong></span><font style="vertical-align: inherit;">命令来对C ++名称进行解压缩。
            </font></font><span class="command"><strong><font style="vertical-align: inherit;"></font></strong></span><font style="vertical-align: inherit;"></font><span class="command"><strong><font style="vertical-align: inherit;"></font></strong></span><font style="vertical-align: inherit;"></font><span class="command"><strong><font style="vertical-align: inherit;"></font></strong></span><font style="vertical-align: inherit;"></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              执行以下命令：
            </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">外壳&gt; </font></font><strong class="userinput"><code>resolve_stack_dump -s /tmp/mysqld.sym -n mysqld.stack</code></strong>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              如果您无法在符号文件中包含demangled C ++名称，请</font><font style="vertical-align: inherit;">使用</font><span class="command"><strong><font style="vertical-align: inherit;">c ++ filt</font></strong></span><font style="vertical-align: inherit;">处理
               </font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#resolve-stack-dump" title="4.7.3 resolve_stack_dump  - 将数值堆栈跟踪转储解析为符号"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">resolve_stack_dump</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">输出
               </font><font style="vertical-align: inherit;">：
            </font></font><span class="command"><strong><font style="vertical-align: inherit;"></font></strong></span><font style="vertical-align: inherit;"></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">外壳&gt; </font></font><strong class="userinput"><code>resolve_stack_dump -s /tmp/mysqld.sym -n mysqld.stack | c++filt</code></strong>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              这会打印出</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">死亡的地方。</font><font style="vertical-align: inherit;">如果这不能帮助你找出</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为什么会
               </font><font style="vertical-align: inherit;">死掉，你应该创建一个错误报告，并在错误报告中包含上述命令的输出。
            </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              但是，在大多数情况下，它不能帮助我们找到堆栈跟踪来找出问题的原因。</font><font style="vertical-align: inherit;">为了能够找到bug或提供解决方法，在大多数情况下，我们需要知道杀死</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的语句，
               </font><font style="vertical-align: inherit;">最好是测试用例，以便我们可以重复这个问题！</font><font style="vertical-align: inherit;">请参见
               </font></font><a class="xref" href="/mysql-5.7-google-zh/introduction.html#bug-reports" title="1.7如何报告错误或问题"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第1.7节“如何报告错误或问题”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p></li></ol>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          较新版本的</font></font><code class="literal">glibc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">堆栈跟踪函数还会打印相对于对象的地址。</font><font style="vertical-align: inherit;">在
           </font></font><code class="literal">glibc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">基于系统的系统（Linux）中，插件内的崩溃跟踪如下所示：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">插件/ AUTH / auth_test_plugin.so（+ 0x9a6）[0x7ff4d11c29a6]
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          要将相对地址（</font></font><code class="literal">+0x9a6</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）转换为文件名和行号，请​​使用以下命令：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">外壳&gt; </font></font><strong class="userinput"><code>addr2line -fie auth_test_plugin.so 0x9a6</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
auth_test_plugin</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MySQL的干线/插件/ AUTH / test_plugin.c：65</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          该</font></font><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">addr2line</font></font></strong></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">实用程序是部分
           </font></font><code class="literal">binutils</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">包在Linux上。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          在Solaris上，该过程类似。</font><font style="vertical-align: inherit;">Solaris
           </font></font><code class="literal">printstack()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已经打印相对地址：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">插件/认证/ auth_test_plugin.so：0x1510
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          要翻译，请使用以下命令：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">外壳&gt; </font></font><strong class="userinput"><code>gaddr2line -fie auth_test_plugin.so 0x1510</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MySQL的干线/插件/ AUTH / test_plugin.c：88</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          Windows已经打印地址，函数名称和行：
        </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">000007FEF07E10A4 auth_test_plugin.dll！auth_test_plugin（）[test_plugin.c：72]
</font></font></pre>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h4 class="title"><a name="using-log-files"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.5.1.6使用服务器日志查找mysqld中的错误原因</font></font></h4>

</div>

</div>

</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          请注意，在</font><font style="vertical-align: inherit;">启用一般查询日志</font><font style="vertical-align: inherit;">启动</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">之前</font><font style="vertical-align: inherit;">，您应该使用</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#myisamchk" title="4.6.3 myisamchk  -  MyISAM表维护实用程序"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">myisamchk</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">检查所有表</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">请参阅
           </font></font><a class="xref" href="/mysql-5.7-google-zh/server-administration.html" title="第5章MySQL服务器管理"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第5章</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL服务器管理</font></font></i></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          如果</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">死亡或挂起，则应启用
           </font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并启用常规查询日志。</font><font style="vertical-align: inherit;">请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/server-administration.html#query-log" title="5.4.3一般查询日志"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第5.4.3节“常规查询日志”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">当
           </font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">再次死亡时，您可以检查杀死</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的查询的日志文件的末尾
           </font><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          如果使用默认的通用查询日志文件，则日志将存储在数据库目录中，因为
           </font></font><code class="filename"><em class="replaceable"><code>host_name</code></em>.log</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          在大多数情况下，它是日志文件中最后一个查询，它会杀死
           </font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，但如果可能的话，您应该通过重新启动</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并执行查找到的查询来自</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysql" title="4.5.1 mysql  -  MySQL命令行工具"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">命令行工具。</font><font style="vertical-align: inherit;">如果这样做，您还应该测试所有未完成的复杂查询。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          您也可以尝试</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#explain" title="13.8.2 EXPLAIN语法"><code class="literal">EXPLAIN</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">所有</font></font><a class="link" href="/mysql-5.7-google-zh/sql-syntax.html#select" title="13.2.9 SELECT语法"><code class="literal">SELECT</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">需要很长时间才能确保</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">正确使用索引的</font><font style="vertical-align: inherit;">所有
           </font><font style="vertical-align: inherit;">语句</font><font style="vertical-align: inherit;">的命令
           </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/sql-syntax.html#explain" title="13.8.2 EXPLAIN语法"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第13.8.2节“EXPLAIN语法”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          您可以通过</font><font style="vertical-align: inherit;">在启用慢查询日志的情况</font><font style="vertical-align: inherit;">下启动</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">来查找需要很长时间才能执行的</font><font style="vertical-align: inherit;">查询。</font><font style="vertical-align: inherit;">请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/server-administration.html#slow-query-log" title="5.4.5慢查询日志"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第5.4.5节“慢速查询日志”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          如果您</font></font><code class="literal">mysqld restarted</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在错误日志中</font><font style="vertical-align: inherit;">找到文本</font><font style="vertical-align: inherit;">（通常是一个名为文件
           </font></font><code class="filename"><em class="replaceable"><code>host_name</code></em>.err</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">），您可能找到了导致</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">失败</font><font style="vertical-align: inherit;">的查询
           </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">如果发生这种情况，您应该使用</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#myisamchk" title="4.6.3 myisamchk  -  MyISAM表维护实用程序"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">myisamchk</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">检查所有表</font><font style="vertical-align: inherit;">（请参阅
           </font></font><a class="xref" href="/mysql-5.7-google-zh/server-administration.html" title="第5章MySQL服务器管理"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第5章</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL服务器管理</font></font></i></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">），然后测试MySQL日志文件中的查询以查看是否失败。</font><font style="vertical-align: inherit;">如果您发现这样的查询，请先尝试升级到最新的MySQL版本。</font><font style="vertical-align: inherit;">如果这没有帮助，并且您在</font></font><code class="literal">mysql</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">邮件存档中</font><font style="vertical-align: inherit;">找不到任何内容，则
           </font><font style="vertical-align: inherit;">应该将错误报告给MySQL邮件列表。</font><font style="vertical-align: inherit;">邮件列表在</font><a class="ulink" href="http://lists.mysql.com/" target="_top"><font style="vertical-align: inherit;">http://lists.mysql.com/上</font></a><font style="vertical-align: inherit;">有描述。</font></font><a class="ulink" href="http://lists.mysql.com/" target="_top"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，它也有链接到在线列表档案。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          如果你已经开始</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用
           </font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#option_mysqld_myisam-recover-options"><code class="option">--myisam-recover-options</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">中，MySQL自动检查并尝试修复
           </font></font><code class="literal">MyISAM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表，如果他们被标记为“未正常关闭”或“崩溃”。</font><font style="vertical-align: inherit;">如果发生这种情况，MySQL会在该</font></font><code class="literal">hostname.err</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文件中
           </font><font style="vertical-align: inherit;">写入一个条目，</font><font style="vertical-align: inherit;">如果该表需要修复</font></font><code class="literal">'Warning: Checking table ...'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><code class="literal">Warning: Repairing table</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">那么该</font><font style="vertical-align: inherit;">条目</font><font style="vertical-align: inherit;">后跟一个</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">如果你得到了很多这些错误，而没有</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在以前意外死亡，那么有些错误，需要进一步调查。</font><font style="vertical-align: inherit;">请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/server-administration.html#server-options" title="5.1.4服务器命令选项"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第5.1.4节“服务器命令选项”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          当服务器检测到</font></font><code class="literal">MyISAM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表损坏时，它会向错误日志中写入其他信息，例如源文件的名称和行号以及访问该表的线程列表。</font><font style="vertical-align: inherit;">例如：</font></font><code class="literal">Got an
          error from thread_id=1, mi_dynrec.c:368</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这是包含在错误报告中的有用信息。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          如果</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">意外死亡，</font><font style="vertical-align: inherit;">这不是一个好兆头</font><font style="vertical-align: inherit;">，但在这种情况下，您不应该调查这些
           </font></font><code class="literal">Checking table...</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">消息，而是试着找出为什么</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">死亡。
</font></font></p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h4 class="title"><a name="reproducible-test-case"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.5.1.7如果您遇到表损坏，则制作测试用例</font></font></h4>

</div>

</div>

</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          以下过程适用于
           </font></font><a class="link" href="/mysql-5.7-google-zh/storage-engines.html#myisam-storage-engine" title="15.2 MyISAM存储引擎"><code class="literal">MyISAM</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表格。</font><font style="vertical-align: inherit;">有关遇到</font></font><code class="literal">InnoDB</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表损坏</font><font style="vertical-align: inherit;">时要执行的步骤的信息
           </font><font style="vertical-align: inherit;">，请参见
           </font></font><a class="xref" href="/mysql-5.7-google-zh/introduction.html#bug-reports" title="1.7如何报告错误或问题"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第1.7节“如何报告错误或问题”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
        </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          如果遇到损坏的</font></font><a class="link" href="/mysql-5.7-google-zh/storage-engines.html#myisam-storage-engine" title="15.2 MyISAM存储引擎"><code class="literal">MyISAM</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          表或者</font><font style="vertical-align: inherit;">某些更新语句后</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">总是失败，可以通过执行以下操作来测试问题是否可重现：
</font></font></p>
<div class="orderedlist">
<ol class="orderedlist" type="1"><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              用</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqladmin" title="4.5.2 mysqladmin  - 用于管理MySQL服务器的客户端"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqladmin shutdown</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">停止MySQL守护进程</font><font style="vertical-align: inherit;">。
            </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              对表格进行备份，以防止发生修复不良的情况。
            </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              使用</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#myisamchk" title="4.6.3 myisamchk  -  MyISAM表维护实用程序"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">myisamchk -s database / *。MYI</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">检查所有表</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">用</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#myisamchk" title="4.6.3 myisamchk  -  MyISAM表维护实用程序"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">myisamchk -r数据库/ </font></font><em class="replaceable"><code>table</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.MYI</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">修复任何损坏的表
               </font><font style="vertical-align: inherit;">。
            </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              对表格进行第二次备份。
            </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              如果需要更多空间，请从MySQL数据目录中删除（或移走）任何旧日志文件。
            </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在启用二进制日志的情况下</font><font style="vertical-align: inherit;">
              启动</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">如果你想找到一个崩溃</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的语句
               </font><font style="vertical-align: inherit;">，你应该启动一般查询日志的服务器。</font><font style="vertical-align: inherit;">请参见
               </font></font><a class="xref" href="/mysql-5.7-google-zh/server-administration.html#query-log" title="5.4.3一般查询日志"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第5.4.3节“常规查询日志”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
               </font></font><a class="xref" href="/mysql-5.7-google-zh/server-administration.html#binary-log" title="5.4.4二进制日志"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第5.4.4节“二进制日志”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
            </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              当你得到一个崩溃的表时，停止
               </font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">服务器。
            </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              恢复备份。
            </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              在</font><span class="emphasis"><em><font style="vertical-align: inherit;">未</font></em></span><font style="vertical-align: inherit;">启用二进制日志的</font><span class="emphasis"><em><font style="vertical-align: inherit;">情况下</font></em></span><font style="vertical-align: inherit;">重新启动</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">服务器
               </font><font style="vertical-align: inherit;">。
            </font></font><span class="emphasis"><em><font style="vertical-align: inherit;"></font></em></span><font style="vertical-align: inherit;"></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              用</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqlbinlog" title="4.6.7 mysqlbinlog  - 处理二进制日志文件的实用程序"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqlbinlog binary-log-file |</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重新执行语句 </font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqlbinlog" title="4.6.7 mysqlbinlog  - 处理二进制日志文件的实用程序"><span class="command"><strong><font style="vertical-align: inherit;">mysql</font></strong></span></a><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">二进制日志以名称保存在MySQL数据库目录中
               </font><font style="vertical-align: inherit;">。
            </font></font><code class="literal">hostname-bin.<em class="replaceable"><code>NNNNNN</code></em></code><font style="vertical-align: inherit;"></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
              如果表再次损坏，或者您可以</font><font style="vertical-align: inherit;">使用上述命令</font><font style="vertical-align: inherit;">使
               </font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">死亡，您会发现可重现的错误。</font><font style="vertical-align: inherit;">使用</font></font><a class="xref" href="/mysql-5.7-google-zh/introduction.html#bug-reports" title="1.7如何报告错误或问题"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第1.7节“如何报告错误或问题”中</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">给出的说明将表格和二进制日志FTP到我们的错误数据库</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">如果您是支持客户，则可以使用MySQL客户支持中心（</font></font><a class="ulink" href="http://www.mysql.com/support/" target="_top"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http://www.mysql.com/support/</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）向MySQL团队发出有关该问题的警报，并尽快进行修复。
</font></font></p></li></ol>
</div>

</div>

</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="debugging-client"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.5.2调试MySQL客户端</font></font></h3>

</div>

</div>

</div>
<a class="indexterm" name="idm140527953619760"></a><a class="indexterm" name="idm140527953618304"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        为了能够使用集成调试包调试MySQL客户端，您应该使用配置MySQL
         </font></font><a class="link" href="/mysql-5.7-google-zh/installing.html#option_cmake_with_debug"><code class="option">-DWITH_DEBUG=1</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">请参见
         </font></font><a class="xref" href="/mysql-5.7-google-zh/installing.html#source-configuration-options" title="2.9.4 MySQL源配置选项"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第2.9.4节“MySQL源配置选项”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
      </font></font></p><a class="indexterm" name="idm140527953614576"></a><a class="indexterm" name="idm140527953613536"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        在运行客户端之前，您应该设置
         </font></font><code class="literal">MYSQL_DEBUG</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">环境变量：
      </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shell&gt; </font></font><strong class="userinput"><code>MYSQL_DEBUG=d:t:O,/tmp/client.trace</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
shell&gt;</font></font><strong class="userinput"><code>export MYSQL_DEBUG</code></strong>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        这会导致客户端生成一个跟踪文件
         </font></font><code class="filename">/tmp/client.trace</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
      </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        如果您对自己的客户端代码有问题，则应尝试连接到服务器并使用已知可用的客户端运行查询。</font><font style="vertical-align: inherit;">通过</font><font style="vertical-align: inherit;">在调试模式下</font><font style="vertical-align: inherit;">运行</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysql" title="4.5.1 mysql  -  MySQL命令行工具"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">来</font><font style="vertical-align: inherit;">完成此
         </font><font style="vertical-align: inherit;">操作（假设您已经在调试时编译了MySQL）：
      </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">外壳&gt; </font></font><strong class="userinput"><code>mysql --debug=d:t:O,/tmp/client.trace</code></strong>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        这提供了有用的信息，以防您发送错误报告。</font><font style="vertical-align: inherit;">请参见</font></font><a class="xref" href="/mysql-5.7-google-zh/introduction.html#bug-reports" title="1.7如何报告错误或问题"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第1.7节“如何报告错误或问题”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
      </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        如果您的客户端在某些“合法”代码中崩溃，则应检查</font></font><code class="filename">mysql.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">包含文件是否与您的MySQL库文件相匹配。</font><font style="vertical-align: inherit;">一个非常常见的错误是使用</font></font><code class="filename">mysql.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">旧的MySQL安装中</font><font style="vertical-align: inherit;">的旧</font><font style="vertical-align: inherit;">文件和新的MySQL库。
</font></font></p>
</div>
<div class="section">
<div class="titlepage">
<div>
<div>
<h3 class="title"><a name="dbug-package"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.5.3 DBUG包</font></font></h3>

</div>

</div>

</div>
<a class="indexterm" name="idm140527953599840"></a><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        MySQL服务器和大多数MySQL客户端都是用Fred Fish最初创建的DBUG包编译的。</font><font style="vertical-align: inherit;">当您配置MySQL进行调试时，该软件包可以获取程序正在执行的跟踪文件。</font><font style="vertical-align: inherit;">请参见
         </font></font><a class="xref" href="/mysql-5.7-google-zh/extending-mysql.html#making-trace-files" title="28.5.1.2创建跟踪文件"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28.5.1.2节“创建跟踪文件”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
      </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        本节总结了您可以在命令行的调试选项中为使用调试支持构建的MySQL程序指定的参数值。</font><font style="vertical-align: inherit;">有关使用DBUG包进行编程的更多信息，请参阅</font></font><code class="filename">dbug</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL源代码分发目录中</font><font style="vertical-align: inherit;">的DBUG手册</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">最好使用最近的发行版来获取最新的DBUG手册。
      </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        通过使用</font><font style="vertical-align: inherit;">
        or </font><font style="vertical-align: inherit;">选项</font><font style="vertical-align: inherit;">调用程序可以使用DBUG包
         </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">如果您指定</font><font style="vertical-align: inherit;">
        没有</font><font style="vertical-align: inherit;">值</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">or </font><font style="vertical-align: inherit;">选项</font><font style="vertical-align: inherit;">，大多数MySQL程序使用默认值。</font><font style="vertical-align: inherit;">服务器默认
         </font><font style="vertical-align: inherit;">在Unix和
         </font><font style="vertical-align: inherit;">Windows上。</font><font style="vertical-align: inherit;">这个默认的效果是：
</font></font><code class="option">--debug[=<em class="replaceable"><code>debug_options</code></em>]</code><font style="vertical-align: inherit;"></font><code class="option">-#
        [<em class="replaceable"><code>debug_options</code></em>]</code><font style="vertical-align: inherit;"></font><code class="option">--debug</code><font style="vertical-align: inherit;"></font><code class="option">-#</code><font style="vertical-align: inherit;"></font><em class="replaceable"><code>debug_options</code></em><font style="vertical-align: inherit;"></font><code class="literal">d:t:i:o,/tmp/mysqld.trace</code><font style="vertical-align: inherit;"></font><code class="literal">d:t:i:O,\mysqld.trace</code><font style="vertical-align: inherit;"></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            <code class="literal">d</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：为所有调试宏启用输出
          </font></font></p></li><li class="listitem"><p>
            <code class="literal">t</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：跟踪函数调用并退出
          </font></font></p></li><li class="listitem"><p>
            <code class="literal">i</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：将PID添加到输出行
          </font></font></p></li><li class="listitem"><p>
            <code class="literal">o,/tmp/mysqld.trace</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
             </font></font><code class="literal">O,\mysqld.trace</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：设置调试输出文件。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        大多数客户端程序使用默认
         </font></font><em class="replaceable"><code>debug_options</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值
         </font><font style="vertical-align: inherit;">，而不管平台。
      </font></font><code class="literal">d:t:o,/tmp/<em class="replaceable"><code>program_name</code></em>.trace</code><font style="vertical-align: inherit;"></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        以下是调试控制字符串的一些示例，因为它们可能在shell命令行中指定：
      </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">--debug = d：吨</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
--debug = d：F，主，subr1：F：L：吨，20</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
--debug = d，输入，输出，文件：N</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
--debug = d：吨：I：O，\\ mysqld.trace目录</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        对于</font></font><a class="link" href="/mysql-5.7-google-zh/programs.html#mysqld" title="4.3.1 mysqld  -  MySQL服务器"><span class="command"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysqld</font></font></strong></span></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，也可以通过设置</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_debug"><code class="literal">debug</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统变量</font><font style="vertical-align: inherit;">在运行时更改DBUG设置
         </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这个变量具有全局和会话值：
      </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql&gt; </font><font style="vertical-align: inherit;">
mysql&gt;</font></font><strong class="userinput"><code>SET GLOBAL debug = '<em class="replaceable"><code>debug_options</code></em>';</code></strong><font style="vertical-align: inherit;"></font><strong class="userinput"><code>SET SESSION debug = '<em class="replaceable"><code>debug_options</code></em>';</code></strong>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        运行时更改需要
         </font></font><a class="link" href="/mysql-5.7-google-zh/security.html#priv_super"><code class="literal">SUPER</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特权，即使是会话值也是如此。
      </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        该</font></font><em class="replaceable"><code>debug_options</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值是以冒号分隔的字段的序列：
      </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">field_1：field_2：...：field_</font></font><em class="replaceable"><code>N</code></em>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        值中的每个字段都由一个强制性标志字符组成，可选地以一个</font></font><code class="literal">+</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
         </font><font style="vertical-align: inherit;">一个</font></font><code class="literal">-</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">字符开头，并且可选地后跟一个以逗号分隔的修饰符列表：
      </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[+ |  - ]标记[，改性剂，改性剂，...，修改]
</font></font></pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        下表介绍了允许的标志字符。</font><font style="vertical-align: inherit;">无法识别的标志字符被无声地忽略。
</font></font></p>
<div class="informaltable">
<table frame="all" summary="Descriptions of permitted debug_options flag characters."><colgroup><col width="8%"><col width="92%"></colgroup><thead><tr>
            <th scope="col"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                旗
              </font></font></p></th>
            <th scope="col"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                描述
              </font></font></p></th>
          </tr></thead><tbody><tr>
            <td scope="row"><p>
                <code class="literal">d</code>
              </p></td>
            <td><p><font style="vertical-align: inherit;"></font><em class="replaceable"><code>XXX</code></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                为当前状态</font><font style="vertical-align: inherit;">
                启用DBUG_ </font><font style="vertical-align: inherit;">宏的</font><font style="vertical-align: inherit;">输出</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">可能后跟一个关键字列表，该列表仅对具有该关键字的DBUG宏启用输出。</font><font style="vertical-align: inherit;">一个空的关键字列表为所有宏启用输出。
              </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                在MySQL中，公共调试宏关键字启用是
                 </font></font><code class="literal">enter</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><code class="literal">exit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
                 </font></font><code class="literal">error</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><code class="literal">warning</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，
                 </font></font><code class="literal">info</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，和</font></font><code class="literal">loop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
              </font></font></p></td>
          </tr><tr>
            <td scope="row"><p>
                <code class="literal">D</code>
              </p></td>
            <td><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                每个调试器输出线后延迟。</font><font style="vertical-align: inherit;">争论是十分之几秒的延迟，取决于机器的能力。</font><font style="vertical-align: inherit;">例如，</font></font><code class="literal">D,20</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                指定延迟两秒。
              </font></font></p></td>
          </tr><tr>
            <td scope="row"><p>
                <code class="literal">f</code>
              </p></td>
            <td><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                将调试，跟踪和分析限制为指定函数的列表。</font><font style="vertical-align: inherit;">一个空列表启用所有功能。</font><font style="vertical-align: inherit;">必须给予</font><font style="vertical-align: inherit;">适当的</font></font><code class="literal">d</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
                 </font></font><code class="literal">t</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">标志; </font><font style="vertical-align: inherit;">这个标志只限制它们的动作，如果它们被启用。
              </font></font></p></td>
          </tr><tr>
            <td scope="row"><p>
                <code class="literal">F</code>
              </p></td>
            <td><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                确定每行调试或跟踪输出的源文件名。
              </font></font></p></td>
          </tr><tr>
            <td scope="row"><p>
                <code class="literal">i</code>
              </p></td>
            <td><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                使用每行调试或跟踪输出的PID或线程ID标识进程。
              </font></font></p></td>
          </tr><tr>
            <td scope="row"><p>
                <code class="literal">L</code>
              </p></td>
            <td><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                确定每行调试或跟踪输出的源文件行号。
              </font></font></p></td>
          </tr><tr>
            <td scope="row"><p>
                <code class="literal">n</code>
              </p></td>
            <td><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                打印每行调试或跟踪输出的当前函数嵌套深度。
              </font></font></p></td>
          </tr><tr>
            <td scope="row"><p>
                <code class="literal">N</code>
              </p></td>
            <td><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                为调试输出的每一行编号。
              </font></font></p></td>
          </tr><tr>
            <td scope="row"><p>
                <code class="literal">o</code>
              </p></td>
            <td><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                将调试器输出流重定向到指定的文件。</font><font style="vertical-align: inherit;">默认输出是</font></font><code class="literal">stderr</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
              </font></font></p></td>
          </tr><tr>
            <td scope="row"><p>
                <code class="literal">O</code>
              </p></td>
            <td><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                就像</font></font><code class="literal">o</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，但是文件在每次写入之间真正被刷新。</font><font style="vertical-align: inherit;">需要时，文件将在每次写入之间关闭并重新打开。
              </font></font></p></td>
          </tr><tr>
            <td scope="row"><p>
                <code class="literal">p</code>
              </p></td>
            <td><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                将调试器操作限制到指定的进程。</font><font style="vertical-align: inherit;">必须使用</font></font><code class="literal">DBUG_PROCESS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">宏</font><font style="vertical-align: inherit;">标识进程</font><font style="vertical-align: inherit;">并在列表中匹配</font><font style="vertical-align: inherit;">进程
                 </font><font style="vertical-align: inherit;">中的调试器动作。
              </font></font></p></td>
          </tr><tr>
            <td scope="row"><p>
                <code class="literal">P</code>
              </p></td>
            <td><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                打印每行调试或跟踪输出的当前进程名称。
              </font></font></p></td>
          </tr><tr>
            <td scope="row"><p>
                <code class="literal">r</code>
              </p></td>
            <td><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                推入新状态时，不要继承先前状态的函数嵌套级别。</font><font style="vertical-align: inherit;">当输出从左边界开始时有用。
              </font></font></p></td>
          </tr><tr>
            <td scope="row"><p>
                <code class="literal">S</code>
              </p></td>
            <td><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                DO功能</font></font><code class="literal">_sanity(_file_,_line_)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在每个调试功能，直到
                 </font></font><code class="literal">_sanity()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">返回的东西，从0不同。
              </font></font></p></td>
          </tr><tr>
            <td scope="row"><p>
                <code class="literal">t</code>
              </p></td>
            <td><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                启用函数调用/退出跟踪线。</font><font style="vertical-align: inherit;">可能后跟一个列表（仅包含一个修饰符），给出一个数字最大跟踪级别，超出此级别，调试或跟踪宏都不会输出。</font><font style="vertical-align: inherit;">缺省值是编译时选项。
              </font></font></p></td>
</tr></tbody></table>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        前导</font></font><code class="literal">+</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或</font></font><code class="literal">-</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        字符和尾随列表中的修饰符用于标志字符，例如</font></font><code class="literal">d</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或</font></font><code class="literal">f</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        可以对所有适用的修饰符或其中一些修饰符启用调试操作：
</font></font></p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            没有领先</font></font><code class="literal">+</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或者
             </font></font><code class="literal">-</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，标志值被设置为正确的修饰符列表。
          </font></font></p></li><li class="listitem"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            使用前导</font></font><code class="literal">+</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或</font></font><code class="literal">-</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，列表中的修饰符将添加到当前修改器列表或从当前修改器列表中减去。
</font></font></p></li></ul>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        下面的例子显示了这个</font></font><code class="literal">d</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">标志是</font><font style="vertical-align: inherit;">如何工作的
         </font><font style="vertical-align: inherit;">。</font></font><code class="literal">d</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为所有调试宏启用</font><font style="vertical-align: inherit;">空</font><font style="vertical-align: inherit;">列表输出。</font><font style="vertical-align: inherit;">非空列表仅对列表中的宏关键字启用输出。
      </font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        这些语句将该</font></font><code class="literal">d</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值设置为修饰符列表，如下所示：
      </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql&gt; </font></font><strong class="userinput"><code>SET debug = 'd';</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql&gt;</font></font><strong class="userinput"><code>SELECT @@debug;</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ --------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">@@ debug |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ --------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">d |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ --------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql&gt; </font></font><strong class="userinput"><code>SET debug = 'd,error,warning';</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql&gt;</font></font><strong class="userinput"><code>SELECT @@debug;</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ----------------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">@@ debug |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ----------------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">d，错误，警告|</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ----------------- +</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        领先</font></font><code class="literal">+</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或</font></font><code class="literal">-</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">增加或减少当前</font></font><code class="literal">d</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值：
      </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql&gt; </font></font><strong class="userinput"><code>SET debug = '+d,loop';</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql&gt;</font></font><strong class="userinput"><code>SELECT @@debug;</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ---------------------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">@@ debug |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ---------------------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">d，错误，警告，循环|</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ---------------------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql&gt; </font></font><strong class="userinput"><code>SET debug = '-d,error,loop';</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql&gt;</font></font><strong class="userinput"><code>SELECT @@debug;</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ----------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">@@ debug |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ----------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">d，警告|</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ----------- +</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        添加到</font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><span class="quote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">所有启用的宏</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结果不变：
      </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql&gt; </font></font><strong class="userinput"><code>SET debug = 'd';</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql&gt;</font></font><strong class="userinput"><code>SELECT @@debug;</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ --------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">@@ debug |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ --------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">d |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ --------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql&gt; </font></font><strong class="userinput"><code>SET debug = '+d,loop';</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql&gt;</font></font><strong class="userinput"><code>SELECT @@debug;</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ --------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">@@ debug |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ --------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">d |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ --------- +</font></font><font></font>
</pre><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        禁用所有启用的宏将</font></font><code class="literal">d</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        完全</font><font style="vertical-align: inherit;">禁用</font><font style="vertical-align: inherit;">标志：
      </font></font></p><pre class="programlisting"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql&gt; </font></font><strong class="userinput"><code>SET debug = 'd,error,loop';</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql&gt;</font></font><strong class="userinput"><code>SELECT @@debug;</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ -------------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">@@ debug |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ -------------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">d，错误，循环|</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ -------------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql&gt; </font></font><strong class="userinput"><code>SET debug = '-d,error,loop';</code></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysql&gt;</font></font><strong class="userinput"><code>SELECT @@debug;</code></strong><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ --------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">@@ debug |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ --------- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">|</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ --------- +</font></font><font></font>
</pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">

<div class="admon-title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
注意
</font></font></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          在MySQL 5.7.2之前，</font></font><code class="literal">+</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
           </font></font><code class="literal">-</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">修饰符并不总是正确处理，并可能使标志值处于不正确的状态。</font></font><a class="link" href="/mysql-5.7-google-zh/server-administration.html#sysvar_debug"><code class="literal">debug</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">提前</font><font style="vertical-align: inherit;">验证您的</font><font style="vertical-align: inherit;">设置序列或者不使用</font></font><code class="literal">+</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或</font><font style="vertical-align: inherit;">设置它
           </font></font><code class="literal">-</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。
</font></font></p>
</div>

</div>

</div>

</div>
<div class="copyright-footer">

</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tbody><tr>
<td width="40%" align="left"><a accesskey="p" href="/mysql-5.7-google-zh/connectors-apis.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">上一页</font></font></a></td>
<td width="20%" align="center"><a accesskey="u" href="/mysql-5.7-google-zh/extending-mysql.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">向上</font></font></a></td>
<td width="40%" align="right">&nbsp;<a accesskey="n" href="/mysql-5.7-google-zh/mysql-enterprise.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">下一个</font></font></a></td>
</tr>
<tr>
<td width="40%" align="left" valign="top"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第27章连接器和API</font></font></td>
<td width="20%" align="center"><a accesskey="h" href="/mysql-5.7-google-zh/index.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">家</font></font></a></td>
<td width="40%" align="right" valign="top"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第29章MySQL企业版</font></font></td>
</tr>
</tbody></table>
</div><div id="goog-gt-tt" class="skiptranslate" dir="ltr"><div style="padding: 8px;"><div><div class="logo"><img src="./images/translate_24dp.png" width="20" height="20" alt="Google 翻译"></div></div></div><div class="top" style="padding: 8px; float: left; width: 100%;"><h1 class="title gray">原文</h1></div><div class="middle" style="padding: 8px;"><div class="original-text"></div></div><div class="bottom" style="padding: 8px;"><div class="activity-links"><span class="activity-link">提供更好的翻译建议</span><span class="activity-link"></span></div><div class="started-activity-container"><hr style="color: #CCC; background-color: #CCC; height: 1px; border: none;"><div class="activity-root"></div></div></div><div class="status-message" style="display: none;"></div></div>


<div class="goog-te-spinner-pos"><div class="goog-te-spinner-animation"><svg xmlns="http://www.w3.org/2000/svg" class="goog-te-spinner" width="96px" height="96px" viewBox="0 0 66 66"><circle class="goog-te-spinner-path" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"></circle></svg></div></div></body></html>