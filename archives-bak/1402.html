
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>用户登录过程详解 | 青春部落    </title>
    <meta name="keywords"  content="用户登陆过程,系统用户登陆" />
    <meta name="description"  content="linux 系统用户登陆过程中的系统执行操作详解" />
    <link rel="stylesheet" type="text/css" media="all" href="https://cn-blogs.cn/wp-content/themes/pencilone/style.css" />
    <link rel="profile" href="http://gmpg.org/xfn/11">
    <link rel="pingback" href="https://cn-blogs.cn/xmlrpc.php">
    <link id="favicon" href="/favicon.ico" rel="icon" type="image/x-icon" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="青春部落 &raquo; 用户登录过程详解评论Feed" href="https://cn-blogs.cn/archives/1402.html/feed" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.3\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.3\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/cn-blogs.cn\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.9.1"}};
			!function(a,b,c){function d(a,b){var c=String.fromCharCode;l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,a),0,0);var d=k.toDataURL();l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,b),0,0);var e=k.toDataURL();return d===e}function e(a){var b;if(!l||!l.fillText)return!1;switch(l.textBaseline="top",l.font="600 32px Arial",a){case"flag":return!(b=d([55356,56826,55356,56819],[55356,56826,8203,55356,56819]))&&(b=d([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]),!b);case"emoji":return b=d([55358,56794,8205,9794,65039],[55358,56794,8203,9794,65039]),!b}return!1}function f(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var g,h,i,j,k=b.createElement("canvas"),l=k.getContext&&k.getContext("2d");for(j=Array("flag","emoji"),c.supports={everything:!0,everythingExceptFlag:!0},i=0;i<j.length;i++)c.supports[j[i]]=e(j[i]),c.supports.everything=c.supports.everything&&c.supports[j[i]],"flag"!==j[i]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[j[i]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(h=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",h,!1),a.addEventListener("load",h,!1)):(a.attachEvent("onload",h),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),g=c.source||{},g.concatemoji?f(g.concatemoji):g.wpemoji&&g.twemoji&&(f(g.twemoji),f(g.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel='https://api.w.org/' href='https://cn-blogs.cn/wp-json/' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://cn-blogs.cn/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://cn-blogs.cn/wp-includes/wlwmanifest.xml" /> 
<link rel='prev' title='MongoEngine入门' href='https://cn-blogs.cn/archives/1352.html' />
<link rel='next' title='MongoEngine类说明' href='https://cn-blogs.cn/archives/1438.html' />
<meta name="generator" content="WordPress 4.9.1" />
<link rel="canonical" href="https://cn-blogs.cn/archives/1402.html" />
<link rel='shortlink' href='https://cn-blogs.cn/?p=1402' />
<link rel="alternate" type="application/json+oembed" href="https://cn-blogs.cn/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fcn-blogs.cn%2Farchives%2F1402.html" />
<link rel="alternate" type="text/xml+oembed" href="https://cn-blogs.cn/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fcn-blogs.cn%2Farchives%2F1402.html&#038;format=xml" />
<link rel="icon" href="https://cn-blogs.cn/wp-content/uploads/2018/03/cropped-logo-32x32.png" sizes="32x32" />
<link rel="icon" href="https://cn-blogs.cn/wp-content/uploads/2018/03/cropped-logo-192x192.png" sizes="192x192" />
<link rel="apple-touch-icon-precomposed" href="https://cn-blogs.cn/wp-content/uploads/2018/03/cropped-logo-180x180.png" />
<meta name="msapplication-TileImage" content="https://cn-blogs.cn/wp-content/uploads/2018/03/cropped-logo-270x270.png" />

<meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">


</head>

<body class="post-template-default single single-post postid-1402 single-format-standard">
<header class="navbar">
<div class="container">
    <div class="navbar-brand">
        <img src="/logo.png" width="73" height="88">
        <div>
        <h1 class="title2 is-3 navbar-item">
            <a href="https://cn-blogs.cn/" rel="home">青春部落</a>
        </h1>
        <p class="has-text-right">
            <a href="/">记录生活的足迹</a>
        </p>
        </div>
    </div>
    <div class="navbar-menu is-active">
    <div class="navbar-end">
    <div class="tabs is-right">
    <a class="navbar-item" href="/pages/index.html">索引</a>
    <a class="navbar-item" href="/about">About</a>
    </div>
    </div>
    </div>
</div>
</header>


<main class="container">
        <article class="article margin-top20">

        <!-- 文章分类和上一篇\下一篇 -->
        <div class="box columns">
            <!-- 文章分类 -->
            <div class="column is-two-fifth">
                <div class="categproe-name">分类：</div>
                <ul class="post-categories">
	<li><a href="https://cn-blogs.cn/archives/category/kernel/centos" rel="category tag">CentOS发行版</a></li></ul>            </div>
            <!-- 文章分类结束 -->

            <!-- 上一篇和下一篇 -->
            <div class="column is-two-fifth is-offset-5">
                
	<nav class="navigation post-navigation" role="navigation">
		<h2 class="screen-reader-text">Post navigation</h2>
		<div class="nav-links"><div class="nav-previous"><a href="https://cn-blogs.cn/archives/1352.html" rel="prev">上一篇：MongoEngine入门</a></div><div class="nav-next"><a href="https://cn-blogs.cn/archives/1438.html" rel="next">下一篇：MongoEngine类说明</a></div></div>
	</nav>            </div>
            <!-- 上一篇和下一篇结束 -->
        </div>

        <!-- 文章信息 -->
        <!-- 文章标题 -->
        <div class="title is-3 has-text-centered">
            用户登录过程详解        </div>
        <!-- 文章标题结束 -->

        <!-- 文章作者、发布时间、更新时间 -->
        <div class="subtitle is-5 has-text-centered">
            <span class="entry-author"><a href="https://cn-blogs.cn/archives/author/admin" title="由admin发布" rel="author">admin</a></span>
            <span class="entry-date">2017/09/13</span>
            <span class="update is-hidden">2018-01-08</span>
        </div>
        <!-- 文章作者、发布时间、更新时间结束 -->

        <!-- 文章内容 -->
        <div class="content article-body">
            <div class="content">
                <p><strong>记录用户登陆过程中系统执行的操作</strong><br />
#strace -o su -e trace=open su &#8211; alice<br />
#grep ^open /etc/su|grep -v null|grep &#8220;= 3&#8243;|nl<br />
<code><br />
1 open("/etc/ld.so.cache", O_RDONLY) = 3<br />
2 open("/lib/libcrypt.so.1", O_RDONLY) = 3<br />
3 open("/lib/tls/libc.so.6", O_RDONLY) = 3<br />
4 open("/usr/lib/locale/locale-archive", O_RDONLY|O_LARGEFILE) = 3<br />
5 open("/etc/nsswitch.conf", O_RDONLY) = 3<br />
6 open("/etc/ld.so.cache", O_RDONLY) = 3<br />
7 open("/lib/libnss_files.so.2", O_RDONLY) = 3<br />
8 open("/etc/passwd", O_RDONLY) = 3<br />
9 open("/etc/shadow", O_RDONLY) = 3<br />
10 open("/etc/group", O_RDONLY) = 3<br />
11 open("/etc/ld.so.cache", O_RDONLY) = 3<br />
12 open("/lib/libtermcap.so.2", O_RDONLY) = 3<br />
13 open("/lib/libdl.so.2", O_RDONLY) = 3<br />
14 open("/lib/tls/libc.so.6", O_RDONLY) = 3<br />
15 open("/dev/tty", O_RDWR|O_NONBLOCK|O_LARGEFILE) = 3<br />
16 open("/etc/mtab", O_RDONLY) = 3<br />
17 open("/proc/meminfo", O_RDONLY) = 3<br />
18 open("/etc/nsswitch.conf", O_RDONLY) = 3<br />
19 open("/etc/ld.so.cache", O_RDONLY) = 3<br />
20 open("/lib/libnss_files.so.2", O_RDONLY) = 3<br />
21 open("/etc/passwd", O_RDONLY) = 3</code><br />
<strong>######第一部分:</strong><br />
从1-21行基本是打开动态链接库文件和身份验证的文件<br />
<code>22 open("/etc/profile", O_RDONLY|O_LARGEFILE) = 3<br />
23 open("/etc/profile.d/", O_RDONLY|O_NONBLOCK|O_LARGEFILE|O_DIRECTORY) = 3</code><br />
<strong>######第二部分:</strong><br />
第22行是打开/etc/profile文件,如下:<br />
###############<br />
# /etc/profile<br />
# System wide environment and startup programs, for login setup<br />
# Functions and aliases go in /etc/bashrc<br />
###############<br />
#定义pathmunge函数<br />
#echo $PATH | /bin/egrep -q &#8220;(^|:)$1($|:)&#8221;是过滤$PATH中的可执行目录,如果egrep到批配项,返回真但取反;也就是不增加执行目录到$PATH中,<br />
选项-q禁止所有的输出到标准输出，不管匹配行。<br />
如果选中输入行，以 0 状态退出这里由 | (竖线)或者换行符隔开的多个正则表达式会匹配与任何一个正则表达式所匹配的字符串一个正则表达式可以被包括在“()”（括弧）中进行分组<br />
###############<br />
pathmunge () {<br />
if ! echo $PATH | /bin/egrep -q &#8220;(^|:)$1($|:)&#8221; ; then<br />
if [ &#8220;$2&#8221; = &#8220;after&#8221; ] ; then<br />
PATH=$PATH:$1<br />
else<br />
PATH=$1:$PATH<br />
fi<br />
fi<br />
}<br />
###############<br />
#如果uid为0的用户,将在$PATH变量上加入/sbin/,/usr/sbin,/usr/local/sbin三个目录-q &#8220;(^|:)($|:)&#8221;<br />
#因为调用pathmunge函数，没有加入after参数,所以以上三个目录都加在了$PATH变量的最前面<br />
###############<br />
# Path manipulation<br />
if [ `id -u` = 0 ]; then<br />
pathmunge /sbin<br />
pathmunge /usr/sbin<br />
pathmunge /usr/local/sbin<br />
fi<br />
##################<br />
#调用pathmunge函数,在$PATH后面增加/usr/X11R6/bin<br />
#################<br />
pathmunge /usr/X11R6/bin after<br />
unset pathmunge<br />
####################<br />
#ulimit设定-S为软控制,-c为core file文件大小,这里是不做限制<br />
################<br />
# No core files by default<br />
ulimit -S -c 0 &gt; /dev/null 2&gt;&amp;1<br />
#################<br />
#id -un是打印输出当前的用户名,例如:root<br />
#定义了LOGNAME变量和MAIL变量,会有程序用到这些变量<br />
####################<br />
USER=&#8221;`id -un`&#8221;<br />
LOGNAME=$USER<br />
MAIL=&#8221;/var/spool/mail/$USER&#8221;<br />
####################<br />
#通过/bin/hostname获取主机名<br />
#定义history的记录数为1000<br />
#####################<br />
HOSTNAME=`/bin/hostname`<br />
HISTSIZE=1000<br />
#####################<br />
#如果没有定义$INPUTRC并且不存在$HOME/.inputrc文件<br />
#定义变量INPUTRC的值为/etc/inputrc<br />
#######################<br />
if [ -z &#8220;$INPUTRC&#8221; -a ! -f &#8220;$HOME/.inputrc&#8221; ]; then<br />
INPUTRC=/etc/inputrc<br />
fi<br />
export REMOTE_JAVA_DEBUG=on<br />
export PATH USER LOGNAME MAIL HOSTNAME HISTSIZE INPUTRC<br />
##################<br />
#执行/etc/profile.d/下的所有脚本,-r是确认它们可读<br />
##################<br />
for i in /etc/profile.d/*.sh ; do<br />
if [ -r &#8220;$i&#8221; ]; then<br />
. $i<br />
fi<br />
done<br />
unset i<br />
. /ceno/product/imeg/etc/profile<br />
export PS1=&#8221;/[/e[32;1m/][/u@/h]/[/e[33;1m/]:/[/e[31;1m/]/w&gt;//$ /[/e[0m/]&#8221;</p>
<p><code>24 open("/etc/profile.d/colorls.sh", O_RDONLY|O_LARGEFILE) = 3<br />
25 open(".", O_RDONLY|O_NONBLOCK|O_LARGEFILE|O_DIRECTORY) = 3<br />
26 open("/etc/profile.d/glib2.sh", O_RDONLY|O_LARGEFILE) = 3<br />
27 open("/etc/profile.d/gnome-ssh-askpass.sh", O_RDONLY|O_LARGEFILE) = 3<br />
28 open("/etc/profile.d/krb5.sh", O_RDONLY|O_LARGEFILE) = 3<br />
29 open("/etc/profile.d/lang.sh", O_RDONLY|O_LARGEFILE) = 3<br />
30 open("/etc/sysconfig/i18n", O_RDONLY|O_LARGEFILE) = 3<br />
31 open("/usr/lib/locale/locale-archive", O_RDONLY|O_LARGEFILE) = 3<br />
32 open("/usr/lib/gconv/gconv-modules.cache", O_RDONLY) = 3<br />
33 open("/etc/profile.d/less.sh", O_RDONLY|O_LARGEFILE) = 3<br />
34 open("/etc/profile.d/qt.sh", O_RDONLY|O_LARGEFILE) = 3<br />
35 open("/etc/profile.d/vim.sh", O_RDONLY|O_LARGEFILE) = 3<br />
36 open("/etc/profile.d/which-2.sh", O_RDONLY|O_LARGEFILE) = 3</code><br />
<strong>#######第三部分:</strong><br />
从24行到36行是执行/etc/profile.d/下的所有脚本，这个执行过程在/etc/profile中定义.<br />
见前面/etc/profile中的脚本分析.<br />
下面是对/etc/profile.d/下脚本做的简要说明,主要设定了环境变量(例如:PATH),alias等<br />
/etc/profile.d/colorls.sh:对/etc/DIR_COLORS的提取,并用dircolors进行设定,最后定义了一些ls的alias<br />
/etc/profile.d/glib2.sh:设定G_BROKEN_FILENAMES=1<br />
/etc/profile.d/gnome-ssh-askpass.sh:设定SSH_ASKPASS=/usr/libexec/openssh/gnome-ssh-askpass<br />
/etc/profile.d/krb5.sh:增加/usr/kerberos/bin或/usr/kerberos/sbin到PATH变量中<br />
/etc/profile.d/lang.sh:设定语言环境,首先会加载/etc/sysconfig/i18n中的环境变量(LANG,SUPPORTED,SYSFONT)到shell中,<br />
根据以上的变量再定义语言环境支持子集,最后再根据LANG设定终端<br />
/etc/profile.d/less.sh:设定LESSOPEN=&#8221;|/usr/bin/lesspipe.sh %s&#8221;,LANGVAR=$LANG<br />
/etc/profile.d/qt.sh:设定QTDIR=&#8221;/usr/lib/qt-3.1&#8243;<br />
/etc/profile.d/vim.sh:设定alias vi=vim<br />
/etc/profile.d/which-2.sh:设定alias which=&#8221;alias | /usr/bin/which &#8211;tty-only &#8211;read-alias &#8211;show-dot &#8211;show-tilde&#8221;<br />
########################################################<br />
<code><br />
37 open("/ceno/product/imeg/etc/profile", O_RDONLY|O_LARGEFILE) = 3</code><br />
<strong>#####第四部分:</strong><br />
第37行open(&#8220;/ceno/product/imeg/etc/profile&#8221;, O_RDONLY|O_LARGEFILE) = 3，这里加载了用户自己的环境设定脚本.<br />
<code><br />
38 open("/home/alice/.bash_profile", O_RDONLY|O_LARGEFILE) = 3<br />
39 open("/home/alice/.bashrc", O_RDONLY|O_LARGEFILE) = 3<br />
40 open("/etc/bashrc", O_RDONLY|O_LARGEFILE) = 3</code><br />
<strong>####第五部分:</strong><br />
第38行open(&#8220;/home/alice/.bash_profile&#8221;, O_RDONLY|O_LARGEFILE) = 3<br />
第39行open(&#8220;/home/alice/.bashrc&#8221;, O_RDONLY|O_LARGEFILE) = 3<br />
第40行open(&#8220;/etc/bashrc&#8221;, O_RDONLY|O_LARGEFILE) = 3<br />
第一步:bash打开/home/alice/.bash_profile文件,<br />
第二步:.bash_profile文件再判断有无/home/alice/.bashrc,如果有加载.bashrc文件<br />
第三步:最后通过.bashrc文件加载/etc/bashrc文件<br />
<code><br />
41 open("/home/alice/.bash_history", O_RDONLY|O_LARGEFILE) = 3<br />
42 open("/home/alice/.bash_history", O_RDONLY|O_LARGEFILE) = 3<br />
43 open("/etc/termcap", O_RDONLY) = 3<br />
44 open("/etc/inputrc", O_RDONLY|O_LARGEFILE) = 3</code><br />
<strong>########第六部分:</strong><br />
在41行open(&#8220;/home/alice/.bash_history&#8221;, O_RDONLY|O_LARGEFILE) = 3<br />
在42行open(&#8220;/home/alice/.bash_history&#8221;, O_RDONLY|O_LARGEFILE) = 3<br />
在43行open(&#8220;/etc/termcap&#8221;, O_RDONLY) = 3<br />
在44行open(&#8220;/etc/inputrc&#8221;, O_RDONLY|O_LARGEFILE) = 3<br />
第一步打开.bash_history文件准备记录命令<br />
第二步打开termcap文件<br />
terminfo 数据库用于定义终端和打印机的属性及功能，包括各设备（例如，终端和打印机）的行数和列数以及要发送至该设备的文本的属性<br />
第三步打开inputrc<br />
inputrc 文件为特定的情况处理键盘映射，这个文件被 Readline 用作启动文件，Readline 是 Bash 和其它大多数 shell 使用的与输入相关的库<br />
<code><br />
45 open(".", O_RDONLY|O_NONBLOCK|O_LARGEFILE|O_DIRECTORY) = 3<br />
46 open("/home/alice/.bash_logout", O_RDONLY|O_LARGEFILE) = 3<br />
47 open("/home/alice/.bash_history", O_WRONLY|O_APPEND|O_LARGEFILE) = 3<br />
48 open("/home/alice/.bash_history", O_RDONLY|O_LARGEFILE) = 3</code><br />
<strong>#####第七部分:</strong><br />
第46行open(&#8220;/home/alice/.bash_logout&#8221;, O_RDONLY|O_LARGEFILE) = 3<br />
第47行open(&#8220;/home/alice/.bash_history&#8221;, O_WRONLY|O_APPEND|O_LARGEFILE) = 3<br />
第48行open(&#8220;/home/alice/.bash_history&#8221;, O_RDONLY|O_LARGEFILE) = 3</p>
<p>这里是用户用logout或exit退出的表现.如果直接关闭掉terminal,则不会执行.bash_logout和写回.bash_history文件<br />
.bash_logout脚本默认是调用clear清一下屏幕</p>
            </div>
        </div>
        <!-- 文章内容结束 -->
    </article>


</main><!-- .content-area -->

<div class="footer">
    <div class="container">

<div class="has-text-centered">
Copyright©2015-20178 cn-blogs.cn. All Rights Reserved. 鲁ICP备18001334号-2
</div>
    </div>
  </div>

</body>
</html>
